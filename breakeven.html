<!--
  Breakeven Calculator v1.0.0
  Cost aggregation and breakeven analysis
  Part of the Farm Management Suite
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Breakeven Calculator v1.0.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; }
    @media print {
      .lg\\:w-64, .lg\\:hidden, button:not(.print-show), select, .fixed { visibility: hidden; height: 0; overflow: hidden; }
      body { background: white !important; }
      .lg\\:pl-64 { padding-left: 0 !important; }
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useCallback, useMemo } = React;

// ============================================================================
// SUPABASE CLIENT
// ============================================================================
const SUPABASE_URL = 'https://xehapaasizntuzqzvwej.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhlaGFwYWFzaXpudHV6cXp2d2VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMTkwOTksImV4cCI6MjA4Mzg5NTA5OX0.JTtRaVRfZ4DNddTdT2BsKgCNabErgsCB0rBCHlK0mbA';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

async function testConnection() {
  try {
    const { error } = await db.from('commodities').select('id').limit(1);
    return !error;
  } catch { return false; }
}

// ============================================================================
// ICONS
// ============================================================================
const ICON_FALLBACKS = {
  'pencil': 'âœï¸', 'trash-2': 'ðŸ—‘ï¸', 'plus': '+', 'check': 'âœ”', 'x': 'âœ•',
  'refresh-cw': 'â†»', 'download': 'â¬‡ï¸', 'home': 'ðŸ ', 'settings': 'âš™ï¸',
  'layout-dashboard': 'ðŸ“Š', 'menu': 'â˜°', 'chevron-down': 'â–¼',
  'search': 'ðŸ”', 'save': 'ðŸ’¾', 'link': 'ðŸ”—', 'map-pin': 'ðŸ“',
  'package': 'ðŸ“¦', 'calculator': 'ðŸ§®', 'flask-conical': 'ðŸ§ª', 'wheat': 'ðŸŒ¾',
  'spray-can': 'ðŸ’¨', 'calendar': 'ðŸ“…', 'dollar-sign': '$', 'user': 'ðŸ‘¤',
  'log-out': 'â†’', 'loader': 'âŸ³', 'target': 'ðŸŽ¯', 'building': 'ðŸ¢',
  'tractor': 'ðŸšœ', 'sprout': 'ðŸŒ±', 'land-plot': 'ðŸ“', 'layers': 'ðŸ“š',
  'pie-chart': 'ðŸ¥§', 'bar-chart-3': 'ðŸ“Š', 'trending-up': 'ðŸ“ˆ'
};

function Icon({ name, size = 20, className = '' }) {
  const ref = React.useRef(null);
  useEffect(() => {
    if (ref.current) {
      try {
        if (window.lucide?.icons?.[name]) {
          ref.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size });
        } else {
          ref.current.innerHTML = ICON_FALLBACKS[name] || '*';
        }
      } catch { ref.current.innerHTML = ICON_FALLBACKS[name] || '*'; }
    }
  }, [name, size]);
  return <span ref={ref} className={`inline-flex items-center justify-center ${className}`} style={{ minWidth: size, minHeight: size }} />;
}

// ============================================================================
// TOAST SYSTEM
// ============================================================================
const ToastContext = React.createContext(null);

function ToastProvider({ children }) {
  const [toasts, setToasts] = useState([]);
  const addToast = useCallback((message, options = {}) => {
    const id = Date.now();
    setToasts(prev => [...prev, { id, message, type: options.type || 'info' }]);
    setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 4000);
    return id;
  }, []);
  const removeToast = useCallback((id) => setToasts(prev => prev.filter(t => t.id !== id)), []);
  return (
    <ToastContext.Provider value={{ addToast, removeToast }}>
      {children}
      <div className="fixed bottom-4 right-4 z-50 flex flex-col gap-2">
        {toasts.map(toast => (
          <div key={toast.id} className={`${toast.type === 'success' ? 'bg-green-600' : toast.type === 'error' ? 'bg-red-600' : 'bg-gray-800'} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 min-w-72`}>
            <span className="flex-1">{toast.message}</span>
            <button onClick={() => removeToast(toast.id)} className="hover:opacity-75"><Icon name="x" size={16} /></button>
          </div>
        ))}
      </div>
    </ToastContext.Provider>
  );
}

function useToast() {
  const context = React.useContext(ToastContext);
  if (!context) throw new Error('useToast must be used within ToastProvider');
  return context;
}

// ============================================================================
// MODAL
// ============================================================================
function Modal({ isOpen, onClose, title, children, size = 'md' }) {
  if (!isOpen) return null;
  const sizeClass = size === 'lg' ? 'max-w-3xl' : size === 'xl' ? 'max-w-5xl' : 'max-w-lg';
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
      <div className="fixed inset-0 bg-black bg-opacity-50" onClick={onClose} />
      <div className={`relative bg-white rounded-lg shadow-xl w-full ${sizeClass} max-h-[90vh] overflow-y-auto`}>
        <div className="flex items-center justify-between p-4 border-b">
          <h3 className="text-lg font-semibold text-gray-900">{title}</h3>
          <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg"><Icon name="x" size={20} /></button>
        </div>
        <div className="p-4">{children}</div>
      </div>
    </div>
  );
}

function ConfirmModal({ isOpen, title, message, onConfirm, onCancel }) {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      <div className="fixed inset-0 bg-black bg-opacity-50" onClick={onCancel} />
      <div className="relative bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
        <h3 className="text-lg font-semibold text-gray-900 mb-2">{title}</h3>
        <p className="text-gray-600 mb-6">{message}</p>
        <div className="flex justify-end gap-3">
          <button onClick={onCancel} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
          <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirm</button>
        </div>
      </div>
    </div>
  );
}

// ============================================================================
// UTILITIES
// ============================================================================
const formatDate = (d) => d ? new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
const formatCurrency = (v) => v != null ? '$' + Number(v).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-';
const formatNumber = (v, dec = 0) => v != null ? Number(v).toLocaleString('en-US', { maximumFractionDigits: dec }) : '-';
const formatPrice = (v) => v != null ? '$' + Number(v).toFixed(4) : '-';

// ============================================================================
// DATA SERVICES
// ============================================================================

// Commodities
async function getCommodities() {
  const { data, error } = await db.from('commodities').select('*').eq('active', true).order('sort_order');
  return error ? [] : data || [];
}

// Fields & Production (with landlord/tenant info)
async function getFieldCropYears(cropYear) {
  const { data, error } = await db.from('field_crop_years').select('*, fields(id, name, acres, farm_id, tenant_share, landlord, farms(name, adams_grain_share)), commodities(id, name)').eq('crop_year', cropYear).is('deleted_at', null);
  if (error) return [];
  return (data || []).map(f => {
    // Parse tenant_share as number (Supabase may return as string)
    const tenantShare = f.fields?.tenant_share != null ? Number(f.fields.tenant_share) : 1;
    return {
      ...f,
      field_id: f.fields?.id,
      field_name: f.fields?.name,
      field_acres: f.fields?.acres,
      farm_name: f.fields?.farms?.name,
      commodity_name: f.commodities?.name,
      tenant_share: tenantShare,
      landlord: f.fields?.landlord,
      effective_share: tenantShare * (f.fields?.farms?.adams_grain_share || 1)
    };
  });
}

// Overhead Categories
async function getOverheadCategories() {
  const { data, error } = await db.from('be_overhead_categories').select('*').eq('active', true).is('deleted_at', null).order('sort_order');
  return error ? [] : data || [];
}

// Overhead Expenses
async function getOverheadExpenses(cropYear) {
  const { data, error } = await db.from('be_overhead_expenses').select('*, be_overhead_categories(name), be_overhead_allocations(commodity_id, practice_type, commodities(name))').eq('crop_year', cropYear).is('deleted_at', null).order('name');
  return error ? [] : data || [];
}

async function saveOverheadExpense(expense, allocations = []) {
  if (expense.id) {
    const { error } = await db.from('be_overhead_expenses').update({ name: expense.name, category_id: expense.category_id, amount: expense.amount, allocation_type: expense.allocation_type, notes: expense.notes, updated_at: new Date().toISOString() }).eq('id', expense.id);
    if (error) throw error;
    await db.from('be_overhead_allocations').delete().eq('expense_id', expense.id);
    if (allocations.length > 0) {
      await db.from('be_overhead_allocations').insert(allocations.map(a => ({ expense_id: expense.id, commodity_id: a.commodity_id, practice_type: a.practice_type || null })));
    }
    return expense;
  } else {
    const { data, error } = await db.from('be_overhead_expenses').insert([{ name: expense.name, category_id: expense.category_id, crop_year: expense.crop_year, amount: expense.amount, allocation_type: expense.allocation_type, notes: expense.notes }]).select().single();
    if (error) throw error;
    if (allocations.length > 0) {
      await db.from('be_overhead_allocations').insert(allocations.map(a => ({ expense_id: data.id, commodity_id: a.commodity_id, practice_type: a.practice_type || null })));
    }
    return data;
  }
}

async function deleteOverheadExpense(id) {
  const { error } = await db.from('be_overhead_expenses').update({ deleted_at: new Date().toISOString() }).eq('id', id);
  if (error) throw error;
}

// Seed Costs
async function getSeedCosts(cropYear) {
  const { data, error } = await db.from('be_seed_costs').select('*, field_crop_years(id, field_id, commodity_id, planted_acres, fields(name, farms(name)), commodities(name))').is('deleted_at', null);
  if (error) return [];
  return (data || []).filter(s => s.field_crop_years?.id).map(s => ({
    ...s,
    field_name: s.field_crop_years?.fields?.name,
    farm_name: s.field_crop_years?.fields?.farms?.name,
    commodity_name: s.field_crop_years?.commodities?.name,
    planted_acres: s.field_crop_years?.planted_acres
  }));
}

async function saveSeedCost(seed) {
  if (seed.id) {
    const { error } = await db.from('be_seed_costs').update({ variety: seed.variety, brand: seed.brand, price_per_bag: seed.price_per_bag, seeds_per_bag: seed.seeds_per_bag, seeding_rate: seed.seeding_rate, total_cost: seed.total_cost, notes: seed.notes }).eq('id', seed.id);
    if (error) throw error;
    return seed;
  } else {
    const { data, error } = await db.from('be_seed_costs').insert([seed]).select().single();
    if (error) throw error;
    return data;
  }
}

async function deleteSeedCost(id) {
  const { error } = await db.from('be_seed_costs').update({ deleted_at: new Date().toISOString() }).eq('id', id);
  if (error) throw error;
}

// Land Rent
async function getLandRent(cropYear) {
  const { data, error } = await db.from('be_land_rent').select('*, fields(name, acres, farms(name))').eq('crop_year', cropYear).is('deleted_at', null);
  return error ? [] : (data || []).map(r => ({ ...r, field_name: r.fields?.name, farm_name: r.fields?.farms?.name, field_acres: r.fields?.acres }));
}

async function saveLandRent(rent) {
  const existing = await db.from('be_land_rent').select('id').eq('field_id', rent.field_id).eq('crop_year', rent.crop_year).is('deleted_at', null).maybeSingle();
  if (existing.data) {
    const { error } = await db.from('be_land_rent').update({ rent_type: rent.rent_type, rent_per_acre: rent.rent_per_acre, notes: rent.notes }).eq('id', existing.data.id);
    if (error) throw error;
    return { ...rent, id: existing.data.id };
  } else {
    const { data, error } = await db.from('be_land_rent').insert([rent]).select().single();
    if (error) throw error;
    return data;
  }
}

async function deleteLandRent(id) {
  const { error } = await db.from('be_land_rent').update({ deleted_at: new Date().toISOString() }).eq('id', id);
  if (error) throw error;
}

// Get Fertilizer Costs from Fertilizer App
async function getFertilizerCosts(cropYear) {
  const { data: apps, error } = await db.from('fert_applications').select('field_id, total_cost, acres_applied').eq('crop_year', cropYear).is('deleted_at', null);
  if (error) return {};
  const byField = {};
  (apps || []).forEach(a => {
    if (!byField[a.field_id]) byField[a.field_id] = 0;
    byField[a.field_id] += a.total_cost || 0;
  });
  return byField;
}

// Get Herbicide Costs from Spray-Suite with split info
// Returns { fieldId: { total, splitCost, nonSplitCost } }
// The 'split' column on application_products is 'Y' or 'N' (set from tank_mix or manually)
async function getHerbicideCosts(cropYear) {
  const startDate = `${cropYear - 1}-09-01`;
  const endDate = `${cropYear}-08-31`;

  // Get applications with their products - split is on application_products as 'Y'/'N'
  const { data: apps, error } = await db
    .from('applications')
    .select('id, field_id, total_cost, application_products(product_id, total_cost, split)')
    .gte('date', startDate)
    .lte('date', endDate);

  if (error) {
    console.error('Error fetching herbicide costs:', error);
    return {};
  }

  const byField = {};
  (apps || []).forEach(app => {
    if (!byField[app.field_id]) {
      byField[app.field_id] = { total: 0, splitCost: 0, nonSplitCost: 0 };
    }

    const products = app.application_products || [];
    if (products.length > 0) {
      // Sum by 'split' flag ('Y' = shared with landlord, 'N' = 100% tenant)
      products.forEach(p => {
        const cost = p.total_cost || 0;
        const isSplit = p.split === 'Y';
        byField[app.field_id].total += cost;
        if (isSplit) {
          byField[app.field_id].splitCost += cost;
        } else {
          byField[app.field_id].nonSplitCost += cost;
        }
      });
    } else {
      // Fallback: no product detail, use application total (assume not split for burndowns)
      byField[app.field_id].total += app.total_cost || 0;
      byField[app.field_id].nonSplitCost += app.total_cost || 0;
    }
  });

  return byField;
}

// Get Fertilizer Costs from Fertilizer App with split info
// Fertilizer is ALWAYS split with landlord
async function getFertilizerCostsDetailed(cropYear) {
  const { data: apps, error } = await db
    .from('fert_applications')
    .select('field_id, total_cost, acres_applied')
    .eq('crop_year', cropYear)
    .is('deleted_at', null);

  if (error) return {};

  const byField = {};
  (apps || []).forEach(a => {
    if (!byField[a.field_id]) byField[a.field_id] = { total: 0, splitCost: 0 };
    const cost = a.total_cost || 0;
    byField[a.field_id].total += cost;
    byField[a.field_id].splitCost += cost; // All fertilizer is split
  });

  return byField;
}

// Get all fields for rent assignment (with landlord/tenant info)
async function getFields() {
  const { data, error } = await db.from('fields').select('*, farms(name, adams_grain_share)').eq('active', true).order('name');
  return error ? [] : (data || []).map(f => ({
    ...f,
    farm_name: f.farms?.name,
    effective_share: (f.tenant_share || 1) * (f.farms?.adams_grain_share || 1)
  }));
}

// Herbicide Plans
async function getHerbicidePlans() {
  const { data, error } = await db.from('be_herbicide_plans').select('*, commodities(name)').eq('active', true).is('deleted_at', null).order('name');
  return error ? [] : (data || []).map(p => ({ ...p, commodity_name: p.commodities?.name }));
}

async function saveHerbicidePlan(plan) {
  if (plan.id) {
    const { error } = await db.from('be_herbicide_plans').update({
      name: plan.name,
      commodity_id: plan.commodity_id || null,
      description: plan.description,
      tank_mix_id: plan.tank_mix_id || null,
      estimated_cost_per_acre: plan.estimated_cost_per_acre
    }).eq('id', plan.id);
    if (error) throw error;
    return plan;
  } else {
    const { data, error } = await db.from('be_herbicide_plans').insert([plan]).select().single();
    if (error) throw error;
    return data;
  }
}

async function deleteHerbicidePlan(id) {
  const { error } = await db.from('be_herbicide_plans').update({ deleted_at: new Date().toISOString() }).eq('id', id);
  if (error) throw error;
}

// Fertilizer Plans (from Fertilizer App)
async function getFertilizerPlans() {
  const { data, error } = await db.from('fert_plans').select('*, commodities(name), fert_plan_products(*, fert_products(name, unit))').eq('active', true).is('deleted_at', null).order('name');
  return error ? [] : (data || []).map(p => ({
    ...p,
    commodity_name: p.commodities?.name,
    products: p.fert_plan_products || []
  }));
}

// Field Crop Plans
async function getFieldCropPlans(cropYear) {
  const { data, error } = await db.from('be_field_crop_plans')
    .select('*, field_crop_years(id, field_id, commodity_id, planted_acres, fields(name, farms(name), tenant_share, landlord), commodities(name)), fert_plans(name), be_field_herbicide_passes(*, be_herbicide_plans(name, estimated_cost_per_acre))')
    .is('deleted_at', null);
  if (error) return [];
  return (data || []).filter(p => p.field_crop_years).map(p => ({
    ...p,
    field_id: p.field_crop_years?.field_id,
    field_name: p.field_crop_years?.fields?.name,
    farm_name: p.field_crop_years?.fields?.farms?.name,
    commodity_id: p.field_crop_years?.commodity_id,
    commodity_name: p.field_crop_years?.commodities?.name,
    planted_acres: p.field_crop_years?.planted_acres,
    tenant_share: p.field_crop_years?.fields?.tenant_share || 1,
    landlord: p.field_crop_years?.fields?.landlord,
    fert_plan_name: p.fert_plans?.name,
    herbicide_passes: p.be_field_herbicide_passes || []
  }));
}

async function saveFieldCropPlan(plan) {
  if (plan.id) {
    const { error } = await db.from('be_field_crop_plans').update({
      seed_variety: plan.seed_variety,
      seed_brand: plan.seed_brand,
      seeding_rate: plan.seeding_rate,
      fertilizer_plan_id: plan.fertilizer_plan_id || null,
      fertilizer_plan_override: plan.fertilizer_plan_override || null,
      herbicide_cost_override: plan.herbicide_cost_override || null,
      notes: plan.notes,
      updated_at: new Date().toISOString()
    }).eq('id', plan.id);
    if (error) throw error;
    return plan;
  } else {
    const { data, error } = await db.from('be_field_crop_plans').insert([{
      field_crop_year_id: plan.field_crop_year_id,
      seed_variety: plan.seed_variety,
      seed_brand: plan.seed_brand,
      seeding_rate: plan.seeding_rate,
      fertilizer_plan_id: plan.fertilizer_plan_id || null,
      fertilizer_plan_override: plan.fertilizer_plan_override || null,
      herbicide_cost_override: plan.herbicide_cost_override || null,
      notes: plan.notes
    }]).select().single();
    if (error) throw error;
    return data;
  }
}

async function deleteFieldCropPlan(id) {
  const { error } = await db.from('be_field_crop_plans').update({ deleted_at: new Date().toISOString() }).eq('id', id);
  if (error) throw error;
}

// Herbicide Passes for a field crop plan
async function saveHerbicidePasses(fieldCropPlanId, passes) {
  // Delete existing passes
  await db.from('be_field_herbicide_passes').delete().eq('field_crop_plan_id', fieldCropPlanId);
  // Insert new passes
  if (passes.length > 0) {
    const { error } = await db.from('be_field_herbicide_passes').insert(
      passes.map((p, i) => ({
        field_crop_plan_id: fieldCropPlanId,
        herbicide_plan_id: p.herbicide_plan_id,
        pass_name: p.pass_name,
        planned_date: p.planned_date || null,
        sort_order: i
      }))
    );
    if (error) throw error;
  }
}

// Get Spray-Suite tank mixes (for linking herbicide plans)
async function getTankMixes() {
  const { data, error } = await db.from('tank_mixes').select('id, name, commodities(name)').eq('active', true).order('name');
  return error ? [] : (data || []).map(t => ({ ...t, commodity_name: t.commodities?.name }));
}

// ============================================================================
// CALCULATION HELPERS
// ============================================================================

function allocateOverhead(expenses, fieldCropYears) {
  const allocations = {};
  fieldCropYears.forEach(fcy => { allocations[fcy.id] = 0; });

  expenses.forEach(expense => {
    if (expense.allocation_type === 'ALL_ACRES') {
      const totalAcres = fieldCropYears.reduce((sum, f) => sum + (f.planted_acres || 0), 0);
      if (totalAcres > 0) {
        fieldCropYears.forEach(fcy => {
          allocations[fcy.id] += (expense.amount * (fcy.planted_acres || 0)) / totalAcres;
        });
      }
    } else {
      const allocs = expense.be_overhead_allocations || [];
      const eligibleFields = fieldCropYears.filter(fcy =>
        allocs.some(a => a.commodity_id === fcy.commodity_id &&
          (a.practice_type === null ||
           (a.practice_type === 'IR' && fcy.is_irrigated) ||
           (a.practice_type === 'DL' && !fcy.is_irrigated)))
      );
      const totalAcres = eligibleFields.reduce((sum, f) => sum + (f.planted_acres || 0), 0);
      if (totalAcres > 0) {
        eligibleFields.forEach(fcy => {
          allocations[fcy.id] += (expense.amount * (fcy.planted_acres || 0)) / totalAcres;
        });
      }
    }
  });

  return allocations;
}

function calculateSeedCost(seed) {
  if (!seed.price_per_bag || !seed.seeds_per_bag || !seed.seeding_rate || !seed.planted_acres) return 0;
  const totalSeeds = seed.seeding_rate * seed.planted_acres;
  const bagsNeeded = totalSeeds / seed.seeds_per_bag;
  return bagsNeeded * seed.price_per_bag;
}

// ============================================================================
// NAVIGATION
// ============================================================================
const navItems = [
  { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
  { id: 'overhead', label: 'Overhead', icon: 'building' },
  { id: 'inputs', label: 'Inputs', icon: 'package' },
  { id: 'crop-plans', label: 'Crop Plans', icon: 'layers' },
  { id: 'field-assignments', label: 'Field Assignments', icon: 'map-pin' },
  { id: 'breakeven', label: 'Breakeven', icon: 'target' },
  { id: 'landlord-report', label: 'Landlord Report', icon: 'users' },
  { id: 'settings', label: 'Settings', icon: 'settings' }
];

const appLinks = [
  { name: 'GrainTrack', url: 'https://baldwinag.com/portal/graintrack', icon: 'wheat', desc: 'Marketing & Inventory' },
  { name: 'Spray-Suite', url: 'https://baldwinag.com/spray/manager', icon: 'spray-can', desc: 'Chemical Applications' },
  { name: 'Fertilizer', url: 'https://baldwinag.com/portal/fertilizer', icon: 'flask-conical', desc: 'Fertilizer Applications' }
];

// ============================================================================
// DASHBOARD PAGE
// ============================================================================
function DashboardPage({ cropYear, onYearChange }) {
  const [data, setData] = useState({
    commodities: [],
    totalCost: 0,
    totalAcres: 0,
    breakdown: { overhead: 0, seed: 0, rent: 0, fertilizer: 0, herbicide: 0 }
  });
  const [loading, setLoading] = useState(true);
  const currentYear = new Date().getFullYear();
  const cropYears = [currentYear - 1, currentYear, currentYear + 1];

  useEffect(() => {
    async function load() {
      setLoading(true);
      const [fcys, expenses, seeds, rents, fertCosts, herbCosts, commodities] = await Promise.all([
        getFieldCropYears(cropYear),
        getOverheadExpenses(cropYear),
        getSeedCosts(cropYear),
        getLandRent(cropYear),
        getFertilizerCosts(cropYear),
        getHerbicideCosts(cropYear),
        getCommodities()
      ]);

      const overheadAlloc = allocateOverhead(expenses, fcys);
      const seedMap = {};
      seeds.forEach(s => { seedMap[s.field_crop_year_id] = s.total_cost || calculateSeedCost({ ...s, planted_acres: s.planted_acres }); });
      const rentMap = {};
      rents.forEach(r => { rentMap[r.field_id] = r.rent_per_acre || 0; });

      let totalCost = 0;
      let totalAcres = 0;
      const breakdown = { overhead: 0, seed: 0, rent: 0, fertilizer: 0, herbicide: 0 };
      const byCommodity = {};

      fcys.forEach(fcy => {
        const overhead = overheadAlloc[fcy.id] || 0;
        const seed = seedMap[fcy.id] || 0;
        const rentPerAcre = rentMap[fcy.field_id] || 0;
        const rent = rentPerAcre * (fcy.planted_acres || 0);
        const fert = fertCosts[fcy.field_id] || 0;
        const herbData = herbCosts[fcy.field_id] || { total: 0 };
        const herb = typeof herbData === 'object' ? herbData.total : herbData;
        const fieldTotal = overhead + seed + rent + fert + herb;
        const bushels = fcy.actual_production || ((fcy.planted_acres || 0) * (fcy.estimated_yield || 0));

        totalCost += fieldTotal;
        totalAcres += fcy.planted_acres || 0;
        breakdown.overhead += overhead;
        breakdown.seed += seed;
        breakdown.rent += rent;
        breakdown.fertilizer += fert;
        breakdown.herbicide += herb;

        if (!byCommodity[fcy.commodity_id]) {
          byCommodity[fcy.commodity_id] = {
            name: fcy.commodity_name,
            cost: 0,
            acres: 0,
            bushels: 0,
            overhead: 0,
            seed: 0,
            rent: 0,
            fertilizer: 0,
            herbicide: 0
          };
        }
        byCommodity[fcy.commodity_id].cost += fieldTotal;
        byCommodity[fcy.commodity_id].acres += fcy.planted_acres || 0;
        byCommodity[fcy.commodity_id].bushels += bushels;
        byCommodity[fcy.commodity_id].overhead += overhead;
        byCommodity[fcy.commodity_id].seed += seed;
        byCommodity[fcy.commodity_id].rent += rent;
        byCommodity[fcy.commodity_id].fertilizer += fert;
        byCommodity[fcy.commodity_id].herbicide += herb;
      });

      const commoditySummary = Object.values(byCommodity).map(c => ({
        ...c,
        breakeven: c.bushels > 0 ? c.cost / c.bushels : null,
        costPerAcre: c.acres > 0 ? c.cost / c.acres : 0
      }));

      setData({ commodities: commoditySummary, totalCost, totalAcres, breakdown });
      setLoading(false);
    }
    load();
  }, [cropYear]);

  const commodityColors = {
    'Corn': { bg: 'bg-amber-500', light: 'bg-amber-100', text: 'text-amber-700', border: 'border-amber-200' },
    'Soybeans': { bg: 'bg-emerald-500', light: 'bg-emerald-100', text: 'text-emerald-700', border: 'border-emerald-200' },
    'Wheat': { bg: 'bg-violet-500', light: 'bg-violet-100', text: 'text-violet-700', border: 'border-violet-200' },
    'Milo': { bg: 'bg-red-500', light: 'bg-red-100', text: 'text-red-700', border: 'border-red-200' }
  };
  const defaultColor = { bg: 'bg-gray-500', light: 'bg-gray-100', text: 'text-gray-700', border: 'border-gray-200' };

  const categoryColors = {
    overhead: { bg: 'bg-slate-500', label: 'Overhead' },
    seed: { bg: 'bg-amber-500', label: 'Seed' },
    rent: { bg: 'bg-green-500', label: 'Rent' },
    fertilizer: { bg: 'bg-blue-500', label: 'Fertilizer' },
    herbicide: { bg: 'bg-purple-500', label: 'Herbicide' }
  };

  if (loading) return <div className="flex items-center justify-center h-64"><Icon name="loader" className="animate-spin text-blue-600" size={32} /></div>;

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Breakeven Dashboard</h1>
          <p className="text-sm text-gray-500">Cost summary and breakeven prices for {cropYear}</p>
        </div>
        <select value={cropYear} onChange={(e) => onYearChange(parseInt(e.target.value))} className="px-4 py-2 border rounded-lg">
          {cropYears.map(y => <option key={y} value={y}>{y} Crop Year</option>)}
        </select>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
          <div className="flex items-center gap-3 mb-2">
            <Icon name="dollar-sign" size={24} />
            <span className="text-blue-100">Total Cost</span>
          </div>
          <div className="text-3xl font-bold">{formatCurrency(data.totalCost)}</div>
          <div className="text-sm text-blue-100 mt-1">{formatNumber(data.totalAcres)} acres</div>
        </div>
        <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
          <div className="flex items-center gap-3 mb-2">
            <Icon name="map" size={24} />
            <span className="text-green-100">Avg Cost/Acre</span>
          </div>
          <div className="text-3xl font-bold">{data.totalAcres > 0 ? formatCurrency(data.totalCost / data.totalAcres) : '-'}</div>
        </div>
        <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
          <div className="flex items-center gap-3 mb-2">
            <Icon name="bar-chart-3" size={24} />
            <span className="text-purple-100">Commodities</span>
          </div>
          <div className="text-3xl font-bold">{data.commodities.length}</div>
          <div className="text-sm text-purple-100 mt-1">{data.commodities.map(c => c.name).join(', ')}</div>
        </div>
      </div>

      {/* Cost Breakdown */}
      <div className="bg-white rounded-xl shadow-sm border p-6">
        <h2 className="font-semibold text-lg mb-4">Cost Breakdown</h2>

        {/* Visual Bar Chart */}
        <div className="mb-6">
          <div className="h-8 rounded-full overflow-hidden flex bg-gray-100">
            {Object.entries(categoryColors).map(([key, config]) => {
              const value = data.breakdown[key] || 0;
              const percent = data.totalCost > 0 ? (value / data.totalCost) * 100 : 0;
              if (percent < 0.5) return null;
              return (
                <div
                  key={key}
                  className={`${config.bg} transition-all duration-500 flex items-center justify-center`}
                  style={{ width: `${percent}%` }}
                  title={`${config.label}: ${formatCurrency(value)} (${percent.toFixed(1)}%)`}
                >
                  {percent > 8 && <span className="text-white text-xs font-medium">{percent.toFixed(0)}%</span>}
                </div>
              );
            })}
          </div>
          <div className="flex flex-wrap gap-4 mt-3 justify-center">
            {Object.entries(categoryColors).map(([key, config]) => (
              <div key={key} className="flex items-center gap-2 text-sm">
                <div className={`w-3 h-3 rounded-full ${config.bg}`}></div>
                <span className="text-gray-600">{config.label}</span>
              </div>
            ))}
          </div>
        </div>

        {/* Breakdown Table */}
        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
          {Object.entries(categoryColors).map(([key, config]) => {
            const value = data.breakdown[key] || 0;
            const percent = data.totalCost > 0 ? (value / data.totalCost) * 100 : 0;
            return (
              <div key={key} className="text-center p-3 rounded-lg bg-gray-50">
                <div className={`w-10 h-10 rounded-full ${config.bg} mx-auto mb-2 flex items-center justify-center`}>
                  <Icon name={key === 'overhead' ? 'building' : key === 'seed' ? 'sprout' : key === 'rent' ? 'home' : key === 'fertilizer' ? 'flask-conical' : 'spray-can'} size={18} className="text-white" />
                </div>
                <div className="text-xs text-gray-500 uppercase tracking-wide">{config.label}</div>
                <div className="font-bold text-lg">{formatCurrency(value)}</div>
                <div className="text-xs text-gray-400">{percent.toFixed(1)}%</div>
              </div>
            );
          })}
        </div>
      </div>

      {/* Commodity Breakeven Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {data.commodities.map(c => {
          const colors = commodityColors[c.name] || defaultColor;
          return (
            <div key={c.name} className="bg-white rounded-xl shadow-sm border overflow-hidden">
              <div className={`${colors.bg} px-6 py-4`}>
                <h3 className="text-xl font-bold text-white">{c.name}</h3>
                <div className="text-white/80 text-sm">{formatNumber(c.acres)} acres â€¢ {formatNumber(c.bushels)} bu</div>
              </div>
              <div className="p-6">
                <div className="flex items-baseline gap-2 mb-4">
                  <span className="text-3xl font-bold text-gray-900">{c.breakeven ? formatPrice(c.breakeven) : '-'}</span>
                  <span className="text-gray-500">breakeven</span>
                </div>
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between py-1 border-b">
                    <span className="text-gray-500">Total Cost</span>
                    <span className="font-semibold">{formatCurrency(c.cost)}</span>
                  </div>
                  <div className="flex justify-between py-1 border-b">
                    <span className="text-gray-500">Cost/Acre</span>
                    <span className="font-semibold">{formatCurrency(c.costPerAcre)}</span>
                  </div>
                  <div className="flex justify-between py-1">
                    <span className="text-gray-500">Bushels</span>
                    <span className="font-semibold">{formatNumber(c.bushels)}</span>
                  </div>
                </div>

                {/* Mini breakdown */}
                <div className="mt-4 pt-4 border-t">
                  <div className="text-xs text-gray-500 uppercase tracking-wide mb-2">Cost Breakdown</div>
                  <div className="h-2 rounded-full overflow-hidden flex bg-gray-100">
                    {c.overhead > 0 && <div className="bg-slate-500" style={{ width: `${(c.overhead / c.cost) * 100}%` }}></div>}
                    {c.seed > 0 && <div className="bg-amber-500" style={{ width: `${(c.seed / c.cost) * 100}%` }}></div>}
                    {c.rent > 0 && <div className="bg-green-500" style={{ width: `${(c.rent / c.cost) * 100}%` }}></div>}
                    {c.fertilizer > 0 && <div className="bg-blue-500" style={{ width: `${(c.fertilizer / c.cost) * 100}%` }}></div>}
                    {c.herbicide > 0 && <div className="bg-purple-500" style={{ width: `${(c.herbicide / c.cost) * 100}%` }}></div>}
                  </div>
                  <div className="grid grid-cols-5 gap-1 mt-2 text-xs text-center text-gray-400">
                    <span>{((c.overhead / c.cost) * 100).toFixed(0)}%</span>
                    <span>{((c.seed / c.cost) * 100).toFixed(0)}%</span>
                    <span>{((c.rent / c.cost) * 100).toFixed(0)}%</span>
                    <span>{((c.fertilizer / c.cost) * 100).toFixed(0)}%</span>
                    <span>{((c.herbicide / c.cost) * 100).toFixed(0)}%</span>
                  </div>
                </div>
              </div>
            </div>
          );
        })}
      </div>

      {data.commodities.length === 0 && (
        <div className="bg-white rounded-xl shadow-sm border p-8 text-center">
          <Icon name="alert-circle" size={48} className="mx-auto text-gray-300 mb-4" />
          <h3 className="text-lg font-semibold text-gray-900 mb-2">No Production Data</h3>
          <p className="text-gray-500">Add production records in GrainTrack to see breakeven calculations here.</p>
          <a href="graintrack.html" className="inline-flex items-center gap-2 mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            <Icon name="external-link" size={16} /> Open GrainTrack
          </a>
        </div>
      )}
    </div>
  );
}

// ============================================================================
// OVERHEAD PAGE
// ============================================================================
function OverheadPage({ cropYear, onYearChange }) {
  const [expenses, setExpenses] = useState([]);
  const [categories, setCategories] = useState([]);
  const [commodities, setCommodities] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showCopyModal, setShowCopyModal] = useState(false);
  const [editingItem, setEditingItem] = useState(null);
  const [deleteConfirm, setDeleteConfirm] = useState(null);
  const [activeCategory, setActiveCategory] = useState(null);
  const { addToast } = useToast();
  const currentYear = new Date().getFullYear();
  const cropYears = [currentYear - 1, currentYear, currentYear + 1];

  const loadData = async () => {
    setLoading(true);
    const [exp, cats, coms] = await Promise.all([getOverheadExpenses(cropYear), getOverheadCategories(), getCommodities()]);
    setExpenses(exp);
    setCategories(cats);
    setCommodities(coms);
    if (!activeCategory && cats.length > 0) setActiveCategory(cats[0].id);
    setLoading(false);
  };

  useEffect(() => { loadData(); }, [cropYear]);

  const handleDelete = async () => {
    try {
      await deleteOverheadExpense(deleteConfirm.id);
      addToast('Expense deleted', { type: 'success' });
      setDeleteConfirm(null);
      loadData();
    } catch (e) {
      addToast('Failed to delete: ' + e.message, { type: 'error' });
    }
  };

  const handleCopyFromYear = async (sourceYear) => {
    try {
      const sourceExpenses = await getOverheadExpenses(sourceYear);
      if (sourceExpenses.length === 0) {
        addToast(`No expenses found in ${sourceYear}`, { type: 'error' });
        return;
      }

      let copied = 0;
      for (const exp of sourceExpenses) {
        const allocations = exp.be_overhead_allocations?.map(a => ({
          commodity_id: a.commodity_id,
          practice_type: a.practice_type
        })) || [];

        await saveOverheadExpense({
          name: exp.name,
          category_id: exp.category_id,
          amount: exp.amount,
          allocation_type: exp.allocation_type,
          notes: exp.notes,
          crop_year: cropYear
        }, allocations);
        copied++;
      }

      addToast(`Copied ${copied} expenses from ${sourceYear}`, { type: 'success' });
      setShowCopyModal(false);
      loadData();
    } catch (e) {
      addToast('Failed to copy: ' + e.message, { type: 'error' });
    }
  };

  const filteredExpenses = activeCategory ? expenses.filter(e => e.category_id === activeCategory) : expenses;
  const categoryTotal = filteredExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
  const grandTotal = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Overhead Expenses</h1>
          <p className="text-sm text-gray-500">Farm-level costs allocated to crops</p>
        </div>
        <div className="flex gap-3">
          <select value={cropYear} onChange={(e) => onYearChange(parseInt(e.target.value))} className="px-4 py-2 border rounded-lg">
            {cropYears.map(y => <option key={y} value={y}>{y}</option>)}
          </select>
          <button onClick={() => setShowCopyModal(true)} className="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200" title="Copy from another year">
            <Icon name="copy" size={18} /> Copy Year
          </button>
          <button onClick={() => { setEditingItem(null); setShowModal(true); }} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            <Icon name="plus" size={18} /> Add Expense
          </button>
        </div>
      </div>

      <div className="bg-white rounded-xl shadow-sm border p-4">
        <div className="text-sm text-gray-500 mb-1">Total Overhead ({cropYear})</div>
        <div className="text-2xl font-bold text-gray-900">{formatCurrency(grandTotal)}</div>
      </div>

      <div className="flex gap-2 flex-wrap">
        {categories.map(cat => (
          <button key={cat.id} onClick={() => setActiveCategory(cat.id)}
            className={`px-4 py-2 rounded-lg font-medium ${activeCategory === cat.id ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
            {cat.name}
          </button>
        ))}
      </div>

      <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
        {loading ? (
          <div className="p-8 text-center"><Icon name="loader" className="animate-spin text-blue-600 mx-auto" size={32} /></div>
        ) : (
          <>
            <table className="w-full text-sm">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left">Expense</th>
                  <th className="px-4 py-3 text-right">Amount</th>
                  <th className="px-4 py-3 text-left">Allocation</th>
                  <th className="px-4 py-3 text-center">Actions</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {filteredExpenses.length === 0 ? (
                  <tr><td colSpan={4} className="px-4 py-8 text-center text-gray-500">No expenses in this category</td></tr>
                ) : filteredExpenses.map(exp => (
                  <tr key={exp.id} className="hover:bg-gray-50">
                    <td className="px-4 py-3">
                      <div className="font-medium">{exp.name}</div>
                      {exp.notes && <div className="text-xs text-gray-500">{exp.notes}</div>}
                    </td>
                    <td className="px-4 py-3 text-right font-medium">{formatCurrency(exp.amount)}</td>
                    <td className="px-4 py-3">
                      {exp.allocation_type === 'ALL_ACRES' ? (
                        <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs font-medium">
                          <Icon name="check-circle" size={12} /> All Acres
                        </span>
                      ) : (
                        <div className="flex flex-wrap gap-1">
                          {(exp.be_overhead_allocations || []).map((a, i) => {
                            const practice = a.practice_type === 'IR' ? ' (IR)' : a.practice_type === 'DL' ? ' (DL)' : '';
                            return (
                              <span key={i} className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">
                                {a.commodities?.name}{practice}
                              </span>
                            );
                          })}
                        </div>
                      )}
                    </td>
                    <td className="px-4 py-3 text-center">
                      <button onClick={() => { setEditingItem(exp); setShowModal(true); }} className="p-1 hover:bg-gray-100 rounded"><Icon name="pencil" size={16} /></button>
                      <button onClick={() => setDeleteConfirm(exp)} className="p-1 hover:bg-red-100 rounded text-red-600"><Icon name="trash-2" size={16} /></button>
                    </td>
                  </tr>
                ))}
              </tbody>
              <tfoot className="bg-gray-50">
                <tr>
                  <td className="px-4 py-3 font-semibold">Category Total</td>
                  <td className="px-4 py-3 text-right font-bold">{formatCurrency(categoryTotal)}</td>
                  <td colSpan={2}></td>
                </tr>
              </tfoot>
            </table>
          </>
        )}
      </div>

      {showModal && <OverheadModal expense={editingItem} cropYear={cropYear} categories={categories} commodities={commodities} onClose={() => setShowModal(false)} onSave={() => { setShowModal(false); loadData(); }} />}
      {showCopyModal && (
        <Modal isOpen={true} onClose={() => setShowCopyModal(false)} title="Copy Overhead from Another Year">
          <div className="space-y-4">
            <p className="text-gray-600">Select a year to copy all overhead expenses from. This will add copies to {cropYear}.</p>
            {expenses.length > 0 && (
              <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-800">
                <Icon name="alert-triangle" size={16} className="inline mr-2" />
                Warning: {cropYear} already has {expenses.length} expense(s). Copying will add more, not replace.
              </div>
            )}
            <div className="grid grid-cols-3 gap-3">
              {cropYears.filter(y => y !== cropYear).map(year => (
                <button
                  key={year}
                  onClick={() => handleCopyFromYear(year)}
                  className="p-4 border-2 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-all"
                >
                  <div className="text-2xl font-bold text-gray-900">{year}</div>
                  <div className="text-sm text-gray-500">Copy from</div>
                </button>
              ))}
            </div>
            <div className="flex justify-end pt-4 border-t">
              <button onClick={() => setShowCopyModal(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
            </div>
          </div>
        </Modal>
      )}
      <ConfirmModal isOpen={!!deleteConfirm} title="Delete Expense" message="Are you sure?" onConfirm={handleDelete} onCancel={() => setDeleteConfirm(null)} />
    </div>
  );
}

function OverheadModal({ expense, cropYear, categories, commodities, onClose, onSave }) {
  const [form, setForm] = useState({ name: '', category_id: categories[0]?.id || '', amount: '', allocation_type: 'ALL_ACRES', notes: '', crop_year: cropYear });
  const [allocations, setAllocations] = useState([]);
  const [saving, setSaving] = useState(false);
  const { addToast } = useToast();

  const practiceTypes = [
    { id: null, label: 'All Practices', desc: 'Both irrigated and dryland' },
    { id: 'IR', label: 'Irrigated Only', desc: 'Only irrigated fields' },
    { id: 'DL', label: 'Dryland Only', desc: 'Only dryland fields' }
  ];

  useEffect(() => {
    if (expense) {
      setForm({ ...expense });
      setAllocations(expense.be_overhead_allocations?.map(a => ({ commodity_id: a.commodity_id, practice_type: a.practice_type })) || []);
    }
  }, [expense]);

  const isCommoditySelected = (commodityId) => allocations.some(a => a.commodity_id === commodityId);

  const toggleCommodity = (commodityId) => {
    if (isCommoditySelected(commodityId)) {
      setAllocations(prev => prev.filter(a => a.commodity_id !== commodityId));
    } else {
      setAllocations(prev => [...prev, { commodity_id: commodityId, practice_type: null }]);
    }
  };

  const setPracticeForCommodity = (commodityId, practiceType) => {
    setAllocations(prev => prev.map(a =>
      a.commodity_id === commodityId ? { ...a, practice_type: practiceType } : a
    ));
  };

  const getAllocationForCommodity = (commodityId) => {
    return allocations.find(a => a.commodity_id === commodityId);
  };

  const handleSave = async () => {
    if (!form.name || !form.amount) {
      addToast('Please fill required fields', { type: 'error' });
      return;
    }
    if (form.allocation_type === 'SPECIFIC_CROPS' && allocations.length === 0) {
      addToast('Please select at least one commodity', { type: 'error' });
      return;
    }
    setSaving(true);
    try {
      await saveOverheadExpense({ ...form, amount: parseFloat(form.amount), id: expense?.id }, form.allocation_type === 'SPECIFIC_CROPS' ? allocations : []);
      addToast('Expense saved', { type: 'success' });
      onSave();
    } catch (e) {
      addToast('Failed to save: ' + e.message, { type: 'error' });
    }
    setSaving(false);
  };

  return (
    <Modal isOpen={true} onClose={onClose} title={expense ? 'Edit Expense' : 'Add Expense'}>
      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-1">Expense Name *</label>
          <input type="text" value={form.name} onChange={(e) => setForm(f => ({ ...f, name: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" placeholder="e.g., Planter Payment" />
        </div>
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">Category</label>
            <select value={form.category_id} onChange={(e) => setForm(f => ({ ...f, category_id: e.target.value }))} className="w-full px-3 py-2 border rounded-lg">
              {categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Amount *</label>
            <input type="number" step="0.01" value={form.amount} onChange={(e) => setForm(f => ({ ...f, amount: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" />
          </div>
        </div>
        <div>
          <label className="block text-sm font-medium mb-1">Allocation Method</label>
          <div className="grid grid-cols-2 gap-2">
            <button
              type="button"
              onClick={() => setForm(f => ({ ...f, allocation_type: 'ALL_ACRES' }))}
              className={`p-3 rounded-lg border-2 text-left transition-all ${form.allocation_type === 'ALL_ACRES' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
            >
              <div className="font-medium">All Acres</div>
              <div className="text-xs text-gray-500">Spread evenly across all fields</div>
            </button>
            <button
              type="button"
              onClick={() => setForm(f => ({ ...f, allocation_type: 'SPECIFIC_CROPS' }))}
              className={`p-3 rounded-lg border-2 text-left transition-all ${form.allocation_type === 'SPECIFIC_CROPS' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
            >
              <div className="font-medium">Specific Crops</div>
              <div className="text-xs text-gray-500">Only certain commodities/practices</div>
            </button>
          </div>
        </div>
        {form.allocation_type === 'SPECIFIC_CROPS' && (
          <div className="border rounded-lg p-4 bg-gray-50 space-y-3">
            <div className="text-sm font-medium text-gray-700">Select Crops & Practices</div>
            <p className="text-xs text-gray-500">Click a crop to include it, then choose which practice types to include.</p>
            <div className="space-y-2">
              {commodities.map(c => {
                const isSelected = isCommoditySelected(c.id);
                const alloc = getAllocationForCommodity(c.id);
                return (
                  <div key={c.id} className={`rounded-lg border-2 transition-all ${isSelected ? 'border-blue-400 bg-white' : 'border-gray-200 bg-white'}`}>
                    <button
                      type="button"
                      onClick={() => toggleCommodity(c.id)}
                      className="w-full p-3 flex items-center justify-between"
                    >
                      <div className="flex items-center gap-3">
                        <div className={`w-5 h-5 rounded border-2 flex items-center justify-center ${isSelected ? 'bg-blue-500 border-blue-500' : 'border-gray-300'}`}>
                          {isSelected && <Icon name="check" size={14} className="text-white" />}
                        </div>
                        <span className={`font-medium ${isSelected ? 'text-blue-700' : 'text-gray-600'}`}>{c.name}</span>
                      </div>
                      {isSelected && (
                        <span className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded">
                          {alloc?.practice_type === 'IR' ? 'Irrigated' : alloc?.practice_type === 'DL' ? 'Dryland' : 'All'}
                        </span>
                      )}
                    </button>
                    {isSelected && (
                      <div className="px-3 pb-3 flex gap-2">
                        {practiceTypes.map(pt => (
                          <button
                            key={pt.id || 'all'}
                            type="button"
                            onClick={() => setPracticeForCommodity(c.id, pt.id)}
                            className={`px-3 py-1.5 rounded text-xs font-medium transition-all ${alloc?.practice_type === pt.id ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                          >
                            {pt.label}
                          </button>
                        ))}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
            {allocations.length > 0 && (
              <div className="mt-3 pt-3 border-t text-xs text-gray-500">
                <strong>Summary:</strong> {allocations.map(a => {
                  const com = commodities.find(c => c.id === a.commodity_id);
                  const practice = a.practice_type === 'IR' ? ' (IR)' : a.practice_type === 'DL' ? ' (DL)' : '';
                  return com?.name + practice;
                }).join(', ')}
              </div>
            )}
          </div>
        )}
        <div>
          <label className="block text-sm font-medium mb-1">Notes</label>
          <textarea value={form.notes || ''} onChange={(e) => setForm(f => ({ ...f, notes: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" rows={2} placeholder="Optional notes about this expense..." />
        </div>
        <div className="flex justify-end gap-3 pt-4 border-t">
          <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
          <button onClick={handleSave} disabled={saving} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">{saving ? 'Saving...' : 'Save'}</button>
        </div>
      </div>
    </Modal>
  );
}

// ============================================================================
// INPUTS PAGE (Seed & Land Rent)
// ============================================================================
function InputsPage({ cropYear, onYearChange }) {
  const [activeTab, setActiveTab] = useState('seed');
  const [seeds, setSeeds] = useState([]);
  const [rents, setRents] = useState([]);
  const [fieldCropYears, setFieldCropYears] = useState([]);
  const [fields, setFields] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showSeedModal, setShowSeedModal] = useState(false);
  const [showRentModal, setShowRentModal] = useState(false);
  const [showCopyRentModal, setShowCopyRentModal] = useState(false);
  const [editingSeed, setEditingSeed] = useState(null);
  const [editingRent, setEditingRent] = useState(null);
  const [deleteConfirm, setDeleteConfirm] = useState(null);
  const { addToast } = useToast();
  const currentYear = new Date().getFullYear();
  const cropYears = [currentYear - 1, currentYear, currentYear + 1];

  const loadData = async () => {
    setLoading(true);
    const [s, r, fcy, f] = await Promise.all([getSeedCosts(cropYear), getLandRent(cropYear), getFieldCropYears(cropYear), getFields()]);
    setSeeds(s);
    setRents(r);
    setFieldCropYears(fcy);
    setFields(f);
    setLoading(false);
  };

  useEffect(() => { loadData(); }, [cropYear]);

  const handleDeleteSeed = async () => {
    try {
      await deleteSeedCost(deleteConfirm.id);
      addToast('Seed cost deleted', { type: 'success' });
      setDeleteConfirm(null);
      loadData();
    } catch (e) {
      addToast('Failed to delete: ' + e.message, { type: 'error' });
    }
  };

  const handleDeleteRent = async () => {
    try {
      await deleteLandRent(deleteConfirm.id);
      addToast('Rent deleted', { type: 'success' });
      setDeleteConfirm(null);
      loadData();
    } catch (e) {
      addToast('Failed to delete: ' + e.message, { type: 'error' });
    }
  };

  const handleCopyRentFromYear = async (sourceYear) => {
    try {
      const sourceRents = await getLandRent(sourceYear);
      if (sourceRents.length === 0) {
        addToast(`No rent entries found in ${sourceYear}`, { type: 'error' });
        return;
      }

      let copied = 0;
      for (const rent of sourceRents) {
        await saveLandRent({
          field_id: rent.field_id,
          crop_year: cropYear,
          rent_type: rent.rent_type,
          rent_per_acre: rent.rent_per_acre,
          notes: rent.notes
        });
        copied++;
      }

      addToast(`Copied ${copied} rent entries from ${sourceYear}`, { type: 'success' });
      setShowCopyRentModal(false);
      loadData();
    } catch (e) {
      addToast('Failed to copy: ' + e.message, { type: 'error' });
    }
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Input Costs</h1>
          <p className="text-sm text-gray-500">Seed and land rent per field</p>
        </div>
        <div className="flex gap-3">
          <select value={cropYear} onChange={(e) => onYearChange(parseInt(e.target.value))} className="px-4 py-2 border rounded-lg">
            {cropYears.map(y => <option key={y} value={y}>{y}</option>)}
          </select>
        </div>
      </div>

      <div className="flex gap-2 border-b">
        <button onClick={() => setActiveTab('seed')} className={`px-4 py-2 font-medium ${activeTab === 'seed' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>Seed Costs</button>
        <button onClick={() => setActiveTab('rent')} className={`px-4 py-2 font-medium ${activeTab === 'rent' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>Land Rent</button>
      </div>

      {activeTab === 'seed' && (
        <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
          <div className="p-4 border-b flex items-center justify-between">
            <h2 className="font-semibold">Seed Costs</h2>
            <button onClick={() => { setEditingSeed(null); setShowSeedModal(true); }} className="flex items-center gap-2 px-3 py-1.5 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">
              <Icon name="plus" size={16} /> Add Seed Cost
            </button>
          </div>
          {loading ? (
            <div className="p-8 text-center"><Icon name="loader" className="animate-spin text-blue-600 mx-auto" size={32} /></div>
          ) : (
            <table className="w-full text-sm">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left">Field</th>
                  <th className="px-4 py-3 text-left">Variety</th>
                  <th className="px-4 py-3 text-right">Acres</th>
                  <th className="px-4 py-3 text-right">Rate</th>
                  <th className="px-4 py-3 text-right">Bags</th>
                  <th className="px-4 py-3 text-right">$/Bag</th>
                  <th className="px-4 py-3 text-right">$/Acre</th>
                  <th className="px-4 py-3 text-right font-semibold">Total</th>
                  <th className="px-4 py-3 text-center">Actions</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {seeds.length === 0 ? (
                  <tr><td colSpan={9} className="px-4 py-8 text-center text-gray-500">No seed costs entered</td></tr>
                ) : seeds.map(s => {
                  const totalCost = s.total_cost || calculateSeedCost({ ...s, planted_acres: s.planted_acres });
                  const bagsNeeded = s.seeding_rate && s.seeds_per_bag && s.planted_acres
                    ? (s.seeding_rate * s.planted_acres) / s.seeds_per_bag : 0;
                  const costPerAcre = totalCost && s.planted_acres ? totalCost / s.planted_acres : 0;
                  return (
                    <tr key={s.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3">
                        <div className="font-medium">{s.field_name}</div>
                        <div className="text-xs text-gray-500">{s.commodity_name}</div>
                      </td>
                      <td className="px-4 py-3">
                        <div>{s.variety || '-'}</div>
                        {s.brand && <div className="text-xs text-gray-500">{s.brand}</div>}
                      </td>
                      <td className="px-4 py-3 text-right">{formatNumber(s.planted_acres)}</td>
                      <td className="px-4 py-3 text-right text-gray-600">{formatNumber(s.seeding_rate)}/ac</td>
                      <td className="px-4 py-3 text-right text-gray-600">{bagsNeeded.toFixed(1)}</td>
                      <td className="px-4 py-3 text-right text-gray-600">{formatCurrency(s.price_per_bag)}</td>
                      <td className="px-4 py-3 text-right text-gray-600">{formatCurrency(costPerAcre)}</td>
                      <td className="px-4 py-3 text-right font-semibold">{formatCurrency(totalCost)}</td>
                      <td className="px-4 py-3 text-center">
                        <button onClick={() => { setEditingSeed(s); setShowSeedModal(true); }} className="p-1 hover:bg-gray-100 rounded"><Icon name="pencil" size={16} /></button>
                        <button onClick={() => setDeleteConfirm({ ...s, type: 'seed' })} className="p-1 hover:bg-red-100 rounded text-red-600"><Icon name="trash-2" size={16} /></button>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
              {seeds.length > 0 && (
                <tfoot className="bg-gray-100">
                  <tr className="font-semibold">
                    <td className="px-4 py-3">TOTAL</td>
                    <td></td>
                    <td className="px-4 py-3 text-right">{formatNumber(seeds.reduce((s, seed) => s + (seed.planted_acres || 0), 0))}</td>
                    <td></td>
                    <td className="px-4 py-3 text-right">{seeds.reduce((s, seed) => s + ((seed.seeding_rate && seed.seeds_per_bag && seed.planted_acres) ? (seed.seeding_rate * seed.planted_acres) / seed.seeds_per_bag : 0), 0).toFixed(1)}</td>
                    <td></td>
                    <td></td>
                    <td className="px-4 py-3 text-right">{formatCurrency(seeds.reduce((s, seed) => s + (seed.total_cost || calculateSeedCost({ ...seed, planted_acres: seed.planted_acres })), 0))}</td>
                    <td></td>
                  </tr>
                </tfoot>
              )}
            </table>
          )}
        </div>
      )}

      {activeTab === 'rent' && (
        <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
          <div className="p-4 border-b flex items-center justify-between">
            <h2 className="font-semibold">Land Rent</h2>
            <div className="flex gap-2">
              <button onClick={() => setShowCopyRentModal(true)} className="flex items-center gap-2 px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200">
                <Icon name="copy" size={16} /> Copy Year
              </button>
              <button onClick={() => { setEditingRent(null); setShowRentModal(true); }} className="flex items-center gap-2 px-3 py-1.5 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">
                <Icon name="plus" size={16} /> Add Rent
              </button>
            </div>
          </div>
          {loading ? (
            <div className="p-8 text-center"><Icon name="loader" className="animate-spin text-blue-600 mx-auto" size={32} /></div>
          ) : (
            <table className="w-full text-sm">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left">Field</th>
                  <th className="px-4 py-3 text-left">Type</th>
                  <th className="px-4 py-3 text-right">Rent/Acre</th>
                  <th className="px-4 py-3 text-right">Total</th>
                  <th className="px-4 py-3 text-center">Actions</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {rents.length === 0 ? (
                  <tr><td colSpan={5} className="px-4 py-8 text-center text-gray-500">No rent entered</td></tr>
                ) : rents.map(r => (
                  <tr key={r.id} className="hover:bg-gray-50">
                    <td className="px-4 py-3">
                      <div className="font-medium">{r.field_name}</div>
                      <div className="text-xs text-gray-500">{r.farm_name}</div>
                    </td>
                    <td className="px-4 py-3">{r.rent_type}</td>
                    <td className="px-4 py-3 text-right">{formatCurrency(r.rent_per_acre)}</td>
                    <td className="px-4 py-3 text-right font-medium">{formatCurrency((r.rent_per_acre || 0) * (r.field_acres || 0))}</td>
                    <td className="px-4 py-3 text-center">
                      <button onClick={() => { setEditingRent(r); setShowRentModal(true); }} className="p-1 hover:bg-gray-100 rounded"><Icon name="pencil" size={16} /></button>
                      <button onClick={() => setDeleteConfirm({ ...r, type: 'rent' })} className="p-1 hover:bg-red-100 rounded text-red-600"><Icon name="trash-2" size={16} /></button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>
      )}

      {showSeedModal && <SeedModal seed={editingSeed} fieldCropYears={fieldCropYears} onClose={() => setShowSeedModal(false)} onSave={() => { setShowSeedModal(false); loadData(); }} />}
      {showRentModal && <RentModal rent={editingRent} cropYear={cropYear} fields={fields} onClose={() => setShowRentModal(false)} onSave={() => { setShowRentModal(false); loadData(); }} />}
      {showCopyRentModal && (
        <Modal isOpen={true} onClose={() => setShowCopyRentModal(false)} title="Copy Rent from Another Year">
          <div className="space-y-4">
            <p className="text-gray-600">Select a year to copy all rent entries from. Existing entries for fields in {cropYear} will be updated.</p>
            <div className="grid grid-cols-3 gap-3">
              {cropYears.filter(y => y !== cropYear).map(year => (
                <button
                  key={year}
                  onClick={() => handleCopyRentFromYear(year)}
                  className="p-4 border-2 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-all"
                >
                  <div className="text-2xl font-bold text-gray-900">{year}</div>
                  <div className="text-sm text-gray-500">Copy from</div>
                </button>
              ))}
            </div>
            <div className="flex justify-end pt-4 border-t">
              <button onClick={() => setShowCopyRentModal(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
            </div>
          </div>
        </Modal>
      )}
      <ConfirmModal isOpen={!!deleteConfirm} title={`Delete ${deleteConfirm?.type === 'seed' ? 'Seed Cost' : 'Rent'}`} message="Are you sure?" onConfirm={deleteConfirm?.type === 'seed' ? handleDeleteSeed : handleDeleteRent} onCancel={() => setDeleteConfirm(null)} />
    </div>
  );
}

function SeedModal({ seed, fieldCropYears, onClose, onSave }) {
  // Default seeds/bag by commodity
  const seedDefaults = {
    'Corn': { seeds_per_bag: 80000, seeding_rate: 32000 },
    'Soybeans': { seeds_per_bag: 140000, seeding_rate: 140000 },
    'Wheat': { seeds_per_bag: 600000, seeding_rate: 1200000 },
    'Milo': { seeds_per_bag: 80000, seeding_rate: 32000 }
  };

  const [form, setForm] = useState({ field_crop_year_id: '', variety: '', brand: '', price_per_bag: '', seeds_per_bag: 80000, seeding_rate: 32000, total_cost: '' });
  const [saving, setSaving] = useState(false);
  const { addToast } = useToast();

  useEffect(() => {
    if (seed) setForm({ ...seed });
  }, [seed]);

  const selectedFcy = fieldCropYears.find(f => f.id === form.field_crop_year_id);

  // Auto-set defaults when field is selected based on commodity
  useEffect(() => {
    if (selectedFcy && !seed) {
      const defaults = seedDefaults[selectedFcy.commodity_name] || { seeds_per_bag: 80000, seeding_rate: 32000 };
      setForm(f => ({ ...f, seeds_per_bag: defaults.seeds_per_bag, seeding_rate: defaults.seeding_rate }));
    }
  }, [selectedFcy?.commodity_name]);

  const totalSeeds = form.seeding_rate && selectedFcy?.planted_acres ? form.seeding_rate * selectedFcy.planted_acres : 0;
  const bagsNeeded = form.seeds_per_bag && totalSeeds ? totalSeeds / form.seeds_per_bag : 0;
  const calculatedCost = form.price_per_bag && bagsNeeded ? bagsNeeded * parseFloat(form.price_per_bag) : 0;
  const costPerAcre = calculatedCost && selectedFcy?.planted_acres ? calculatedCost / selectedFcy.planted_acres : 0;

  const handleSave = async () => {
    if (!form.field_crop_year_id) {
      addToast('Please select a field', { type: 'error' });
      return;
    }
    setSaving(true);
    try {
      await saveSeedCost({ ...form, total_cost: form.total_cost || calculatedCost, id: seed?.id });
      addToast('Seed cost saved', { type: 'success' });
      onSave();
    } catch (e) {
      addToast('Failed to save: ' + e.message, { type: 'error' });
    }
    setSaving(false);
  };

  return (
    <Modal isOpen={true} onClose={onClose} title={seed ? 'Edit Seed Cost' : 'Add Seed Cost'}>
      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-1">Field *</label>
          <select value={form.field_crop_year_id} onChange={(e) => setForm(f => ({ ...f, field_crop_year_id: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" disabled={!!seed}>
            <option value="">Select Field</option>
            {fieldCropYears.map(f => <option key={f.id} value={f.id}>{f.field_name} - {f.commodity_name} ({formatNumber(f.planted_acres)} ac)</option>)}
          </select>
        </div>
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">Brand</label>
            <input type="text" value={form.brand} onChange={(e) => setForm(f => ({ ...f, brand: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" placeholder="Pioneer, Dekalb..." />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Variety</label>
            <input type="text" value={form.variety} onChange={(e) => setForm(f => ({ ...f, variety: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" placeholder="P1185AM..." />
          </div>
        </div>
        <div className="grid grid-cols-3 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">Price/Bag</label>
            <input type="number" step="0.01" value={form.price_per_bag} onChange={(e) => setForm(f => ({ ...f, price_per_bag: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Seeds/Bag</label>
            <input type="number" value={form.seeds_per_bag} onChange={(e) => setForm(f => ({ ...f, seeds_per_bag: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Seeding Rate</label>
            <input type="number" value={form.seeding_rate} onChange={(e) => setForm(f => ({ ...f, seeding_rate: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" />
          </div>
        </div>
        <div className="bg-blue-50 rounded-lg p-4 space-y-2">
          <div className="text-sm font-medium text-blue-800 mb-2">Seed Calculation</div>
          {selectedFcy?.planted_acres ? (
            <>
              <div className="grid grid-cols-2 gap-2 text-sm">
                <span className="text-gray-600">Acres:</span>
                <span className="text-right font-medium">{formatNumber(selectedFcy.planted_acres)}</span>
                <span className="text-gray-600">Seeds/Acre:</span>
                <span className="text-right font-medium">{formatNumber(form.seeding_rate || 0)}</span>
                <span className="text-gray-600">Total Seeds:</span>
                <span className="text-right font-medium">{formatNumber(totalSeeds)}</span>
                <span className="text-gray-600">Seeds/Bag:</span>
                <span className="text-right font-medium">{formatNumber(form.seeds_per_bag || 0)}</span>
                <span className="text-gray-600 font-semibold">Bags Needed:</span>
                <span className="text-right font-bold text-blue-700">{bagsNeeded.toFixed(2)}</span>
              </div>
              <div className="border-t pt-2 mt-2 flex justify-between text-sm">
                <span className="text-gray-600">@ {formatCurrency(form.price_per_bag || 0)}/bag:</span>
                <span className="font-bold text-lg">{formatCurrency(calculatedCost)}</span>
              </div>
              <div className="flex justify-between text-sm text-gray-500">
                <span>Cost per acre:</span>
                <span>{formatCurrency(costPerAcre)}/ac</span>
              </div>
            </>
          ) : (
            <p className="text-sm text-gray-500">Select a field to see calculations</p>
          )}
          <div className="mt-3 pt-3 border-t">
            <label className="block text-sm font-medium mb-1">Override Total Cost (optional)</label>
            <input type="number" step="0.01" value={form.total_cost} onChange={(e) => setForm(f => ({ ...f, total_cost: e.target.value }))} className="w-full px-3 py-2 border rounded-lg bg-white" placeholder="Leave blank to use calculated" />
            <p className="text-xs text-gray-500 mt-1">Use this if you have an actual invoice amount different from calculated</p>
          </div>
        </div>
        <div className="flex justify-end gap-3 pt-4 border-t">
          <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
          <button onClick={handleSave} disabled={saving} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">{saving ? 'Saving...' : 'Save'}</button>
        </div>
      </div>
    </Modal>
  );
}

function RentModal({ rent, cropYear, fields, onClose, onSave }) {
  const [form, setForm] = useState({ field_id: '', crop_year: cropYear, rent_type: 'CASH', rent_per_acre: '', notes: '' });
  const [saving, setSaving] = useState(false);
  const { addToast } = useToast();

  useEffect(() => {
    if (rent) setForm({ ...rent });
  }, [rent]);

  const handleSave = async () => {
    if (!form.field_id || !form.rent_per_acre) {
      addToast('Please fill required fields', { type: 'error' });
      return;
    }
    setSaving(true);
    try {
      await saveLandRent({ ...form, rent_per_acre: parseFloat(form.rent_per_acre) });
      addToast('Rent saved', { type: 'success' });
      onSave();
    } catch (e) {
      addToast('Failed to save: ' + e.message, { type: 'error' });
    }
    setSaving(false);
  };

  return (
    <Modal isOpen={true} onClose={onClose} title={rent ? 'Edit Rent' : 'Add Rent'}>
      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-1">Field *</label>
          <select value={form.field_id} onChange={(e) => setForm(f => ({ ...f, field_id: e.target.value }))} className="w-full px-3 py-2 border rounded-lg">
            <option value="">Select Field</option>
            {fields.map(f => <option key={f.id} value={f.id}>{f.name} ({f.farm_name}) - {formatNumber(f.acres)} ac</option>)}
          </select>
        </div>
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">Rent Type</label>
            <select value={form.rent_type} onChange={(e) => setForm(f => ({ ...f, rent_type: e.target.value }))} className="w-full px-3 py-2 border rounded-lg">
              <option value="CASH">Cash Rent</option>
              <option value="SHARE">Share Rent</option>
              <option value="OWNED">Owned</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Rent/Acre *</label>
            <input type="number" step="0.01" value={form.rent_per_acre} onChange={(e) => setForm(f => ({ ...f, rent_per_acre: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" />
          </div>
        </div>
        <div>
          <label className="block text-sm font-medium mb-1">Notes</label>
          <textarea value={form.notes || ''} onChange={(e) => setForm(f => ({ ...f, notes: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" rows={2} />
        </div>
        <div className="flex justify-end gap-3 pt-4 border-t">
          <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
          <button onClick={handleSave} disabled={saving} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">{saving ? 'Saving...' : 'Save'}</button>
        </div>
      </div>
    </Modal>
  );
}

// ============================================================================
// CROP PLANS PAGE
// ============================================================================
function CropPlansPage({ cropYear, onYearChange }) {
  const [activeTab, setActiveTab] = useState('herbicide');
  const [herbPlans, setHerbPlans] = useState([]);
  const [fertPlans, setFertPlans] = useState([]);
  const [tankMixes, setTankMixes] = useState([]);
  const [commodities, setCommodities] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [editing, setEditing] = useState(null);
  const [deleteConfirm, setDeleteConfirm] = useState(null);
  const { addToast } = useToast();

  const loadData = async () => {
    setLoading(true);
    const [hp, fp, tm, c] = await Promise.all([
      getHerbicidePlans(),
      getFertilizerPlans(),
      getTankMixes(),
      getCommodities()
    ]);
    setHerbPlans(hp);
    setFertPlans(fp);
    setTankMixes(tm);
    setCommodities(c);
    setLoading(false);
  };

  useEffect(() => { loadData(); }, []);

  const handleDelete = async () => {
    try {
      await deleteHerbicidePlan(deleteConfirm.id);
      addToast('Plan deleted', { type: 'success' });
      setDeleteConfirm(null);
      loadData();
    } catch (e) {
      addToast('Failed to delete: ' + e.message, { type: 'error' });
    }
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Crop Plans</h1>
          <p className="text-sm text-gray-500">Herbicide and fertilizer plan templates</p>
        </div>
      </div>

      <div className="flex gap-2 border-b">
        <button onClick={() => setActiveTab('herbicide')} className={`px-4 py-2 font-medium ${activeTab === 'herbicide' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>Herbicide Plans</button>
        <button onClick={() => setActiveTab('fertilizer')} className={`px-4 py-2 font-medium ${activeTab === 'fertilizer' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>Fertilizer Plans</button>
      </div>

      {activeTab === 'herbicide' && (
        <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
          <div className="p-4 border-b flex items-center justify-between">
            <h2 className="font-semibold">Herbicide Plans</h2>
            <button onClick={() => { setEditing(null); setShowModal(true); }} className="flex items-center gap-2 px-3 py-1.5 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">
              <Icon name="plus" size={16} /> Add Plan
            </button>
          </div>
          <div className="p-4 bg-amber-50 border-b text-sm text-amber-800">
            <Icon name="link" size={16} className="inline mr-2" />
            Link plans to <a href="https://baldwinag.com/spray/manager" className="underline font-medium">Spray-Suite tank mixes</a> to pull actual FIFO costs, or set estimated cost manually.
          </div>
          {loading ? (
            <div className="p-8 text-center"><Icon name="loader" className="animate-spin text-blue-600 mx-auto" size={32} /></div>
          ) : (
            <table className="w-full text-sm">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left">Plan Name</th>
                  <th className="px-4 py-3 text-left">Commodity</th>
                  <th className="px-4 py-3 text-left">Linked Tank Mix</th>
                  <th className="px-4 py-3 text-right">Est. Cost/Acre</th>
                  <th className="px-4 py-3 text-center">Actions</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {herbPlans.length === 0 ? (
                  <tr><td colSpan={5} className="px-4 py-8 text-center text-gray-500">No herbicide plans. Create one to get started.</td></tr>
                ) : herbPlans.map(p => (
                  <tr key={p.id} className="hover:bg-gray-50">
                    <td className="px-4 py-3">
                      <div className="font-medium">{p.name}</div>
                      {p.description && <div className="text-xs text-gray-500">{p.description}</div>}
                    </td>
                    <td className="px-4 py-3">{p.commodity_name || 'All'}</td>
                    <td className="px-4 py-3">
                      {p.tank_mix_id ? (
                        <span className="text-green-600 flex items-center gap-1"><Icon name="link" size={14} /> Linked</span>
                      ) : (
                        <span className="text-gray-400">Manual</span>
                      )}
                    </td>
                    <td className="px-4 py-3 text-right">{formatCurrency(p.estimated_cost_per_acre)}</td>
                    <td className="px-4 py-3 text-center">
                      <button onClick={() => { setEditing(p); setShowModal(true); }} className="p-1 hover:bg-gray-100 rounded"><Icon name="pencil" size={16} /></button>
                      <button onClick={() => setDeleteConfirm(p)} className="p-1 hover:bg-red-100 rounded text-red-600"><Icon name="trash-2" size={16} /></button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>
      )}

      {activeTab === 'fertilizer' && (
        <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
          <div className="p-4 border-b flex items-center justify-between">
            <h2 className="font-semibold">Fertilizer Plans</h2>
            <a href="https://baldwinag.com/portal/fertilizer" className="flex items-center gap-2 px-3 py-1.5 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700">
              <Icon name="flask-conical" size={16} /> Manage in Fertilizer App
            </a>
          </div>
          <div className="p-4 bg-green-50 border-b text-sm text-green-800">
            <Icon name="link" size={16} className="inline mr-2" />
            Fertilizer plans are managed in the <a href="https://baldwinag.com/portal/fertilizer" className="underline font-medium">Fertilizer App</a>. They appear here for assignment.
          </div>
          {loading ? (
            <div className="p-8 text-center"><Icon name="loader" className="animate-spin text-blue-600 mx-auto" size={32} /></div>
          ) : (
            <table className="w-full text-sm">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left">Plan Name</th>
                  <th className="px-4 py-3 text-left">Commodity</th>
                  <th className="px-4 py-3 text-left">Products</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {fertPlans.length === 0 ? (
                  <tr><td colSpan={3} className="px-4 py-8 text-center text-gray-500">No fertilizer plans. Create them in the Fertilizer App.</td></tr>
                ) : fertPlans.map(p => (
                  <tr key={p.id} className="hover:bg-gray-50">
                    <td className="px-4 py-3">
                      <div className="font-medium">{p.name}</div>
                      {p.description && <div className="text-xs text-gray-500">{p.description}</div>}
                    </td>
                    <td className="px-4 py-3">{p.commodity_name || 'All'}</td>
                    <td className="px-4 py-3">
                      <div className="flex flex-wrap gap-1">
                        {p.products.slice(0, 3).map((prod, i) => (
                          <span key={i} className="px-2 py-0.5 bg-gray-100 rounded text-xs">{prod.fert_products?.name}</span>
                        ))}
                        {p.products.length > 3 && <span className="text-xs text-gray-500">+{p.products.length - 3} more</span>}
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>
      )}

      {showModal && (
        <HerbicidePlanModal
          plan={editing}
          commodities={commodities}
          tankMixes={tankMixes}
          onClose={() => setShowModal(false)}
          onSave={() => { setShowModal(false); loadData(); }}
        />
      )}

      <ConfirmModal
        isOpen={!!deleteConfirm}
        title="Delete Plan"
        message={`Are you sure you want to delete "${deleteConfirm?.name}"?`}
        onConfirm={handleDelete}
        onCancel={() => setDeleteConfirm(null)}
      />
    </div>
  );
}

function HerbicidePlanModal({ plan, commodities, tankMixes, onClose, onSave }) {
  const [form, setForm] = useState({
    name: plan?.name || '',
    commodity_id: plan?.commodity_id || '',
    description: plan?.description || '',
    tank_mix_id: plan?.tank_mix_id || '',
    estimated_cost_per_acre: plan?.estimated_cost_per_acre || ''
  });
  const [saving, setSaving] = useState(false);
  const [tankMixDetails, setTankMixDetails] = useState(null);
  const [loadingDetails, setLoadingDetails] = useState(false);
  const { addToast } = useToast();

  // Load tank mix details when selected
  useEffect(() => {
    async function loadTankMixDetails() {
      if (!form.tank_mix_id) {
        setTankMixDetails(null);
        return;
      }
      setLoadingDetails(true);
      try {
        const { data } = await db.from('tank_mixes')
          .select('*, tank_mix_products(*, products(name, unit))')
          .eq('id', form.tank_mix_id)
          .single();
        setTankMixDetails(data);
        // Auto-fill estimated cost if not set
        if (data?.cost_per_acre && !form.estimated_cost_per_acre) {
          setForm(f => ({ ...f, estimated_cost_per_acre: data.cost_per_acre }));
        }
      } catch (e) {
        console.error('Error loading tank mix:', e);
      }
      setLoadingDetails(false);
    }
    loadTankMixDetails();
  }, [form.tank_mix_id]);

  const handleSave = async () => {
    if (!form.name.trim()) {
      addToast('Plan name is required', { type: 'error' });
      return;
    }
    setSaving(true);
    try {
      await saveHerbicidePlan({ ...form, id: plan?.id });
      addToast('Plan saved', { type: 'success' });
      onSave();
    } catch (e) {
      addToast('Failed to save: ' + e.message, { type: 'error' });
    }
    setSaving(false);
  };

  const selectedTankMix = tankMixes.find(t => t.id === form.tank_mix_id);

  return (
    <Modal isOpen={true} onClose={onClose} title={plan ? 'Edit Herbicide Plan' : 'Add Herbicide Plan'}>
      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-1">Plan Name *</label>
          <input type="text" value={form.name} onChange={(e) => setForm(f => ({ ...f, name: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" placeholder="Burndown, Post-emerge Corn..." />
        </div>
        <div>
          <label className="block text-sm font-medium mb-1">Commodity</label>
          <select value={form.commodity_id} onChange={(e) => setForm(f => ({ ...f, commodity_id: e.target.value }))} className="w-full px-3 py-2 border rounded-lg">
            <option value="">All Commodities</option>
            {commodities.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
          </select>
        </div>

        <div className="bg-gray-50 rounded-lg p-4">
          <div className="font-medium mb-3 flex items-center gap-2">
            <Icon name="link" size={16} className="text-blue-600" />
            Cost Source
          </div>

          <div className="space-y-3">
            <label className="flex items-center gap-3 p-3 bg-white rounded-lg border cursor-pointer hover:border-blue-300">
              <input
                type="radio"
                name="costSource"
                checked={!form.tank_mix_id}
                onChange={() => setForm(f => ({ ...f, tank_mix_id: '' }))}
                className="text-blue-600"
              />
              <div>
                <div className="font-medium">Manual Estimate</div>
                <div className="text-xs text-gray-500">Enter cost per acre manually</div>
              </div>
            </label>

            <label className="flex items-center gap-3 p-3 bg-white rounded-lg border cursor-pointer hover:border-blue-300">
              <input
                type="radio"
                name="costSource"
                checked={!!form.tank_mix_id}
                onChange={() => {}}
                className="text-blue-600"
              />
              <div className="flex-1">
                <div className="font-medium">Link to Spray-Suite Tank Mix</div>
                <div className="text-xs text-gray-500">Use actual FIFO costs from inventory</div>
              </div>
            </label>

            {form.tank_mix_id !== '' || !form.tank_mix_id ? null : null}
            <select
              value={form.tank_mix_id}
              onChange={(e) => setForm(f => ({ ...f, tank_mix_id: e.target.value }))}
              className="w-full px-3 py-2 border rounded-lg ml-6"
              style={{ marginLeft: '2rem' }}
            >
              <option value="">Select a tank mix...</option>
              {tankMixes.map(t => (
                <option key={t.id} value={t.id}>
                  {t.name} {t.commodity_name ? `(${t.commodity_name})` : ''} - {formatCurrency(t.cost_per_acre || 0)}/ac
                </option>
              ))}
            </select>
          </div>
        </div>

        {/* Tank Mix Details */}
        {form.tank_mix_id && (
          <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
            <div className="flex items-center justify-between mb-3">
              <div className="font-medium text-blue-800">Linked Tank Mix: {selectedTankMix?.name}</div>
              <a href="https://baldwinag.com/spray/manager" target="_blank" className="text-xs text-blue-600 hover:underline flex items-center gap-1">
                <Icon name="external-link" size={12} /> View in Spray-Suite
              </a>
            </div>
            {loadingDetails ? (
              <div className="text-center py-2"><Icon name="loader" className="animate-spin" size={16} /></div>
            ) : tankMixDetails?.tank_mix_products?.length > 0 ? (
              <div className="space-y-1">
                <div className="text-xs text-blue-600 uppercase tracking-wide mb-2">Products in this mix:</div>
                {tankMixDetails.tank_mix_products.map((p, i) => (
                  <div key={i} className="flex justify-between text-sm bg-white/50 rounded px-2 py-1">
                    <span>{p.products?.name || 'Unknown'}</span>
                    <span className="text-gray-500">{p.rate} {p.products?.unit || 'oz'}/ac</span>
                  </div>
                ))}
                <div className="flex justify-between font-semibold text-sm mt-2 pt-2 border-t border-blue-200">
                  <span>Estimated Cost:</span>
                  <span>{formatCurrency(tankMixDetails.cost_per_acre || 0)}/ac</span>
                </div>
              </div>
            ) : (
              <p className="text-sm text-blue-700">No product details available</p>
            )}
          </div>
        )}

        {/* Manual cost input */}
        <div>
          <label className="block text-sm font-medium mb-1">
            {form.tank_mix_id ? 'Override Cost/Acre (optional)' : 'Estimated Cost/Acre *'}
          </label>
          <div className="flex items-center gap-2">
            <span className="text-gray-500">$</span>
            <input
              type="number"
              step="0.01"
              value={form.estimated_cost_per_acre}
              onChange={(e) => setForm(f => ({ ...f, estimated_cost_per_acre: e.target.value }))}
              className="w-full px-3 py-2 border rounded-lg"
              placeholder={form.tank_mix_id ? 'Leave blank to use tank mix cost' : '25.00'}
            />
            <span className="text-gray-500">/acre</span>
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">Description</label>
          <textarea value={form.description} onChange={(e) => setForm(f => ({ ...f, description: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" rows={2} placeholder="Notes about this plan..." />
        </div>

        <div className="flex justify-end gap-3 pt-4 border-t">
          <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
          <button onClick={handleSave} disabled={saving} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
            {saving ? 'Saving...' : 'Save Plan'}
          </button>
        </div>
      </div>
    </Modal>
  );
}

// ============================================================================
// FIELD ASSIGNMENTS PAGE
// ============================================================================
function FieldAssignmentsPage({ cropYear, onYearChange }) {
  const [fieldCropYears, setFieldCropYears] = useState([]);
  const [fieldPlans, setFieldPlans] = useState([]);
  const [fertPlans, setFertPlans] = useState([]);
  const [herbPlans, setHerbPlans] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [selectedField, setSelectedField] = useState(null);
  const [filterCommodity, setFilterCommodity] = useState('');
  const [commodities, setCommodities] = useState([]);
  const { addToast } = useToast();
  const currentYear = new Date().getFullYear();
  const cropYears = [currentYear - 1, currentYear, currentYear + 1];

  const loadData = async () => {
    setLoading(true);
    const [fcy, fp, fertP, herbP, c] = await Promise.all([
      getFieldCropYears(cropYear),
      getFieldCropPlans(cropYear),
      getFertilizerPlans(),
      getHerbicidePlans(),
      getCommodities()
    ]);
    setFieldCropYears(fcy);
    setFieldPlans(fp);
    setFertPlans(fertP);
    setHerbPlans(herbP);
    setCommodities(c);
    setLoading(false);
  };

  useEffect(() => { loadData(); }, [cropYear]);

  // Match field crop years with their plans
  const fieldsWithPlans = fieldCropYears.map(fcy => {
    const plan = fieldPlans.find(p => p.field_crop_year_id === fcy.id);
    return {
      ...fcy,
      plan: plan || null,
      hasPlan: !!plan
    };
  });

  const filteredFields = filterCommodity
    ? fieldsWithPlans.filter(f => f.commodity_id === filterCommodity)
    : fieldsWithPlans;

  const uniqueCommodities = [...new Set(fieldCropYears.map(f => f.commodity_id))];

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Field Assignments</h1>
          <p className="text-sm text-gray-500">Assign crop plans to fields for {cropYear}</p>
        </div>
        <div className="flex gap-3">
          <select value={filterCommodity} onChange={(e) => setFilterCommodity(e.target.value)} className="px-4 py-2 border rounded-lg">
            <option value="">All Commodities</option>
            {commodities.filter(c => uniqueCommodities.includes(c.id)).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
          </select>
          <select value={cropYear} onChange={(e) => onYearChange(parseInt(e.target.value))} className="px-4 py-2 border rounded-lg">
            {cropYears.map(y => <option key={y} value={y}>{y}</option>)}
          </select>
        </div>
      </div>

      <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
        <div className="p-4 border-b">
          <div className="flex items-center justify-between">
            <h2 className="font-semibold">Field Crop Plans</h2>
            <div className="text-sm text-gray-500">
              {fieldsWithPlans.filter(f => f.hasPlan).length} of {fieldsWithPlans.length} fields have plans assigned
            </div>
          </div>
        </div>
        {loading ? (
          <div className="p-8 text-center"><Icon name="loader" className="animate-spin text-blue-600 mx-auto" size={32} /></div>
        ) : (
          <table className="w-full text-sm">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left">Field</th>
                <th className="px-4 py-3 text-left">Crop</th>
                <th className="px-4 py-3 text-right">Acres</th>
                <th className="px-4 py-3 text-left">Landlord Split</th>
                <th className="px-4 py-3 text-left">Fert Plan</th>
                <th className="px-4 py-3 text-left">Herb Passes</th>
                <th className="px-4 py-3 text-center">Actions</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {filteredFields.length === 0 ? (
                <tr><td colSpan={7} className="px-4 py-8 text-center text-gray-500">No fields for {cropYear}. Add production in GrainTrack first.</td></tr>
              ) : filteredFields.map(f => (
                <tr key={f.id} className={`hover:bg-gray-50 ${!f.hasPlan ? 'bg-amber-50' : ''}`}>
                  <td className="px-4 py-3">
                    <div className="font-medium">{f.field_name}</div>
                    <div className="text-xs text-gray-500">{f.farm_name}</div>
                  </td>
                  <td className="px-4 py-3">{f.commodity_name}</td>
                  <td className="px-4 py-3 text-right">{formatNumber(f.planted_acres)}</td>
                  <td className="px-4 py-3">
                    {f.tenant_share != null && f.tenant_share < 1 ? (
                      <span className="px-2 py-0.5 bg-purple-100 text-purple-800 rounded text-xs">
                        {((1 - f.tenant_share) * 100).toFixed(0)}% to {f.landlord || 'Landlord'}
                      </span>
                    ) : (
                      <span className="text-gray-400 text-xs">100% Tenant</span>
                    )}
                  </td>
                  <td className="px-4 py-3">
                    {f.plan?.fert_plan_name ? (
                      <span className="px-2 py-0.5 bg-green-100 text-green-800 rounded text-xs">{f.plan.fert_plan_name}</span>
                    ) : f.plan?.fertilizer_plan_override ? (
                      <span className="text-gray-600">{formatCurrency(f.plan.fertilizer_plan_override)}/ac override</span>
                    ) : (
                      <span className="text-gray-400">Not set</span>
                    )}
                  </td>
                  <td className="px-4 py-3">
                    {f.plan?.herbicide_passes?.length > 0 ? (
                      <div className="flex flex-wrap gap-1">
                        {f.plan.herbicide_passes.map((p, i) => (
                          <span key={i} className="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs">{p.pass_name || p.be_herbicide_plans?.name}</span>
                        ))}
                      </div>
                    ) : f.plan?.herbicide_cost_override ? (
                      <span className="text-gray-600">{formatCurrency(f.plan.herbicide_cost_override)}/ac override</span>
                    ) : (
                      <span className="text-gray-400">Not set</span>
                    )}
                  </td>
                  <td className="px-4 py-3 text-center">
                    <button onClick={() => { setSelectedField(f); setShowModal(true); }}
                      className={`px-3 py-1 rounded text-sm ${f.hasPlan ? 'bg-gray-100 hover:bg-gray-200' : 'bg-blue-600 text-white hover:bg-blue-700'}`}>
                      {f.hasPlan ? 'Edit' : 'Assign'}
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      {showModal && selectedField && (
        <FieldPlanModal
          fieldCropYear={selectedField}
          existingPlan={selectedField.plan}
          fertPlans={fertPlans}
          herbPlans={herbPlans}
          onClose={() => setShowModal(false)}
          onSave={() => { setShowModal(false); loadData(); }}
        />
      )}
    </div>
  );
}

function FieldPlanModal({ fieldCropYear, existingPlan, fertPlans, herbPlans, onClose, onSave }) {
  const [form, setForm] = useState({
    fertilizer_plan_id: existingPlan?.fertilizer_plan_id || '',
    fertilizer_plan_override: existingPlan?.fertilizer_plan_override || '',
    herbicide_cost_override: existingPlan?.herbicide_cost_override || '',
    notes: existingPlan?.notes || ''
  });
  const [herbPasses, setHerbPasses] = useState(
    existingPlan?.herbicide_passes?.map(p => ({
      herbicide_plan_id: p.herbicide_plan_id,
      pass_name: p.pass_name || ''
    })) || []
  );
  const [saving, setSaving] = useState(false);
  const { addToast } = useToast();

  const commodityHerbPlans = herbPlans.filter(p => !p.commodity_id || p.commodity_id === fieldCropYear.commodity_id);
  const commodityFertPlans = fertPlans.filter(p => !p.commodity_id || p.commodity_id === fieldCropYear.commodity_id);

  const addHerbPass = () => {
    setHerbPasses([...herbPasses, { herbicide_plan_id: '', pass_name: '' }]);
  };

  const removeHerbPass = (index) => {
    setHerbPasses(herbPasses.filter((_, i) => i !== index));
  };

  const updateHerbPass = (index, field, value) => {
    const updated = [...herbPasses];
    updated[index] = { ...updated[index], [field]: value };
    setHerbPasses(updated);
  };

  const handleSave = async () => {
    setSaving(true);
    try {
      const planData = {
        id: existingPlan?.id,
        field_crop_year_id: fieldCropYear.id,
        fertilizer_plan_id: form.fertilizer_plan_id || null,
        fertilizer_plan_override: form.fertilizer_plan_override || null,
        herbicide_cost_override: form.herbicide_cost_override || null,
        notes: form.notes
      };
      const savedPlan = await saveFieldCropPlan(planData);

      // Save herbicide passes
      const validPasses = herbPasses.filter(p => p.herbicide_plan_id);
      if (validPasses.length > 0 || existingPlan?.herbicide_passes?.length > 0) {
        await saveHerbicidePasses(savedPlan.id || existingPlan.id, validPasses);
      }

      addToast('Field plan saved', { type: 'success' });
      onSave();
    } catch (e) {
      addToast('Failed to save: ' + e.message, { type: 'error' });
    }
    setSaving(false);
  };

  return (
    <Modal isOpen={true} onClose={onClose} title={`${fieldCropYear.field_name} - ${fieldCropYear.commodity_name}`} size="lg">
      <div className="space-y-6">
        <div className="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
          <div><span className="text-gray-500">Farm:</span> {fieldCropYear.farm_name}</div>
          <div><span className="text-gray-500">Acres:</span> {formatNumber(fieldCropYear.planted_acres)}</div>
        </div>

        <div>
          <h3 className="font-medium mb-3 flex items-center gap-2"><Icon name="flask-conical" size={18} className="text-green-600" /> Fertilizer</h3>
          <div className="space-y-3">
            <div>
              <label className="block text-sm font-medium mb-1">Fertilizer Plan</label>
              <select value={form.fertilizer_plan_id} onChange={(e) => setForm(f => ({ ...f, fertilizer_plan_id: e.target.value }))} className="w-full px-3 py-2 border rounded-lg">
                <option value="">Select plan or use override</option>
                {commodityFertPlans.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Or Cost Override ($/ac)</label>
              <input type="number" step="0.01" value={form.fertilizer_plan_override} onChange={(e) => setForm(f => ({ ...f, fertilizer_plan_override: e.target.value }))}
                className="w-full px-3 py-2 border rounded-lg" placeholder="Override planned cost" disabled={!!form.fertilizer_plan_id} />
              <p className="text-xs text-gray-500 mt-1">All fertilizer costs are split with landlord at their grain share %</p>
            </div>
          </div>
        </div>

        <div>
          <h3 className="font-medium mb-3 flex items-center gap-2"><Icon name="spray-can" size={18} className="text-purple-600" /> Herbicide Passes</h3>
          <div className="space-y-3">
            {herbPasses.map((pass, i) => (
              <div key={i} className="flex gap-3 items-center">
                <input type="text" value={pass.pass_name} onChange={(e) => updateHerbPass(i, 'pass_name', e.target.value)}
                  className="w-32 px-3 py-2 border rounded-lg" placeholder="Pass name" />
                <select value={pass.herbicide_plan_id} onChange={(e) => updateHerbPass(i, 'herbicide_plan_id', e.target.value)} className="flex-1 px-3 py-2 border rounded-lg">
                  <option value="">Select herbicide plan</option>
                  {commodityHerbPlans.map(p => <option key={p.id} value={p.id}>{p.name} - {formatCurrency(p.estimated_cost_per_acre)}/ac</option>)}
                </select>
                <button onClick={() => removeHerbPass(i)} className="p-2 text-red-600 hover:bg-red-50 rounded"><Icon name="trash-2" size={16} /></button>
              </div>
            ))}
            <button onClick={addHerbPass} className="flex items-center gap-2 px-3 py-2 text-blue-600 hover:bg-blue-50 rounded-lg text-sm">
              <Icon name="plus" size={16} /> Add Herbicide Pass
            </button>
            <div>
              <label className="block text-sm font-medium mb-1">Or Cost Override ($/ac)</label>
              <input type="number" step="0.01" value={form.herbicide_cost_override} onChange={(e) => setForm(f => ({ ...f, herbicide_cost_override: e.target.value }))}
                className="w-full px-3 py-2 border rounded-lg" placeholder="Override planned cost" disabled={herbPasses.length > 0} />
              <p className="text-xs text-gray-500 mt-1">Chemical costs split with landlord IF split toggle is on in Spray-Suite</p>
            </div>
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">Notes</label>
          <textarea value={form.notes} onChange={(e) => setForm(f => ({ ...f, notes: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" rows={2} />
        </div>

        <div className="flex justify-end gap-3 pt-4 border-t">
          <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
          <button onClick={handleSave} disabled={saving} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
            {saving ? 'Saving...' : 'Save Plan'}
          </button>
        </div>
      </div>
    </Modal>
  );
}

// ============================================================================
// BREAKEVEN PAGE
// ============================================================================
function BreakevenPage({ cropYear, onYearChange }) {
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [viewMode, setViewMode] = useState('tenant'); // 'tenant' or 'total'
  const currentYear = new Date().getFullYear();
  const cropYears = [currentYear - 1, currentYear, currentYear + 1];

  useEffect(() => {
    async function load() {
      setLoading(true);
      const [fcys, expenses, seeds, rents, fertCosts, herbCosts] = await Promise.all([
        getFieldCropYears(cropYear),
        getOverheadExpenses(cropYear),
        getSeedCosts(cropYear),
        getLandRent(cropYear),
        getFertilizerCostsDetailed(cropYear),
        getHerbicideCosts(cropYear)
      ]);

      const overheadAlloc = allocateOverhead(expenses, fcys);
      const seedMap = {};
      seeds.forEach(s => { seedMap[s.field_crop_year_id] = s.total_cost || calculateSeedCost({ ...s, planted_acres: s.planted_acres }); });

      // Build rent map with rent type (CASH, SHARE, OWNED)
      const rentMap = {};
      rents.forEach(r => {
        rentMap[r.field_id] = {
          rentPerAcre: r.rent_per_acre || 0,
          rentType: r.rent_type || 'OWNED'
        };
      });

      const results = fcys.map(fcy => {
        const overhead = overheadAlloc[fcy.id] || 0;
        const seed = seedMap[fcy.id] || 0;
        const rentInfo = rentMap[fcy.field_id] || { rentPerAcre: 0, rentType: 'OWNED' };
        const rent = rentInfo.rentPerAcre * (fcy.planted_acres || 0);
        const rentType = rentInfo.rentType;

        // Tenant share comes from fields table (e.g., 0.5 = 50% tenant, 50% landlord)
        const tenantShare = fcy.tenant_share || 1;
        const landlordShare = 1 - tenantShare;

        // Has landlord = tenant_share < 1 (regardless of rent_type record)
        const hasLandlordSplit = landlordShare > 0;

        // Rent type determines if it's share crop vs cash rent
        // But if tenant_share < 1, there IS a landlord split
        const isShareCrop = hasLandlordSplit && (rentType === 'SHARE' || rentType === 'OWNED');
        // Note: If tenant_share < 1 but no be_land_rent record, treat as share crop

        // Get fertilizer costs (always split when there's a landlord)
        const fertData = fertCosts[fcy.field_id] || { total: 0, splitCost: 0 };
        const fertTotal = fertData.total;

        // Get herbicide costs with split breakdown
        const herbData = herbCosts[fcy.field_id] || { total: 0, splitCost: 0, nonSplitCost: 0 };
        const herbTotal = herbData.total;
        const herbSplitCost = herbData.splitCost;      // Products marked 'shared' on products table
        const herbNonSplitCost = herbData.nonSplitCost; // Burndowns, etc. (100% tenant)

        // Calculate tenant's portion:
        // - If landlord split exists: split costs at tenant_share %
        // - CASH RENT with 100% tenant_share: no split
        let fertTenant, fertLandlord, herbTenant, herbLandlord;

        if (hasLandlordSplit) {
          // SHARE CROP or any field with tenant_share < 1
          // Fertilizer: ALWAYS split at tenant_share
          fertTenant = fertTotal * tenantShare;
          fertLandlord = fertTotal * landlordShare;

          // Herbicide: Only split products marked 'shared' on products table
          // Non-shared products (burndowns) = 100% tenant
          herbTenant = (herbSplitCost * tenantShare) + herbNonSplitCost;
          herbLandlord = herbSplitCost * landlordShare;
        } else {
          // No landlord split (100% tenant_share) - tenant pays all
          fertTenant = fertTotal;
          fertLandlord = 0;
          herbTenant = herbTotal;
          herbLandlord = 0;
        }

        // Overhead, seed, rent: 100% tenant responsibility (never split)
        const totalAll = overhead + seed + rent + fertTotal + herbTotal;
        const totalTenant = overhead + seed + rent + fertTenant + herbTenant;
        const totalLandlord = fertLandlord + herbLandlord;

        // Bushels: If landlord split, use tenant share of bushels
        const bushelsAll = fcy.actual_production || ((fcy.planted_acres || 0) * (fcy.estimated_yield || 0));
        const bushelsTenant = hasLandlordSplit ? bushelsAll * tenantShare : bushelsAll;

        // Breakeven: Total tenant costs / Tenant bushels
        const breakevenAll = bushelsAll > 0 ? totalAll / bushelsAll : null;
        const breakevenTenant = bushelsTenant > 0 ? totalTenant / bushelsTenant : null;
        const costPerAcreAll = fcy.planted_acres > 0 ? totalAll / fcy.planted_acres : 0;
        const costPerAcreTenant = fcy.planted_acres > 0 ? totalTenant / fcy.planted_acres : 0;

        return {
          ...fcy,
          overhead,
          seed,
          rent,
          rentType,
          isShareCrop: hasLandlordSplit,
          fertTotal,
          fertTenant,
          fertLandlord,
          herbTotal,
          herbSplitCost,
          herbNonSplitCost,
          herbTenant,
          herbLandlord,
          totalAll,
          totalTenant,
          totalLandlord,
          bushelsAll,
          bushelsTenant,
          breakevenAll,
          breakevenTenant,
          costPerAcreAll,
          costPerAcreTenant,
          hasLandlord: hasLandlordSplit
        };
      });

      setData(results);
      setLoading(false);
    }
    load();
  }, [cropYear]);

  const exportCSV = () => {
    const headers = ['Field', 'Farm', 'Commodity', 'Acres', 'Rent Type', 'Landlord', 'Split %', 'Overhead', 'Seed', 'Rent', 'Fertilizer', 'Herbicide', 'Total Cost', 'Bushels', 'Breakeven'];
    const rows = data.map(d => {
      const fert = viewMode === 'tenant' ? d.fertTenant : d.fertTotal;
      const herb = viewMode === 'tenant' ? d.herbTenant : d.herbTotal;
      const total = viewMode === 'tenant' ? d.totalTenant : d.totalAll;
      const bushels = viewMode === 'tenant' ? d.bushelsTenant : d.bushelsAll;
      const breakeven = viewMode === 'tenant' ? d.breakevenTenant : d.breakevenAll;
      return [d.field_name, d.farm_name, d.commodity_name, d.planted_acres, d.rentType, d.landlord || '', d.hasLandlord ? ((1 - d.tenant_share) * 100).toFixed(0) + '%' : '', d.overhead.toFixed(2), d.seed.toFixed(2), d.rent.toFixed(2), fert.toFixed(2), herb.toFixed(2), total.toFixed(2), bushels.toFixed(0), breakeven?.toFixed(4) || ''];
    });
    const csv = [headers, ...rows].map(r => r.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `breakeven-${viewMode}-${cropYear}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  if (loading) return <div className="flex items-center justify-center h-64"><Icon name="loader" className="animate-spin text-blue-600" size={32} /></div>;

  const hasAnyLandlord = data.some(d => d.hasLandlord);

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Breakeven Analysis</h1>
          <p className="text-sm text-gray-500">Per-field cost breakdown and breakeven prices</p>
        </div>
        <div className="flex gap-3">
          {hasAnyLandlord && (
            <div className="flex items-center bg-gray-100 rounded-lg p-1">
              <button onClick={() => setViewMode('tenant')} className={`px-3 py-1.5 rounded text-sm font-medium ${viewMode === 'tenant' ? 'bg-white shadow text-blue-600' : 'text-gray-600'}`}>
                Tenant Share
              </button>
              <button onClick={() => setViewMode('total')} className={`px-3 py-1.5 rounded text-sm font-medium ${viewMode === 'total' ? 'bg-white shadow text-blue-600' : 'text-gray-600'}`}>
                Total Costs
              </button>
            </div>
          )}
          <select value={cropYear} onChange={(e) => onYearChange(parseInt(e.target.value))} className="px-4 py-2 border rounded-lg">
            {cropYears.map(y => <option key={y} value={y}>{y}</option>)}
          </select>
          <button onClick={exportCSV} className="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
            <Icon name="download" size={18} /> Export CSV
          </button>
        </div>
      </div>

      {viewMode === 'tenant' && hasAnyLandlord && (
        <div className="bg-purple-50 border border-purple-200 rounded-lg p-4 text-sm text-purple-800">
          <strong>Tenant Share View:</strong> Shows YOUR costs and YOUR bushels.
          <ul className="mt-2 ml-4 list-disc space-y-1">
            <li><strong>Share Crop:</strong> Fertilizer always split. Herbicide split only for products marked "split with landlord" (in-crop, at-planting residuals). Burndowns = 100% tenant.</li>
            <li><strong>Cash Rent / Owned:</strong> 100% tenant pays all costs, receives all bushels.</li>
            <li><strong>Overhead, Seed, Rent:</strong> Always 100% tenant responsibility.</li>
          </ul>
        </div>
      )}

      <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left">Field</th>
                <th className="px-4 py-3 text-left">Commodity</th>
                <th className="px-4 py-3 text-right">Acres</th>
                <th className="px-4 py-3 text-right">Overhead</th>
                <th className="px-4 py-3 text-right">Seed</th>
                <th className="px-4 py-3 text-right">Rent</th>
                <th className="px-4 py-3 text-right">Fertilizer</th>
                <th className="px-4 py-3 text-right">Herbicide</th>
                <th className="px-4 py-3 text-right font-semibold">Total</th>
                <th className="px-4 py-3 text-right">$/Acre</th>
                <th className="px-4 py-3 text-right font-semibold">Breakeven</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {data.length === 0 ? (
                <tr><td colSpan={11} className="px-4 py-8 text-center text-gray-500">No field data for {cropYear}</td></tr>
              ) : data.map(d => {
                const fert = viewMode === 'tenant' ? d.fertTenant : d.fertTotal;
                const herb = viewMode === 'tenant' ? d.herbTenant : d.herbTotal;
                const total = viewMode === 'tenant' ? d.totalTenant : d.totalAll;
                const costPerAcre = viewMode === 'tenant' ? d.costPerAcreTenant : d.costPerAcreAll;
                const breakeven = viewMode === 'tenant' ? d.breakevenTenant : d.breakevenAll;
                return (
                  <tr key={d.id} className={`hover:bg-gray-50 ${d.isShareCrop ? 'bg-purple-50/30' : ''}`}>
                    <td className="px-4 py-3">
                      <div className="font-medium">{d.field_name}</div>
                      <div className="text-xs text-gray-500">{d.farm_name}</div>
                      {d.isShareCrop && d.hasLandlord ? (
                        <div className="text-xs text-purple-600">
                          <span className="font-medium">SHARE</span> - {d.landlord} ({((1 - d.tenant_share) * 100).toFixed(0)}%)
                        </div>
                      ) : d.rentType === 'CASH' ? (
                        <div className="text-xs text-green-600 font-medium">CASH RENT</div>
                      ) : (
                        <div className="text-xs text-gray-400">OWNED</div>
                      )}
                    </td>
                    <td className="px-4 py-3">{d.commodity_name}</td>
                    <td className="px-4 py-3 text-right">{formatNumber(d.planted_acres)}</td>
                    <td className="px-4 py-3 text-right">{formatCurrency(d.overhead)}</td>
                    <td className="px-4 py-3 text-right">{formatCurrency(d.seed)}</td>
                    <td className="px-4 py-3 text-right">{formatCurrency(d.rent)}</td>
                    <td className="px-4 py-3 text-right">{formatCurrency(fert)}</td>
                    <td className="px-4 py-3 text-right">{formatCurrency(herb)}</td>
                    <td className="px-4 py-3 text-right font-semibold">{formatCurrency(total)}</td>
                    <td className="px-4 py-3 text-right">{formatCurrency(costPerAcre)}</td>
                    <td className="px-4 py-3 text-right font-bold text-blue-600">{breakeven ? formatPrice(breakeven) : '-'}</td>
                  </tr>
                );
              })}
            </tbody>
            <tfoot className="bg-gray-100">
              <tr className="font-semibold">
                <td className="px-4 py-3">TOTAL</td>
                <td></td>
                <td className="px-4 py-3 text-right">{formatNumber(data.reduce((s, d) => s + (d.planted_acres || 0), 0))}</td>
                <td className="px-4 py-3 text-right">{formatCurrency(data.reduce((s, d) => s + d.overhead, 0))}</td>
                <td className="px-4 py-3 text-right">{formatCurrency(data.reduce((s, d) => s + d.seed, 0))}</td>
                <td className="px-4 py-3 text-right">{formatCurrency(data.reduce((s, d) => s + d.rent, 0))}</td>
                <td className="px-4 py-3 text-right">{formatCurrency(data.reduce((s, d) => s + (viewMode === 'tenant' ? d.fertTenant : d.fertTotal), 0))}</td>
                <td className="px-4 py-3 text-right">{formatCurrency(data.reduce((s, d) => s + (viewMode === 'tenant' ? d.herbTenant : d.herbTotal), 0))}</td>
                <td className="px-4 py-3 text-right font-bold">{formatCurrency(data.reduce((s, d) => s + (viewMode === 'tenant' ? d.totalTenant : d.totalAll), 0))}</td>
                <td></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  );
}

// ============================================================================
// LANDLORD REPORT PAGE
// ============================================================================
function LandlordReportPage({ cropYear, onYearChange }) {
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [expandedLandlord, setExpandedLandlord] = useState(null);
  const currentYear = new Date().getFullYear();
  const cropYears = [currentYear - 1, currentYear, currentYear + 1];

  useEffect(() => {
    async function load() {
      setLoading(true);
      const [fcys, fertCosts, herbCosts] = await Promise.all([
        getFieldCropYears(cropYear),
        getFertilizerCostsDetailed(cropYear),
        getHerbicideCosts(cropYear)
      ]);

      // Only include fields with landlord splits (tenant_share < 1)
      const landlordFields = fcys.filter(fcy => fcy.tenant_share != null && fcy.tenant_share < 1);

      // Calculate landlord costs for each field
      const fieldsWithCosts = landlordFields.map(fcy => {
        const tenantShare = fcy.tenant_share;
        const landlordShare = 1 - tenantShare;

        // Fertilizer: ALWAYS split
        const fertData = fertCosts[fcy.field_id] || { total: 0 };
        const fertTotal = fertData.total;
        const fertLandlord = fertTotal * landlordShare;

        // Herbicide: Only split products marked 'split' = 'Y'
        const herbData = herbCosts[fcy.field_id] || { total: 0, splitCost: 0, nonSplitCost: 0 };
        const herbSplitCost = herbData.splitCost;  // Only these are split
        const herbLandlord = herbSplitCost * landlordShare;

        const totalLandlord = fertLandlord + herbLandlord;
        const costPerAcreLandlord = fcy.planted_acres > 0 ? totalLandlord / fcy.planted_acres : 0;

        return {
          ...fcy,
          landlordShare,
          fertTotal,
          fertLandlord,
          herbSplitCost,
          herbLandlord,
          totalLandlord,
          costPerAcreLandlord
        };
      });

      // Group by landlord name
      const byLandlord = {};
      fieldsWithCosts.forEach(f => {
        const landlordName = f.landlord || 'Unknown Landlord';
        if (!byLandlord[landlordName]) {
          byLandlord[landlordName] = { name: landlordName, fields: [], totals: { acres: 0, fertLandlord: 0, herbLandlord: 0, totalLandlord: 0 } };
        }
        byLandlord[landlordName].fields.push(f);
        byLandlord[landlordName].totals.acres += f.planted_acres || 0;
        byLandlord[landlordName].totals.fertLandlord += f.fertLandlord;
        byLandlord[landlordName].totals.herbLandlord += f.herbLandlord;
        byLandlord[landlordName].totals.totalLandlord += f.totalLandlord;
      });

      setData(Object.values(byLandlord).sort((a, b) => a.name.localeCompare(b.name)));
      setLoading(false);
    }
    load();
  }, [cropYear]);

  const exportCSV = () => {
    const headers = ['Landlord', 'Field', 'Farm', 'Commodity', 'Acres', 'Landlord %', 'Fertilizer Share', 'Herbicide Share', 'Total Landlord Cost'];
    const rows = [];
    data.forEach(landlord => {
      landlord.fields.forEach(f => {
        rows.push([
          landlord.name,
          f.field_name,
          f.farm_name,
          f.commodity_name,
          f.planted_acres,
          (f.landlordShare * 100).toFixed(0) + '%',
          f.fertLandlord.toFixed(2),
          f.herbLandlord.toFixed(2),
          f.totalLandlord.toFixed(2)
        ]);
      });
      rows.push([landlord.name + ' TOTAL', '', '', '', landlord.totals.acres, '', landlord.totals.fertLandlord.toFixed(2), landlord.totals.herbLandlord.toFixed(2), landlord.totals.totalLandlord.toFixed(2)]);
    });
    const csv = [headers, ...rows].map(r => r.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `landlord-report-${cropYear}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const grandTotals = data.reduce((acc, l) => ({
    acres: acc.acres + l.totals.acres,
    fertLandlord: acc.fertLandlord + l.totals.fertLandlord,
    herbLandlord: acc.herbLandlord + l.totals.herbLandlord,
    totalLandlord: acc.totalLandlord + l.totals.totalLandlord
  }), { acres: 0, fertLandlord: 0, herbLandlord: 0, totalLandlord: 0 });

  const exportPDF = (landlordName = null) => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const margin = 14;
    let yPos = 20;

    const landlords = landlordName ? data.filter(l => l.name === landlordName) : data;
    const title = landlordName ? `Landlord Statement - ${landlordName}` : 'Landlord Report Summary';

    // Title
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.text(title, margin, yPos);
    yPos += 8;

    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(100);
    doc.text(`${cropYear} Crop Year â€¢ Generated ${new Date().toLocaleDateString()}`, margin, yPos);
    yPos += 12;

    doc.setTextColor(0);

    landlords.forEach((landlord, idx) => {
      if (idx > 0) {
        yPos += 10;
        if (yPos > 250) {
          doc.addPage();
          yPos = 20;
        }
      }

      // Landlord header
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text(landlord.name, margin, yPos);
      yPos += 6;

      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text(`${landlord.fields.length} field(s) â€¢ ${formatNumber(landlord.totals.acres)} acres`, margin, yPos);
      yPos += 8;

      // Table
      const tableData = landlord.fields.map(f => [
        f.field_name,
        f.commodity_name,
        formatNumber(f.planted_acres),
        (f.landlordShare * 100).toFixed(0) + '%',
        formatCurrency(f.fertLandlord),
        formatCurrency(f.herbLandlord),
        formatCurrency(f.totalLandlord)
      ]);

      // Add totals row
      tableData.push([
        { content: 'TOTAL', styles: { fontStyle: 'bold' } },
        '',
        { content: formatNumber(landlord.totals.acres), styles: { fontStyle: 'bold' } },
        '',
        { content: formatCurrency(landlord.totals.fertLandlord), styles: { fontStyle: 'bold' } },
        { content: formatCurrency(landlord.totals.herbLandlord), styles: { fontStyle: 'bold' } },
        { content: formatCurrency(landlord.totals.totalLandlord), styles: { fontStyle: 'bold' } }
      ]);

      doc.autoTable({
        startY: yPos,
        head: [['Field', 'Crop', 'Acres', 'Share %', 'Fertilizer', 'Herbicide', 'Total']],
        body: tableData,
        margin: { left: margin, right: margin },
        styles: { fontSize: 9 },
        headStyles: { fillColor: [88, 80, 141] },
        columnStyles: {
          2: { halign: 'right' },
          3: { halign: 'right' },
          4: { halign: 'right' },
          5: { halign: 'right' },
          6: { halign: 'right' }
        }
      });

      yPos = doc.lastAutoTable.finalY + 5;
    });

    // Grand total if showing all landlords
    if (!landlordName && landlords.length > 1) {
      yPos += 5;
      if (yPos > 260) {
        doc.addPage();
        yPos = 20;
      }

      doc.setFillColor(88, 80, 141);
      doc.rect(margin, yPos, doc.internal.pageSize.width - margin * 2, 12, 'F');
      doc.setTextColor(255);
      doc.setFont('helvetica', 'bold');
      doc.text('GRAND TOTAL ALL LANDLORDS:', margin + 4, yPos + 8);
      doc.text(formatCurrency(grandTotals.totalLandlord), doc.internal.pageSize.width - margin - 4, yPos + 8, { align: 'right' });
      doc.setTextColor(0);
    }

    // Footer note
    yPos = doc.internal.pageSize.height - 20;
    doc.setFontSize(8);
    doc.setFont('helvetica', 'italic');
    doc.setTextColor(100);
    doc.text('Note: Includes fertilizer and split herbicide costs only. Burndowns, overhead, seed, rent, insurance, and taxes are tenant responsibility.', margin, yPos);

    const fileName = landlordName
      ? `landlord-statement-${landlordName.replace(/\s+/g, '-').toLowerCase()}-${cropYear}.pdf`
      : `landlord-report-${cropYear}.pdf`;
    doc.save(fileName);
  };

  if (loading) return <div className="flex items-center justify-center h-64"><Icon name="loader" className="animate-spin text-blue-600" size={32} /></div>;

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Landlord Report</h1>
          <p className="text-sm text-gray-500">Expected expenses by landlord for {cropYear}</p>
        </div>
        <div className="flex gap-3">
          <select value={cropYear} onChange={(e) => onYearChange(parseInt(e.target.value))} className="px-4 py-2 border rounded-lg">
            {cropYears.map(y => <option key={y} value={y}>{y}</option>)}
          </select>
          <button onClick={exportCSV} className="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
            <Icon name="download" size={18} /> CSV
          </button>
          <button onClick={() => exportPDF()} className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
            <Icon name="file-text" size={18} /> PDF Report
          </button>
        </div>
      </div>

      <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 text-sm text-amber-800">
        <Icon name="info" size={16} className="inline mr-2" />
        <strong>Note:</strong> This report shows landlord's share of <strong>fertilizer</strong> and <strong>herbicide</strong> costs only.
        Insurance, taxes, overhead, seed, and rent are tenant responsibilities and not included here.
        Burndowns and non-residual herbicides are also 100% tenant and excluded.
      </div>

      {data.length === 0 ? (
        <div className="bg-white rounded-xl shadow-sm border p-8 text-center text-gray-500">
          <Icon name="users" size={48} className="mx-auto mb-4 text-gray-300" />
          <p>No landlord fields found for {cropYear}.</p>
          <p className="text-sm mt-2">Fields with tenant_share less than 100% will appear here.</p>
        </div>
      ) : (
        <div className="space-y-4">
          {data.map(landlord => (
            <div key={landlord.name} className="bg-white rounded-xl shadow-sm border overflow-hidden">
              <button
                onClick={() => setExpandedLandlord(expandedLandlord === landlord.name ? null : landlord.name)}
                className="w-full flex items-center justify-between p-4 hover:bg-gray-50"
              >
                <div className="flex items-center gap-4">
                  <div className="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                    <Icon name="user" size={20} className="text-purple-600" />
                  </div>
                  <div className="text-left">
                    <div className="font-semibold text-lg">{landlord.name}</div>
                    <div className="text-sm text-gray-500">{landlord.fields.length} field{landlord.fields.length !== 1 ? 's' : ''} â€¢ {formatNumber(landlord.totals.acres)} acres</div>
                  </div>
                </div>
                <div className="flex items-center gap-6">
                  <div className="text-right">
                    <div className="text-sm text-gray-500">Expected Expenses</div>
                    <div className="text-xl font-bold text-purple-600">{formatCurrency(landlord.totals.totalLandlord)}</div>
                  </div>
                  <Icon name={expandedLandlord === landlord.name ? 'chevron-up' : 'chevron-down'} size={20} className="text-gray-400" />
                </div>
              </button>

              {expandedLandlord === landlord.name && (
                <div className="border-t">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-4 py-2 text-left">Field</th>
                        <th className="px-4 py-2 text-left">Commodity</th>
                        <th className="px-4 py-2 text-right">Acres</th>
                        <th className="px-4 py-2 text-right">Share %</th>
                        <th className="px-4 py-2 text-right">Fertilizer</th>
                        <th className="px-4 py-2 text-right">Herbicide</th>
                        <th className="px-4 py-2 text-right font-semibold">Total</th>
                        <th className="px-4 py-2 text-right">$/Acre</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y">
                      {landlord.fields.map(f => (
                        <tr key={f.id} className="hover:bg-gray-50">
                          <td className="px-4 py-2">
                            <div className="font-medium">{f.field_name}</div>
                            <div className="text-xs text-gray-500">{f.farm_name}</div>
                          </td>
                          <td className="px-4 py-2">{f.commodity_name}</td>
                          <td className="px-4 py-2 text-right">{formatNumber(f.planted_acres)}</td>
                          <td className="px-4 py-2 text-right">
                            <span className="px-2 py-0.5 bg-purple-100 text-purple-800 rounded text-xs">
                              {(f.landlordShare * 100).toFixed(0)}%
                            </span>
                          </td>
                          <td className="px-4 py-2 text-right">{formatCurrency(f.fertLandlord)}</td>
                          <td className="px-4 py-2 text-right">{formatCurrency(f.herbLandlord)}</td>
                          <td className="px-4 py-2 text-right font-semibold">{formatCurrency(f.totalLandlord)}</td>
                          <td className="px-4 py-2 text-right text-gray-600">{formatCurrency(f.costPerAcreLandlord)}</td>
                        </tr>
                      ))}
                    </tbody>
                    <tfoot className="bg-purple-50">
                      <tr className="font-semibold text-purple-800">
                        <td className="px-4 py-2">{landlord.name} Total</td>
                        <td></td>
                        <td className="px-4 py-2 text-right">{formatNumber(landlord.totals.acres)}</td>
                        <td></td>
                        <td className="px-4 py-2 text-right">{formatCurrency(landlord.totals.fertLandlord)}</td>
                        <td className="px-4 py-2 text-right">{formatCurrency(landlord.totals.herbLandlord)}</td>
                        <td className="px-4 py-2 text-right">{formatCurrency(landlord.totals.totalLandlord)}</td>
                        <td></td>
                      </tr>
                    </tfoot>
                  </table>
                  <div className="p-3 bg-gray-50 border-t flex justify-end">
                    <button
                      onClick={(e) => { e.stopPropagation(); exportPDF(landlord.name); }}
                      className="flex items-center gap-2 px-3 py-1.5 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700"
                    >
                      <Icon name="file-text" size={16} /> Export {landlord.name} Statement
                    </button>
                  </div>
                </div>
              )}
            </div>
          ))}

          <div className="bg-purple-600 text-white rounded-xl shadow-sm p-6">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-purple-200 text-sm">Grand Total - All Landlords</div>
                <div className="text-2xl font-bold">{formatCurrency(grandTotals.totalLandlord)}</div>
              </div>
              <div className="grid grid-cols-3 gap-8 text-right">
                <div>
                  <div className="text-purple-200 text-sm">Total Acres</div>
                  <div className="text-xl font-semibold">{formatNumber(grandTotals.acres)}</div>
                </div>
                <div>
                  <div className="text-purple-200 text-sm">Fertilizer</div>
                  <div className="text-xl font-semibold">{formatCurrency(grandTotals.fertLandlord)}</div>
                </div>
                <div>
                  <div className="text-purple-200 text-sm">Herbicide</div>
                  <div className="text-xl font-semibold">{formatCurrency(grandTotals.herbLandlord)}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============================================================================
// SETTINGS PAGE
// ============================================================================
function SettingsPage({ isConnected }) {
  const [activeTab, setActiveTab] = useState('hotlinks');

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-bold text-gray-900">Settings</h1>
        <p className="text-sm text-gray-500">App configuration and links</p>
      </div>

      <div className="flex gap-2 border-b">
        <button onClick={() => setActiveTab('hotlinks')} className={`px-4 py-2 font-medium ${activeTab === 'hotlinks' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>App Links</button>
        <button onClick={() => setActiveTab('status')} className={`px-4 py-2 font-medium ${activeTab === 'status' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>Status</button>
      </div>

      {activeTab === 'hotlinks' && (
        <div className="bg-white rounded-xl shadow-sm border p-6">
          <h2 className="font-semibold mb-4">Farm Management Suite</h2>
          <div className="grid gap-4">
            {appLinks.map(app => (
              <a key={app.name} href={app.url} className="flex items-center gap-4 p-4 border rounded-lg hover:bg-gray-50">
                <div className="p-2 bg-blue-100 rounded-lg"><Icon name={app.icon} size={24} className="text-blue-600" /></div>
                <div>
                  <div className="font-medium">{app.name}</div>
                  <div className="text-sm text-gray-500">{app.desc}</div>
                </div>
              </a>
            ))}
          </div>
        </div>
      )}

      {activeTab === 'status' && (
        <div className="bg-white rounded-xl shadow-sm border p-6">
          <div className="flex items-center gap-3">
            <div className={`w-3 h-3 rounded-full ${isConnected ? 'bg-green-500' : 'bg-red-500'}`} />
            <span className="font-medium">{isConnected ? 'Connected to Database' : 'Disconnected'}</span>
          </div>
          <p className="text-sm text-gray-500 mt-2">Breakeven Calculator v1.0.0</p>
          <div className="mt-4 p-4 bg-blue-50 rounded-lg">
            <h3 className="font-medium text-blue-800 mb-2">Data Sources</h3>
            <ul className="text-sm text-blue-700 space-y-1">
              <li>Fertilizer costs pulled from Fertilizer App</li>
              <li>Herbicide costs pulled from Spray-Suite applications</li>
              <li>Overhead, seed, and rent managed here</li>
            </ul>
          </div>
        </div>
      )}
    </div>
  );
}

// ============================================================================
// MAIN APP
// ============================================================================
function App() {
  const [currentPage, setCurrentPage] = useState('dashboard');
  const [isConnected, setIsConnected] = useState(null);
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [user, setUser] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);
  const currentYear = new Date().getFullYear();
  const [selectedCropYear, setSelectedCropYear] = useState(currentYear);

  useEffect(() => {
    async function checkAuth() {
      const { data: { session } } = await db.auth.getSession();
      if (!session) {
        window.location.href = 'login.html';
        return;
      }
      setUser(session.user);
      setAuthLoading(false);
    }
    checkAuth();
    const { data: { subscription } } = db.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_OUT' || !session) window.location.href = 'login.html';
      else setUser(session.user);
    });
    return () => subscription.unsubscribe();
  }, []);

  useEffect(() => { testConnection().then(setIsConnected); }, []);

  const handleLogout = async () => {
    await db.auth.signOut();
    window.location.href = 'login.html';
  };

  if (authLoading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <Icon name="loader" className="animate-spin text-blue-600" size={32} />
      </div>
    );
  }

  const renderPage = () => {
    switch (currentPage) {
      case 'dashboard': return <DashboardPage cropYear={selectedCropYear} onYearChange={setSelectedCropYear} />;
      case 'overhead': return <OverheadPage cropYear={selectedCropYear} onYearChange={setSelectedCropYear} />;
      case 'inputs': return <InputsPage cropYear={selectedCropYear} onYearChange={setSelectedCropYear} />;
      case 'crop-plans': return <CropPlansPage cropYear={selectedCropYear} onYearChange={setSelectedCropYear} />;
      case 'field-assignments': return <FieldAssignmentsPage cropYear={selectedCropYear} onYearChange={setSelectedCropYear} />;
      case 'breakeven': return <BreakevenPage cropYear={selectedCropYear} onYearChange={setSelectedCropYear} />;
      case 'landlord-report': return <LandlordReportPage cropYear={selectedCropYear} onYearChange={setSelectedCropYear} />;
      case 'settings': return <SettingsPage isConnected={isConnected} />;
      default: return <DashboardPage cropYear={selectedCropYear} onYearChange={setSelectedCropYear} />;
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Mobile header */}
      <div className="lg:hidden bg-white border-b px-4 py-3 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <button onClick={() => setIsSidebarOpen(true)} className="p-2 hover:bg-gray-100 rounded-lg"><Icon name="menu" size={20} /></button>
          <div className="flex items-center gap-2">
            <Icon name="target" size={24} className="text-blue-600" />
            <span className="font-bold text-gray-900">Breakeven</span>
          </div>
        </div>
        <div className="flex items-center gap-1">
          <a href="https://baldwinag.com/portal/graintrack" className="p-2 hover:bg-gray-100 rounded-lg" title="GrainTrack"><Icon name="wheat" size={18} className="text-amber-600" /></a>
          <a href="https://baldwinag.com/portal/fertilizer" className="p-2 hover:bg-gray-100 rounded-lg" title="Fertilizer"><Icon name="flask-conical" size={18} className="text-green-600" /></a>
          <a href="https://baldwinag.com/spray/manager" className="p-2 hover:bg-gray-100 rounded-lg" title="Spray-Suite"><Icon name="spray-can" size={18} className="text-purple-600" /></a>
        </div>
      </div>

      {/* Mobile sidebar overlay */}
      {isSidebarOpen && (
        <div className="lg:hidden fixed inset-0 z-50">
          <div className="fixed inset-0 bg-black bg-opacity-50" onClick={() => setIsSidebarOpen(false)} />
          <div className="fixed left-0 top-0 bottom-0 w-64 bg-white shadow-xl">
            <div className="p-4 border-b flex items-center justify-between">
              <div className="flex items-center gap-2">
                <Icon name="target" size={24} className="text-blue-600" />
                <span className="font-bold text-gray-900">Breakeven</span>
              </div>
              <button onClick={() => setIsSidebarOpen(false)} className="p-2 hover:bg-gray-100 rounded-lg"><Icon name="x" size={20} /></button>
            </div>
            <nav className="p-2">
              {navItems.map(item => (
                <button key={item.id} onClick={() => { setCurrentPage(item.id); setIsSidebarOpen(false); }}
                  className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left mb-1 ${currentPage === item.id ? 'bg-blue-100 text-blue-900' : 'text-gray-600 hover:bg-gray-100'}`}>
                  <Icon name={item.icon} size={20} />
                  <span className="font-medium">{item.label}</span>
                </button>
              ))}
            </nav>
          </div>
        </div>
      )}

      <div className="lg:flex">
        {/* Desktop sidebar */}
        <div className="hidden lg:block w-64 min-h-screen bg-white border-r">
          <div className="p-4 border-b">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <Icon name="target" size={28} className="text-blue-600" />
                <div>
                  <div className="font-bold text-gray-900">Breakeven Calculator</div>
                  <div className="text-xs text-gray-500">v1.0.0</div>
                </div>
              </div>
              <div className="flex items-center gap-1">
                <a href="https://baldwinag.com/portal/graintrack" className="p-2 hover:bg-gray-100 rounded-lg" title="GrainTrack"><Icon name="wheat" size={18} className="text-amber-600" /></a>
                <a href="https://baldwinag.com/portal/fertilizer" className="p-2 hover:bg-gray-100 rounded-lg" title="Fertilizer"><Icon name="flask-conical" size={18} className="text-green-600" /></a>
                <a href="https://baldwinag.com/spray/manager" className="p-2 hover:bg-gray-100 rounded-lg" title="Spray-Suite"><Icon name="spray-can" size={18} className="text-purple-600" /></a>
              </div>
            </div>
          </div>
          <nav className="p-2">
            {navItems.map(item => (
              <button key={item.id} onClick={() => setCurrentPage(item.id)}
                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left mb-1 ${currentPage === item.id ? 'bg-blue-100 text-blue-900' : 'text-gray-600 hover:bg-gray-100'}`}>
                <Icon name={item.icon} size={20} />
                <span className="font-medium">{item.label}</span>
              </button>
            ))}
          </nav>
          <div className="absolute bottom-0 left-0 w-64 p-4 border-t space-y-3">
            {user && (
              <div className="flex items-center justify-between">
                <span className="text-sm text-gray-700 truncate">{user.email}</span>
                <button onClick={handleLogout} className="p-2 text-gray-400 hover:text-red-500 rounded-lg" title="Sign out">
                  <Icon name="log-out" size={18} />
                </button>
              </div>
            )}
            <div className="flex items-center gap-2">
              <div className={`w-2 h-2 rounded-full ${isConnected ? 'bg-green-500' : isConnected === false ? 'bg-red-500' : 'bg-gray-300'}`} />
              <span className="text-sm text-gray-500">{isConnected ? 'Connected' : isConnected === false ? 'Disconnected' : 'Checking...'}</span>
            </div>
          </div>
        </div>

        {/* Main content */}
        <div className="flex-1 p-4 lg:p-8">{renderPage()}</div>
      </div>
    </div>
  );
}

// Render the app
ReactDOM.createRoot(document.getElementById('root')).render(
  <ToastProvider>
    <App />
  </ToastProvider>
);
</script>
</body>
</html>
