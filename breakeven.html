<!--
  Breakeven Calculator v2.5.0
  Cost aggregation and breakeven analysis
  Part of the Farm Management Suite
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Breakeven Calculator v2.5.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; }
    @media print {
      .lg\\:w-64, .lg\\:hidden, button:not(.print-show), select, .fixed { visibility: hidden; height: 0; overflow: hidden; }
      body { background: white !important; }
      .lg\\:pl-64 { padding-left: 0 !important; }
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useCallback, useMemo } = React;

// ============================================================================
// SUPABASE CLIENT
// ============================================================================
const SUPABASE_URL = 'https://xehapaasizntuzqzvwej.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhlaGFwYWFzaXpudHV6cXp2d2VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMTkwOTksImV4cCI6MjA4Mzg5NTA5OX0.JTtRaVRfZ4DNddTdT2BsKgCNabErgsCB0rBCHlK0mbA';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

async function testConnection() {
  try {
    const { error } = await db.from('commodities').select('id').limit(1);
    return !error;
  } catch { return false; }
}

// ============================================================================
// ICONS
// ============================================================================
const ICON_FALLBACKS = {
  'pencil': 'âœï¸', 'trash-2': 'ðŸ—‘ï¸', 'plus': '+', 'check': 'âœ”', 'x': 'âœ•',
  'refresh-cw': 'â†»', 'download': 'â¬‡ï¸', 'home': 'ðŸ ', 'settings': 'âš™ï¸',
  'layout-dashboard': 'ðŸ“Š', 'menu': 'â˜°', 'chevron-down': 'â–¼',
  'search': 'ðŸ”', 'save': 'ðŸ’¾', 'link': 'ðŸ”—', 'map-pin': 'ðŸ“',
  'package': 'ðŸ“¦', 'calculator': 'ðŸ§®', 'flask-conical': 'ðŸ§ª', 'wheat': 'ðŸŒ¾',
  'spray-can': 'ðŸ’¨', 'calendar': 'ðŸ“…', 'dollar-sign': '$', 'user': 'ðŸ‘¤',
  'log-out': 'â†’', 'loader': 'âŸ³', 'target': 'ðŸŽ¯', 'building': 'ðŸ¢',
  'tractor': 'ðŸšœ', 'sprout': 'ðŸŒ±', 'land-plot': 'ðŸ“', 'layers': 'ðŸ“š',
  'pie-chart': 'ðŸ¥§', 'bar-chart-3': 'ðŸ“Š', 'trending-up': 'ðŸ“ˆ',
  'file-text': 'ðŸ“„', 'users': 'ðŸ‘¥', 'alert-triangle': 'âš ï¸', 'info': 'â„¹ï¸',
  'alert-circle': 'âš ï¸', 'check-circle': 'âœ“', 'external-link': 'â†—', 'map': 'ðŸ—ºï¸'
};

function Icon({ name, size = 20, className = '' }) {
  const ref = React.useRef(null);
  useEffect(() => {
    if (ref.current) {
      try {
        if (window.lucide?.icons?.[name]) {
          ref.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size });
        } else {
          ref.current.innerHTML = ICON_FALLBACKS[name] || '*';
        }
      } catch { ref.current.innerHTML = ICON_FALLBACKS[name] || '*'; }
    }
  }, [name, size]);
  return <span ref={ref} className={`inline-flex items-center justify-center ${className}`} style={{ minWidth: size, minHeight: size }} />;
}

// ============================================================================
// TOAST SYSTEM
// ============================================================================
const ToastContext = React.createContext(null);

function ToastProvider({ children }) {
  const [toasts, setToasts] = useState([]);
  const addToast = useCallback((message, options = {}) => {
    const id = Date.now();
    setToasts(prev => [...prev, { id, message, type: options.type || 'info' }]);
    setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 4000);
    return id;
  }, []);
  const removeToast = useCallback((id) => setToasts(prev => prev.filter(t => t.id !== id)), []);
  return (
    <ToastContext.Provider value={{ addToast, removeToast }}>
      {children}
      <div className="fixed bottom-4 right-4 z-50 flex flex-col gap-2">
        {toasts.map(toast => (
          <div key={toast.id} className={`${toast.type === 'success' ? 'bg-green-600' : toast.type === 'error' ? 'bg-red-600' : 'bg-gray-800'} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 min-w-72`}>
            <span className="flex-1">{toast.message}</span>
            <button onClick={() => removeToast(toast.id)} className="hover:opacity-75"><Icon name="x" size={16} /></button>
          </div>
        ))}
      </div>
    </ToastContext.Provider>
  );
}

function useToast() {
  const context = React.useContext(ToastContext);
  if (!context) throw new Error('useToast must be used within ToastProvider');
  return context;
}

// ============================================================================
// MODAL
// ============================================================================
function Modal({ isOpen, onClose, title, children, size = 'md' }) {
  if (!isOpen) return null;
  const sizeClass = size === 'lg' ? 'max-w-3xl' : size === 'xl' ? 'max-w-5xl' : 'max-w-lg';
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
      <div className="fixed inset-0 bg-black bg-opacity-50" onClick={onClose} />
      <div className={`relative bg-white rounded-lg shadow-xl w-full ${sizeClass} max-h-[90vh] overflow-y-auto`}>
        <div className="flex items-center justify-between p-4 border-b">
          <h3 className="text-lg font-semibold text-gray-900">{title}</h3>
          <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg"><Icon name="x" size={20} /></button>
        </div>
        <div className="p-4">{children}</div>
      </div>
    </div>
  );
}

function ConfirmModal({ isOpen, title, message, onConfirm, onCancel }) {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      <div className="fixed inset-0 bg-black bg-opacity-50" onClick={onCancel} />
      <div className="relative bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
        <h3 className="text-lg font-semibold text-gray-900 mb-2">{title}</h3>
        <p className="text-gray-600 mb-6">{message}</p>
        <div className="flex justify-end gap-3">
          <button onClick={onCancel} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
          <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirm</button>
        </div>
      </div>
    </div>
  );
}

// ============================================================================
// UTILITIES
// ============================================================================
const formatDate = (d) => d ? new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
const formatCurrency = (v) => v != null ? '$' + Number(v).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-';
const formatNumber = (v, dec = 0) => v != null ? Number(v).toLocaleString('en-US', { maximumFractionDigits: dec }) : '-';
const formatPrice = (v) => v != null ? '$' + Number(v).toFixed(4) : '-';

// ============================================================================
// DATA SERVICES
// ============================================================================

// Commodities
async function getCommodities() {
  const { data, error } = await db.from('commodities').select('*').eq('active', true).order('sort_order');
  return error ? [] : data || [];
}

// Fields & Production (with landlord/tenant info)
async function getFieldCropYears(cropYear) {
  const { data, error } = await db.from('field_crop_years').select('*, fields(id, name, acres, farm_id, tenant_share, landlord, farms(name, adams_grain_share)), commodities(id, name)').eq('crop_year', cropYear).is('deleted_at', null);
  if (error) return [];
  return (data || []).map(f => {
    // Parse tenant_share as number (Supabase may return as string)
    const tenantShare = f.fields?.tenant_share != null ? Number(f.fields.tenant_share) : 1;
    return {
      ...f,
      field_id: f.fields?.id,
      field_name: f.fields?.name,
      field_acres: f.fields?.acres,
      farm_name: f.fields?.farms?.name,
      commodity_name: f.commodities?.name,
      tenant_share: tenantShare,
      landlord: f.fields?.landlord,
      effective_share: tenantShare * (f.fields?.farms?.adams_grain_share || 1)
    };
  });
}

// Overhead Categories - deduplicate by name to handle duplicate records
async function getOverheadCategories() {
  const { data, error } = await db.from('be_overhead_categories').select('*').eq('active', true).is('deleted_at', null).order('sort_order');
  if (error) {
    console.error('Error loading overhead categories:', error);
    return [];
  }
  console.log('Loaded overhead categories:', data);
  // Deduplicate by name (keep first occurrence)
  const seen = new Set();
  return (data || []).filter(cat => {
    if (seen.has(cat.name)) return false;
    seen.add(cat.name);
    return true;
  });
}

// Overhead Expenses
async function getOverheadExpenses(cropYear) {
  const { data, error } = await db.from('be_overhead_expenses').select('*, be_overhead_categories(name, is_family_living, is_debt_service), be_overhead_allocations(commodity_id, practice_type, commodities(name)), fields(name)').eq('crop_year', cropYear).is('deleted_at', null).order('name');
  return error ? [] : data || [];
}

async function saveOverheadExpense(expense, allocations = []) {
  const expenseData = {
    name: expense.name,
    category_id: expense.category_id,
    amount: expense.amount,
    allocation_type: expense.allocation_type,
    entry_mode: expense.entry_mode || 'TOTAL',
    per_acre_amount: expense.per_acre_amount || null,
    field_id: expense.field_id || null,
    notes: expense.notes
  };

  if (expense.id) {
    const { error } = await db.from('be_overhead_expenses').update({ ...expenseData, updated_at: new Date().toISOString() }).eq('id', expense.id);
    if (error) throw error;
    await db.from('be_overhead_allocations').delete().eq('expense_id', expense.id);
    if (allocations.length > 0) {
      await db.from('be_overhead_allocations').insert(allocations.map(a => ({ expense_id: expense.id, commodity_id: a.commodity_id, practice_type: a.practice_type || null })));
    }
    return expense;
  } else {
    const { data, error } = await db.from('be_overhead_expenses').insert([{ ...expenseData, crop_year: expense.crop_year }]).select().single();
    if (error) throw error;
    if (allocations.length > 0) {
      await db.from('be_overhead_allocations').insert(allocations.map(a => ({ expense_id: data.id, commodity_id: a.commodity_id, practice_type: a.practice_type || null })));
    }
    return data;
  }
}

async function deleteOverheadExpense(id) {
  const { error } = await db.from('be_overhead_expenses').update({ deleted_at: new Date().toISOString() }).eq('id', id);
  if (error) throw error;
}

// Seed Costs
async function getSeedCosts(cropYear) {
  const { data, error } = await db.from('be_seed_costs').select('*, field_crop_years(id, field_id, commodity_id, planted_acres, fields(name, farms(name)), commodities(name))').is('deleted_at', null);
  if (error) return [];
  return (data || []).filter(s => s.field_crop_years?.id).map(s => ({
    ...s,
    field_name: s.field_crop_years?.fields?.name,
    farm_name: s.field_crop_years?.fields?.farms?.name,
    commodity_name: s.field_crop_years?.commodities?.name,
    planted_acres: s.field_crop_years?.planted_acres
  }));
}

async function saveSeedCost(seed) {
  if (seed.id) {
    const { error } = await db.from('be_seed_costs').update({ variety: seed.variety, brand: seed.brand, price_per_bag: seed.price_per_bag, seeds_per_bag: seed.seeds_per_bag, seeding_rate: seed.seeding_rate, total_cost: seed.total_cost, notes: seed.notes }).eq('id', seed.id);
    if (error) throw error;
    return seed;
  } else {
    const { data, error } = await db.from('be_seed_costs').insert([seed]).select().single();
    if (error) throw error;
    return data;
  }
}

async function deleteSeedCost(id) {
  const { error } = await db.from('be_seed_costs').update({ deleted_at: new Date().toISOString() }).eq('id', id);
  if (error) throw error;
}

// Seed Products (Catalog)
async function getSeedProducts(cropYear) {
  const { data, error } = await db.from('be_seed_products').select('*, commodities(name)').eq('crop_year', cropYear).eq('active', true).is('deleted_at', null).order('brand').order('hybrid');
  if (error) {
    console.error('Error loading seed products:', error);
    return [];
  }
  return (data || []).map(p => ({
    ...p,
    commodity_name: p.commodities?.name
  }));
}

async function saveSeedProduct(product, cropYear) {
  const productData = {
    crop_year: cropYear,
    commodity_id: product.commodity_id,
    brand: product.brand,
    hybrid: product.hybrid,
    relative_maturity: product.relative_maturity,
    traits: product.traits,
    seeds_per_bag: product.seeds_per_bag,
    price_per_bag: product.price_per_bag,
    default_seeding_rate: product.default_seeding_rate,
    practice_type: product.practice_type,
    notes: product.notes,
    active: true
  };

  if (product.id) {
    const { error } = await db.from('be_seed_products').update(productData).eq('id', product.id);
    if (error) throw error;
    return { ...product, ...productData };
  } else {
    const { data, error } = await db.from('be_seed_products').insert([productData]).select().single();
    if (error) throw error;
    return data;
  }
}

async function deleteSeedProduct(id) {
  const { error } = await db.from('be_seed_products').update({ deleted_at: new Date().toISOString(), active: false }).eq('id', id);
  if (error) throw error;
}

// Land Rent
async function getLandRent(cropYear) {
  const { data, error } = await db.from('be_land_rent').select('*, fields(name, acres, farms(name))').eq('crop_year', cropYear).is('deleted_at', null);
  return error ? [] : (data || []).map(r => ({ ...r, field_name: r.fields?.name, farm_name: r.fields?.farms?.name, field_acres: r.fields?.acres }));
}

async function saveLandRent(rent) {
  const existing = await db.from('be_land_rent').select('id').eq('field_id', rent.field_id).eq('crop_year', rent.crop_year).is('deleted_at', null).maybeSingle();
  if (existing.data) {
    const { error } = await db.from('be_land_rent').update({ rent_type: rent.rent_type, rent_per_acre: rent.rent_per_acre, notes: rent.notes }).eq('id', existing.data.id);
    if (error) throw error;
    return { ...rent, id: existing.data.id };
  } else {
    const { data, error } = await db.from('be_land_rent').insert([rent]).select().single();
    if (error) throw error;
    return data;
  }
}

async function deleteLandRent(id) {
  const { error } = await db.from('be_land_rent').update({ deleted_at: new Date().toISOString() }).eq('id', id);
  if (error) throw error;
}

// Get Fertilizer Costs from Fertilizer App
async function getFertilizerCosts(cropYear) {
  const { data: apps, error } = await db.from('fert_applications').select('field_id, total_cost, acres_applied').eq('crop_year', cropYear).is('deleted_at', null);
  if (error) return {};
  const byField = {};
  (apps || []).forEach(a => {
    if (!byField[a.field_id]) byField[a.field_id] = 0;
    byField[a.field_id] += a.total_cost || 0;
  });
  return byField;
}

// Get Herbicide Costs from Spray-Suite with split info
// Returns { fieldId: { total, splitCost, nonSplitCost } }
// The 'split' column on application_products is 'Y' or 'N' (set from tank_mix or manually)
async function getHerbicideCosts(cropYear) {
  const startDate = `${cropYear - 1}-09-01`;
  const endDate = `${cropYear}-08-31`;

  // Get applications with their products
  // Split flag is on application_products table
  const { data: apps, error } = await db
    .from('applications')
    .select(`
      id,
      field_id,
      total_cost,
      application_products(
        product_id,
        total_cost,
        split
      )
    `)
    .gte('date', startDate)
    .lte('date', endDate);

  if (error) {
    console.error('Error fetching herbicide costs:', error);
    return {};
  }

  const byField = {};
  (apps || []).forEach(app => {
    if (!byField[app.field_id]) {
      byField[app.field_id] = { total: 0, splitCost: 0, nonSplitCost: 0 };
    }

    const products = app.application_products || [];
    if (products.length > 0) {
      // Sum by 'split' flag ('Y' = shared with landlord, 'N' = 100% tenant)
      // Split flag is on application_products table
      products.forEach(p => {
        const cost = p.total_cost || 0;
        const isSplit = p.split === 'Y' || p.split === true;

        byField[app.field_id].total += cost;
        if (isSplit) {
          byField[app.field_id].splitCost += cost;
        } else {
          byField[app.field_id].nonSplitCost += cost;
        }
      });
    } else {
      // Fallback: no product detail, use application total (assume not split for burndowns)
      byField[app.field_id].total += app.total_cost || 0;
      byField[app.field_id].nonSplitCost += app.total_cost || 0;
    }
  });

  return byField;
}

// Get Planned Herbicide Costs from Field Crop Plans
// Returns { fieldId: { total, splitCost, nonSplitCost } }
async function getPlannedHerbicideCosts(cropYear) {
  // Get field crop plans with herbicide passes
  // Note: be_field_crop_plans doesn't have crop_year, so we filter by field_crop_years.crop_year
  const { data: fieldPlans, error } = await db
    .from('be_field_crop_plans')
    .select(`
      *,
      field_crop_years!inner(id, field_id, crop_year, planted_acres, fields(tenant_share, farms(adams_grain_share))),
      be_field_herbicide_passes(*, be_herbicide_plans(name, estimated_cost_per_acre))
    `)
    .eq('field_crop_years.crop_year', cropYear)
    .is('deleted_at', null);

  if (error) {
    console.error('Error fetching planned herbicide costs:', error);
    return {};
  }

  const byField = {};
  (fieldPlans || []).forEach(plan => {
    const fcy = plan.field_crop_years;
    if (!fcy) return;

    const fieldId = fcy.field_id;
    if (!byField[fieldId]) {
      byField[fieldId] = { total: 0, splitCost: 0, nonSplitCost: 0 };
    }

    const acres = fcy.planted_acres || 0;

    // Check for override first ($/acre)
    if (plan.herbicide_cost_override && plan.herbicide_cost_override > 0) {
      const totalCost = plan.herbicide_cost_override * acres;
      // NOTE: Planned costs don't track split vs non-split yet
      // Defaulting to non-split (100% tenant) - actual costs from Spray-Suite have split marked
      byField[fieldId].total += totalCost;
      byField[fieldId].nonSplitCost += totalCost;
    } else if (plan.be_field_herbicide_passes && plan.be_field_herbicide_passes.length > 0) {
      // Calculate from herbicide passes
      plan.be_field_herbicide_passes.forEach(pass => {
        const herbPlan = pass.be_herbicide_plans;
        if (herbPlan && herbPlan.estimated_cost_per_acre) {
          const cost = herbPlan.estimated_cost_per_acre * acres;
          // NOTE: Planned costs don't track split vs non-split yet
          // Defaulting to non-split (100% tenant) - actual costs from Spray-Suite have split marked
          byField[fieldId].total += cost;
          byField[fieldId].nonSplitCost += cost;
        }
      });
    }
  });

  return byField;
}

// Get Fertilizer Costs from Fertilizer App with split info
// Fertilizer is ALWAYS split with landlord
async function getFertilizerCostsDetailed(cropYear) {
  const { data: apps, error } = await db
    .from('fert_applications')
    .select('field_id, total_cost, acres_applied')
    .eq('crop_year', cropYear)
    .is('deleted_at', null);

  if (error) return {};

  const byField = {};
  (apps || []).forEach(a => {
    if (!byField[a.field_id]) byField[a.field_id] = { total: 0, splitCost: 0 };
    const cost = a.total_cost || 0;
    byField[a.field_id].total += cost;
    byField[a.field_id].splitCost += cost; // All fertilizer is split
  });

  return byField;
}

// Get all fields for rent assignment (with landlord/tenant info)
async function getFields() {
  const { data, error } = await db.from('fields').select('*, farms(name, adams_grain_share)').eq('active', true).order('name');
  return error ? [] : (data || []).map(f => ({
    ...f,
    farm_name: f.farms?.name,
    effective_share: (f.tenant_share || 1) * (f.farms?.adams_grain_share || 1)
  }));
}

// ============================================================================
// GRAINTRACK INTEGRATION - Contracts & Marketing
// ============================================================================

// Get contracted bushels and blended average prices from GrainTrack
async function getContractedPositions(cropYear) {
  // Query contracts from GrainTrack (CASH, FORWARD, SPOT, HTA types)
  // Try with minimal columns first in case some don't exist
  const { data: contracts, error } = await db.from('contracts')
    .select('commodity_id, contract_type, bushels, price')
    .eq('crop_year', cropYear)
    .in('contract_type', ['CASH', 'FORWARD', 'SPOT', 'HTA'])
    .is('deleted_at', null);

  if (error) {
    console.error('Error fetching contracts:', error);
    return {};
  }

  // Calculate blended average and total contracted bushels per commodity
  const positions = {};
  (contracts || []).forEach(c => {
    if (!positions[c.commodity_id]) {
      positions[c.commodity_id] = {
        contracted_bushels: 0,
        total_revenue: 0,
        blended_avg_price: 0
      };
    }

    const bushels = c.bushels || 0;
    const price = c.price || 0;
    const revenue = bushels * price;

    positions[c.commodity_id].contracted_bushels += bushels;
    positions[c.commodity_id].total_revenue += revenue;
  });

  // Calculate weighted average price
  Object.keys(positions).forEach(commodityId => {
    const pos = positions[commodityId];
    if (pos.contracted_bushels > 0) {
      pos.blended_avg_price = pos.total_revenue / pos.contracted_bushels;
    }
  });

  return positions;
}

// Get or create target prices for uncontracted bushels
async function getTargetPrices(cropYear) {
  const { data, error } = await db.from('be_target_prices')
    .select('*')
    .eq('crop_year', cropYear)
    .is('deleted_at', null);

  if (error) {
    console.log('Target prices not available (feature may not be set up yet):', error.message);
    return [];
  }

  return data || [];
}

// Save target price for uncontracted bushels
async function saveTargetPrice(cropYear, commodityId, targetPrice) {
  const { data: existing } = await db.from('be_target_prices')
    .select('id')
    .eq('crop_year', cropYear)
    .eq('commodity_id', commodityId)
    .is('deleted_at', null)
    .maybeSingle();

  const priceData = {
    crop_year: cropYear,
    commodity_id: commodityId,
    target_price: targetPrice,
    updated_at: new Date().toISOString()
  };

  if (existing) {
    const { error } = await db.from('be_target_prices')
      .update(priceData)
      .eq('id', existing.id);
    if (error) throw error;
  } else {
    const { error } = await db.from('be_target_prices')
      .insert([priceData]);
    if (error) throw error;
  }
}

// ============================================================================
// COMPREHENSIVE CROP PLANS (Phase 2)
// ============================================================================

// Get all crop plans with nested data
async function getCropPlans(cropYear) {
  const { data, error } = await db.from('be_crop_plans')
    .select(`
      *,
      commodities(name),
      be_crop_plan_seed(*),
      be_crop_plan_custom_costs(*),
      be_crop_plan_fertilizer(*, be_crop_plan_fertilizer_products(*)),
      be_crop_plan_chemicals(*, be_crop_plan_chemical_products(*))
    `)
    .eq('crop_year', cropYear)
    .eq('active', true)
    .is('deleted_at', null)
    .order('name');

  if (error) return [];
  return (data || []).map(p => ({
    ...p,
    commodity_name: p.commodities?.name,
    seed: p.be_crop_plan_seed?.[0] || null,
    custom_costs: (p.be_crop_plan_custom_costs || []).sort((a, b) => a.sort_order - b.sort_order),
    fertilizer_passes: (p.be_crop_plan_fertilizer || []).sort((a, b) => a.sort_order - b.sort_order).map(fp => ({
      ...fp,
      products: (fp.be_crop_plan_fertilizer_products || []).sort((a, b) => a.sort_order - b.sort_order)
    })),
    chemical_passes: (p.be_crop_plan_chemicals || []).sort((a, b) => a.sort_order - b.sort_order).map(cp => ({
      ...cp,
      products: (cp.be_crop_plan_chemical_products || []).sort((a, b) => a.sort_order - b.sort_order)
    }))
  }));
}

// Save crop plan (main record only)
async function saveCropPlan(plan) {
  const planData = {
    name: plan.name,
    commodity_id: plan.commodity_id || null,
    practice_type: plan.practice_type || null,
    crop_year: plan.crop_year,
    description: plan.description || null,
    updated_at: new Date().toISOString()
  };

  if (plan.id) {
    const { error } = await db.from('be_crop_plans').update(planData).eq('id', plan.id);
    if (error) throw error;
    return { ...plan, ...planData };
  } else {
    const { data, error } = await db.from('be_crop_plans').insert([planData]).select().single();
    if (error) throw error;
    return data;
  }
}

// Delete crop plan (soft delete)
async function deleteCropPlan(id) {
  const { error } = await db.from('be_crop_plans').update({ deleted_at: new Date().toISOString(), active: false }).eq('id', id);
  if (error) throw error;
}

// Save seed config for a plan
async function saveCropPlanSeed(planId, seed) {
  // Delete existing seed first
  await db.from('be_crop_plan_seed').delete().eq('crop_plan_id', planId);

  if (!seed || (!seed.brand && !seed.hybrid && !seed.price_per_bag)) return null;

  const { data, error } = await db.from('be_crop_plan_seed').insert([{
    crop_plan_id: planId,
    brand: seed.brand || null,
    hybrid: seed.hybrid || null,
    seeds_per_bag: seed.seeds_per_bag || 80000,
    price_per_bag: seed.price_per_bag || null,
    default_seeding_rate: seed.default_seeding_rate || null,
    treatment: seed.treatment || null,
    notes: seed.notes || null
  }]).select().single();

  if (error) throw error;
  return data;
}

// Save custom costs for a plan
async function saveCropPlanCustomCosts(planId, costs) {
  // Delete existing costs first
  await db.from('be_crop_plan_custom_costs').delete().eq('crop_plan_id', planId);

  if (!costs || costs.length === 0) return [];

  const { data, error } = await db.from('be_crop_plan_custom_costs').insert(
    costs.map((c, i) => ({
      crop_plan_id: planId,
      name: c.name,
      cost_type: c.cost_type || 'PER_ACRE',
      amount: c.amount,
      unit: c.unit || '/acre',
      timing: c.timing || null,
      notes: c.notes || null,
      sort_order: i
    }))
  ).select();

  if (error) throw error;
  return data;
}

// Save fertilizer passes for a plan
async function saveCropPlanFertilizer(planId, passes) {
  // Delete existing passes (cascade deletes products)
  await db.from('be_crop_plan_fertilizer').delete().eq('crop_plan_id', planId);

  if (!passes || passes.length === 0) return [];

  const savedPasses = [];
  for (let i = 0; i < passes.length; i++) {
    const pass = passes[i];
    const { data: passData, error: passError } = await db.from('be_crop_plan_fertilizer').insert([{
      crop_plan_id: planId,
      pass_name: pass.pass_name,
      timing: pass.timing || null,
      application_method: pass.application_method || null,
      notes: pass.notes || null,
      sort_order: i
    }]).select().single();

    if (passError) throw passError;

    // Save products for this pass
    if (pass.products && pass.products.length > 0) {
      const { error: prodError } = await db.from('be_crop_plan_fertilizer_products').insert(
        pass.products.map((p, j) => ({
          fertilizer_pass_id: passData.id,
          product_id: p.product_id || null,
          product_name: p.product_name,
          rate: p.rate,
          rate_unit: p.rate_unit || 'lb/acre',
          price_per_unit: p.price_per_unit || null,
          notes: p.notes || null,
          sort_order: j
        }))
      );
      if (prodError) throw prodError;
    }

    savedPasses.push(passData);
  }

  return savedPasses;
}

// Save chemical passes for a plan
async function saveCropPlanChemicals(planId, passes) {
  // Delete existing passes (cascade deletes products)
  await db.from('be_crop_plan_chemicals').delete().eq('crop_plan_id', planId);

  if (!passes || passes.length === 0) return [];

  const savedPasses = [];
  for (let i = 0; i < passes.length; i++) {
    const pass = passes[i];
    const { data: passData, error: passError } = await db.from('be_crop_plan_chemicals').insert([{
      crop_plan_id: planId,
      pass_name: pass.pass_name,
      timing: pass.timing || null,
      tank_mix_id: pass.tank_mix_id || null,
      application_method: pass.application_method || null,
      notes: pass.notes || null,
      sort_order: i
    }]).select().single();

    if (passError) throw passError;

    // Save products for this pass
    if (pass.products && pass.products.length > 0) {
      const { error: prodError } = await db.from('be_crop_plan_chemical_products').insert(
        pass.products.map((p, j) => ({
          chemical_pass_id: passData.id,
          product_id: p.product_id || null,
          product_name: p.product_name,
          rate: p.rate,
          rate_unit: p.rate_unit || 'oz/acre',
          price_per_unit: p.price_per_unit || null,
          notes: p.notes || null,
          sort_order: j
        }))
      );
      if (prodError) throw prodError;
    }

    savedPasses.push(passData);
  }

  return savedPasses;
}

// Calculate total cost per acre for a crop plan
function calculateCropPlanCost(plan) {
  let total = 0;

  // Seed cost
  if (plan.seed?.price_per_bag && plan.seed?.default_seeding_rate && plan.seed?.seeds_per_bag) {
    const bagsPerAcre = plan.seed.default_seeding_rate / plan.seed.seeds_per_bag;
    total += bagsPerAcre * plan.seed.price_per_bag;
  }

  // Custom costs (only per-acre for now)
  for (const cost of plan.custom_costs || []) {
    if (cost.cost_type === 'PER_ACRE') {
      total += cost.amount || 0;
    }
  }

  // Fertilizer passes
  for (const pass of plan.fertilizer_passes || []) {
    for (const prod of pass.products || []) {
      if (prod.rate && prod.price_per_unit) {
        total += prod.rate * prod.price_per_unit;
      }
    }
  }

  // Chemical passes
  for (const pass of plan.chemical_passes || []) {
    for (const prod of pass.products || []) {
      if (prod.rate && prod.price_per_unit) {
        total += prod.rate * prod.price_per_unit;
      }
    }
  }

  return total;
}

// ============================================================================
// FIELD PLAN ASSIGNMENTS (Phase 4)
// ============================================================================

// Get field assignments with crop plan details
async function getFieldPlanAssignments(cropYear) {
  const { data, error } = await db.from('be_field_plan_assignments')
    .select(`
      *,
      be_crop_plans(*),
      field_crop_years(id, field_id, commodity_id, crop_year, planted_acres, expected_yield,
        fields(id, name, acres, farm_id, tenant_share, landlord,
          farms(name, adams_grain_share)),
        commodities(id, name)
      )
    `)
    .is('deleted_at', null);

  if (error) {
    console.log('Field plan assignments not available (table may not exist yet):', error.message);
    return [];
  }

  // Filter by crop year from field_crop_years
  return (data || []).filter(a =>
    a.field_crop_years && a.field_crop_years.crop_year === cropYear
  ).map(a => ({
    ...a,
    plan: a.be_crop_plans,
    field_crop_year_id: a.field_crop_years?.id,
    field_id: a.field_crop_years?.field_id,
    field_name: a.field_crop_years?.fields?.name,
    field_acres: a.field_crop_years?.fields?.acres,
    farm_name: a.field_crop_years?.fields?.farms?.name,
    adams_grain_share: a.field_crop_years?.fields?.farms?.adams_grain_share ?? 1,
    commodity_id: a.field_crop_years?.commodity_id,
    commodity_name: a.field_crop_years?.commodities?.name,
    planted_acres: a.field_crop_years?.planted_acres,
    expected_yield: a.field_crop_years?.expected_yield,
    tenant_share: Number(a.field_crop_years?.fields?.tenant_share ?? 1),
    landlord: a.field_crop_years?.fields?.landlord
  }));
}

// Save field plan assignment
async function saveFieldPlanAssignment(assignment) {
  const data = {
    field_crop_year_id: assignment.field_crop_year_id,
    crop_plan_id: assignment.crop_plan_id,
    seed_override_hybrid: assignment.seed_override_hybrid || null,
    seed_override_brand: assignment.seed_override_brand || null,
    seed_override_rate: assignment.seed_override_rate || null,
    seed_override_price: assignment.seed_override_price || null,
    status: assignment.status || 'PLANNED',
    notes: assignment.notes || null,
    updated_at: new Date().toISOString()
  };

  if (assignment.id) {
    const { error } = await db.from('be_field_plan_assignments').update(data).eq('id', assignment.id);
    if (error) throw error;
    return { ...assignment, ...data };
  } else {
    const { data: newData, error } = await db.from('be_field_plan_assignments').insert([data]).select().single();
    if (error) throw error;
    return newData;
  }
}

// Delete field plan assignment
async function deleteFieldPlanAssignment(id) {
  const { error } = await db.from('be_field_plan_assignments').update({ deleted_at: new Date().toISOString() }).eq('id', id);
  if (error) throw error;
}

// Bulk assign crop plan to multiple fields
async function bulkAssignCropPlan(fieldCropYearIds, cropPlanId) {
  const results = [];
  for (const fcyId of fieldCropYearIds) {
    // Check if assignment already exists
    const { data: existing } = await db.from('be_field_plan_assignments')
      .select('id')
      .eq('field_crop_year_id', fcyId)
      .is('deleted_at', null)
      .single();

    if (existing) {
      // Update existing
      const { error } = await db.from('be_field_plan_assignments')
        .update({ crop_plan_id: cropPlanId, updated_at: new Date().toISOString() })
        .eq('id', existing.id);
      if (error) throw error;
      results.push({ fcyId, action: 'updated' });
    } else {
      // Insert new
      const { error } = await db.from('be_field_plan_assignments')
        .insert([{ field_crop_year_id: fcyId, crop_plan_id: cropPlanId }]);
      if (error) throw error;
      results.push({ fcyId, action: 'created' });
    }
  }
  return results;
}

// ============================================================================
// LEGACY HERBICIDE/FERTILIZER PLANS (keep for backward compatibility)
// ============================================================================

// Herbicide Plans
async function getHerbicidePlans() {
  const { data, error } = await db.from('be_herbicide_plans').select('*, commodities(name)').eq('active', true).is('deleted_at', null).order('name');
  return error ? [] : (data || []).map(p => ({ ...p, commodity_name: p.commodities?.name }));
}

async function saveHerbicidePlan(plan) {
  if (plan.id) {
    const { error } = await db.from('be_herbicide_plans').update({
      name: plan.name,
      commodity_id: plan.commodity_id || null,
      description: plan.description,
      tank_mix_id: plan.tank_mix_id || null,
      estimated_cost_per_acre: plan.estimated_cost_per_acre
    }).eq('id', plan.id);
    if (error) throw error;
    return plan;
  } else {
    const { data, error } = await db.from('be_herbicide_plans').insert([plan]).select().single();
    if (error) throw error;
    return data;
  }
}

async function deleteHerbicidePlan(id) {
  const { error } = await db.from('be_herbicide_plans').update({ deleted_at: new Date().toISOString() }).eq('id', id);
  if (error) throw error;
}

// Fertilizer Plans (from Fertilizer App)
async function getFertilizerPlans() {
  const { data, error } = await db.from('fert_plans').select('*, commodities(name), fert_plan_products(*, fert_products(name, unit))').eq('active', true).is('deleted_at', null).order('name');
  return error ? [] : (data || []).map(p => ({
    ...p,
    commodity_name: p.commodities?.name,
    products: p.fert_plan_products || []
  }));
}

// Field Crop Plans
async function getFieldCropPlans(cropYear) {
  const { data, error } = await db.from('be_field_crop_plans')
    .select('*, field_crop_years(id, field_id, commodity_id, planted_acres, fields(name, farms(name), tenant_share, landlord), commodities(name)), fert_plans(name), be_field_herbicide_passes(*, be_herbicide_plans(name, estimated_cost_per_acre))')
    .is('deleted_at', null);
  if (error) return [];
  return (data || []).filter(p => p.field_crop_years).map(p => ({
    ...p,
    field_id: p.field_crop_years?.field_id,
    field_name: p.field_crop_years?.fields?.name,
    farm_name: p.field_crop_years?.fields?.farms?.name,
    commodity_id: p.field_crop_years?.commodity_id,
    commodity_name: p.field_crop_years?.commodities?.name,
    planted_acres: p.field_crop_years?.planted_acres,
    tenant_share: p.field_crop_years?.fields?.tenant_share || 1,
    landlord: p.field_crop_years?.fields?.landlord,
    fert_plan_name: p.fert_plans?.name,
    herbicide_passes: p.be_field_herbicide_passes || []
  }));
}

async function saveFieldCropPlan(plan) {
  if (plan.id) {
    const { error } = await db.from('be_field_crop_plans').update({
      seed_variety: plan.seed_variety,
      seed_brand: plan.seed_brand,
      seeding_rate: plan.seeding_rate,
      fertilizer_plan_id: plan.fertilizer_plan_id || null,
      fertilizer_plan_override: plan.fertilizer_plan_override || null,
      herbicide_cost_override: plan.herbicide_cost_override || null,
      notes: plan.notes,
      updated_at: new Date().toISOString()
    }).eq('id', plan.id);
    if (error) throw error;
    return plan;
  } else {
    const { data, error } = await db.from('be_field_crop_plans').insert([{
      field_crop_year_id: plan.field_crop_year_id,
      seed_variety: plan.seed_variety,
      seed_brand: plan.seed_brand,
      seeding_rate: plan.seeding_rate,
      fertilizer_plan_id: plan.fertilizer_plan_id || null,
      fertilizer_plan_override: plan.fertilizer_plan_override || null,
      herbicide_cost_override: plan.herbicide_cost_override || null,
      notes: plan.notes
    }]).select().single();
    if (error) throw error;
    return data;
  }
}

async function deleteFieldCropPlan(id) {
  const { error } = await db.from('be_field_crop_plans').update({ deleted_at: new Date().toISOString() }).eq('id', id);
  if (error) throw error;
}

// Herbicide Passes for a field crop plan
async function saveHerbicidePasses(fieldCropPlanId, passes) {
  // Delete existing passes
  await db.from('be_field_herbicide_passes').delete().eq('field_crop_plan_id', fieldCropPlanId);
  // Insert new passes
  if (passes.length > 0) {
    const { error } = await db.from('be_field_herbicide_passes').insert(
      passes.map((p, i) => ({
        field_crop_plan_id: fieldCropPlanId,
        herbicide_plan_id: p.herbicide_plan_id,
        pass_name: p.pass_name,
        planned_date: p.planned_date || null,
        sort_order: i
      }))
    );
    if (error) throw error;
  }
}

// Get Spray-Suite tank mixes with products (for linking herbicide plans)
async function getTankMixes() {
  const { data, error } = await db.from('tank_mixes')
    .select(`
      id, name,
      tank_mix_products(
        id, rate, unit, method, split,
        products(id, commercial_name, unit_of_measure, default_price)
      )
    `)
    .eq('active', true)
    .order('name');

  if (error) {
    console.error('Error loading tank mixes:', error);
    return [];
  }

  console.log('Loaded tank mixes:', data);

  return (data || []).map(t => {
    // Calculate costs from products
    const products = (t.tank_mix_products || []).map(tmp => {
      const costPerUnit = tmp.products?.default_price || 0;
      // Calculate cost per acre based on rate and product cost
      const costPerAcre = costPerUnit * (tmp.rate || 0);
      return {
        product_id: tmp.products?.id,
        product_name: tmp.products?.commercial_name || 'Unknown',
        rate: tmp.rate,
        rate_unit: tmp.unit || 'oz/acre',
        price_per_unit: costPerUnit,
        cost_per_acre: costPerAcre,
        split: tmp.split === 'Y'
      };
    });

    return {
      ...t,
      products,
      total_cost: products.reduce((sum, p) => sum + (p.cost_per_acre || 0), 0)
    };
  });
}

// ============================================================================
// MISC INCOME DATA SERVICES
// ============================================================================

// Get misc income categories
async function getMiscIncomeCategories() {
  const { data, error } = await db.from('be_misc_income_categories')
    .select('*')
    .eq('active', true)
    .order('sort_order');
  return error ? [] : data || [];
}

// Get misc income entries for a crop year
async function getMiscIncome(cropYear) {
  const { data, error } = await db.from('be_misc_income')
    .select(`
      *,
      be_misc_income_categories(name),
      commodities(name),
      be_misc_income_allocations(commodity_id, field_id, practice_type, commodities(name), fields(name))
    `)
    .eq('crop_year', cropYear)
    .is('deleted_at', null)
    .order('name');
  if (error) {
    console.log('Misc income not available (table may not exist yet):', error.message);
    return [];
  }
  return (data || []).map(i => ({
    ...i,
    category_name: i.be_misc_income_categories?.name,
    commodity_name: i.commodities?.name,
    allocations: i.be_misc_income_allocations || []
  }));
}

// Save misc income entry
async function saveMiscIncome(income, allocations = []) {
  const incomeData = {
    category_id: income.category_id || null,
    crop_year: income.crop_year,
    name: income.name,
    income_type: income.income_type || 'TOTAL',
    amount: parseFloat(income.amount) || 0,
    allocation_type: income.allocation_type || 'ALL_ACRES',
    commodity_id: income.commodity_id || null,
    is_projected: income.is_projected !== false,
    payment_date: income.payment_date || null,
    notes: income.notes || null,
    updated_at: new Date().toISOString()
  };

  if (income.id) {
    const { error } = await db.from('be_misc_income').update(incomeData).eq('id', income.id);
    if (error) throw error;
    // Update allocations
    await db.from('be_misc_income_allocations').delete().eq('income_id', income.id);
    if (allocations.length > 0) {
      await db.from('be_misc_income_allocations').insert(
        allocations.map(a => ({ income_id: income.id, commodity_id: a.commodity_id, field_id: a.field_id, practice_type: a.practice_type || null }))
      );
    }
    return { ...income, ...incomeData };
  } else {
    const { data, error } = await db.from('be_misc_income').insert([incomeData]).select().single();
    if (error) throw error;
    if (allocations.length > 0) {
      await db.from('be_misc_income_allocations').insert(
        allocations.map(a => ({ income_id: data.id, commodity_id: a.commodity_id, field_id: a.field_id, practice_type: a.practice_type || null }))
      );
    }
    return data;
  }
}

// Delete misc income entry
async function deleteMiscIncome(id) {
  const { error } = await db.from('be_misc_income').update({ deleted_at: new Date().toISOString() }).eq('id', id);
  if (error) throw error;
}

// Calculate allocated income for a field
function allocateMiscIncome(incomeEntries, fieldCropYears) {
  const allocations = {};
  fieldCropYears.forEach(fcy => { allocations[fcy.id] = 0; });

  incomeEntries.forEach(income => {
    const amount = income.amount || 0;

    if (income.allocation_type === 'ALL_ACRES') {
      // Spread evenly across effective acres (Adams acres + BFP acres Ã— adams_grain_share)
      const totalEffectiveAcres = fieldCropYears.reduce((sum, f) => {
        const acres = f.planted_acres || 0;
        const adamsGrainShare = f.effective_share && f.tenant_share ? f.effective_share / f.tenant_share : 1;
        return sum + (acres * adamsGrainShare);
      }, 0);

      if (totalEffectiveAcres > 0) {
        if (income.income_type === 'TOTAL') {
          fieldCropYears.forEach(fcy => {
            const acres = fcy.planted_acres || 0;
            const adamsGrainShare = fcy.effective_share && fcy.tenant_share ? fcy.effective_share / fcy.tenant_share : 1;
            const effectiveAcres = acres * adamsGrainShare;
            allocations[fcy.id] += (amount * effectiveAcres) / totalEffectiveAcres;
          });
        } else if (income.income_type === 'PER_ACRE') {
          fieldCropYears.forEach(fcy => {
            const acres = fcy.planted_acres || 0;
            const adamsGrainShare = fcy.effective_share && fcy.tenant_share ? fcy.effective_share / fcy.tenant_share : 1;
            allocations[fcy.id] += amount * acres * adamsGrainShare;
          });
        }
      }
    } else if (income.allocation_type === 'SPECIFIC_CROPS' && income.commodity_id) {
      // Only to specific commodity - use effective acres
      const eligibleFields = fieldCropYears.filter(fcy => fcy.commodity_id === income.commodity_id);
      const totalEffectiveAcres = eligibleFields.reduce((sum, f) => {
        const acres = f.planted_acres || 0;
        const adamsGrainShare = f.effective_share && f.tenant_share ? f.effective_share / f.tenant_share : 1;
        return sum + (acres * adamsGrainShare);
      }, 0);

      if (totalEffectiveAcres > 0) {
        if (income.income_type === 'TOTAL') {
          eligibleFields.forEach(fcy => {
            const acres = fcy.planted_acres || 0;
            const adamsGrainShare = fcy.effective_share && fcy.tenant_share ? fcy.effective_share / fcy.tenant_share : 1;
            const effectiveAcres = acres * adamsGrainShare;
            allocations[fcy.id] += (amount * effectiveAcres) / totalEffectiveAcres;
          });
        } else if (income.income_type === 'PER_ACRE') {
          eligibleFields.forEach(fcy => {
            const acres = fcy.planted_acres || 0;
            const adamsGrainShare = fcy.effective_share && fcy.tenant_share ? fcy.effective_share / fcy.tenant_share : 1;
            allocations[fcy.id] += amount * acres * adamsGrainShare;
          });
        }
      }
    } else if (income.allocation_type === 'SPECIFIC_FIELDS') {
      // Use detailed allocations
      const allocs = income.allocations || [];
      allocs.forEach(a => {
        const fcy = fieldCropYears.find(f =>
          (a.field_id && f.field_id === a.field_id) ||
          (a.commodity_id && f.commodity_id === a.commodity_id)
        );
        if (fcy) {
          const acres = fcy.planted_acres || 0;
          const adamsGrainShare = fcy.effective_share && fcy.tenant_share ? fcy.effective_share / fcy.tenant_share : 1;
          if (income.income_type === 'TOTAL') {
            allocations[fcy.id] += (amount / allocs.length) * adamsGrainShare;
          } else if (income.income_type === 'PER_ACRE') {
            allocations[fcy.id] += amount * acres * adamsGrainShare;
          }
        }
      });
    }
  });

  return allocations;
}

// ============================================================================
// ACTUAL COSTS TRACKING
// ============================================================================

// Get actual costs for a crop year
async function getActualCosts(cropYear) {
  const { data, error } = await db.from('be_actual_costs')
    .select(`
      *,
      field_crop_years(id, field_id, commodity_id, planted_acres,
        fields(name, farms(name)),
        commodities(name)
      )
    `);
  if (error) return [];

  // Filter by crop year from field_crop_years
  return (data || []).filter(ac => {
    // We need to join to get crop_year, for now filter client-side
    return ac.field_crop_years;
  }).map(ac => ({
    ...ac,
    field_name: ac.field_crop_years?.fields?.name,
    farm_name: ac.field_crop_years?.fields?.farms?.name,
    commodity_name: ac.field_crop_years?.commodities?.name,
    planted_acres: ac.field_crop_years?.planted_acres
  }));
}

// Save actual cost entry
async function saveActualCost(cost) {
  const costData = {
    field_crop_year_id: cost.field_crop_year_id,
    cost_type: cost.cost_type,
    description: cost.description || null,
    planned_cost: cost.planned_cost || null,
    actual_cost: cost.actual_cost || null,
    source_type: cost.source_type || 'MANUAL',
    source_id: cost.source_id || null,
    planned_per_acre: cost.planned_per_acre || null,
    actual_per_acre: cost.actual_per_acre || null,
    notes: cost.notes || null,
    updated_at: new Date().toISOString()
  };

  if (cost.id) {
    const { error } = await db.from('be_actual_costs').update(costData).eq('id', cost.id);
    if (error) throw error;
    return { ...cost, ...costData };
  } else {
    const { data, error } = await db.from('be_actual_costs').insert([costData]).select().single();
    if (error) throw error;
    return data;
  }
}

// Pull actual costs from Spray-Suite for a field
async function pullSpraySuiteActuals(fieldId, cropYear) {
  const startDate = `${cropYear - 1}-09-01`;
  const endDate = `${cropYear}-08-31`;

  const { data, error } = await db.from('applications')
    .select(`
      id,
      date,
      total_cost,
      application_products(
        product_id,
        total_cost,
        split,
        products(split)
      )
    `)
    .eq('field_id', fieldId)
    .gte('date', startDate)
    .lte('date', endDate);

  if (error) return { total: 0, applications: [] };

  const total = (data || []).reduce((sum, app) => sum + (app.total_cost || 0), 0);
  return { total, applications: data || [] };
}

// Pull actual costs from Fertilizer App for a field
async function pullFertilizerActuals(fieldId, cropYear) {
  const { data, error } = await db.from('fert_applications')
    .select('id, application_date, total_cost, acres_applied')
    .eq('field_id', fieldId)
    .eq('crop_year', cropYear)
    .is('deleted_at', null);

  if (error) return { total: 0, applications: [] };

  const total = (data || []).reduce((sum, app) => sum + (app.total_cost || 0), 0);
  return { total, applications: data || [] };
}

// ============================================================================
// PHASE 3: FIELD VISIBILITY & PLANNED VS ACTUAL
// ============================================================================

// Get field settings for breakeven visibility
async function getFieldSettings() {
  const { data, error } = await db.from('be_field_settings')
    .select('*');
  if (error) {
    console.error('Error loading field settings:', error);
    return [];
  }
  return data || [];
}

// Save field settings
async function saveFieldSetting(fieldId, isActiveForBreakeven, notes = null) {
  const { data: existing } = await db.from('be_field_settings')
    .select('id')
    .eq('field_id', fieldId)
    .single();

  if (existing) {
    const { error } = await db.from('be_field_settings')
      .update({ is_active_for_breakeven: isActiveForBreakeven, notes, updated_at: new Date().toISOString() })
      .eq('id', existing.id);
    if (error) throw error;
  } else {
    const { error } = await db.from('be_field_settings')
      .insert([{ field_id: fieldId, is_active_for_breakeven: isActiveForBreakeven, notes }]);
    if (error) throw error;
  }
}

// Get visible fields for breakeven (applies visibility settings)
async function getVisibleFields() {
  // Get fields where:
  // 1. Farm is active AND has adams_grain_share > 0
  // 2. Field is active
  // 3. be_field_settings.is_active_for_breakeven = true (or no setting exists)

  const { data: fields, error } = await db.from('fields')
    .select(`
      id, name, acres, farm_id, tenant_share, landlord, active,
      farms!inner(id, name, active, adams_grain_share),
      be_field_settings(is_active_for_breakeven)
    `)
    .eq('active', true)
    .eq('farms.active', true)
    .gt('farms.adams_grain_share', 0);

  if (error) {
    console.error('Error loading visible fields:', error);
    return [];
  }

  // Filter out fields with is_active_for_breakeven = false
  return (fields || []).filter(f =>
    !f.be_field_settings?.[0] ||
    f.be_field_settings[0].is_active_for_breakeven !== false
  ).map(f => ({
    ...f,
    farm_name: f.farms?.name,
    adams_grain_share: f.farms?.adams_grain_share,
    effective_share: (f.tenant_share || 1) * (f.farms?.adams_grain_share || 1)
  }));
}

// Get actual chemical costs from Spray-Suite for a crop year
async function getActualChemicalCosts(cropYear) {
  const startDate = `${cropYear - 1}-09-01`;
  const endDate = `${cropYear}-08-31`;

  const { data, error } = await db.from('applications')
    .select(`
      id, field_id, date, total_acres, total_cost,
      application_products(
        product_id, rate, unit, unit_cost, total_cost, split,
        products(commercial_name, split)
      )
    `)
    .gte('date', startDate)
    .lte('date', endDate);

  if (error) {
    console.error('Error fetching actual chemical costs:', error);
    return { byField: {}, lastSynced: new Date().toISOString() };
  }

  // Aggregate by field_id
  const byField = {};
  (data || []).forEach(app => {
    if (!byField[app.field_id]) {
      byField[app.field_id] = {
        total: 0,
        splitCost: 0,
        nonSplitCost: 0,
        applications: [],
        products: []
      };
    }

    const products = app.application_products || [];
    let appTotal = 0;
    let appSplit = 0;
    let appNonSplit = 0;

    products.forEach(p => {
      const cost = p.total_cost || 0;
      // Check for split flag: prioritize application_products.split, then products.split
      let isSplit = false;
      if (p.split !== undefined && p.split !== null) {
        isSplit = p.split === 'Y' || p.split === true;
      } else if (p.products && p.products.split !== undefined && p.products.split !== null) {
        isSplit = p.products.split === 'Y' || p.products.split === true;
      }

      appTotal += cost;
      if (isSplit) {
        appSplit += cost;
      } else {
        appNonSplit += cost;
      }
      byField[app.field_id].products.push({
        product_name: p.products?.commercial_name || 'Unknown',
        rate: p.rate,
        unit: p.unit,
        cost: cost,
        is_split: isSplit,
        date: app.date
      });
    });

    // Fallback if no product detail
    if (products.length === 0) {
      appTotal = app.total_cost || 0;
      appNonSplit = appTotal;
    }

    byField[app.field_id].total += appTotal;
    byField[app.field_id].splitCost += appSplit;
    byField[app.field_id].nonSplitCost += appNonSplit;
    byField[app.field_id].applications.push({
      id: app.id,
      date: app.date,
      acres: app.total_acres,
      total_cost: appTotal
    });
  });

  return { byField, lastSynced: new Date().toISOString() };
}

// Get profitability price settings for a crop year
async function getProfitabilityPrices(cropYear, commodities) {
  // Get saved price preferences
  const { data: savedPrices } = await db.from('be_profitability_prices')
    .select('*')
    .eq('crop_year', cropYear);

  // Get insurance settings for reference prices
  const { data: insuranceSettings } = await db.from('insurance_settings')
    .select('commodity_id, price_election')
    .eq('crop_year', cropYear);

  // Get latest market prices from GrainTrack (barchart_technicals or market_prices)
  const { data: marketPrices } = await db.from('market_prices')
    .select('commodity_id, price, updated_at')
    .order('updated_at', { ascending: false });

  // Build price map by commodity
  const prices = {};
  const savedMap = {};
  (savedPrices || []).forEach(sp => { savedMap[sp.commodity_id] = sp; });

  const insuranceMap = {};
  (insuranceSettings || []).forEach(is => { insuranceMap[is.commodity_id] = is.price_election; });

  // Get unique latest market prices per commodity
  const marketMap = {};
  (marketPrices || []).forEach(mp => {
    if (!marketMap[mp.commodity_id]) {
      marketMap[mp.commodity_id] = mp.price;
    }
  });

  commodities.forEach(c => {
    const saved = savedMap[c.id];
    const marketPrice = marketMap[c.id] ? marketMap[c.id] / 100 : null; // Prices stored in cents
    const insurancePrice = insuranceMap[c.id] || null;

    let effectivePrice = null;
    const priceSource = saved?.price_source || 'insurance';

    if (priceSource === 'market' && marketPrice) {
      effectivePrice = marketPrice;
    } else if (priceSource === 'insurance' && insurancePrice) {
      effectivePrice = insurancePrice;
    } else if (priceSource === 'manual' && saved?.manual_price) {
      effectivePrice = parseFloat(saved.manual_price);
    } else {
      // Fallback priority: insurance > market
      effectivePrice = insurancePrice || marketPrice || null;
    }

    prices[c.id] = {
      commodity_id: c.id,
      commodity_name: c.name,
      market_price: marketPrice,
      insurance_price: insurancePrice,
      manual_price: saved?.manual_price ? parseFloat(saved.manual_price) : null,
      price_source: priceSource,
      effective_price: effectivePrice
    };
  });

  return prices;
}

// Save profitability price setting
async function saveProfitabilityPrice(cropYear, commodityId, priceSource, manualPrice = null) {
  const { data: existing } = await db.from('be_profitability_prices')
    .select('id')
    .eq('crop_year', cropYear)
    .eq('commodity_id', commodityId)
    .single();

  const priceData = {
    crop_year: cropYear,
    commodity_id: commodityId,
    price_source: priceSource,
    manual_price: priceSource === 'manual' ? manualPrice : null,
    updated_at: new Date().toISOString()
  };

  if (existing) {
    const { error } = await db.from('be_profitability_prices')
      .update(priceData)
      .eq('id', existing.id);
    if (error) throw error;
  } else {
    const { error } = await db.from('be_profitability_prices')
      .insert([priceData]);
    if (error) throw error;
  }
}

// Calculate variance between planned and actual costs
function calculateVariance(planned, actual) {
  const calcVar = (p, a) => ({
    planned: p || 0,
    actual: a || 0,
    variance: (a || 0) - (p || 0),
    pctChange: p > 0 ? (((a || 0) - p) / p * 100) : 0
  });

  return {
    seed: calcVar(planned.seed, actual.seed),
    fertilizer: calcVar(planned.fertilizer, actual.fertilizer),
    chemicals: calcVar(planned.chemicals, actual.chemicals),
    overhead: calcVar(planned.overhead, actual.overhead),
    rent: calcVar(planned.rent, actual.rent),
    total: calcVar(planned.total, actual.total)
  };
}

// Calculate profitability for a field
function calculateProfitability(fieldData, prices) {
  return fieldData.map(f => {
    const priceInfo = prices[f.commodity_id];
    const price = priceInfo?.effective_price || 0;
    const bushels = f.actual_production || (f.planted_acres * (f.expected_yield || 0));
    const revenue = bushels * price;
    const profit = revenue - f.totalCost;
    const profitPerAcre = f.planted_acres > 0 ? profit / f.planted_acres : 0;

    return {
      ...f,
      price_used: price,
      price_source: priceInfo?.price_source || 'none',
      gross_revenue: revenue,
      profit,
      profitPerAcre,
      isProfitable: profit > 0
    };
  });
}

// ============================================================================
// CALCULATION HELPERS
// ============================================================================

function allocateOverhead(expenses, fieldCropYears) {
  const allocations = {};
  fieldCropYears.forEach(fcy => { allocations[fcy.id] = 0; });

  expenses.forEach(expense => {
    if (expense.allocation_type === 'ALL_ACRES') {
      // Calculate effective acres: Adams acres + (BFP acres Ã— adams_grain_share)
      const totalEffectiveAcres = fieldCropYears.reduce((sum, f) => {
        const acres = f.planted_acres || 0;
        const adamsGrainShare = f.effective_share && f.tenant_share ? f.effective_share / f.tenant_share : 1;
        return sum + (acres * adamsGrainShare);
      }, 0);

      if (totalEffectiveAcres > 0) {
        fieldCropYears.forEach(fcy => {
          const acres = fcy.planted_acres || 0;
          const adamsGrainShare = fcy.effective_share && fcy.tenant_share ? fcy.effective_share / fcy.tenant_share : 1;
          const effectiveAcres = acres * adamsGrainShare;
          allocations[fcy.id] += (expense.amount * effectiveAcres) / totalEffectiveAcres;
        });
      }
    } else {
      const allocs = expense.be_overhead_allocations || [];
      const eligibleFields = fieldCropYears.filter(fcy =>
        allocs.some(a => a.commodity_id === fcy.commodity_id &&
          (a.practice_type === null ||
           (a.practice_type === 'IR' && fcy.is_irrigated) ||
           (a.practice_type === 'DL' && !fcy.is_irrigated)))
      );

      // Calculate effective acres for eligible fields only
      const totalEffectiveAcres = eligibleFields.reduce((sum, f) => {
        const acres = f.planted_acres || 0;
        const adamsGrainShare = f.effective_share && f.tenant_share ? f.effective_share / f.tenant_share : 1;
        return sum + (acres * adamsGrainShare);
      }, 0);

      if (totalEffectiveAcres > 0) {
        eligibleFields.forEach(fcy => {
          const acres = fcy.planted_acres || 0;
          const adamsGrainShare = fcy.effective_share && fcy.tenant_share ? fcy.effective_share / fcy.tenant_share : 1;
          const effectiveAcres = acres * adamsGrainShare;
          allocations[fcy.id] += (expense.amount * effectiveAcres) / totalEffectiveAcres;
        });
      }
    }
  });

  return allocations;
}

function calculateSeedCost(seed) {
  if (!seed.price_per_bag || !seed.seeds_per_bag || !seed.seeding_rate || !seed.planted_acres) return 0;
  const totalSeeds = seed.seeding_rate * seed.planted_acres;
  const bagsNeeded = totalSeeds / seed.seeds_per_bag;
  return bagsNeeded * seed.price_per_bag;
}

// ============================================================================
// NAVIGATION
// ============================================================================
const navItems = [
  { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
  { id: 'crop-plans', label: 'Crop Plans', icon: 'layers' },
  { id: 'seed-products', label: 'Seed Products', icon: 'package' },
  { id: 'field-applications', label: 'Field Applications', icon: 'map-pin' },
  { id: 'overhead', label: 'Overhead', icon: 'building' },
  { id: 'income', label: 'Misc Income', icon: 'dollar-sign' },
  { id: 'land-rent', label: 'Land Rent', icon: 'home' },
  { id: 'breakeven', label: 'Breakeven', icon: 'calculator' },
  { id: 'analysis', label: 'Analysis', icon: 'bar-chart-3' },
  { id: 'reports', label: 'Reports', icon: 'file-text' },
  { id: 'landlord-report', label: 'Landlord Report', icon: 'users' },
  { id: 'settings', label: 'Settings', icon: 'settings' }
];

const appLinks = [
  { name: 'GrainTrack', url: 'https://baldwinag.com/portal/graintrack', icon: 'wheat', desc: 'Marketing & Inventory' },
  { name: 'Spray-Suite', url: 'https://baldwinag.com/spray/manager', icon: 'spray-can', desc: 'Chemical Applications' },
  { name: 'Fertilizer', url: 'https://baldwinag.com/portal/fertilizer', icon: 'flask-conical', desc: 'Fertilizer Applications' }
];

// ============================================================================
// DASHBOARD PAGE
// ============================================================================
function DashboardPage({ cropYear, onYearChange }) {
  const [data, setData] = useState({
    commodities: [],
    totalCost: 0,
    totalAcres: 0,
    totalIncome: 0,
    netCost: 0,
    breakdown: { overhead: 0, seed: 0, rent: 0, fertilizer: 0, herbicide: 0 },
    familyLivingTotal: 0,
    totalPlannedCost: 0,
    totalVariance: 0,
    hasOverages: false
  });
  const [loading, setLoading] = useState(true);
  const [includeFamilyLiving, setIncludeFamilyLiving] = useState(true);
  const [costView, setCostView] = useState('actual'); // 'planned', 'actual', 'variance'
  const [rawData, setRawData] = useState(null); // Store raw data for recalculation
  const [showTargetPriceModal, setShowTargetPriceModal] = useState(false);
  const [editingTargetPrice, setEditingTargetPrice] = useState(null);
  const [yieldOverrides, setYieldOverrides] = useState({}); // { commodity_id: new_yield_per_acre }
  const [drillDownModal, setDrillDownModal] = useState({
    isOpen: false,
    commodityId: null,
    commodityName: null
  });
  const currentYear = new Date().getFullYear();
  const cropYears = [currentYear - 1, currentYear, currentYear + 1];
  const { addToast } = useToast();

  // Load raw data from database
  useEffect(() => {
    async function loadRawData() {
      setLoading(true);
      const [fcys, expenses, categories, seeds, rents, fertCosts, herbCosts, commodities, miscIncome, cropPlans, assignments, contractedPositions, targetPrices] = await Promise.all([
        getFieldCropYears(cropYear),
        getOverheadExpenses(cropYear),
        getOverheadCategories(),
        getSeedCosts(cropYear),
        getLandRent(cropYear),
        getFertilizerCosts(cropYear),
        getHerbicideCosts(cropYear),
        getCommodities(),
        getMiscIncome(cropYear),
        getCropPlans(cropYear),
        getFieldPlanAssignments(cropYear),
        getContractedPositions(cropYear),
        getTargetPrices(cropYear)
      ]);
      setRawData({ fcys, expenses, categories, seeds, rents, fertCosts, herbCosts, commodities, miscIncome, cropPlans, assignments, contractedPositions, targetPrices });
    }
    loadRawData();
  }, [cropYear]);

  // Recalculate when raw data or toggle changes
  useEffect(() => {
    if (!rawData) return;

    const { fcys, expenses, categories, seeds, rents, fertCosts, herbCosts, miscIncome, cropPlans, assignments, contractedPositions, targetPrices } = rawData;

    // Build target price map
    const targetPriceMap = {};
    (targetPrices || []).forEach(tp => {
      targetPriceMap[tp.commodity_id] = tp.target_price;
    });

    // Find family living category IDs
    const familyLivingCategoryIds = categories
      .filter(c => c.is_family_living)
      .map(c => c.id);

    // Separate family living expenses
    const familyLivingExpenses = expenses.filter(e => familyLivingCategoryIds.includes(e.category_id));
    const familyLivingTotal = familyLivingExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);

    // Filter expenses based on toggle
    const filteredExpenses = includeFamilyLiving
      ? expenses
      : expenses.filter(e => !familyLivingCategoryIds.includes(e.category_id));

    const overheadAlloc = allocateOverhead(filteredExpenses, fcys);
    const incomeAlloc = allocateMiscIncome(miscIncome, fcys);
    const seedMap = {};
    seeds.forEach(s => { seedMap[s.field_crop_year_id] = s.total_cost || calculateSeedCost({ ...s, planted_acres: s.planted_acres }); });
    const rentMap = {};
    rents.forEach(r => { rentMap[r.field_id] = r.rent_per_acre || 0; });

    let totalCost = 0;
    let totalPlannedCost = 0;
    let totalAcres = 0;
    let totalIncome = 0;
    const breakdown = { overhead: 0, seed: 0, rent: 0, fertilizer: 0, herbicide: 0 };
    const byCommodity = {};

    fcys.forEach(fcy => {
      // Calculate adams_grain_share (BFP partnership split)
      const tenantShareBase = fcy.tenant_share || 1;
      const effectiveShare = fcy.effective_share || tenantShareBase;
      const adamsGrainShare = tenantShareBase > 0 ? effectiveShare / tenantShareBase : 1;

      // Actual costs
      // Overhead already allocated by effective acres, no additional multiplication needed
      const overhead = overheadAlloc[fcy.id] || 0;
      const seed = (seedMap[fcy.id] || 0) * adamsGrainShare;
      const rentPerAcre = rentMap[fcy.field_id] || 0;
      const rent = (rentPerAcre * (fcy.planted_acres || 0)) * adamsGrainShare;
      const fert = (fertCosts[fcy.field_id] || 0) * adamsGrainShare;
      const herbData = herbCosts[fcy.field_id] || { total: 0 };
      const herb = (typeof herbData === 'object' ? herbData.total : herbData) * adamsGrainShare;
      const fieldTotal = overhead + seed + rent + fert + herb;
      // Income already allocated by effective acres, no additional multiplication needed
      const income = incomeAlloc[fcy.id] || 0;

      // Check for yield override
      const yieldPerAcre = yieldOverrides[fcy.commodity_id] !== undefined
        ? yieldOverrides[fcy.commodity_id]
        : (fcy.estimated_yield || 0);
      // Calculate bushels with effective share (already calculated above)
      const bushelsAll = fcy.actual_production || ((fcy.planted_acres || 0) * yieldPerAcre);
      const bushels = bushelsAll * effectiveShare;

      // Planned costs (only multiply per-acre costs by acres, not already-totaled costs)
      // Apply BFP partnership split
      const assignment = assignments.find(a => a.field_crop_year_id === fcy.id);
      const plan = assignment ? cropPlans.find(p => p.id === assignment.crop_plan_id) : null;
      const plannedCostPerAcre = plan ? calculateCropPlanCost(plan) : 0;
      const plannedFieldTotal = (plannedCostPerAcre * (fcy.planted_acres || 0)) * adamsGrainShare;

      totalCost += fieldTotal;
      totalPlannedCost += plannedFieldTotal;
      totalAcres += fcy.planted_acres || 0;
      totalIncome += income;
      breakdown.overhead += overhead;
      breakdown.seed += seed;
      breakdown.rent += rent;
      breakdown.fertilizer += fert;
      breakdown.herbicide += herb;

      if (!byCommodity[fcy.commodity_id]) {
        byCommodity[fcy.commodity_id] = {
          name: fcy.commodity_name,
          cost: 0,
          plannedCost: 0,
          acres: 0,
          bushels: 0,
          income: 0,
          overhead: 0,
          seed: 0,
          rent: 0,
          fertilizer: 0,
          herbicide: 0
        };
      }
      byCommodity[fcy.commodity_id].cost += fieldTotal;
      byCommodity[fcy.commodity_id].plannedCost += plannedFieldTotal;
      byCommodity[fcy.commodity_id].acres += fcy.planted_acres || 0;
      byCommodity[fcy.commodity_id].bushels += bushels;
      byCommodity[fcy.commodity_id].income += income;
      byCommodity[fcy.commodity_id].overhead += overhead;
      byCommodity[fcy.commodity_id].seed += seed;
      byCommodity[fcy.commodity_id].rent += rent;
      byCommodity[fcy.commodity_id].fertilizer += fert;
      byCommodity[fcy.commodity_id].herbicide += herb;
    });

    const commoditySummary = Object.values(byCommodity).map(c => {
      const variance = c.cost - c.plannedCost;
      const variancePct = c.plannedCost > 0 ? ((c.cost - c.plannedCost) / c.plannedCost) * 100 : null;

      // Get marketing position for this commodity
      const commodityId = Object.keys(byCommodity).find(key => byCommodity[key] === c);
      const position = (contractedPositions || {})[commodityId] || { contracted_bushels: 0, blended_avg_price: 0 };
      const targetPrice = targetPriceMap[commodityId] || 0;

      // Store commodity_id for use in render
      c.commodity_id = commodityId;

      // Calculate contracted vs uncontracted
      const contractedBu = position.contracted_bushels || 0;
      const uncontractedBu = Math.max(0, c.bushels - contractedBu);
      const blendedAvgPrice = position.blended_avg_price || 0;

      // Calculate revenue
      const contractedRevenue = contractedBu * blendedAvgPrice;
      const uncontractedRevenue = uncontractedBu * targetPrice;
      const totalRevenue = contractedRevenue + uncontractedRevenue;

      // Calculate profit/loss
      const netCost = c.cost - c.income;
      const profitLoss = totalRevenue - netCost;
      const profitPerBu = c.bushels > 0 ? profitLoss / c.bushels : 0;

      return {
        ...c,
        variance,
        variancePct,
        netCost,
        breakeven: c.bushels > 0 ? c.cost / c.bushels : null,
        netBreakeven: c.bushels > 0 ? netCost / c.bushels : null,
        costPerAcre: c.acres > 0 ? c.cost / c.acres : 0,
        netCostPerAcre: c.acres > 0 ? netCost / c.acres : 0,
        plannedCostPerAcre: c.acres > 0 ? c.plannedCost / c.acres : 0,
        // Marketing data
        contractedBu,
        uncontractedBu,
        blendedAvgPrice,
        targetPrice,
        contractedRevenue,
        uncontractedRevenue,
        totalRevenue,
        profitLoss,
        profitPerBu
      };
    });

    const totalVariance = totalCost - totalPlannedCost;
    const hasOverages = commoditySummary.some(c => c.variancePct != null && c.variancePct > 10);

    setData({
      commodities: commoditySummary,
      totalCost,
      totalPlannedCost,
      totalVariance,
      totalAcres,
      totalIncome,
      netCost: totalCost - totalIncome,
      breakdown,
      familyLivingTotal,
      hasOverages
    });
    setLoading(false);
  }, [rawData, includeFamilyLiving, yieldOverrides]);

  const commodityColors = {
    'Corn': { bg: 'bg-amber-500', light: 'bg-amber-100', text: 'text-amber-700', border: 'border-amber-200' },
    'Soybeans': { bg: 'bg-emerald-500', light: 'bg-emerald-100', text: 'text-emerald-700', border: 'border-emerald-200' },
    'Wheat': { bg: 'bg-violet-500', light: 'bg-violet-100', text: 'text-violet-700', border: 'border-violet-200' },
    'Milo': { bg: 'bg-red-500', light: 'bg-red-100', text: 'text-red-700', border: 'border-red-200' }
  };
  const defaultColor = { bg: 'bg-gray-500', light: 'bg-gray-100', text: 'text-gray-700', border: 'border-gray-200' };

  const categoryColors = {
    overhead: { bg: 'bg-slate-500', label: 'Overhead' },
    seed: { bg: 'bg-amber-500', label: 'Seed' },
    rent: { bg: 'bg-green-500', label: 'Rent' },
    fertilizer: { bg: 'bg-blue-500', label: 'Fertilizer' },
    herbicide: { bg: 'bg-purple-500', label: 'Herbicide' }
  };

  const handleCommodityClick = (commodityId, commodityName) => {
    setDrillDownModal({ isOpen: true, commodityId, commodityName });
  };

  if (loading) return <div className="flex items-center justify-center h-64"><Icon name="loader" className="animate-spin text-blue-600" size={32} /></div>;

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Breakeven Dashboard</h1>
          <p className="text-sm text-gray-500">Cost summary and breakeven prices for {cropYear}</p>
        </div>
        <div className="flex items-center gap-4">
          <label className="flex items-center gap-2 text-sm cursor-pointer">
            <input
              type="checkbox"
              checked={includeFamilyLiving}
              onChange={(e) => setIncludeFamilyLiving(e.target.checked)}
              className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
            />
            <span className="text-gray-600">Include Family Living</span>
            {data.familyLivingTotal > 0 && (
              <span className="text-xs text-gray-400">({formatCurrency(data.familyLivingTotal)})</span>
            )}
          </label>
          <select value={cropYear} onChange={(e) => onYearChange(parseInt(e.target.value))} className="px-4 py-2 border rounded-lg">
            {cropYears.map(y => <option key={y} value={y}>{y} Crop Year</option>)}
          </select>
        </div>
      </div>

      {/* Cost View Toggle */}
      <div className="flex items-center justify-between bg-white rounded-xl shadow-sm border p-4">
        <div className="flex items-center gap-2">
          <Icon name="bar-chart-3" size={20} className="text-gray-400" />
          <span className="font-medium text-gray-700">Cost View:</span>
        </div>
        <div className="flex gap-2">
          <button
            onClick={() => setCostView('planned')}
            className={`px-4 py-2 rounded-lg font-medium transition-colors ${
              costView === 'planned'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
            }`}
          >
            Planned
          </button>
          <button
            onClick={() => setCostView('actual')}
            className={`px-4 py-2 rounded-lg font-medium transition-colors ${
              costView === 'actual'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
            }`}
          >
            Actual
          </button>
          <button
            onClick={() => setCostView('variance')}
            className={`px-4 py-2 rounded-lg font-medium transition-colors ${
              costView === 'variance'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
            }`}
          >
            Variance
          </button>
        </div>
      </div>

      {/* Variance Alert Banner */}
      {data.hasOverages && (
        <div className="bg-red-50 border-l-4 border-red-500 rounded-lg p-4 flex items-start gap-3">
          <Icon name="alert-triangle" size={20} className="text-red-500 mt-0.5" />
          <div className="flex-1">
            <h3 className="font-semibold text-red-800">Budget Variance Alert</h3>
            <p className="text-sm text-red-700 mt-1">
              One or more commodities are over budget by more than 10%. Review the Analysis page for detailed variance breakdown.
            </p>
          </div>
          <a href="#" onClick={(e) => { e.preventDefault(); /* Navigate to analysis page */ }} className="text-red-600 hover:text-red-800 font-medium text-sm whitespace-nowrap">
            View Details â†’
          </a>
        </div>
      )}

      {/* Budget Status Summary (when variance view selected) */}
      {costView === 'variance' && data.totalPlannedCost > 0 && (
        <div className={`rounded-xl shadow-sm border p-6 ${
          data.totalVariance > 0 ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'
        }`}>
          <div className="flex items-center justify-between">
            <div>
              <h3 className="font-semibold text-lg text-gray-900">Overall Budget Status</h3>
              <p className="text-sm text-gray-600 mt-1">
                {data.totalVariance > 0 ? 'Over budget' : data.totalVariance < 0 ? 'Under budget' : 'On track'}
              </p>
            </div>
            <div className="text-right">
              <div className={`text-3xl font-bold ${data.totalVariance > 0 ? 'text-red-600' : 'text-green-600'}`}>
                {data.totalVariance > 0 ? '+' : ''}{formatCurrency(data.totalVariance)}
              </div>
              <div className="text-sm text-gray-500">
                {data.totalPlannedCost > 0 ? `${((data.totalVariance / data.totalPlannedCost) * 100).toFixed(1)}%` : '-'} variance
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
          <div className="flex items-center gap-3 mb-2">
            <Icon name="dollar-sign" size={24} />
            <span className="text-blue-100">
              {costView === 'planned' ? 'Planned Cost' : costView === 'variance' ? 'Variance' : 'Total Cost'}
            </span>
          </div>
          <div className="text-3xl font-bold">
            {costView === 'planned'
              ? formatCurrency(data.totalPlannedCost)
              : costView === 'variance'
                ? (data.totalVariance > 0 ? '+' : '') + formatCurrency(data.totalVariance)
                : formatCurrency(data.totalCost)
            }
          </div>
          <div className="text-sm text-blue-100 mt-1">
            {costView === 'variance' && data.totalPlannedCost > 0
              ? `${((data.totalVariance / data.totalPlannedCost) * 100).toFixed(1)}% ${data.totalVariance > 0 ? 'over' : 'under'} budget`
              : `${formatNumber(data.totalAcres)} acres`
            }
          </div>
        </div>
        <div className="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl shadow-lg p-6 text-white">
          <div className="flex items-center gap-3 mb-2">
            <Icon name="trending-up" size={24} />
            <span className="text-emerald-100">Misc Income</span>
          </div>
          <div className="text-3xl font-bold">{formatCurrency(data.totalIncome)}</div>
          <div className="text-sm text-emerald-100 mt-1">ARC, PLC, CRP, etc.</div>
        </div>
        <div className="bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl shadow-lg p-6 text-white">
          <div className="flex items-center gap-3 mb-2">
            <Icon name="target" size={24} />
            <span className="text-amber-100">Net Cost</span>
          </div>
          <div className="text-3xl font-bold">
            {costView === 'planned'
              ? formatCurrency(data.totalPlannedCost - data.totalIncome)
              : formatCurrency(data.netCost)
            }
          </div>
          <div className="text-sm text-amber-100 mt-1">After income offset</div>
        </div>
        <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
          <div className="flex items-center gap-3 mb-2">
            <Icon name="map" size={24} />
            <span className="text-purple-100">Avg Cost/Acre</span>
          </div>
          <div className="text-3xl font-bold">
            {data.totalAcres > 0
              ? formatCurrency(
                  costView === 'planned'
                    ? (data.totalPlannedCost - data.totalIncome) / data.totalAcres
                    : costView === 'variance'
                      ? data.totalVariance / data.totalAcres
                      : data.netCost / data.totalAcres
                )
              : '-'
            }
          </div>
          <div className="text-sm text-purple-100 mt-1">
            {costView === 'variance' ? 'Variance per acre' : 'Net after income'}
          </div>
        </div>
      </div>

      {/* Cost Breakdown */}
      <div className="bg-white rounded-xl shadow-sm border p-6">
        <h2 className="font-semibold text-lg mb-4">Cost Breakdown</h2>

        {/* Visual Bar Chart */}
        <div className="mb-6">
          <div className="h-8 rounded-full overflow-hidden flex bg-gray-100">
            {Object.entries(categoryColors).map(([key, config]) => {
              const value = data.breakdown[key] || 0;
              const percent = data.totalCost > 0 ? (value / data.totalCost) * 100 : 0;
              if (percent < 0.5) return null;
              return (
                <div
                  key={key}
                  className={`${config.bg} transition-all duration-500 flex items-center justify-center`}
                  style={{ width: `${percent}%` }}
                  title={`${config.label}: ${formatCurrency(value)} (${percent.toFixed(1)}%)`}
                >
                  {percent > 8 && <span className="text-white text-xs font-medium">{percent.toFixed(0)}%</span>}
                </div>
              );
            })}
          </div>
          <div className="flex flex-wrap gap-4 mt-3 justify-center">
            {Object.entries(categoryColors).map(([key, config]) => (
              <div key={key} className="flex items-center gap-2 text-sm">
                <div className={`w-3 h-3 rounded-full ${config.bg}`}></div>
                <span className="text-gray-600">{config.label}</span>
              </div>
            ))}
          </div>
        </div>

        {/* Breakdown Table */}
        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
          {Object.entries(categoryColors).map(([key, config]) => {
            const value = data.breakdown[key] || 0;
            const percent = data.totalCost > 0 ? (value / data.totalCost) * 100 : 0;
            return (
              <div key={key} className="text-center p-3 rounded-lg bg-gray-50">
                <div className={`w-10 h-10 rounded-full ${config.bg} mx-auto mb-2 flex items-center justify-center`}>
                  <Icon name={key === 'overhead' ? 'building' : key === 'seed' ? 'sprout' : key === 'rent' ? 'home' : key === 'fertilizer' ? 'flask-conical' : 'spray-can'} size={18} className="text-white" />
                </div>
                <div className="text-xs text-gray-500 uppercase tracking-wide">{config.label}</div>
                <div className="font-bold text-lg">{formatCurrency(value)}</div>
                <div className="text-xs text-gray-400">{percent.toFixed(1)}%</div>
              </div>
            );
          })}
        </div>
      </div>

      {/* Commodity Breakeven Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {data.commodities.map(c => {
          const colors = commodityColors[c.name] || defaultColor;
          const varianceColor = c.variance > 0 ? 'text-red-600' : c.variance < 0 ? 'text-green-600' : 'text-gray-600';
          const varianceBadgeColor = c.variancePct != null && c.variancePct > 10
            ? 'bg-red-100 text-red-700 border-red-300'
            : c.variancePct != null && c.variancePct < -10
              ? 'bg-green-100 text-green-700 border-green-300'
              : c.variancePct != null
                ? 'bg-yellow-100 text-yellow-700 border-yellow-300'
                : 'bg-gray-100 text-gray-600 border-gray-300';

          return (
            <div
              key={c.name}
              className="bg-white rounded-xl shadow-sm border overflow-hidden cursor-pointer hover:shadow-lg transition-shadow"
              onClick={() => handleCommodityClick(c.commodity_id, c.name)}
            >
              <div className={`${colors.bg} px-6 py-4 relative`}>
                <h3 className="text-xl font-bold text-white">{c.name}</h3>
                <div className="text-white/80 text-sm flex items-center gap-2">
                  <span>{formatNumber(c.acres)} acres â€¢ {formatNumber(c.bushels)} bu</span>
                  {costView === 'actual' && (
                    <button
                      onClick={() => {
                        const currentYield = c.acres > 0 ? c.bushels / c.acres : 0;
                        const newYield = prompt(`Adjust yield for ${c.name} (current: ${currentYield.toFixed(1)} bu/ac):`, currentYield.toFixed(1));
                        if (newYield && !isNaN(parseFloat(newYield))) {
                          setYieldOverrides(prev => ({ ...prev, [c.commodity_id]: parseFloat(newYield) }));
                        }
                      }}
                      className="text-white/60 hover:text-white text-xs"
                      title="Edit yield for what-if scenario"
                    >
                      âœï¸
                    </button>
                  )}
                </div>

                {/* Variance Badge */}
                {c.variancePct != null && c.plannedCost > 0 && (
                  <div className={`absolute top-4 right-4 px-2 py-1 rounded-lg border text-xs font-semibold ${varianceBadgeColor}`}>
                    {c.variance > 0 ? '+' : ''}{c.variancePct.toFixed(1)}%
                  </div>
                )}
              </div>
              <div className="p-6">
                <div className="flex items-baseline gap-2 mb-2">
                  <span className="text-3xl font-bold text-gray-900">
                    {costView === 'variance'
                      ? (c.variance > 0 ? '+' : '') + formatCurrency(c.variance)
                      : c.netBreakeven
                        ? formatPrice(c.netBreakeven)
                        : '-'
                    }
                  </span>
                  <span className="text-gray-500">
                    {costView === 'variance' ? 'variance' : 'net breakeven'}
                  </span>
                </div>
                {c.income > 0 && costView !== 'variance' && (
                  <div className="text-xs text-gray-400 mb-4">
                    Gross: {c.breakeven ? formatPrice(c.breakeven) : '-'} | Income offset: {formatCurrency(c.income)}
                  </div>
                )}
                <div className="space-y-2 text-sm">
                  {costView === 'planned' ? (
                    <>
                      <div className="flex justify-between py-1 border-b">
                        <span className="text-gray-500">Planned Cost</span>
                        <span className="font-semibold">{formatCurrency(c.plannedCost)}</span>
                      </div>
                      {c.income > 0 && (
                        <div className="flex justify-between py-1 border-b">
                          <span className="text-green-600">- Misc Income</span>
                          <span className="font-semibold text-green-600">-{formatCurrency(c.income)}</span>
                        </div>
                      )}
                      <div className="flex justify-between py-1 border-b">
                        <span className="text-gray-500">Net Planned</span>
                        <span className="font-bold">{formatCurrency(c.plannedCost - c.income)}</span>
                      </div>
                      <div className="flex justify-between py-1">
                        <span className="text-gray-500">Planned $/Acre</span>
                        <span className="font-semibold">{formatCurrency(c.plannedCostPerAcre)}</span>
                      </div>
                    </>
                  ) : costView === 'variance' ? (
                    <>
                      <div className="flex justify-between py-1 border-b">
                        <span className="text-gray-500">Planned Cost</span>
                        <span className="font-semibold">{formatCurrency(c.plannedCost)}</span>
                      </div>
                      <div className="flex justify-between py-1 border-b">
                        <span className="text-gray-500">Actual Cost</span>
                        <span className="font-semibold">{formatCurrency(c.cost)}</span>
                      </div>
                      <div className="flex justify-between py-1 border-b">
                        <span className="text-gray-500">Variance</span>
                        <span className={`font-bold ${varianceColor}`}>
                          {c.variance > 0 ? '+' : ''}{formatCurrency(c.variance)}
                        </span>
                      </div>
                      <div className="flex justify-between py-1">
                        <span className="text-gray-500">Variance %</span>
                        <span className={`font-semibold ${varianceColor}`}>
                          {c.variancePct != null ? `${c.variancePct > 0 ? '+' : ''}${c.variancePct.toFixed(1)}%` : '-'}
                        </span>
                      </div>
                    </>
                  ) : (
                    <>
                      <div className="flex justify-between py-1 border-b">
                        <span className="text-gray-500">Gross Cost</span>
                        <span className="font-semibold">{formatCurrency(c.cost)}</span>
                      </div>
                      {c.income > 0 && (
                        <div className="flex justify-between py-1 border-b">
                          <span className="text-green-600">- Misc Income</span>
                          <span className="font-semibold text-green-600">-{formatCurrency(c.income)}</span>
                        </div>
                      )}
                      <div className="flex justify-between py-1 border-b">
                        <span className="text-gray-500">Net Cost</span>
                        <span className="font-bold">{formatCurrency(c.netCost)}</span>
                      </div>
                      <div className="flex justify-between py-1">
                        <span className="text-gray-500">Net $/Acre</span>
                        <span className="font-semibold">{formatCurrency(c.netCostPerAcre)}</span>
                      </div>
                    </>
                  )}
                </div>

                {/* Mini breakdown */}
                <div className="mt-4 pt-4 border-t">
                  <div className="text-xs text-gray-500 uppercase tracking-wide mb-2">Cost Breakdown</div>
                  <div className="h-2 rounded-full overflow-hidden flex bg-gray-100">
                    {c.overhead > 0 && <div className="bg-slate-500" style={{ width: `${(c.overhead / c.cost) * 100}%` }}></div>}
                    {c.seed > 0 && <div className="bg-amber-500" style={{ width: `${(c.seed / c.cost) * 100}%` }}></div>}
                    {c.rent > 0 && <div className="bg-green-500" style={{ width: `${(c.rent / c.cost) * 100}%` }}></div>}
                    {c.fertilizer > 0 && <div className="bg-blue-500" style={{ width: `${(c.fertilizer / c.cost) * 100}%` }}></div>}
                    {c.herbicide > 0 && <div className="bg-purple-500" style={{ width: `${(c.herbicide / c.cost) * 100}%` }}></div>}
                  </div>
                  <div className="grid grid-cols-5 gap-1 mt-2 text-xs text-center text-gray-400">
                    <span>{((c.overhead / c.cost) * 100).toFixed(0)}%</span>
                    <span>{((c.seed / c.cost) * 100).toFixed(0)}%</span>
                    <span>{((c.rent / c.cost) * 100).toFixed(0)}%</span>
                    <span>{((c.fertilizer / c.cost) * 100).toFixed(0)}%</span>
                    <span>{((c.herbicide / c.cost) * 100).toFixed(0)}%</span>
                  </div>
                </div>

                {/* Marketing & P/L */}
                {costView === 'actual' && (
                  <div className="mt-4 pt-4 border-t">
                    <div className="flex items-center justify-between mb-2">
                      <div className="text-xs text-gray-500 uppercase tracking-wide">Marketing Position</div>
                      {c.uncontractedBu > 0 && (
                        <button
                          onClick={() => {
                            setEditingTargetPrice({ commodityId: c.commodity_id, name: c.name, currentPrice: c.targetPrice, uncontractedBu: c.uncontractedBu });
                            setShowTargetPriceModal(true);
                          }}
                          className="text-xs text-blue-600 hover:text-blue-800"
                        >
                          Set Target
                        </button>
                      )}
                    </div>
                    <div className="space-y-1 text-sm">
                      {c.contractedBu > 0 && (
                        <div className="flex justify-between">
                          <span className="text-gray-600">Contracted</span>
                          <span className="font-medium">{formatNumber(c.contractedBu)} bu @ {formatPrice(c.blendedAvgPrice)}</span>
                        </div>
                      )}
                      {c.uncontractedBu > 0 && (
                        <div className="flex justify-between">
                          <span className="text-gray-600">Uncontracted</span>
                          <span className="font-medium">{formatNumber(c.uncontractedBu)} bu @ {c.targetPrice > 0 ? formatPrice(c.targetPrice) : '-'}</span>
                        </div>
                      )}
                      {(c.contractedBu > 0 || c.targetPrice > 0) && (
                        <>
                          <div className="flex justify-between pt-2 border-t">
                            <span className="font-semibold">Est. Profit/Loss</span>
                            <span className={`font-bold ${c.profitLoss > 0 ? 'text-green-600' : c.profitLoss < 0 ? 'text-red-600' : 'text-gray-600'}`}>
                              {c.profitLoss > 0 ? '+' : ''}{formatCurrency(c.profitLoss)}
                            </span>
                          </div>
                          <div className="text-xs text-gray-500 text-right">
                            {c.profitPerBu > 0 ? '+' : ''}{formatPrice(c.profitPerBu)}/bu
                          </div>
                        </>
                      )}
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        })}
      </div>

      {data.commodities.length === 0 && (
        <div className="bg-white rounded-xl shadow-sm border p-8 text-center">
          <Icon name="alert-circle" size={48} className="mx-auto text-gray-300 mb-4" />
          <h3 className="text-lg font-semibold text-gray-900 mb-2">No Production Data</h3>
          <p className="text-gray-500">Add production records in GrainTrack to see breakeven calculations here.</p>
          <a href="graintrack.html" className="inline-flex items-center gap-2 mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            <Icon name="external-link" size={16} /> Open GrainTrack
          </a>
        </div>
      )}

      {/* Target Price Modal */}
      {showTargetPriceModal && editingTargetPrice && (
        <TargetPriceModal
          commodity={editingTargetPrice}
          cropYear={cropYear}
          onClose={() => {
            setShowTargetPriceModal(false);
            setEditingTargetPrice(null);
          }}
          onSave={async (commodityId, targetPrice) => {
            try {
              await saveTargetPrice(cropYear, commodityId, targetPrice);
              addToast('Target price saved', { type: 'success' });
              setShowTargetPriceModal(false);
              setEditingTargetPrice(null);
              // Reload data
              const [fcys, expenses, categories, seeds, rents, fertCosts, herbCosts, commodities, miscIncome, cropPlans, assignments, contractedPositions, targetPrices] = await Promise.all([
                getFieldCropYears(cropYear),
                getOverheadExpenses(cropYear),
                getOverheadCategories(),
                getSeedCosts(cropYear),
                getLandRent(cropYear),
                getFertilizerCosts(cropYear),
                getHerbicideCosts(cropYear),
                getCommodities(),
                getMiscIncome(cropYear),
                getCropPlans(cropYear),
                getFieldPlanAssignments(cropYear),
                getContractedPositions(cropYear),
                getTargetPrices(cropYear)
              ]);
              setRawData({ fcys, expenses, categories, seeds, rents, fertCosts, herbCosts, commodities, miscIncome, cropPlans, assignments, contractedPositions, targetPrices });
            } catch (e) {
              addToast('Failed to save: ' + e.message, { type: 'error' });
            }
          }}
        />
      )}

      {/* Commodity Drill-Down Modal */}
      {drillDownModal.isOpen && (
        <CommodityDrillDownModal
          isOpen={drillDownModal.isOpen}
          onClose={() => setDrillDownModal({ isOpen: false, commodityId: null, commodityName: null })}
          commodityId={drillDownModal.commodityId}
          commodityName={drillDownModal.commodityName}
          rawData={rawData}
          costView={costView}
        />
      )}
    </div>
  );
}

// ============================================================================
// COMMODITY DRILL-DOWN MODAL
// ============================================================================

// Aggregate data for drill-down modal
function aggregateDrillDownData(rawData, commodityId, subFilters, costView) {
  const { fcys, expenses, categories, seeds, rents, fertCosts, herbCosts, commodities } = rawData;

  // Filter field_crop_years by commodity
  let filteredFcys = fcys.filter(fcy => fcy.commodity_id === commodityId);

  // Apply sub-filters
  if (subFilters.irrigation === 'IR') {
    filteredFcys = filteredFcys.filter(fcy => fcy.is_irrigated);
  } else if (subFilters.irrigation === 'DL') {
    filteredFcys = filteredFcys.filter(fcy => !fcy.is_irrigated);
  }

  if (subFilters.practice !== 'all') {
    filteredFcys = filteredFcys.filter(fcy => fcy.practice_type === subFilters.practice);
  }

  // Allocate overhead
  const overheadAlloc = allocateOverhead(expenses, filteredFcys);

  // Group overhead by category
  const overheadByCategory = {};
  expenses.forEach(expense => {
    const categoryId = expense.category_id;
    const category = categories.find(c => c.id === categoryId);

    if (!overheadByCategory[categoryId]) {
      overheadByCategory[categoryId] = {
        id: categoryId,
        name: category?.name || 'Unknown',
        sort_order: category?.sort_order || 999,
        total: 0,
        lineItems: []
      };
    }

    // Sum allocations for this expense across filtered fields
    const expenseTotal = filteredFcys.reduce((sum, fcy) => {
      return sum + (overheadAlloc[fcy.id] || 0);
    }, 0);

    overheadByCategory[categoryId].total += expenseTotal;
    overheadByCategory[categoryId].lineItems.push({
      id: expense.id,
      name: expense.name,
      amount: expenseTotal,
      allocation_type: expense.allocation_type
    });
  });

  // Aggregate seed costs
  const seedTotals = { total: 0, breakdown: [] };
  filteredFcys.forEach(fcy => {
    const seed = seeds.find(s => s.field_crop_year_id === fcy.id);
    if (seed) {
      const adamsGrainShare = fcy.effective_share && fcy.tenant_share ? fcy.effective_share / fcy.tenant_share : 1;
      const cost = (seed.total_cost || 0) * adamsGrainShare;

      seedTotals.total += cost;
      seedTotals.breakdown.push({
        field_name: fcy.field_name,
        brand: seed.brand,
        hybrid: seed.hybrid,
        cost
      });
    }
  });

  // Aggregate fertilizer costs
  const fertTotals = { total: 0 };
  filteredFcys.forEach(fcy => {
    const fertData = fertCosts[fcy.field_id] || { total: 0 };
    const adamsGrainShare = fcy.effective_share && fcy.tenant_share ? fcy.effective_share / fcy.tenant_share : 1;
    fertTotals.total += fertData.total * adamsGrainShare;
  });

  // Aggregate herbicide/custom hire costs
  const customHireTotals = { total: 0, applications: [] };
  filteredFcys.forEach(fcy => {
    const herbData = herbCosts[fcy.field_id] || { total: 0 };
    const adamsGrainShare = fcy.effective_share && fcy.tenant_share ? fcy.effective_share / fcy.tenant_share : 1;

    customHireTotals.total += herbData.total * adamsGrainShare;

    // Get detailed applications if available
    if (herbData.applications) {
      herbData.applications.forEach(app => {
        customHireTotals.applications.push({
          field_name: fcy.field_name,
          date: app.date,
          acres: app.acres,
          cost: app.total_cost * adamsGrainShare,
          products: app.application_products || []
        });
      });
    }
  });

  // Aggregate rent costs
  const rentMap = {};
  rents.forEach(r => {
    rentMap[r.field_id] = r.rent_per_acre || 0;
  });

  let rentTotal = 0;
  filteredFcys.forEach(fcy => {
    const adamsGrainShare = fcy.effective_share && fcy.tenant_share ? fcy.effective_share / fcy.tenant_share : 1;
    const rentPerAcre = rentMap[fcy.field_id] || 0;
    rentTotal += rentPerAcre * (fcy.planted_acres || 0) * adamsGrainShare;
  });

  // Calculate totals and averages
  const totalAcres = filteredFcys.reduce((s, f) => s + (f.planted_acres || 0), 0);
  const totalBushels = filteredFcys.reduce((s, f) => {
    const bushelsAll = f.actual_production || (f.planted_acres * f.estimated_yield);
    return s + (bushelsAll * (f.effective_share || f.tenant_share || 1));
  }, 0);

  const overheadTotal = Object.values(overheadByCategory).reduce((s, c) => s + c.total, 0);
  const totalCost = overheadTotal + seedTotals.total + fertTotals.total + customHireTotals.total + rentTotal;

  return {
    totals: {
      acres: totalAcres,
      bushels: totalBushels,
      overhead: overheadTotal,
      seed: seedTotals.total,
      fertilizer: fertTotals.total,
      customHire: customHireTotals.total,
      rent: rentTotal,
      totalCost
    },
    averages: {
      costPerAcre: totalAcres > 0 ? totalCost / totalAcres : 0,
      bushelsPerAcre: totalAcres > 0 ? totalBushels / totalAcres : 0,
      breakeven: totalBushels > 0 ? totalCost / totalBushels : 0
    },
    overhead: Object.values(overheadByCategory).sort((a, b) => a.sort_order - b.sort_order),
    seed: seedTotals,
    fertilizer: fertTotals,
    customHire: customHireTotals
  };
}

function CommodityDrillDownModal({ isOpen, onClose, commodityId, commodityName, rawData, costView }) {
  const [subFilters, setSubFilters] = useState({ irrigation: 'all', practice: 'all' });
  const [expandedCategories, setExpandedCategories] = useState(new Set());
  const [expandedCustomHire, setExpandedCustomHire] = useState(false);

  // Aggregate data based on commodity and sub-filters
  const data = useMemo(() => {
    if (!rawData) return null;
    return aggregateDrillDownData(rawData, commodityId, subFilters, costView);
  }, [rawData, commodityId, subFilters, costView]);

  if (!data) return null;

  const toggleCategory = (categoryId) => {
    setExpandedCategories(prev => {
      const next = new Set(prev);
      if (next.has(categoryId)) {
        next.delete(categoryId);
      } else {
        next.add(categoryId);
      }
      return next;
    });
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} size="xl">
      <div className="space-y-6">
        {/* Header */}
        <div>
          <h2 className="text-2xl font-bold text-gray-900 mb-2">{commodityName} - Detailed Breakdown</h2>
          <p className="text-sm text-gray-500">Click sections to expand and view details</p>
        </div>

        {/* Summary Cards */}
        <div className="grid grid-cols-3 gap-4">
          <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
            <div className="text-sm text-blue-600 font-medium mb-1">Cost per Acre</div>
            <div className="text-2xl font-bold text-blue-900">{formatCurrency(data.averages.costPerAcre)}</div>
            <div className="text-xs text-blue-600 mt-1">{formatNumber(data.totals.acres)} acres</div>
          </div>
          <div className="bg-green-50 rounded-lg p-4 border border-green-200">
            <div className="text-sm text-green-600 font-medium mb-1">Bushels per Acre</div>
            <div className="text-2xl font-bold text-green-900">{formatNumber(data.averages.bushelsPerAcre, 1)}</div>
            <div className="text-xs text-green-600 mt-1">{formatNumber(data.totals.bushels)} total bu</div>
          </div>
          <div className="bg-purple-50 rounded-lg p-4 border border-purple-200">
            <div className="text-sm text-purple-600 font-medium mb-1">Breakeven</div>
            <div className="text-2xl font-bold text-purple-900">{formatPrice(data.averages.breakeven)}</div>
            <div className="text-xs text-purple-600 mt-1">per bushel</div>
          </div>
        </div>

        {/* Sub-Filters */}
        <div className="flex gap-4">
          <div className="flex items-center gap-2">
            <span className="text-sm font-medium text-gray-700">Irrigation:</span>
            <div className="flex rounded-lg border overflow-hidden">
              {['all', 'IR', 'DL'].map(type => (
                <button
                  key={type}
                  onClick={() => setSubFilters(f => ({ ...f, irrigation: type }))}
                  className={`px-3 py-1 text-sm ${
                    subFilters.irrigation === type
                      ? 'bg-blue-600 text-white'
                      : 'bg-white text-gray-600 hover:bg-gray-50'
                  }`}
                >
                  {type === 'all' ? 'All' : type}
                </button>
              ))}
            </div>
          </div>
          <div className="flex items-center gap-2">
            <span className="text-sm font-medium text-gray-700">Practice:</span>
            <div className="flex rounded-lg border overflow-hidden">
              {['all', 'FS', 'DC'].map(type => (
                <button
                  key={type}
                  onClick={() => setSubFilters(f => ({ ...f, practice: type }))}
                  className={`px-3 py-1 text-sm ${
                    subFilters.practice === type
                      ? 'bg-blue-600 text-white'
                      : 'bg-white text-gray-600 hover:bg-gray-50'
                  }`}
                >
                  {type === 'all' ? 'All' : type}
                </button>
              ))}
            </div>
          </div>
        </div>

        {/* Overhead Section */}
        <div>
          <h3 className="text-lg font-semibold mb-3">Overhead Expenses</h3>
          <div className="space-y-2">
            {data.overhead.map(category => (
              <div key={category.id} className="border rounded-lg overflow-hidden">
                <button
                  onClick={() => toggleCategory(category.id)}
                  className="w-full flex items-center justify-between p-4 hover:bg-gray-50 transition-colors"
                >
                  <div className="flex items-center gap-3">
                    <Icon
                      name={expandedCategories.has(category.id) ? 'chevron-down' : 'chevron-right'}
                      size={18}
                      className="text-gray-400"
                    />
                    <span className="font-medium">{category.name}</span>
                    <span className="text-sm text-gray-500">({category.lineItems.length} items)</span>
                  </div>
                  <span className="font-semibold text-gray-900">{formatCurrency(category.total)}</span>
                </button>
                {expandedCategories.has(category.id) && (
                  <div className="px-4 pb-4 pt-2 bg-gray-50 border-t">
                    <div className="space-y-2">
                      {category.lineItems.map(item => (
                        <div key={item.id} className="flex justify-between text-sm">
                          <span className="text-gray-600">{item.name}</span>
                          <span className="text-gray-900">{formatCurrency(item.amount)}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
          <div className="mt-2 pt-2 border-t flex justify-between font-semibold">
            <span>Total Overhead</span>
            <span>{formatCurrency(data.totals.overhead)}</span>
          </div>
        </div>

        {/* Crop Plan Expenses */}
        <div>
          <h3 className="text-lg font-semibold mb-3">Crop Plan Expenses</h3>
          <div className="space-y-3">
            {/* Seed */}
            <div className="bg-amber-50 rounded-lg p-4 border border-amber-200">
              <div className="flex justify-between items-center">
                <div>
                  <div className="font-medium text-amber-900">Seed</div>
                  <div className="text-xs text-amber-600">{data.seed.breakdown.length} fields</div>
                </div>
                <div className="text-xl font-bold text-amber-900">{formatCurrency(data.totals.seed)}</div>
              </div>
            </div>

            {/* Fertilizer */}
            <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
              <div className="flex justify-between items-center">
                <div>
                  <div className="font-medium text-blue-900">Fertilizer</div>
                  <div className="text-xs text-blue-600">All applications</div>
                </div>
                <div className="text-xl font-bold text-blue-900">{formatCurrency(data.totals.fertilizer)}</div>
              </div>
            </div>

            {/* Custom Hire / Herbicide */}
            <div className="border rounded-lg overflow-hidden">
              <button
                onClick={() => setExpandedCustomHire(!expandedCustomHire)}
                className="w-full flex items-center justify-between p-4 bg-purple-50 hover:bg-purple-100 transition-colors"
              >
                <div className="flex items-center gap-3">
                  <Icon
                    name={expandedCustomHire ? 'chevron-down' : 'chevron-right'}
                    size={18}
                    className="text-purple-600"
                  />
                  <div>
                    <div className="font-medium text-purple-900">Custom Hire / Herbicide</div>
                    <div className="text-xs text-purple-600">{data.customHire.applications.length} applications</div>
                  </div>
                </div>
                <div className="text-xl font-bold text-purple-900">{formatCurrency(data.totals.customHire)}</div>
              </button>
              {expandedCustomHire && (
                <div className="px-4 pb-4 pt-2 bg-gray-50 border-t">
                  <div className="space-y-3">
                    {data.customHire.applications.map((app, idx) => (
                      <div key={idx} className="text-sm border-b pb-2 last:border-b-0">
                        <div className="flex justify-between font-medium mb-1">
                          <span>{app.field_name}</span>
                          <span>{formatCurrency(app.cost)}</span>
                        </div>
                        <div className="text-xs text-gray-500">
                          {app.date} â€¢ {formatNumber(app.acres)} acres
                        </div>
                        {app.products && app.products.length > 0 && (
                          <div className="text-xs text-gray-600 mt-1">
                            Products: {app.products.map(p => p.product_name || p.name).join(', ')}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* Rent */}
            <div className="bg-green-50 rounded-lg p-4 border border-green-200">
              <div className="flex justify-between items-center">
                <div>
                  <div className="font-medium text-green-900">Land Rent</div>
                  <div className="text-xs text-green-600">Cash & share rent</div>
                </div>
                <div className="text-xl font-bold text-green-900">{formatCurrency(data.totals.rent)}</div>
              </div>
            </div>
          </div>
        </div>

        {/* Total Summary */}
        <div className="bg-gray-900 text-white rounded-lg p-6">
          <div className="flex justify-between items-center mb-4">
            <div className="text-lg font-semibold">Total Cost</div>
            <div className="text-3xl font-bold">{formatCurrency(data.totals.totalCost)}</div>
          </div>
          <div className="grid grid-cols-2 gap-4 text-sm">
            <div className="flex justify-between">
              <span className="text-gray-400">Total Acres:</span>
              <span className="font-medium">{formatNumber(data.totals.acres)}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-400">Cost/Acre:</span>
              <span className="font-medium">{formatCurrency(data.averages.costPerAcre)}</span>
            </div>
          </div>
        </div>
      </div>
    </Modal>
  );
}

// Target Price Modal Component
function TargetPriceModal({ commodity, cropYear, onClose, onSave }) {
  const [targetPrice, setTargetPrice] = useState(commodity.currentPrice || '');
  const [saving, setSaving] = useState(false);

  const handleSave = async () => {
    if (!targetPrice || parseFloat(targetPrice) <= 0) {
      return;
    }
    setSaving(true);
    await onSave(commodity.commodityId, parseFloat(targetPrice));
    setSaving(false);
  };

  return (
    <Modal isOpen={true} onClose={onClose} title={`Set Target Price - ${commodity.name}`}>
      <div className="space-y-4">
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800">
          <strong>Uncontracted Bushels:</strong> {formatNumber(commodity.uncontractedBu)} bu
          <div className="text-xs text-blue-600 mt-1">
            Set your expected/target price for these bushels to calculate estimated profit/loss
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">Target Price ($/bu)</label>
          <div className="relative">
            <span className="absolute left-3 top-2.5 text-gray-500">$</span>
            <input
              type="number"
              step="0.01"
              value={targetPrice}
              onChange={(e) => setTargetPrice(e.target.value)}
              className="w-full pl-7 pr-3 py-2 border rounded-lg"
              placeholder="4.50"
              autoFocus
            />
          </div>
          <div className="text-xs text-gray-500 mt-1">
            This could be your target sale price, current market price, or expected future price
          </div>
        </div>

        <div className="flex justify-end gap-3 pt-4 border-t">
          <button
            onClick={onClose}
            className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
          >
            Cancel
          </button>
          <button
            onClick={handleSave}
            disabled={saving || !targetPrice || parseFloat(targetPrice) <= 0}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
          >
            {saving ? 'Saving...' : 'Save Target Price'}
          </button>
        </div>
      </div>
    </Modal>
  );
}

// ============================================================================
// OVERHEAD PAGE
// ============================================================================
function OverheadPage({ cropYear, onYearChange }) {
  const [expenses, setExpenses] = useState([]);
  const [categories, setCategories] = useState([]);
  const [commodities, setCommodities] = useState([]);
  const [fieldCropYears, setFieldCropYears] = useState([]);
  const [fields, setFields] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showCopyModal, setShowCopyModal] = useState(false);
  const [editingItem, setEditingItem] = useState(null);
  const [deleteConfirm, setDeleteConfirm] = useState(null);
  const [activeCategory, setActiveCategory] = useState(null);
  const { addToast } = useToast();
  const currentYear = new Date().getFullYear();
  const cropYears = [currentYear - 1, currentYear, currentYear + 1];

  // Calculate total acres for per-acre expense calculations
  const totalAcres = fieldCropYears.reduce((sum, fcy) => sum + (fcy.planted_acres || 0), 0);

  const loadData = async () => {
    setLoading(true);
    const [exp, cats, coms, fcy, flds] = await Promise.all([
      getOverheadExpenses(cropYear),
      getOverheadCategories(),
      getCommodities(),
      getFieldCropYears(cropYear),
      getFields()
    ]);
    setExpenses(exp);
    setCategories(cats);
    setCommodities(coms);
    setFieldCropYears(fcy);
    setFields(flds);
    if (!activeCategory && cats.length > 0) setActiveCategory(cats[0].id);
    setLoading(false);
  };

  useEffect(() => { loadData(); }, [cropYear]);

  const handleDelete = async () => {
    try {
      await deleteOverheadExpense(deleteConfirm.id);
      addToast('Expense deleted', { type: 'success' });
      setDeleteConfirm(null);
      loadData();
    } catch (e) {
      addToast('Failed to delete: ' + e.message, { type: 'error' });
    }
  };

  const handleCopyFromYear = async (sourceYear) => {
    try {
      const sourceExpenses = await getOverheadExpenses(sourceYear);
      if (sourceExpenses.length === 0) {
        addToast(`No expenses found in ${sourceYear}`, { type: 'error' });
        return;
      }

      let copied = 0;
      for (const exp of sourceExpenses) {
        const allocations = exp.be_overhead_allocations?.map(a => ({
          commodity_id: a.commodity_id,
          practice_type: a.practice_type
        })) || [];

        await saveOverheadExpense({
          name: exp.name,
          category_id: exp.category_id,
          amount: exp.amount,
          allocation_type: exp.allocation_type,
          notes: exp.notes,
          crop_year: cropYear
        }, allocations);
        copied++;
      }

      addToast(`Copied ${copied} expenses from ${sourceYear}`, { type: 'success' });
      setShowCopyModal(false);
      loadData();
    } catch (e) {
      addToast('Failed to copy: ' + e.message, { type: 'error' });
    }
  };

  const filteredExpenses = activeCategory ? expenses.filter(e => e.category_id === activeCategory) : expenses;
  const categoryTotal = filteredExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
  const grandTotal = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Overhead Expenses</h1>
          <p className="text-sm text-gray-500">Farm-level costs allocated to crops</p>
        </div>
        <div className="flex gap-3">
          <button onClick={() => setShowCopyModal(true)} className="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200" title="Copy from another year">
            <Icon name="copy" size={18} /> Copy Year
          </button>
          <button onClick={() => { setEditingItem(null); setShowModal(true); }} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            <Icon name="plus" size={18} /> Add Expense
          </button>
          <select value={cropYear} onChange={(e) => onYearChange(parseInt(e.target.value))} className="px-4 py-2 border rounded-lg">
            {cropYears.map(y => <option key={y} value={y}>{y} Crop Year</option>)}
          </select>
        </div>
      </div>

      <div className="bg-white rounded-xl shadow-sm border p-4">
        <div className="text-sm text-gray-500 mb-1">Total Overhead ({cropYear})</div>
        <div className="text-2xl font-bold text-gray-900">{formatCurrency(grandTotal)}</div>
      </div>

      <div className="flex gap-2 flex-wrap">
        {categories.map(cat => (
          <button key={cat.id} onClick={() => setActiveCategory(cat.id)}
            className={`px-4 py-2 rounded-lg font-medium ${activeCategory === cat.id ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
            {cat.name}
          </button>
        ))}
      </div>

      <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
        {loading ? (
          <div className="p-8 text-center"><Icon name="loader" className="animate-spin text-blue-600 mx-auto" size={32} /></div>
        ) : (
          <>
            <table className="w-full text-sm">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left">Expense</th>
                  <th className="px-4 py-3 text-right">Amount</th>
                  <th className="px-4 py-3 text-left">Allocation</th>
                  <th className="px-4 py-3 text-center">Actions</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {filteredExpenses.length === 0 ? (
                  <tr><td colSpan={4} className="px-4 py-8 text-center text-gray-500">No expenses in this category</td></tr>
                ) : filteredExpenses.map(exp => (
                  <tr key={exp.id} className="hover:bg-gray-50">
                    <td className="px-4 py-3">
                      <div className="font-medium">{exp.name}</div>
                      {exp.notes && <div className="text-xs text-gray-500">{exp.notes}</div>}
                    </td>
                    <td className="px-4 py-3 text-right">
                      <div className="font-medium">{formatCurrency(exp.amount)}</div>
                      {exp.entry_mode === 'PER_ACRE' && exp.per_acre_amount && (
                        <div className="text-xs text-gray-500">{formatCurrency(exp.per_acre_amount)}/acre</div>
                      )}
                    </td>
                    <td className="px-4 py-3">
                      {exp.allocation_type === 'ALL_ACRES' ? (
                        <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs font-medium">
                          <Icon name="check-circle" size={12} /> All Acres
                        </span>
                      ) : exp.allocation_type === 'SPECIFIC_FIELD' ? (
                        <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs font-medium">
                          <Icon name="map-pin" size={12} /> {exp.fields?.name || 'Field'}
                        </span>
                      ) : (
                        <div className="flex flex-wrap gap-1">
                          {(exp.be_overhead_allocations || []).map((a, i) => {
                            const practice = a.practice_type === 'IR' ? ' (IR)' : a.practice_type === 'DL' ? ' (DL)' : '';
                            return (
                              <span key={i} className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">
                                {a.commodities?.name}{practice}
                              </span>
                            );
                          })}
                        </div>
                      )}
                    </td>
                    <td className="px-4 py-3 text-center">
                      <button onClick={() => { setEditingItem(exp); setShowModal(true); }} className="p-1 hover:bg-gray-100 rounded"><Icon name="pencil" size={16} /></button>
                      <button onClick={() => setDeleteConfirm(exp)} className="p-1 hover:bg-red-100 rounded text-red-600"><Icon name="trash-2" size={16} /></button>
                    </td>
                  </tr>
                ))}
              </tbody>
              <tfoot className="bg-gray-50">
                <tr>
                  <td className="px-4 py-3 font-semibold">Category Total</td>
                  <td className="px-4 py-3 text-right font-bold">{formatCurrency(categoryTotal)}</td>
                  <td colSpan={2}></td>
                </tr>
              </tfoot>
            </table>
            <div className="p-4 border-t bg-gray-50">
              <button
                onClick={() => { setEditingItem(null); setShowModal(true); }}
                className="w-full flex items-center justify-center gap-2 px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50 transition-all"
              >
                <Icon name="plus" size={18} /> Add Expense to {categories.find(c => c.id === activeCategory)?.name || 'Category'}
              </button>
            </div>
          </>
        )}
      </div>

      {showModal && <OverheadModal expense={editingItem} cropYear={cropYear} categories={categories} commodities={commodities} fields={fields} totalAcres={totalAcres} activeCategory={activeCategory} onClose={() => setShowModal(false)} onSave={(keepOpen) => { if (!keepOpen) setShowModal(false); loadData(); }} />}
      {showCopyModal && (
        <Modal isOpen={true} onClose={() => setShowCopyModal(false)} title="Copy Overhead from Another Year">
          <div className="space-y-4">
            <p className="text-gray-600">Select a year to copy all overhead expenses from. This will add copies to {cropYear}.</p>
            {expenses.length > 0 && (
              <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-800">
                <Icon name="alert-triangle" size={16} className="inline mr-2" />
                Warning: {cropYear} already has {expenses.length} expense(s). Copying will add more, not replace.
              </div>
            )}
            <div className="grid grid-cols-3 gap-3">
              {cropYears.filter(y => y !== cropYear).map(year => (
                <button
                  key={year}
                  onClick={() => handleCopyFromYear(year)}
                  className="p-4 border-2 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-all"
                >
                  <div className="text-2xl font-bold text-gray-900">{year}</div>
                  <div className="text-sm text-gray-500">Copy from</div>
                </button>
              ))}
            </div>
            <div className="flex justify-end pt-4 border-t">
              <button onClick={() => setShowCopyModal(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
            </div>
          </div>
        </Modal>
      )}
      <ConfirmModal isOpen={!!deleteConfirm} title="Delete Expense" message="Are you sure?" onConfirm={handleDelete} onCancel={() => setDeleteConfirm(null)} />
    </div>
  );
}

function OverheadModal({ expense, cropYear, categories, commodities, fields = [], onClose, onSave, totalAcres = 0, activeCategory = null }) {
  // Get initial category - use active category tab or first available
  const getInitialCategory = () => {
    if (expense?.category_id) return expense.category_id;
    if (activeCategory) return activeCategory;
    return categories.length > 0 ? categories[0].id : '';
  };

  const getInitialForm = () => ({
    name: expense?.name || '',
    category_id: getInitialCategory(),
    amount: expense?.amount || '',
    entry_mode: expense?.entry_mode || 'TOTAL',
    per_acre_amount: expense?.per_acre_amount || '',
    allocation_type: expense?.allocation_type || 'ALL_ACRES',
    field_id: expense?.field_id || '',
    notes: expense?.notes || '',
    crop_year: cropYear
  });

  const [form, setForm] = useState(getInitialForm());
  const [allocations, setAllocations] = useState(
    expense?.be_overhead_allocations?.map(a => ({ commodity_id: a.commodity_id, practice_type: a.practice_type })) || []
  );
  const [saving, setSaving] = useState(false);
  const [addAnother, setAddAnother] = useState(false);
  const { addToast } = useToast();

  const practiceTypes = [
    { id: null, label: 'All Practices', desc: 'Both irrigated and dryland' },
    { id: 'IR', label: 'Irrigated Only', desc: 'Only irrigated fields' },
    { id: 'DL', label: 'Dryland Only', desc: 'Only dryland fields' }
  ];

  const isCommoditySelected = (commodityId) => allocations.some(a => a.commodity_id === commodityId);

  const toggleCommodity = (commodityId) => {
    if (isCommoditySelected(commodityId)) {
      setAllocations(prev => prev.filter(a => a.commodity_id !== commodityId));
    } else {
      setAllocations(prev => [...prev, { commodity_id: commodityId, practice_type: null }]);
    }
  };

  const setPracticeForCommodity = (commodityId, practiceType) => {
    setAllocations(prev => prev.map(a =>
      a.commodity_id === commodityId ? { ...a, practice_type: practiceType } : a
    ));
  };

  const getAllocationForCommodity = (commodityId) => {
    return allocations.find(a => a.commodity_id === commodityId);
  };

  const handleSave = async () => {
    const hasAmount = form.entry_mode === 'TOTAL' ? form.amount : form.per_acre_amount;
    if (!form.name || !hasAmount || !form.category_id) {
      addToast('Please fill required fields (name, category, amount)', { type: 'error' });
      return;
    }
    if (form.allocation_type === 'SPECIFIC_CROPS' && allocations.length === 0) {
      addToast('Please select at least one commodity', { type: 'error' });
      return;
    }
    if (form.allocation_type === 'SPECIFIC_FIELD' && !form.field_id) {
      addToast('Please select a field', { type: 'error' });
      return;
    }
    setSaving(true);
    try {
      // Calculate amount based on entry mode
      let finalAmount = 0;
      let perAcre = null;
      if (form.entry_mode === 'TOTAL') {
        finalAmount = parseFloat(form.amount);
      } else {
        perAcre = parseFloat(form.per_acre_amount);
        finalAmount = perAcre * totalAcres; // Will be recalculated during allocation
      }
      await saveOverheadExpense({
        ...form,
        amount: finalAmount,
        per_acre_amount: perAcre,
        entry_mode: form.entry_mode,
        id: expense?.id
      }, form.allocation_type === 'SPECIFIC_CROPS' ? allocations : []);
      addToast('Expense saved', { type: 'success' });

      if (addAnother && !expense) {
        // Reset form for next entry, keep category
        setForm({
          name: '',
          category_id: form.category_id,
          amount: '',
          entry_mode: 'TOTAL',
          per_acre_amount: '',
          allocation_type: 'ALL_ACRES',
          field_id: '',
          notes: '',
          crop_year: cropYear
        });
        setAllocations([]);
        onSave(true); // Signal to refresh data but keep modal open
      } else {
        onSave(false);
      }
    } catch (e) {
      addToast('Failed to save: ' + e.message, { type: 'error' });
    }
    setSaving(false);
  };

  return (
    <Modal isOpen={true} onClose={onClose} title={expense ? 'Edit Expense' : 'Add Expense'}>
      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-1">Expense Name *</label>
          <input type="text" value={form.name} onChange={(e) => setForm(f => ({ ...f, name: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" placeholder="e.g., Planter Payment" />
        </div>
        <div>
          <label className="block text-sm font-medium mb-1">Category *</label>
          <select value={form.category_id} onChange={(e) => setForm(f => ({ ...f, category_id: e.target.value }))} className="w-full px-3 py-2 border rounded-lg">
            {!form.category_id && <option value="">Select a category...</option>}
            {categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
          </select>
          {categories.length === 0 && <div className="text-xs text-amber-600 mt-1">No categories found. Please check database.</div>}
        </div>

        <div>
          <label className="block text-sm font-medium mb-2">Entry Mode</label>
          <div className="grid grid-cols-2 gap-2">
            <button
              type="button"
              onClick={() => setForm(f => ({ ...f, entry_mode: 'TOTAL' }))}
              className={`p-3 rounded-lg border-2 text-left transition-all ${form.entry_mode === 'TOTAL' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
            >
              <div className="font-medium">Total Amount</div>
              <div className="text-xs text-gray-500">Enter fixed annual cost</div>
            </button>
            <button
              type="button"
              onClick={() => setForm(f => ({ ...f, entry_mode: 'PER_ACRE' }))}
              className={`p-3 rounded-lg border-2 text-left transition-all ${form.entry_mode === 'PER_ACRE' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
            >
              <div className="font-medium">Per Acre Cost</div>
              <div className="text-xs text-gray-500">Enter cost per acre</div>
            </button>
          </div>
        </div>

        {form.entry_mode === 'TOTAL' ? (
          <div>
            <label className="block text-sm font-medium mb-1">Total Amount *</label>
            <div className="relative">
              <span className="absolute left-3 top-2 text-gray-500">$</span>
              <input type="number" step="0.01" value={form.amount} onChange={(e) => setForm(f => ({ ...f, amount: e.target.value }))} className="w-full pl-7 pr-3 py-2 border rounded-lg" placeholder="e.g., 45000" />
            </div>
            {form.amount && totalAcres > 0 && (
              <div className="text-xs text-gray-500 mt-1">= {formatCurrency(parseFloat(form.amount) / totalAcres)}/acre ({totalAcres.toLocaleString()} acres)</div>
            )}
          </div>
        ) : (
          <div>
            <label className="block text-sm font-medium mb-1">Cost Per Acre *</label>
            <div className="relative">
              <span className="absolute left-3 top-2 text-gray-500">$</span>
              <input type="number" step="0.01" value={form.per_acre_amount} onChange={(e) => setForm(f => ({ ...f, per_acre_amount: e.target.value }))} className="w-full pl-7 pr-16 py-2 border rounded-lg" placeholder="e.g., 12.50" />
              <span className="absolute right-3 top-2 text-gray-500">/acre</span>
            </div>
            {form.per_acre_amount && totalAcres > 0 && (
              <div className="text-xs text-gray-500 mt-1">= {formatCurrency(parseFloat(form.per_acre_amount) * totalAcres)} total ({totalAcres.toLocaleString()} acres)</div>
            )}
          </div>
        )}
        <div>
          <label className="block text-sm font-medium mb-1">Allocation Method</label>
          <div className="grid grid-cols-3 gap-2">
            <button
              type="button"
              onClick={() => setForm(f => ({ ...f, allocation_type: 'ALL_ACRES', field_id: '' }))}
              className={`p-3 rounded-lg border-2 text-left transition-all ${form.allocation_type === 'ALL_ACRES' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
            >
              <div className="font-medium">All Acres</div>
              <div className="text-xs text-gray-500">Spread across all fields</div>
            </button>
            <button
              type="button"
              onClick={() => setForm(f => ({ ...f, allocation_type: 'SPECIFIC_CROPS', field_id: '' }))}
              className={`p-3 rounded-lg border-2 text-left transition-all ${form.allocation_type === 'SPECIFIC_CROPS' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
            >
              <div className="font-medium">Specific Crops</div>
              <div className="text-xs text-gray-500">Certain commodities</div>
            </button>
            <button
              type="button"
              onClick={() => setForm(f => ({ ...f, allocation_type: 'SPECIFIC_FIELD' }))}
              className={`p-3 rounded-lg border-2 text-left transition-all ${form.allocation_type === 'SPECIFIC_FIELD' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
            >
              <div className="font-medium">Specific Field</div>
              <div className="text-xs text-gray-500">One field only</div>
            </button>
          </div>
        </div>
        {form.allocation_type === 'SPECIFIC_FIELD' && (
          <div className="border rounded-lg p-4 bg-gray-50">
            <label className="block text-sm font-medium mb-2">Select Field</label>
            <select
              value={form.field_id}
              onChange={(e) => setForm(f => ({ ...f, field_id: e.target.value }))}
              className="w-full px-3 py-2 border rounded-lg"
            >
              <option value="">Choose a field...</option>
              {fields.map(f => (
                <option key={f.id} value={f.id}>{f.name}</option>
              ))}
            </select>
            <p className="text-xs text-gray-500 mt-2">
              This expense applies only to the selected field. For farm-level reports, it will be averaged across all acres.
            </p>
          </div>
        )}
        {form.allocation_type === 'SPECIFIC_CROPS' && (
          <div className="border rounded-lg p-4 bg-gray-50 space-y-3">
            <div className="text-sm font-medium text-gray-700">Select Crops & Practices</div>
            <p className="text-xs text-gray-500">Click a crop to include it, then choose which practice types to include.</p>
            <div className="space-y-2">
              {commodities.map(c => {
                const isSelected = isCommoditySelected(c.id);
                const alloc = getAllocationForCommodity(c.id);
                return (
                  <div key={c.id} className={`rounded-lg border-2 transition-all ${isSelected ? 'border-blue-400 bg-white' : 'border-gray-200 bg-white'}`}>
                    <button
                      type="button"
                      onClick={() => toggleCommodity(c.id)}
                      className="w-full p-3 flex items-center justify-between"
                    >
                      <div className="flex items-center gap-3">
                        <div className={`w-5 h-5 rounded border-2 flex items-center justify-center ${isSelected ? 'bg-blue-500 border-blue-500' : 'border-gray-300'}`}>
                          {isSelected && <Icon name="check" size={14} className="text-white" />}
                        </div>
                        <span className={`font-medium ${isSelected ? 'text-blue-700' : 'text-gray-600'}`}>{c.name}</span>
                      </div>
                      {isSelected && (
                        <span className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded">
                          {alloc?.practice_type === 'IR' ? 'Irrigated' : alloc?.practice_type === 'DL' ? 'Dryland' : 'All'}
                        </span>
                      )}
                    </button>
                    {isSelected && (
                      <div className="px-3 pb-3 flex gap-2">
                        {practiceTypes.map(pt => (
                          <button
                            key={pt.id || 'all'}
                            type="button"
                            onClick={() => setPracticeForCommodity(c.id, pt.id)}
                            className={`px-3 py-1.5 rounded text-xs font-medium transition-all ${alloc?.practice_type === pt.id ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                          >
                            {pt.label}
                          </button>
                        ))}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
            {allocations.length > 0 && (
              <div className="mt-3 pt-3 border-t text-xs text-gray-500">
                <strong>Summary:</strong> {allocations.map(a => {
                  const com = commodities.find(c => c.id === a.commodity_id);
                  const practice = a.practice_type === 'IR' ? ' (IR)' : a.practice_type === 'DL' ? ' (DL)' : '';
                  return com?.name + practice;
                }).join(', ')}
              </div>
            )}
          </div>
        )}
        <div>
          <label className="block text-sm font-medium mb-1">Notes</label>
          <textarea value={form.notes || ''} onChange={(e) => setForm(f => ({ ...f, notes: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" rows={2} placeholder="Optional notes about this expense..." />
        </div>
        <div className="flex items-center justify-between pt-4 border-t">
          {!expense && (
            <label className="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
              <input
                type="checkbox"
                checked={addAnother}
                onChange={(e) => setAddAnother(e.target.checked)}
                className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
              />
              Add another expense
            </label>
          )}
          {expense && <div></div>}
          <div className="flex gap-3">
            <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
            <button onClick={handleSave} disabled={saving} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
              {saving ? 'Saving...' : addAnother && !expense ? 'Save & Add Another' : 'Save'}
            </button>
          </div>
        </div>
      </div>
    </Modal>
  );
}

// ============================================================================
// SEED PRODUCTS PAGE (Catalog of seed varieties with pricing)
// ============================================================================
function SeedProductsPage({ cropYear, onYearChange }) {
  const [products, setProducts] = useState([]);
  const [commodities, setCommodities] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [editingProduct, setEditingProduct] = useState(null);
  const [deleteConfirm, setDeleteConfirm] = useState(null);
  const [filterCommodity, setFilterCommodity] = useState('');
  const [filterBrand, setFilterBrand] = useState('');
  const { addToast } = useToast();
  const currentYear = new Date().getFullYear();
  const cropYears = [currentYear - 1, currentYear, currentYear + 1];

  const loadData = async () => {
    setLoading(true);
    const [p, c] = await Promise.all([getSeedProducts(cropYear), getCommodities()]);
    setProducts(p);
    setCommodities(c);
    setLoading(false);
  };

  useEffect(() => { loadData(); }, [cropYear]);

  const handleDelete = async () => {
    try {
      await deleteSeedProduct(deleteConfirm.id);
      addToast('Seed product deleted', { type: 'success' });
      setDeleteConfirm(null);
      loadData();
    } catch (e) {
      addToast('Failed to delete: ' + e.message, { type: 'error' });
    }
  };

  // Get unique brands for filter
  const uniqueBrands = [...new Set(products.map(p => p.brand))].sort();

  // Filter products
  const filteredProducts = products.filter(p => {
    if (filterCommodity && p.commodity_id !== filterCommodity) return false;
    if (filterBrand && p.brand !== filterBrand) return false;
    return true;
  });

  // Group by commodity
  const groupedProducts = {};
  filteredProducts.forEach(p => {
    const key = p.commodity_name || 'Other';
    if (!groupedProducts[key]) groupedProducts[key] = [];
    groupedProducts[key].push(p);
  });

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Seed Products</h1>
          <p className="text-sm text-gray-500">Catalog of seed varieties with pricing for crop plans</p>
        </div>
        <div className="flex gap-3">
          <select value={filterBrand} onChange={(e) => setFilterBrand(e.target.value)} className="px-4 py-2 border rounded-lg">
            <option value="">All Brands</option>
            {uniqueBrands.map(b => <option key={b} value={b}>{b}</option>)}
          </select>
          <select value={filterCommodity} onChange={(e) => setFilterCommodity(e.target.value)} className="px-4 py-2 border rounded-lg">
            <option value="">All Crops</option>
            {commodities.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
          </select>
          <button onClick={() => { setEditingProduct(null); setShowModal(true); }} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            <Icon name="plus" size={18} /> Add Product
          </button>
          <select value={cropYear} onChange={(e) => onYearChange(parseInt(e.target.value))} className="px-4 py-2 border rounded-lg">
            {cropYears.map(y => <option key={y} value={y}>{y} Crop Year</option>)}
          </select>
        </div>
      </div>

      {/* Summary cards */}
      <div className="grid grid-cols-4 gap-4">
        <div className="bg-white rounded-xl p-4 shadow-sm border">
          <div className="text-sm text-gray-500">Total Products</div>
          <div className="text-2xl font-bold">{products.length}</div>
        </div>
        <div className="bg-white rounded-xl p-4 shadow-sm border">
          <div className="text-sm text-gray-500">Corn Varieties</div>
          <div className="text-2xl font-bold text-yellow-600">{products.filter(p => p.commodity_name === 'Corn').length}</div>
        </div>
        <div className="bg-white rounded-xl p-4 shadow-sm border">
          <div className="text-sm text-gray-500">Soybean Varieties</div>
          <div className="text-2xl font-bold text-green-600">{products.filter(p => p.commodity_name === 'Soybeans').length}</div>
        </div>
        <div className="bg-white rounded-xl p-4 shadow-sm border">
          <div className="text-sm text-gray-500">Brands</div>
          <div className="text-2xl font-bold text-blue-600">{uniqueBrands.length}</div>
        </div>
      </div>

      {loading ? (
        <div className="p-8 text-center"><Icon name="loader" className="animate-spin text-blue-600 mx-auto" size={32} /></div>
      ) : filteredProducts.length === 0 ? (
        <div className="bg-white rounded-xl shadow-sm border p-8 text-center">
          <Icon name="package" size={48} className="mx-auto text-gray-300 mb-4" />
          <h3 className="text-lg font-medium text-gray-900 mb-2">No Seed Products</h3>
          <p className="text-gray-500 mb-4">Add seed products to use in crop plans and field applications.</p>
          <button onClick={() => { setEditingProduct(null); setShowModal(true); }} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Add Your First Product
          </button>
        </div>
      ) : (
        Object.entries(groupedProducts).map(([commodity, prods]) => (
          <div key={commodity} className="bg-white rounded-xl shadow-sm border overflow-hidden">
            <div className="p-4 border-b bg-gray-50">
              <h2 className="font-semibold text-lg">{commodity}</h2>
              <p className="text-sm text-gray-500">{prods.length} product{prods.length !== 1 ? 's' : ''}</p>
            </div>
            <table className="w-full text-sm">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left">Brand</th>
                  <th className="px-4 py-3 text-left">Hybrid</th>
                  <th className="px-4 py-3 text-left">Maturity</th>
                  <th className="px-4 py-3 text-left">Traits</th>
                  <th className="px-4 py-3 text-right">Seeds/Bag</th>
                  <th className="px-4 py-3 text-right">Price/Bag</th>
                  <th className="px-4 py-3 text-right">Default Rate</th>
                  <th className="px-4 py-3 text-center">Practice</th>
                  <th className="px-4 py-3 text-center">Actions</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {prods.map(p => (
                  <tr key={p.id} className="hover:bg-gray-50">
                    <td className="px-4 py-3 font-medium">{p.brand}</td>
                    <td className="px-4 py-3">
                      <div className="font-medium text-blue-600">{p.hybrid}</div>
                    </td>
                    <td className="px-4 py-3 text-gray-600">{p.relative_maturity || '-'}</td>
                    <td className="px-4 py-3">
                      {p.traits ? (
                        <span className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded">{p.traits}</span>
                      ) : '-'}
                    </td>
                    <td className="px-4 py-3 text-right">{formatNumber(p.seeds_per_bag)}</td>
                    <td className="px-4 py-3 text-right font-medium">{formatCurrency(p.price_per_bag)}</td>
                    <td className="px-4 py-3 text-right text-gray-600">{formatNumber(p.default_seeding_rate)}/ac</td>
                    <td className="px-4 py-3 text-center">
                      {p.practice_type ? (
                        <span className={`text-xs px-2 py-0.5 rounded ${p.practice_type === 'IR' ? 'bg-blue-100 text-blue-700' : 'bg-amber-100 text-amber-700'}`}>
                          {p.practice_type === 'IR' ? 'Irrigated' : 'Dryland'}
                        </span>
                      ) : (
                        <span className="text-xs text-gray-400">Any</span>
                      )}
                    </td>
                    <td className="px-4 py-3 text-center">
                      <button onClick={() => { setEditingProduct(p); setShowModal(true); }} className="p-1 hover:bg-gray-100 rounded"><Icon name="pencil" size={16} /></button>
                      <button onClick={() => setDeleteConfirm(p)} className="p-1 hover:bg-red-100 rounded text-red-600"><Icon name="trash-2" size={16} /></button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ))
      )}

      {showModal && <SeedProductModal product={editingProduct} commodities={commodities} cropYear={cropYear} onClose={() => setShowModal(false)} onSave={(keepOpen) => { if (!keepOpen) setShowModal(false); loadData(); }} />}
      <ConfirmModal isOpen={!!deleteConfirm} title="Delete Seed Product" message={`Delete ${deleteConfirm?.brand} ${deleteConfirm?.hybrid}?`} onConfirm={handleDelete} onCancel={() => setDeleteConfirm(null)} />
    </div>
  );
}

function SeedProductModal({ product, commodities, cropYear, onClose, onSave }) {
  // Default seeds/bag by commodity
  const seedDefaults = {
    'Corn': { seeds_per_bag: 80000, default_seeding_rate: 34000 },
    'Soybeans': { seeds_per_bag: 140000, default_seeding_rate: 140000 },
    'Wheat': { seeds_per_bag: 600000, default_seeding_rate: 1200000 },
    'Milo': { seeds_per_bag: 80000, default_seeding_rate: 32000 }
  };

  const [form, setForm] = useState({
    commodity_id: product?.commodity_id || '',
    brand: product?.brand || '',
    hybrid: product?.hybrid || '',
    relative_maturity: product?.relative_maturity || '',
    traits: product?.traits || '',
    seeds_per_bag: product?.seeds_per_bag || 80000,
    price_per_bag: product?.price_per_bag || '',
    default_seeding_rate: product?.default_seeding_rate || 34000,
    practice_type: product?.practice_type || '',
    notes: product?.notes || ''
  });
  const [saving, setSaving] = useState(false);
  const [addAnother, setAddAnother] = useState(false);
  const { addToast } = useToast();

  // Auto-set defaults when commodity changes
  const selectedCommodity = commodities.find(c => c.id === form.commodity_id);
  useEffect(() => {
    if (selectedCommodity && !product) {
      const defaults = seedDefaults[selectedCommodity.name] || { seeds_per_bag: 80000, default_seeding_rate: 34000 };
      setForm(f => ({ ...f, seeds_per_bag: defaults.seeds_per_bag, default_seeding_rate: defaults.default_seeding_rate }));
    }
  }, [selectedCommodity?.name]);

  const handleSave = async () => {
    if (!form.commodity_id || !form.brand || !form.hybrid) {
      addToast('Please fill required fields (Crop, Brand, Hybrid)', { type: 'error' });
      return;
    }
    setSaving(true);
    try {
      await saveSeedProduct({ ...form, id: product?.id }, cropYear);
      addToast('Seed product saved', { type: 'success' });

      if (addAnother && !product) {
        // Reset form for next entry, keep commodity and brand
        setForm(f => ({
          commodity_id: f.commodity_id,
          brand: f.brand,
          hybrid: '',
          relative_maturity: '',
          traits: f.traits, // Keep traits as they're often similar
          seeds_per_bag: f.seeds_per_bag,
          price_per_bag: f.price_per_bag,
          default_seeding_rate: f.default_seeding_rate,
          practice_type: f.practice_type,
          notes: ''
        }));
        onSave(true); // Signal refresh but keep modal open
      } else {
        onSave(false);
      }
    } catch (e) {
      addToast('Failed to save: ' + e.message, { type: 'error' });
    }
    setSaving(false);
  };

  // Calculate cost per acre for reference
  const costPerAcre = form.price_per_bag && form.seeds_per_bag && form.default_seeding_rate
    ? (form.default_seeding_rate / form.seeds_per_bag) * parseFloat(form.price_per_bag)
    : 0;

  return (
    <Modal isOpen={true} onClose={onClose} title={product ? 'Edit Seed Product' : 'Add Seed Product'}>
      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-1">Crop *</label>
          <select value={form.commodity_id} onChange={(e) => setForm(f => ({ ...f, commodity_id: e.target.value }))} className="w-full px-3 py-2 border rounded-lg">
            <option value="">Select Crop</option>
            {commodities.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
          </select>
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">Brand *</label>
            <input type="text" value={form.brand} onChange={(e) => setForm(f => ({ ...f, brand: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" placeholder="Pioneer, Dekalb, Asgrow..." />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Hybrid *</label>
            <input type="text" value={form.hybrid} onChange={(e) => setForm(f => ({ ...f, hybrid: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" placeholder="P1185AM, DKC64-35..." />
          </div>
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">Relative Maturity</label>
            <input type="text" value={form.relative_maturity} onChange={(e) => setForm(f => ({ ...f, relative_maturity: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" placeholder="111 day, 3.6..." />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Traits</label>
            <input type="text" value={form.traits} onChange={(e) => setForm(f => ({ ...f, traits: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" placeholder="SmartStax Pro, Enlist E3..." />
          </div>
        </div>

        <div className="grid grid-cols-3 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">Seeds/Bag</label>
            <input type="number" value={form.seeds_per_bag} onChange={(e) => setForm(f => ({ ...f, seeds_per_bag: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Price/Bag</label>
            <div className="relative">
              <span className="absolute left-3 top-2 text-gray-500">$</span>
              <input type="number" step="0.01" value={form.price_per_bag} onChange={(e) => setForm(f => ({ ...f, price_per_bag: e.target.value }))} className="w-full pl-7 pr-3 py-2 border rounded-lg" />
            </div>
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Default Rate</label>
            <input type="number" value={form.default_seeding_rate} onChange={(e) => setForm(f => ({ ...f, default_seeding_rate: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" placeholder="seeds/acre" />
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">Practice Type</label>
          <div className="grid grid-cols-3 gap-2">
            <button type="button" onClick={() => setForm(f => ({ ...f, practice_type: '' }))}
              className={`p-2 rounded-lg border-2 text-sm ${!form.practice_type ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>
              Any
            </button>
            <button type="button" onClick={() => setForm(f => ({ ...f, practice_type: 'IR' }))}
              className={`p-2 rounded-lg border-2 text-sm ${form.practice_type === 'IR' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>
              Irrigated
            </button>
            <button type="button" onClick={() => setForm(f => ({ ...f, practice_type: 'DL' }))}
              className={`p-2 rounded-lg border-2 text-sm ${form.practice_type === 'DL' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>
              Dryland
            </button>
          </div>
        </div>

        {costPerAcre > 0 && (
          <div className="bg-blue-50 rounded-lg p-3 flex justify-between items-center">
            <span className="text-sm text-blue-800">Estimated cost per acre:</span>
            <span className="font-bold text-blue-900">{formatCurrency(costPerAcre)}/ac</span>
          </div>
        )}

        <div>
          <label className="block text-sm font-medium mb-1">Notes</label>
          <textarea value={form.notes || ''} onChange={(e) => setForm(f => ({ ...f, notes: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" rows={2} placeholder="Optional notes..." />
        </div>

        <div className="flex items-center justify-between pt-4 border-t">
          {!product && (
            <label className="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
              <input type="checkbox" checked={addAnother} onChange={(e) => setAddAnother(e.target.checked)} className="w-4 h-4 rounded border-gray-300 text-blue-600" />
              Add another product
            </label>
          )}
          {product && <div></div>}
          <div className="flex gap-3">
            <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
            <button onClick={handleSave} disabled={saving} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
              {saving ? 'Saving...' : addAnother && !product ? 'Save & Add Another' : 'Save'}
            </button>
          </div>
        </div>
      </div>
    </Modal>
  );
}

function RentModal({ rent, cropYear, fields, onClose, onSave }) {
  const [form, setForm] = useState({ field_id: '', crop_year: cropYear, rent_type: 'CASH', rent_per_acre: '', notes: '' });
  const [saving, setSaving] = useState(false);
  const { addToast } = useToast();

  useEffect(() => {
    if (rent) setForm({ ...rent });
  }, [rent]);

  const handleSave = async () => {
    if (!form.field_id || !form.rent_per_acre) {
      addToast('Please fill required fields', { type: 'error' });
      return;
    }
    setSaving(true);
    try {
      await saveLandRent({ ...form, rent_per_acre: parseFloat(form.rent_per_acre) });
      addToast('Rent saved', { type: 'success' });
      onSave();
    } catch (e) {
      addToast('Failed to save: ' + e.message, { type: 'error' });
    }
    setSaving(false);
  };

  return (
    <Modal isOpen={true} onClose={onClose} title={rent ? 'Edit Rent' : 'Add Rent'}>
      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-1">Field *</label>
          <select value={form.field_id} onChange={(e) => setForm(f => ({ ...f, field_id: e.target.value }))} className="w-full px-3 py-2 border rounded-lg">
            <option value="">Select Field</option>
            {fields.map(f => <option key={f.id} value={f.id}>{f.name} ({f.farm_name}) - {formatNumber(f.acres)} ac</option>)}
          </select>
        </div>
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">Rent Type</label>
            <select value={form.rent_type} onChange={(e) => setForm(f => ({ ...f, rent_type: e.target.value }))} className="w-full px-3 py-2 border rounded-lg">
              <option value="CASH">Cash Rent</option>
              <option value="SHARE">Share Rent</option>
              <option value="OWNED">Owned</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Rent/Acre *</label>
            <input type="number" step="0.01" value={form.rent_per_acre} onChange={(e) => setForm(f => ({ ...f, rent_per_acre: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" />
          </div>
        </div>
        <div>
          <label className="block text-sm font-medium mb-1">Notes</label>
          <textarea value={form.notes || ''} onChange={(e) => setForm(f => ({ ...f, notes: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" rows={2} />
        </div>
        <div className="flex justify-end gap-3 pt-4 border-t">
          <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
          <button onClick={handleSave} disabled={saving} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">{saving ? 'Saving...' : 'Save'}</button>
        </div>
      </div>
    </Modal>
  );
}

// ============================================================================
// LAND RENT PAGE
// ============================================================================
function LandRentPage({ cropYear, onYearChange }) {
  const [fields, setFields] = useState([]);
  const [rents, setRents] = useState([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState({});
  const { addToast } = useToast();
  const currentYear = new Date().getFullYear();
  const cropYears = [currentYear - 1, currentYear, currentYear + 1];

  const loadData = async () => {
    setLoading(true);
    const [fieldsData, rentsData] = await Promise.all([
      getFieldsWithFarms(),
      getLandRent(cropYear)
    ]);
    setFields(fieldsData);
    setRents(rentsData);
    setLoading(false);
  };

  useEffect(() => { loadData(); }, [cropYear]);

  // Filter fields: only show where adams_grain_share > 0 (exclude Dwight farms)
  const myFields = fields.filter(f => {
    const adamsShare = f.farms?.adams_grain_share ?? 1;
    return adamsShare > 0;
  });

  // Determine rent type for each field
  const getFieldRentInfo = (field) => {
    const adamsShare = field.farms?.adams_grain_share ?? 1;
    const tenantShare = Number(field.tenant_share ?? 1);
    const farmName = field.farms?.name || '';

    // For Adams farms (100% ownership): tenant_share = 1 means cash rent
    // For BFP farms (50% ownership): tenant_share = 1 means cash rent (user gets 50%)
    // If tenant_share < 1, it's share crop

    const isCashRent = tenantShare === 1;
    const landlordShare = isCashRent ? 0 : (1 - tenantShare);

    // Effective share is what the user gets of the grain
    const effectiveShare = tenantShare * adamsShare;

    return {
      isCashRent,
      landlordShare,
      effectiveShare,
      adamsShare,
      tenantShare,
      farmName,
      landlordName: field.landlord || 'Landlord'
    };
  };

  // Build field rows with rent data
  const fieldRows = myFields.map(field => {
    const rentRecord = rents.find(r => r.field_id === field.id);
    const rentInfo = getFieldRentInfo(field);
    return {
      ...field,
      ...rentInfo,
      rent_id: rentRecord?.id,
      rent_per_acre: rentRecord?.rent_per_acre || '',
      rent_type: rentRecord?.rent_type || (rentInfo.isCashRent ? 'CASH' : 'SHARE')
    };
  }).sort((a, b) => {
    // Sort by farm name, then field name
    const farmCompare = (a.farms?.name || '').localeCompare(b.farms?.name || '');
    if (farmCompare !== 0) return farmCompare;
    return (a.name || '').localeCompare(b.name || '');
  });

  // Save rent for a field
  const saveRent = async (field, rentPerAcre) => {
    const key = field.id;
    setSaving(s => ({ ...s, [key]: true }));

    try {
      const rentData = {
        id: field.rent_id || undefined,
        field_id: field.id,
        crop_year: cropYear,
        rent_per_acre: parseFloat(rentPerAcre) || 0,
        rent_type: field.isCashRent ? 'CASH' : 'SHARE'
      };

      await saveLandRent(rentData);
      addToast(`Rent saved for ${field.name}`, { type: 'success' });
      loadData();
    } catch (e) {
      addToast('Failed to save: ' + e.message, { type: 'error' });
    }

    setSaving(s => ({ ...s, [key]: false }));
  };

  // Copy rent from another year
  const copyFromYear = async (fromYear) => {
    try {
      const sourceRents = await getLandRent(fromYear);
      let copied = 0;

      for (const rent of sourceRents) {
        // Only copy for fields we're showing
        if (myFields.some(f => f.id === rent.field_id)) {
          await saveLandRent({
            field_id: rent.field_id,
            crop_year: cropYear,
            rent_per_acre: rent.rent_per_acre,
            rent_type: rent.rent_type
          });
          copied++;
        }
      }

      addToast(`Copied ${copied} rent entries from ${fromYear}`, { type: 'success' });
      loadData();
    } catch (e) {
      addToast('Failed to copy: ' + e.message, { type: 'error' });
    }
  };

  // Group fields by farm for display
  const farmGroups = {};
  fieldRows.forEach(field => {
    const farmName = field.farms?.name || 'Unknown Farm';
    if (!farmGroups[farmName]) {
      farmGroups[farmName] = {
        name: farmName,
        adamsShare: field.adamsShare,
        fields: []
      };
    }
    farmGroups[farmName].fields.push(field);
  });

  // Calculate totals - Full rent (100%) and Your Share (based on adams_grain_share)
  const totalFullRent = fieldRows.reduce((sum, f) => {
    if (f.isCashRent && f.rent_per_acre) {
      return sum + (parseFloat(f.rent_per_acre) * (f.acres || 0));
    }
    return sum;
  }, 0);

  // Your share = Full rent * adams_grain_share
  const totalYourShareRent = fieldRows.reduce((sum, f) => {
    if (f.isCashRent && f.rent_per_acre) {
      const fullRent = parseFloat(f.rent_per_acre) * (f.acres || 0);
      return sum + (fullRent * f.adamsShare);
    }
    return sum;
  }, 0);

  const totalCashRentAcres = fieldRows.filter(f => f.isCashRent).reduce((sum, f) => sum + (f.acres || 0), 0);
  const totalShareCropAcres = fieldRows.filter(f => !f.isCashRent).reduce((sum, f) => sum + (f.acres || 0), 0);

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Land Rent</h1>
          <p className="text-sm text-gray-500">Cash rent entries for {cropYear}</p>
        </div>
        <div className="flex gap-3">
          <div className="relative">
            <select onChange={(e) => e.target.value && copyFromYear(parseInt(e.target.value))}
              className="px-4 py-2 border rounded-lg text-gray-600" defaultValue="">
              <option value="" disabled>Copy from year...</option>
              {cropYears.filter(y => y !== cropYear).map(y => (
                <option key={y} value={y}>{y}</option>
              ))}
            </select>
          </div>
          <select value={cropYear} onChange={(e) => onYearChange(parseInt(e.target.value))} className="px-4 py-2 border rounded-lg">
            {cropYears.map(y => <option key={y} value={y}>{y} Crop Year</option>)}
          </select>
        </div>
      </div>

      {/* Summary cards */}
      <div className="grid grid-cols-4 gap-4">
        <div className="bg-white rounded-xl p-4 shadow-sm border">
          <div className="text-sm text-gray-500">Cash Rent Acres</div>
          <div className="text-2xl font-bold">{formatNumber(totalCashRentAcres)}</div>
        </div>
        <div className="bg-white rounded-xl p-4 shadow-sm border">
          <div className="text-sm text-gray-500">Share Crop Acres</div>
          <div className="text-2xl font-bold text-purple-600">{formatNumber(totalShareCropAcres)}</div>
        </div>
        <div className="bg-white rounded-xl p-4 shadow-sm border">
          <div className="text-sm text-gray-500">Full Rent (100%)</div>
          <div className="text-2xl font-bold text-gray-600">{formatCurrency(totalFullRent)}</div>
          <div className="text-xs text-gray-400">What farms owe</div>
        </div>
        <div className="bg-white rounded-xl p-4 shadow-sm border">
          <div className="text-sm text-gray-500">Your Share</div>
          <div className="text-2xl font-bold text-green-600">{formatCurrency(totalYourShareRent)}</div>
          <div className="text-xs text-gray-400">Your responsibility</div>
        </div>
      </div>

      {loading ? (
        <div className="bg-white rounded-xl p-8 text-center shadow-sm border">
          <Icon name="loader" className="animate-spin text-blue-600 mx-auto" size={32} />
        </div>
      ) : (
        <div className="space-y-6">
          {Object.values(farmGroups).map(farm => (
            <div key={farm.name} className="bg-white rounded-xl shadow-sm border overflow-hidden">
              <div className="px-4 py-3 bg-gray-50 border-b flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <Icon name="home" size={20} className="text-gray-500" />
                  <span className="font-semibold">{farm.name}</span>
                  {farm.adamsShare < 1 && (
                    <span className="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs">
                      {(farm.adamsShare * 100).toFixed(0)}% ownership
                    </span>
                  )}
                </div>
                <span className="text-sm text-gray-500">{farm.fields.length} fields</span>
              </div>
              <table className="w-full text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-2 text-left">Field</th>
                    <th className="px-4 py-2 text-right">Acres</th>
                    <th className="px-4 py-2 text-center">Type</th>
                    <th className="px-4 py-2 text-right w-32">Full Rent/Ac</th>
                    <th className="px-4 py-2 text-right">Your Share/Ac</th>
                    <th className="px-4 py-2 text-right">Full Total</th>
                    <th className="px-4 py-2 text-right">Your Total</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {farm.fields.map(field => {
                    const fullTotal = field.isCashRent && field.rent_per_acre ? parseFloat(field.rent_per_acre) * (field.acres || 0) : 0;
                    const yourSharePerAcre = field.isCashRent && field.rent_per_acre ? parseFloat(field.rent_per_acre) * field.adamsShare : 0;
                    const yourTotal = fullTotal * field.adamsShare;
                    return (
                      <tr key={field.id} className={field.isCashRent ? 'hover:bg-gray-50' : 'bg-purple-50'}>
                        <td className="px-4 py-3">
                          <div className="font-medium">{field.name}</div>
                        </td>
                        <td className="px-4 py-3 text-right">{formatNumber(field.acres)}</td>
                        <td className="px-4 py-3 text-center">
                          {field.isCashRent ? (
                            <span className="px-2 py-0.5 bg-green-100 text-green-800 rounded text-xs">Cash Rent</span>
                          ) : (
                            <span className="px-2 py-0.5 bg-purple-100 text-purple-800 rounded text-xs">
                              {((1 - field.tenantShare) * 100).toFixed(0)}% to {field.landlordName}
                            </span>
                          )}
                        </td>
                        <td className="px-4 py-3">
                          {field.isCashRent ? (
                            <div className="flex items-center justify-end gap-2">
                              <span className="text-gray-500">$</span>
                              <input
                                type="number"
                                step="0.01"
                                defaultValue={field.rent_per_acre}
                                onBlur={(e) => {
                                  if (e.target.value !== String(field.rent_per_acre || '')) {
                                    saveRent(field, e.target.value);
                                  }
                                }}
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    e.target.blur();
                                  }
                                }}
                                className="w-24 px-2 py-1 border rounded text-right"
                                placeholder="0.00"
                              />
                              {saving[field.id] && <Icon name="loader" className="animate-spin" size={16} />}
                            </div>
                          ) : (
                            <div className="flex items-center justify-end">
                              <div className="w-24 px-2 py-1 bg-gray-100 border rounded text-right text-gray-400">
                                N/A
                              </div>
                            </div>
                          )}
                        </td>
                        <td className="px-4 py-3 text-right">
                          {field.isCashRent && field.rent_per_acre ? (
                            <span className={field.adamsShare < 1 ? 'text-blue-600 font-medium' : ''}>
                              {formatCurrency(yourSharePerAcre)}
                              {field.adamsShare < 1 && <span className="text-xs text-gray-400 ml-1">({(field.adamsShare * 100).toFixed(0)}%)</span>}
                            </span>
                          ) : (
                            <span className="text-gray-400">-</span>
                          )}
                        </td>
                        <td className="px-4 py-3 text-right text-gray-600">
                          {field.isCashRent && field.rent_per_acre ? formatCurrency(fullTotal) : <span className="text-gray-400">-</span>}
                        </td>
                        <td className="px-4 py-3 text-right font-medium text-green-600">
                          {field.isCashRent && field.rent_per_acre ? formatCurrency(yourTotal) : <span className="text-gray-400">-</span>}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

// Helper to get fields with farm data for land rent
async function getFieldsWithFarms() {
  const { data, error } = await db.from('fields')
    .select('id, name, acres, tenant_share, landlord, farm_id, farms(id, name, adams_grain_share)')
    .eq('active', true)
    .order('name');
  return error ? [] : data || [];
}

// ============================================================================
// MISC INCOME PAGE
// ============================================================================
function MiscIncomePage({ cropYear, onYearChange }) {
  const [income, setIncome] = useState([]);
  const [categories, setCategories] = useState([]);
  const [commodities, setCommodities] = useState([]);
  const [fieldCropYears, setFieldCropYears] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [editingItem, setEditingItem] = useState(null);
  const [deleteConfirm, setDeleteConfirm] = useState(null);
  const [activeCategory, setActiveCategory] = useState(null);
  const { addToast } = useToast();
  const currentYear = new Date().getFullYear();
  const cropYears = [currentYear - 1, currentYear, currentYear + 1];

  const loadData = async () => {
    setLoading(true);
    const [inc, cats, coms, fcy] = await Promise.all([
      getMiscIncome(cropYear),
      getMiscIncomeCategories(),
      getCommodities(),
      getFieldCropYears(cropYear)
    ]);
    setIncome(inc);
    setCategories(cats);
    setCommodities(coms);
    setFieldCropYears(fcy);
    if (!activeCategory && cats.length > 0) setActiveCategory(cats[0].id);
    setLoading(false);
  };

  useEffect(() => { loadData(); }, [cropYear]);

  const handleDelete = async () => {
    try {
      await deleteMiscIncome(deleteConfirm.id);
      addToast('Income deleted', { type: 'success' });
      setDeleteConfirm(null);
      loadData();
    } catch (e) {
      addToast('Failed to delete: ' + e.message, { type: 'error' });
    }
  };

  const filteredIncome = activeCategory
    ? income.filter(i => i.category_id === activeCategory)
    : income;

  const categoryTotal = filteredIncome.reduce((sum, i) => {
    if (i.income_type === 'TOTAL') return sum + (i.amount || 0);
    if (i.income_type === 'PER_ACRE') {
      const acres = fieldCropYears.reduce((a, f) => a + (f.planted_acres || 0), 0);
      return sum + (i.amount * acres);
    }
    return sum;
  }, 0);

  const grandTotal = income.reduce((sum, i) => {
    if (i.income_type === 'TOTAL') return sum + (i.amount || 0);
    if (i.income_type === 'PER_ACRE') {
      const acres = fieldCropYears.reduce((a, f) => a + (f.planted_acres || 0), 0);
      return sum + (i.amount * acres);
    }
    return sum;
  }, 0);

  const projectedTotal = income.filter(i => i.is_projected).reduce((sum, i) => {
    if (i.income_type === 'TOTAL') return sum + (i.amount || 0);
    if (i.income_type === 'PER_ACRE') {
      const acres = fieldCropYears.reduce((a, f) => a + (f.planted_acres || 0), 0);
      return sum + (i.amount * acres);
    }
    return sum;
  }, 0);

  const receivedTotal = income.filter(i => !i.is_projected).reduce((sum, i) => {
    if (i.income_type === 'TOTAL') return sum + (i.amount || 0);
    if (i.income_type === 'PER_ACRE') {
      const acres = fieldCropYears.reduce((a, f) => a + (f.planted_acres || 0), 0);
      return sum + (i.amount * acres);
    }
    return sum;
  }, 0);

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Misc Income</h1>
          <p className="text-sm text-gray-500">Government payments, conservation, and other farm income for {cropYear}</p>
        </div>
        <div className="flex gap-3">
          <button onClick={() => { setEditingItem(null); setShowModal(true); }} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
            <Icon name="plus" size={18} /> Add Income
          </button>
          <select value={cropYear} onChange={(e) => onYearChange(parseInt(e.target.value))} className="px-4 py-2 border rounded-lg">
            {cropYears.map(y => <option key={y} value={y}>{y} Crop Year</option>)}
          </select>
        </div>
      </div>

      {/* Summary cards */}
      <div className="grid grid-cols-3 gap-4">
        <div className="bg-white rounded-xl p-4 shadow-sm border">
          <div className="text-sm text-gray-500">Total Income ({cropYear})</div>
          <div className="text-2xl font-bold text-green-600">{formatCurrency(grandTotal)}</div>
        </div>
        <div className="bg-white rounded-xl p-4 shadow-sm border">
          <div className="text-sm text-gray-500">Projected</div>
          <div className="text-2xl font-bold text-amber-600">{formatCurrency(projectedTotal)}</div>
          <div className="text-xs text-gray-400">Estimated payments</div>
        </div>
        <div className="bg-white rounded-xl p-4 shadow-sm border">
          <div className="text-sm text-gray-500">Received</div>
          <div className="text-2xl font-bold text-blue-600">{formatCurrency(receivedTotal)}</div>
          <div className="text-xs text-gray-400">Actually received</div>
        </div>
      </div>

      {/* Category tabs */}
      <div className="flex gap-2 flex-wrap">
        {categories.map(cat => (
          <button key={cat.id} onClick={() => setActiveCategory(cat.id)}
            className={`px-4 py-2 rounded-lg font-medium ${activeCategory === cat.id ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
            {cat.name}
          </button>
        ))}
      </div>

      <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
        {loading ? (
          <div className="p-8 text-center"><Icon name="loader" className="animate-spin text-green-600 mx-auto" size={32} /></div>
        ) : (
          <table className="w-full text-sm">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left">Income</th>
                <th className="px-4 py-3 text-right">Amount</th>
                <th className="px-4 py-3 text-left">Allocation</th>
                <th className="px-4 py-3 text-center">Status</th>
                <th className="px-4 py-3 text-center">Actions</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {filteredIncome.length === 0 ? (
                <tr><td colSpan={5} className="px-4 py-8 text-center text-gray-500">No income in this category</td></tr>
              ) : filteredIncome.map(item => {
                const calcAmount = item.income_type === 'TOTAL' ? item.amount :
                  item.income_type === 'PER_ACRE' ? item.amount * fieldCropYears.reduce((a, f) => a + (f.planted_acres || 0), 0) : item.amount;
                return (
                  <tr key={item.id} className="hover:bg-gray-50">
                    <td className="px-4 py-3">
                      <div className="font-medium">{item.name}</div>
                      {item.notes && <div className="text-xs text-gray-500">{item.notes}</div>}
                    </td>
                    <td className="px-4 py-3 text-right">
                      <div className="font-medium text-green-600">{formatCurrency(calcAmount)}</div>
                      {item.income_type === 'PER_ACRE' && (
                        <div className="text-xs text-gray-500">{formatCurrency(item.amount)}/acre</div>
                      )}
                    </td>
                    <td className="px-4 py-3">
                      {item.allocation_type === 'ALL_ACRES' ? (
                        <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs font-medium">
                          <Icon name="check-circle" size={12} /> All Acres
                        </span>
                      ) : item.allocation_type === 'SPECIFIC_CROPS' && item.commodity_name ? (
                        <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">{item.commodity_name}</span>
                      ) : (
                        <span className="text-gray-400 text-xs">Specific fields</span>
                      )}
                    </td>
                    <td className="px-4 py-3 text-center">
                      {item.is_projected ? (
                        <span className="px-2 py-0.5 bg-amber-100 text-amber-700 rounded text-xs">Projected</span>
                      ) : (
                        <span className="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">Received</span>
                      )}
                    </td>
                    <td className="px-4 py-3 text-center">
                      <button onClick={() => { setEditingItem(item); setShowModal(true); }} className="p-1 hover:bg-gray-100 rounded"><Icon name="pencil" size={16} /></button>
                      <button onClick={() => setDeleteConfirm(item)} className="p-1 hover:bg-red-100 rounded text-red-600"><Icon name="trash-2" size={16} /></button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
            <tfoot className="bg-gray-50">
              <tr>
                <td className="px-4 py-3 font-semibold">Category Total</td>
                <td className="px-4 py-3 text-right font-bold text-green-600">{formatCurrency(categoryTotal)}</td>
                <td colSpan={3}></td>
              </tr>
            </tfoot>
          </table>
        )}
      </div>

      <div className="bg-green-50 border border-green-200 rounded-lg p-4 text-sm text-green-800">
        <Icon name="info" size={16} className="inline mr-2" />
        <strong>How misc income affects breakeven:</strong> Income is subtracted from costs before calculating breakeven price.
        For example, if you have $100/acre in costs and $10/acre in ARC payments, your net cost is $90/acre.
      </div>

      {showModal && (
        <MiscIncomeModal
          income={editingItem}
          cropYear={cropYear}
          categories={categories}
          commodities={commodities}
          onClose={() => setShowModal(false)}
          onSave={() => { setShowModal(false); loadData(); }}
        />
      )}
      <ConfirmModal isOpen={!!deleteConfirm} title="Delete Income" message="Are you sure?" onConfirm={handleDelete} onCancel={() => setDeleteConfirm(null)} />
    </div>
  );
}

function MiscIncomeModal({ income, cropYear, categories, commodities, onClose, onSave }) {
  const [form, setForm] = useState({
    name: '',
    category_id: categories[0]?.id || '',
    income_type: 'TOTAL',
    amount: '',
    allocation_type: 'ALL_ACRES',
    commodity_id: '',
    is_projected: true,
    payment_date: '',
    notes: '',
    crop_year: cropYear
  });
  const [saving, setSaving] = useState(false);
  const { addToast } = useToast();

  useEffect(() => {
    if (income) setForm({ ...income, is_projected: income.is_projected !== false });
  }, [income]);

  const handleSave = async () => {
    if (!form.name || !form.amount) {
      addToast('Please fill required fields', { type: 'error' });
      return;
    }
    setSaving(true);
    try {
      await saveMiscIncome({ ...form, id: income?.id }, []);
      addToast('Income saved', { type: 'success' });
      onSave();
    } catch (e) {
      addToast('Failed to save: ' + e.message, { type: 'error' });
    }
    setSaving(false);
  };

  return (
    <Modal isOpen={true} onClose={onClose} title={income ? 'Edit Income' : 'Add Income'}>
      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-1">Income Name *</label>
          <input type="text" value={form.name} onChange={(e) => setForm(f => ({ ...f, name: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" placeholder="ARC-CO Corn, CRP Annual, etc." />
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">Category</label>
            <select value={form.category_id} onChange={(e) => setForm(f => ({ ...f, category_id: e.target.value }))} className="w-full px-3 py-2 border rounded-lg">
              {categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Status</label>
            <div className="flex gap-2 mt-1">
              <button type="button" onClick={() => setForm(f => ({ ...f, is_projected: true }))}
                className={`flex-1 py-2 px-3 rounded-lg text-sm font-medium ${form.is_projected ? 'bg-amber-100 text-amber-800 border-amber-300' : 'bg-gray-100 text-gray-600'}`}>
                Projected
              </button>
              <button type="button" onClick={() => setForm(f => ({ ...f, is_projected: false }))}
                className={`flex-1 py-2 px-3 rounded-lg text-sm font-medium ${!form.is_projected ? 'bg-green-100 text-green-800 border-green-300' : 'bg-gray-100 text-gray-600'}`}>
                Received
              </button>
            </div>
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium mb-2">Income Type</label>
          <div className="grid grid-cols-2 gap-2">
            <button type="button" onClick={() => setForm(f => ({ ...f, income_type: 'TOTAL' }))}
              className={`p-3 rounded-lg border-2 text-left transition-all ${form.income_type === 'TOTAL' ? 'border-green-500 bg-green-50' : 'border-gray-200 hover:border-gray-300'}`}>
              <div className="font-medium">Total Amount</div>
              <div className="text-xs text-gray-500">Fixed payment amount</div>
            </button>
            <button type="button" onClick={() => setForm(f => ({ ...f, income_type: 'PER_ACRE' }))}
              className={`p-3 rounded-lg border-2 text-left transition-all ${form.income_type === 'PER_ACRE' ? 'border-green-500 bg-green-50' : 'border-gray-200 hover:border-gray-300'}`}>
              <div className="font-medium">Per Acre</div>
              <div className="text-xs text-gray-500">Rate per acre</div>
            </button>
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">Amount *</label>
          <div className="relative">
            <span className="absolute left-3 top-2 text-gray-500">$</span>
            <input type="number" step="0.01" value={form.amount} onChange={(e) => setForm(f => ({ ...f, amount: e.target.value }))} className="w-full pl-7 pr-16 py-2 border rounded-lg" placeholder="0.00" />
            {form.income_type === 'PER_ACRE' && <span className="absolute right-3 top-2 text-gray-500">/acre</span>}
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium mb-2">Allocation</label>
          <div className="space-y-2">
            <label className="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
              <input type="radio" name="allocation" checked={form.allocation_type === 'ALL_ACRES'} onChange={() => setForm(f => ({ ...f, allocation_type: 'ALL_ACRES', commodity_id: '' }))} />
              <div><div className="font-medium">All Acres</div><div className="text-xs text-gray-500">Spread evenly across all fields</div></div>
            </label>
            <label className="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
              <input type="radio" name="allocation" checked={form.allocation_type === 'SPECIFIC_CROPS'} onChange={() => setForm(f => ({ ...f, allocation_type: 'SPECIFIC_CROPS' }))} />
              <div><div className="font-medium">Specific Commodity</div><div className="text-xs text-gray-500">Only to a particular crop</div></div>
            </label>
          </div>
        </div>

        {form.allocation_type === 'SPECIFIC_CROPS' && (
          <div>
            <label className="block text-sm font-medium mb-1">Commodity</label>
            <select value={form.commodity_id} onChange={(e) => setForm(f => ({ ...f, commodity_id: e.target.value }))} className="w-full px-3 py-2 border rounded-lg">
              <option value="">Select commodity...</option>
              {commodities.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
            </select>
          </div>
        )}

        {!form.is_projected && (
          <div>
            <label className="block text-sm font-medium mb-1">Payment Date</label>
            <input type="date" value={form.payment_date || ''} onChange={(e) => setForm(f => ({ ...f, payment_date: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" />
          </div>
        )}

        <div>
          <label className="block text-sm font-medium mb-1">Notes</label>
          <textarea value={form.notes || ''} onChange={(e) => setForm(f => ({ ...f, notes: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" rows={2} placeholder="Optional notes..." />
        </div>

        <div className="flex justify-end gap-3 pt-4 border-t">
          <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
          <button onClick={handleSave} disabled={saving} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50">{saving ? 'Saving...' : 'Save'}</button>
        </div>
      </div>
    </Modal>
  );
}

// ============================================================================
// CHART COMPONENTS
// ============================================================================

// Planned vs Actual Bar Chart Component
function PlannedVsActualChart({ commodities }) {
  const chartRef = React.useRef(null);
  const chartInstance = React.useRef(null);

  useEffect(() => {
    if (!chartRef.current || commodities.length === 0) return;

    // Destroy existing chart
    if (chartInstance.current) {
      chartInstance.current.destroy();
    }

    const ctx = chartRef.current.getContext('2d');
    chartInstance.current = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: commodities.map(c => c.name),
        datasets: [
          {
            label: 'Planned',
            data: commodities.map(c => c.plannedTotal),
            backgroundColor: 'rgba(59, 130, 246, 0.7)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 1
          },
          {
            label: 'Actual',
            data: commodities.map(c => c.actualTotal),
            backgroundColor: 'rgba(16, 185, 129, 0.7)',
            borderColor: 'rgba(16, 185, 129, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 2.5,
        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '$' + (value / 1000).toFixed(0) + 'k';
              }
            }
          }
        }
      }
    });

    return () => {
      if (chartInstance.current) {
        chartInstance.current.destroy();
      }
    };
  }, [commodities]);

  if (commodities.length === 0) {
    return <div className="text-center py-8 text-gray-500">No data available</div>;
  }

  return <canvas ref={chartRef}></canvas>;
}

// Variance Chart Component
function VarianceChart({ commodities }) {
  const chartRef = React.useRef(null);
  const chartInstance = React.useRef(null);

  useEffect(() => {
    if (!chartRef.current || commodities.length === 0) return;

    if (chartInstance.current) {
      chartInstance.current.destroy();
    }

    const ctx = chartRef.current.getContext('2d');
    chartInstance.current = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: commodities.map(c => c.name),
        datasets: [{
          label: 'Variance',
          data: commodities.map(c => c.variance),
          backgroundColor: commodities.map(c =>
            c.variance > 0 ? 'rgba(239, 68, 68, 0.7)' : 'rgba(34, 197, 94, 0.7)'
          ),
          borderColor: commodities.map(c =>
            c.variance > 0 ? 'rgba(239, 68, 68, 1)' : 'rgba(34, 197, 94, 1)'
          ),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 2.5,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const commodity = commodities[context.dataIndex];
                const variance = formatCurrency(context.parsed.y);
                const pct = commodity.variancePct != null ? ` (${commodity.variancePct.toFixed(1)}%)` : '';
                return 'Variance: ' + (context.parsed.y > 0 ? '+' : '') + variance + pct;
              }
            }
          }
        },
        scales: {
          y: {
            ticks: {
              callback: function(value) {
                return '$' + (value / 1000).toFixed(0) + 'k';
              }
            }
          }
        }
      }
    });

    return () => {
      if (chartInstance.current) {
        chartInstance.current.destroy();
      }
    };
  }, [commodities]);

  if (commodities.length === 0) {
    return <div className="text-center py-8 text-gray-500">No data available</div>;
  }

  return <canvas ref={chartRef}></canvas>;
}

// Cost Breakdown Pie Chart for Individual Commodity
function CostBreakdownChart({ commodity }) {
  const chartRef = React.useRef(null);
  const chartInstance = React.useRef(null);

  useEffect(() => {
    if (!chartRef.current) return;

    if (chartInstance.current) {
      chartInstance.current.destroy();
    }

    const ctx = chartRef.current.getContext('2d');

    // Aggregate cost by category
    const overhead = commodity.overhead || 0;
    const seed = commodity.seed || 0;
    const rent = commodity.rent || 0;
    const fertilizer = commodity.fertilizer || 0;
    const herbicide = commodity.herbicide || 0;

    chartInstance.current = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Overhead', 'Seed', 'Rent', 'Fertilizer', 'Herbicide'],
        datasets: [{
          data: [overhead, seed, rent, fertilizer, herbicide],
          backgroundColor: [
            'rgba(100, 116, 139, 0.8)',
            'rgba(251, 191, 36, 0.8)',
            'rgba(34, 197, 94, 0.8)',
            'rgba(59, 130, 246, 0.8)',
            'rgba(168, 85, 247, 0.8)'
          ],
          borderColor: [
            'rgba(100, 116, 139, 1)',
            'rgba(251, 191, 36, 1)',
            'rgba(34, 197, 94, 1)',
            'rgba(59, 130, 246, 1)',
            'rgba(168, 85, 247, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 1.5,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: {
                size: 11
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const value = context.parsed;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const pct = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                return context.label + ': ' + formatCurrency(value) + ' (' + pct + '%)';
              }
            }
          }
        }
      }
    });

    return () => {
      if (chartInstance.current) {
        chartInstance.current.destroy();
      }
    };
  }, [commodity]);

  return <canvas ref={chartRef}></canvas>;
}

// Overall Cost Allocation Chart
function OverallCostChart({ data, type }) {
  const chartRef = React.useRef(null);
  const chartInstance = React.useRef(null);

  useEffect(() => {
    if (!chartRef.current || !data.commodities || data.commodities.length === 0) return;

    if (chartInstance.current) {
      chartInstance.current.destroy();
    }

    const ctx = chartRef.current.getContext('2d');

    // Aggregate totals across all commodities
    const totals = data.commodities.reduce((acc, c) => {
      acc.overhead += c.overhead || 0;
      acc.seed += c.seed || 0;
      acc.rent += c.rent || 0;
      acc.fertilizer += c.fertilizer || 0;
      acc.herbicide += c.herbicide || 0;
      return acc;
    }, { overhead: 0, seed: 0, rent: 0, fertilizer: 0, herbicide: 0 });

    chartInstance.current = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Overhead', 'Seed', 'Rent', 'Fertilizer', 'Herbicide'],
        datasets: [{
          data: [totals.overhead, totals.seed, totals.rent, totals.fertilizer, totals.herbicide],
          backgroundColor: [
            'rgba(100, 116, 139, 0.8)',
            'rgba(251, 191, 36, 0.8)',
            'rgba(34, 197, 94, 0.8)',
            'rgba(59, 130, 246, 0.8)',
            'rgba(168, 85, 247, 0.8)'
          ],
          borderColor: [
            'rgba(100, 116, 139, 1)',
            'rgba(251, 191, 36, 1)',
            'rgba(34, 197, 94, 1)',
            'rgba(59, 130, 246, 1)',
            'rgba(168, 85, 247, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 1.2,
        plugins: {
          legend: {
            position: 'bottom'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const value = context.parsed;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const pct = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                return context.label + ': ' + formatCurrency(value) + ' (' + pct + '%)';
              }
            }
          }
        }
      }
    });

    return () => {
      if (chartInstance.current) {
        chartInstance.current.destroy();
      }
    };
  }, [data, type]);

  if (!data.commodities || data.commodities.length === 0) {
    return <div className="text-center py-8 text-gray-500">No data available</div>;
  }

  return <canvas ref={chartRef}></canvas>;
}

// ============================================================================
// ANALYSIS PAGE (Planned vs Actual, Variance, Trends)
// ============================================================================
function AnalysisPage({ cropYear, onYearChange }) {
  const [data, setData] = useState({ fields: [], commodities: [], totals: {} });
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('charts');
  const currentYear = new Date().getFullYear();
  const cropYears = [currentYear - 1, currentYear, currentYear + 1];

  useEffect(() => {
    async function load() {
      setLoading(true);
      const [fcys, expenses, seeds, rents, fertCosts, herbCosts, miscIncome, cropPlans, assignments] = await Promise.all([
        getFieldCropYears(cropYear),
        getOverheadExpenses(cropYear),
        getSeedCosts(cropYear),
        getLandRent(cropYear),
        getFertilizerCostsDetailed(cropYear),
        getHerbicideCosts(cropYear),
        getMiscIncome(cropYear),
        getCropPlans(cropYear),
        getFieldPlanAssignments(cropYear)
      ]);

      const overheadAlloc = allocateOverhead(expenses, fcys);
      const incomeAlloc = allocateMiscIncome(miscIncome, fcys);
      const seedMap = {};
      seeds.forEach(s => { seedMap[s.field_crop_year_id] = s.total_cost || calculateSeedCost({ ...s, planted_acres: s.planted_acres }); });
      const rentMap = {};
      rents.forEach(r => { rentMap[r.field_id] = r.rent_per_acre || 0; });

      const fieldData = fcys.map(fcy => {
        const assignment = assignments.find(a => a.field_crop_year_id === fcy.id);
        const plan = assignment ? cropPlans.find(p => p.id === assignment.crop_plan_id) : null;
        const plannedCostPerAcre = plan ? calculateCropPlanCost(plan) : 0;
        const plannedTotal = plannedCostPerAcre * (fcy.planted_acres || 0);

        const overhead = overheadAlloc[fcy.id] || 0;
        const seed = seedMap[fcy.id] || 0;
        const rentPerAcre = rentMap[fcy.field_id] || 0;
        const rent = rentPerAcre * (fcy.planted_acres || 0);
        const fertData = fertCosts[fcy.field_id] || { total: 0 };
        const herbData = herbCosts[fcy.field_id] || { total: 0 };
        const fert = fertData.total;
        const herb = typeof herbData === 'object' ? herbData.total : herbData;
        const actualTotal = overhead + seed + rent + fert + herb;
        const incomeOffset = incomeAlloc[fcy.id] || 0;

        const variance = plannedTotal > 0 ? actualTotal - plannedTotal : null;
        const variancePct = plannedTotal > 0 ? ((actualTotal - plannedTotal) / plannedTotal) * 100 : null;

        return {
          ...fcy,
          plan,
          plannedCostPerAcre,
          plannedTotal,
          overhead, seed, rent, fert, herb,
          actualTotal,
          actualCostPerAcre: fcy.planted_acres > 0 ? actualTotal / fcy.planted_acres : 0,
          incomeOffset,
          netCost: actualTotal - incomeOffset,
          variance,
          variancePct
        };
      });

      // Aggregate by commodity
      const byCommodity = {};
      fieldData.forEach(f => {
        if (!byCommodity[f.commodity_id]) {
          byCommodity[f.commodity_id] = {
            name: f.commodity_name,
            acres: 0, plannedTotal: 0, actualTotal: 0, incomeOffset: 0, bushels: 0
          };
        }
        byCommodity[f.commodity_id].acres += f.planted_acres || 0;
        byCommodity[f.commodity_id].plannedTotal += f.plannedTotal || 0;
        byCommodity[f.commodity_id].actualTotal += f.actualTotal || 0;
        byCommodity[f.commodity_id].incomeOffset += f.incomeOffset || 0;
        byCommodity[f.commodity_id].bushels += f.actual_production || ((f.planted_acres || 0) * (f.estimated_yield || 0));
      });

      const commoditySummary = Object.values(byCommodity).map(c => ({
        ...c,
        variance: c.actualTotal - c.plannedTotal,
        variancePct: c.plannedTotal > 0 ? ((c.actualTotal - c.plannedTotal) / c.plannedTotal) * 100 : null,
        netCost: c.actualTotal - c.incomeOffset,
        breakeven: c.bushels > 0 ? (c.actualTotal - c.incomeOffset) / c.bushels : null
      }));

      const totals = {
        acres: fieldData.reduce((s, f) => s + (f.planted_acres || 0), 0),
        plannedTotal: fieldData.reduce((s, f) => s + (f.plannedTotal || 0), 0),
        actualTotal: fieldData.reduce((s, f) => s + f.actualTotal, 0),
        incomeOffset: fieldData.reduce((s, f) => s + (f.incomeOffset || 0), 0)
      };
      totals.variance = totals.actualTotal - totals.plannedTotal;
      totals.variancePct = totals.plannedTotal > 0 ? ((totals.actualTotal - totals.plannedTotal) / totals.plannedTotal) * 100 : null;
      totals.netCost = totals.actualTotal - totals.incomeOffset;

      setData({ fields: fieldData, commodities: commoditySummary, totals });
      setLoading(false);
    }
    load();
  }, [cropYear]);

  if (loading) return <div className="flex items-center justify-center h-64"><Icon name="loader" className="animate-spin text-blue-600" size={32} /></div>;

  const varianceColor = (v) => v > 0 ? 'text-red-600' : v < 0 ? 'text-green-600' : 'text-gray-600';
  const varianceBg = (v) => v > 5 ? 'bg-red-100' : v < -5 ? 'bg-green-100' : 'bg-gray-100';

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Analysis</h1>
          <p className="text-sm text-gray-500">Planned vs actual costs, variance, and trends for {cropYear}</p>
        </div>
        <select value={cropYear} onChange={(e) => onYearChange(parseInt(e.target.value))} className="px-4 py-2 border rounded-lg">
          {cropYears.map(y => <option key={y} value={y}>{y} Crop Year</option>)}
        </select>
      </div>

      {/* Summary cards */}
      <div className="grid grid-cols-4 gap-4">
        <div className="bg-white rounded-xl p-4 shadow-sm border">
          <div className="text-sm text-gray-500">Planned Costs</div>
          <div className="text-2xl font-bold text-gray-900">{formatCurrency(data.totals.plannedTotal)}</div>
          <div className="text-xs text-gray-400">{formatCurrency(data.totals.acres > 0 ? data.totals.plannedTotal / data.totals.acres : 0)}/ac</div>
        </div>
        <div className="bg-white rounded-xl p-4 shadow-sm border">
          <div className="text-sm text-gray-500">Actual Costs</div>
          <div className="text-2xl font-bold text-gray-900">{formatCurrency(data.totals.actualTotal)}</div>
          <div className="text-xs text-gray-400">{formatCurrency(data.totals.acres > 0 ? data.totals.actualTotal / data.totals.acres : 0)}/ac</div>
        </div>
        <div className="bg-white rounded-xl p-4 shadow-sm border">
          <div className="text-sm text-gray-500">Variance</div>
          <div className={`text-2xl font-bold ${varianceColor(data.totals.variance)}`}>
            {data.totals.variance > 0 ? '+' : ''}{formatCurrency(data.totals.variance)}
          </div>
          <div className={`text-xs ${varianceColor(data.totals.variancePct)}`}>
            {data.totals.variancePct != null ? `${data.totals.variancePct > 0 ? '+' : ''}${data.totals.variancePct.toFixed(1)}%` : '-'}
          </div>
        </div>
        <div className="bg-white rounded-xl p-4 shadow-sm border">
          <div className="text-sm text-gray-500">Net (After Income)</div>
          <div className="text-2xl font-bold text-blue-600">{formatCurrency(data.totals.netCost)}</div>
          <div className="text-xs text-gray-400">Income offset: {formatCurrency(data.totals.incomeOffset)}</div>
        </div>
      </div>

      {/* Tabs */}
      <div className="flex gap-2 border-b">
        <button onClick={() => setActiveTab('charts')} className={`px-4 py-2 font-medium ${activeTab === 'charts' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>Charts</button>
        <button onClick={() => setActiveTab('variance')} className={`px-4 py-2 font-medium ${activeTab === 'variance' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>Variance by Commodity</button>
        <button onClick={() => setActiveTab('fields')} className={`px-4 py-2 font-medium ${activeTab === 'fields' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>Field Detail</button>
      </div>

      {activeTab === 'charts' && (
        <div className="space-y-6">
          {/* Planned vs Actual Comparison Chart */}
          <div className="bg-white rounded-xl shadow-sm border p-6">
            <h3 className="text-lg font-semibold mb-4">Planned vs Actual Costs by Commodity</h3>
            <PlannedVsActualChart commodities={data.commodities} />
          </div>

          {/* Variance Chart */}
          <div className="bg-white rounded-xl shadow-sm border p-6">
            <h3 className="text-lg font-semibold mb-4">Cost Variance by Commodity</h3>
            <VarianceChart commodities={data.commodities} />
          </div>

          {/* Cost Breakdown Pie Charts by Commodity */}
          <div className="bg-white rounded-xl shadow-sm border p-6">
            <h3 className="text-lg font-semibold mb-4">Cost Breakdown by Category</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {data.commodities.map(c => (
                <div key={c.name}>
                  <h4 className="text-center font-medium mb-2">{c.name}</h4>
                  <CostBreakdownChart commodity={c} />
                </div>
              ))}
            </div>
          </div>

          {/* Overall Cost Breakdown */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="bg-white rounded-xl shadow-sm border p-6">
              <h3 className="text-lg font-semibold mb-4">Planned Cost Allocation</h3>
              <OverallCostChart data={data} type="planned" />
            </div>
            <div className="bg-white rounded-xl shadow-sm border p-6">
              <h3 className="text-lg font-semibold mb-4">Actual Cost Allocation</h3>
              <OverallCostChart data={data} type="actual" />
            </div>
          </div>
        </div>
      )}

      {activeTab === 'variance' && (
        <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
          <table className="w-full text-sm">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left">Commodity</th>
                <th className="px-4 py-3 text-right">Acres</th>
                <th className="px-4 py-3 text-right">Planned</th>
                <th className="px-4 py-3 text-right">Actual</th>
                <th className="px-4 py-3 text-right">Variance</th>
                <th className="px-4 py-3 text-right">Income Offset</th>
                <th className="px-4 py-3 text-right">Net Cost</th>
                <th className="px-4 py-3 text-right">Breakeven</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {data.commodities.map(c => (
                <tr key={c.name} className="hover:bg-gray-50">
                  <td className="px-4 py-3 font-medium">{c.name}</td>
                  <td className="px-4 py-3 text-right">{formatNumber(c.acres)}</td>
                  <td className="px-4 py-3 text-right">{formatCurrency(c.plannedTotal)}</td>
                  <td className="px-4 py-3 text-right">{formatCurrency(c.actualTotal)}</td>
                  <td className="px-4 py-3 text-right">
                    <span className={`px-2 py-0.5 rounded ${varianceBg(c.variancePct)} ${varianceColor(c.variance)}`}>
                      {c.variance > 0 ? '+' : ''}{formatCurrency(c.variance)}
                      {c.variancePct != null && <span className="ml-1 text-xs">({c.variancePct > 0 ? '+' : ''}{c.variancePct.toFixed(1)}%)</span>}
                    </span>
                  </td>
                  <td className="px-4 py-3 text-right text-green-600">{formatCurrency(c.incomeOffset)}</td>
                  <td className="px-4 py-3 text-right font-medium">{formatCurrency(c.netCost)}</td>
                  <td className="px-4 py-3 text-right font-bold text-blue-600">{c.breakeven ? formatPrice(c.breakeven) : '-'}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {activeTab === 'fields' && (
        <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
          <table className="w-full text-sm">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left">Field</th>
                <th className="px-4 py-3 text-left">Crop</th>
                <th className="px-4 py-3 text-right">Acres</th>
                <th className="px-4 py-3 text-left">Crop Plan</th>
                <th className="px-4 py-3 text-right">Planned</th>
                <th className="px-4 py-3 text-right">Actual</th>
                <th className="px-4 py-3 text-right">Variance</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {data.fields.length === 0 ? (
                <tr><td colSpan={7} className="px-4 py-8 text-center text-gray-500">No fields for {cropYear}</td></tr>
              ) : data.fields.map(f => (
                <tr key={f.id} className={`hover:bg-gray-50 ${f.variancePct != null && f.variancePct > 10 ? 'bg-red-50' : ''}`}>
                  <td className="px-4 py-3">
                    <div className="font-medium">{f.field_name}</div>
                    <div className="text-xs text-gray-500">{f.farm_name}</div>
                  </td>
                  <td className="px-4 py-3">{f.commodity_name}</td>
                  <td className="px-4 py-3 text-right">{formatNumber(f.planted_acres)}</td>
                  <td className="px-4 py-3">
                    {f.plan ? (
                      <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">{f.plan.name}</span>
                    ) : (
                      <span className="text-gray-400 text-xs">No plan</span>
                    )}
                  </td>
                  <td className="px-4 py-3 text-right">{f.plannedTotal > 0 ? formatCurrency(f.plannedTotal) : '-'}</td>
                  <td className="px-4 py-3 text-right">{formatCurrency(f.actualTotal)}</td>
                  <td className="px-4 py-3 text-right">
                    {f.variance != null ? (
                      <span className={varianceColor(f.variance)}>
                        {f.variance > 0 ? '+' : ''}{formatCurrency(f.variance)}
                      </span>
                    ) : '-'}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}

// ============================================================================
// REPORTS PAGE
// ============================================================================
function ReportsPage({ cropYear, onYearChange }) {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [generating, setGenerating] = useState(false);
  const [reportData, setReportData] = useState(null);
  const [fieldCropYears, setFieldCropYears] = useState([]);
  const [actualChemicalCosts, setActualChemicalCosts] = useState({ byField: {}, lastSynced: null });
  const [profitabilityPrices, setProfitabilityPrices] = useState({});
  const [showPriceConfig, setShowPriceConfig] = useState(false);
  const { addToast } = useToast();
  const currentYear = new Date().getFullYear();
  const cropYears = [currentYear - 1, currentYear, currentYear + 1];

  // Filter state
  const [filters, setFilters] = useState({
    farm: '',
    commodity: '',
    practiceType: '',
    landlord: '',
    fields: [],
    includeFamilyLiving: true,
    viewMode: 'per_acre', // 'per_acre' or 'total'
    costView: 'actual' // 'planned', 'actual', 'variance'
  });

  // Report type
  const [reportType, setReportType] = useState('breakeven_summary');

  // Load data for filters
  useEffect(() => {
    async function load() {
      setLoading(true);
      const [farms, commodities, fields, landlords, categories, fcys] = await Promise.all([
        db.from('farms').select('id, name, adams_grain_share').eq('active', true).gt('adams_grain_share', 0).order('name').then(r => r.data || []),
        getCommodities(),
        getVisibleFields(),
        db.from('landlords').select('id, name').order('name').then(r => r.data || []),
        getOverheadCategories(),
        getFieldCropYears(cropYear)
      ]);
      setData({ farms, commodities, fields, landlords, categories });
      setFieldCropYears(fcys);

      // Load profitability prices
      const prices = await getProfitabilityPrices(cropYear, commodities);
      setProfitabilityPrices(prices);

      setLoading(false);
    }
    load();
  }, [cropYear]);

  // Sync actual chemical costs from Spray-Suite
  const syncChemicalCosts = async () => {
    addToast('Syncing chemical costs from Spray-Suite...', { type: 'info' });
    const result = await getActualChemicalCosts(cropYear);
    setActualChemicalCosts(result);
    addToast('Chemical costs synced', { type: 'success' });
  };

  // Auto-load chemical costs on mount
  useEffect(() => {
    if (!loading && data) {
      syncChemicalCosts();
    }
  }, [loading, cropYear]);

  // Cascading filter: filtered landlords based on farm selection
  const filteredLandlords = useMemo(() => {
    if (!data?.landlords || !data?.fields) return [];
    if (!filters.farm) return data.landlords;

    // Get landlords only from fields in selected farm
    const farmFieldLandlordIds = new Set(
      data.fields
        .filter(f => f.farm_id === filters.farm && f.landlord)
        .map(f => f.landlord)
    );

    return data.landlords.filter(l => farmFieldLandlordIds.has(l.id));
  }, [filters.farm, data?.fields, data?.landlords]);

  // Cascading filter: filtered fields based on farm, landlord, and commodity
  const filteredFields = useMemo(() => {
    if (!data?.fields) return [];
    let result = data.fields;

    if (filters.farm) {
      result = result.filter(f => f.farm_id === filters.farm);
    }
    if (filters.landlord) {
      result = result.filter(f => f.landlord === filters.landlord);
    }
    if (filters.commodity) {
      // Filter by fields that have this commodity in field_crop_years
      const fieldIdsWithCommodity = fieldCropYears
        .filter(fcy => fcy.commodity_id === filters.commodity)
        .map(fcy => fcy.field_id);
      result = result.filter(f => fieldIdsWithCommodity.includes(f.id));
    }

    return result;
  }, [filters.farm, filters.landlord, filters.commodity, data?.fields, fieldCropYears]);

  // Clear dependent filters when parent changes
  const handleFarmChange = (farmId) => {
    setFilters(f => ({
      ...f,
      farm: farmId,
      landlord: '', // Clear landlord when farm changes
      fields: []    // Clear field selection
    }));
  };

  const handleLandlordChange = (landlordId) => {
    setFilters(f => ({
      ...f,
      landlord: landlordId,
      fields: [] // Clear field selection
    }));
  };

  // Save profitability price setting
  const handlePriceSourceChange = async (commodityId, priceSource, manualPrice = null) => {
    try {
      await saveProfitabilityPrice(cropYear, commodityId, priceSource, manualPrice);
      // Refresh prices
      const prices = await getProfitabilityPrices(cropYear, data.commodities);
      setProfitabilityPrices(prices);
      addToast('Price setting saved', { type: 'success' });
    } catch (err) {
      addToast('Failed to save price setting', { type: 'error' });
    }
  };

  // Generate report
  const generateReport = async () => {
    setGenerating(true);
    try {
      const [fcys, expenses, categories, seeds, rents, fertCostsPlanned, herbCostsPlanned, miscIncome, cropPlans, fieldAssignments] = await Promise.all([
        getFieldCropYears(cropYear),
        getOverheadExpenses(cropYear),
        getOverheadCategories(),
        getSeedCosts(cropYear),
        getLandRent(cropYear),
        getFertilizerCostsDetailed(cropYear), // Actual fertilizer from Fert App
        getHerbicideCosts(cropYear), // Planned herbicide costs
        getMiscIncome(cropYear),
        getCropPlans(cropYear),
        getFieldPlanAssignments(cropYear)
      ]);

      // Get field and farm info - only visible fields
      const visibleFields = await getVisibleFields();
      const visibleFieldIds = new Set(visibleFields.map(f => f.id));
      const fieldFarmMap = {};
      visibleFields.forEach(f => {
        fieldFarmMap[f.id] = { farmId: f.farm_id, farmName: f.farm_name, landlordId: f.landlord };
      });

      // Filter fcys to only visible fields
      const filteredFcys = fcys.filter(fcy => visibleFieldIds.has(fcy.field_id));

      // Find family living category IDs
      const familyLivingCategoryIds = categories
        .filter(c => c.is_family_living)
        .map(c => c.id);

      // Filter expenses based on family living toggle
      const filteredExpenses = filters.includeFamilyLiving
        ? expenses
        : expenses.filter(e => !familyLivingCategoryIds.includes(e.category_id));

      const overheadAlloc = allocateOverhead(filteredExpenses, filteredFcys);
      const incomeAlloc = allocateMiscIncome(miscIncome, filteredFcys);
      const seedMap = {};
      seeds.forEach(s => { seedMap[s.field_crop_year_id] = s.total_cost || calculateSeedCost({ ...s, planted_acres: s.planted_acres }); });
      const rentMap = {};
      rents.forEach(r => { rentMap[r.field_id] = r.rent_per_acre || 0; });

      // Build crop plan cost map (for planned costs)
      const planCostMap = {};
      cropPlans.forEach(p => { planCostMap[p.id] = calculateCropPlanCost(p); });

      // Build field assignment map
      const assignmentMap = {};
      fieldAssignments.forEach(a => { assignmentMap[a.field_crop_year_id] = a; });

      // Use actual chemical costs from Spray-Suite
      const actualHerbCosts = actualChemicalCosts.byField;

      // Build field-level data
      let fieldData = filteredFcys.map(fcy => {
        const fieldInfo = fieldFarmMap[fcy.field_id] || {};
        const assignment = assignmentMap[fcy.id];
        const planCost = assignment?.crop_plan_id ? planCostMap[assignment.crop_plan_id] || 0 : 0;

        // Calculate adams_grain_share (BFP partnership split)
        const tenantShareBase = fcy.tenant_share || 1;
        const effectiveShare = fcy.effective_share || tenantShareBase;
        const adamsGrainShare = tenantShareBase > 0 ? effectiveShare / tenantShareBase : 1;

        // Overhead already allocated by effective acres, no additional multiplication needed
        const overhead = overheadAlloc[fcy.id] || 0;
        const seed = (seedMap[fcy.id] || 0) * adamsGrainShare;
        const rentPerAcre = rentMap[fcy.field_id] || 0;
        const rent = (rentPerAcre * (fcy.planted_acres || 0)) * adamsGrainShare;

        // Actual costs from apps (apply BFP partnership split)
        const fertActualData = fertCostsPlanned[fcy.field_id] || { total: 0 };
        const fertActual = (typeof fertActualData === 'object' ? fertActualData.total : fertActualData) * adamsGrainShare;

        const herbActualData = actualHerbCosts[fcy.field_id] || { total: 0 };
        const herbActual = (typeof herbActualData === 'object' ? herbActualData.total : herbActualData) * adamsGrainShare;

        // Planned costs from crop plan (if assigned)
        const herbPlannedData = herbCostsPlanned[fcy.field_id] || { total: 0 };
        const herbPlanned = (typeof herbPlannedData === 'object' ? herbPlannedData.total : herbPlannedData) * adamsGrainShare;

        // Choose actual or planned based on view
        const useActual = filters.costView !== 'planned';
        const fert = fertActual; // Always actual from Fert App
        const herb = useActual ? herbActual : (herbPlanned || herbActual);

        const totalCost = overhead + seed + rent + fert + herb;
        const plannedTotal = overhead + seed + rent + fert + herbPlanned;
        // Income already allocated by effective acres, no additional multiplication needed
        const incomeOffset = incomeAlloc[fcy.id] || 0;
        const bushelsAll = fcy.actual_production || ((fcy.planted_acres || 0) * (fcy.expected_yield || 0));
        const bushels = bushelsAll * effectiveShare;

        // Variance calculation
        const variance = calculateVariance(
          { seed, fertilizer: fert, chemicals: herbPlanned, overhead, rent, total: plannedTotal },
          { seed, fertilizer: fert, chemicals: herbActual, overhead, rent, total: overhead + seed + rent + fert + herbActual }
        );

        // Profitability calculation
        const priceInfo = profitabilityPrices[fcy.commodity_id];
        const price = priceInfo?.effective_price || 0;
        const revenue = bushels * price;
        const profit = revenue - totalCost;

        return {
          ...fcy,
          farmId: fieldInfo.farmId,
          farmName: fieldInfo.farmName,
          landlordId: fieldInfo.landlordId,
          overhead, seed, rent, fert, herb,
          herbPlanned, herbActual,
          totalCost,
          plannedTotal,
          incomeOffset,
          netCost: totalCost - incomeOffset,
          bushels,
          costPerAcre: fcy.planted_acres > 0 ? totalCost / fcy.planted_acres : 0,
          netCostPerAcre: fcy.planted_acres > 0 ? (totalCost - incomeOffset) / fcy.planted_acres : 0,
          breakeven: bushels > 0 ? totalCost / bushels : null,
          netBreakeven: bushels > 0 ? (totalCost - incomeOffset) / bushels : null,
          variance,
          price,
          priceSource: priceInfo?.price_source,
          revenue,
          profit,
          profitPerAcre: fcy.planted_acres > 0 ? profit / fcy.planted_acres : 0,
          isProfitable: profit > 0
        };
      });

      // Apply filters
      if (filters.farm) {
        fieldData = fieldData.filter(f => f.farmId === filters.farm);
      }
      if (filters.commodity) {
        fieldData = fieldData.filter(f => f.commodity_id === filters.commodity);
      }
      if (filters.practiceType) {
        fieldData = fieldData.filter(f => f.practice_type === filters.practiceType);
      }
      if (filters.landlord) {
        fieldData = fieldData.filter(f => f.landlordId === filters.landlord);
      }
      if (filters.fields.length > 0) {
        fieldData = fieldData.filter(f => filters.fields.includes(f.field_id));
      }

      // Generate report based on type
      let report = null;
      if (reportType === 'breakeven_summary') {
        // Aggregate by commodity
        const byCommodity = {};
        fieldData.forEach(f => {
          if (!byCommodity[f.commodity_id]) {
            byCommodity[f.commodity_id] = {
              id: f.commodity_id,
              name: f.commodity_name,
              acres: 0, totalCost: 0, plannedTotal: 0, incomeOffset: 0, bushels: 0,
              overhead: 0, seed: 0, rent: 0, fert: 0, herb: 0, herbPlanned: 0, herbActual: 0,
              revenue: 0, profit: 0
            };
          }
          const c = byCommodity[f.commodity_id];
          c.acres += f.planted_acres || 0;
          c.totalCost += f.totalCost;
          c.plannedTotal += f.plannedTotal;
          c.incomeOffset += f.incomeOffset;
          c.bushels += f.bushels;
          c.overhead += f.overhead;
          c.seed += f.seed;
          c.rent += f.rent;
          c.fert += f.fert;
          c.herb += f.herb;
          c.herbPlanned += f.herbPlanned;
          c.herbActual += f.herbActual;
          c.revenue += f.revenue;
          c.profit += f.profit;
        });

        report = {
          type: 'breakeven_summary',
          commodities: Object.values(byCommodity).map(c => {
            const variance = calculateVariance(
              { seed: c.seed, fertilizer: c.fert, chemicals: c.herbPlanned, overhead: c.overhead, rent: c.rent, total: c.plannedTotal },
              { seed: c.seed, fertilizer: c.fert, chemicals: c.herbActual, overhead: c.overhead, rent: c.rent, total: c.totalCost }
            );
            return {
              ...c,
              netCost: c.totalCost - c.incomeOffset,
              costPerAcre: c.acres > 0 ? c.totalCost / c.acres : 0,
              netCostPerAcre: c.acres > 0 ? (c.totalCost - c.incomeOffset) / c.acres : 0,
              breakeven: c.bushels > 0 ? c.totalCost / c.bushels : null,
              netBreakeven: c.bushels > 0 ? (c.totalCost - c.incomeOffset) / c.bushels : null,
              variance,
              profitPerAcre: c.acres > 0 ? c.profit / c.acres : 0,
              isProfitable: c.profit > 0
            };
          }),
          totals: {
            acres: fieldData.reduce((s, f) => s + (f.planted_acres || 0), 0),
            totalCost: fieldData.reduce((s, f) => s + f.totalCost, 0),
            plannedTotal: fieldData.reduce((s, f) => s + f.plannedTotal, 0),
            incomeOffset: fieldData.reduce((s, f) => s + f.incomeOffset, 0),
            bushels: fieldData.reduce((s, f) => s + f.bushels, 0),
            revenue: fieldData.reduce((s, f) => s + f.revenue, 0),
            profit: fieldData.reduce((s, f) => s + f.profit, 0)
          }
        };
        report.totals.netCost = report.totals.totalCost - report.totals.incomeOffset;
        report.totals.variance = calculateVariance(
          { total: report.totals.plannedTotal },
          { total: report.totals.totalCost }
        );
      } else if (reportType === 'field_profitability') {
        report = {
          type: 'field_profitability',
          fields: fieldData.sort((a, b) => (b.profitPerAcre || 0) - (a.profitPerAcre || 0))
        };
      } else if (reportType === 'variance') {
        // Variance report by category
        const totals = {
          seed: { planned: 0, actual: 0 },
          fertilizer: { planned: 0, actual: 0 },
          chemicals: { planned: 0, actual: 0 },
          overhead: { planned: 0, actual: 0 },
          rent: { planned: 0, actual: 0 },
          total: { planned: 0, actual: 0 }
        };
        fieldData.forEach(f => {
          totals.seed.planned += f.seed;
          totals.seed.actual += f.seed;
          totals.fertilizer.planned += f.fert;
          totals.fertilizer.actual += f.fert;
          totals.chemicals.planned += f.herbPlanned;
          totals.chemicals.actual += f.herbActual;
          totals.overhead.planned += f.overhead;
          totals.overhead.actual += f.overhead;
          totals.rent.planned += f.rent;
          totals.rent.actual += f.rent;
          totals.total.planned += f.plannedTotal;
          totals.total.actual += f.totalCost;
        });

        report = {
          type: 'variance',
          categories: Object.entries(totals).map(([key, val]) => ({
            name: key.charAt(0).toUpperCase() + key.slice(1),
            planned: val.planned,
            actual: val.actual,
            variance: val.actual - val.planned,
            pctChange: val.planned > 0 ? ((val.actual - val.planned) / val.planned * 100) : 0
          })),
          fields: fieldData
        };
      }

      setReportData(report);
    } catch (e) {
      console.error('Report generation error:', e);
      addToast('Error generating report', { type: 'error' });
    }
    setGenerating(false);
  };

  // Export CSV
  const exportCSV = () => {
    if (!reportData) return;

    let csv = '';
    if (reportData.type === 'breakeven_summary') {
      csv = 'Commodity,Acres,Total Cost,Income Offset,Net Cost,Cost/Acre,Net Cost/Acre,Bushels,Net Breakeven,Revenue,Profit,Profit/Acre\n';
      reportData.commodities.forEach(c => {
        csv += `"${c.name}",${c.acres},${c.totalCost.toFixed(2)},${c.incomeOffset.toFixed(2)},${c.netCost.toFixed(2)},${c.costPerAcre.toFixed(2)},${c.netCostPerAcre.toFixed(2)},${c.bushels.toFixed(0)},${c.netBreakeven?.toFixed(4) || ''},${(c.revenue || 0).toFixed(2)},${(c.profit || 0).toFixed(2)},${(c.profitPerAcre || 0).toFixed(2)}\n`;
      });
    } else if (reportData.type === 'field_profitability') {
      csv = 'Field,Crop,Practice,Acres,Total Cost,Price,Revenue,Profit,Profit/Acre,Is Profitable\n';
      reportData.fields.forEach(f => {
        csv += `"${f.field_name}","${f.commodity_name}","${f.practice_type || 'N/A'}",${f.planted_acres || 0},${f.totalCost.toFixed(2)},${(f.price || 0).toFixed(2)},${(f.revenue || 0).toFixed(2)},${(f.profit || 0).toFixed(2)},${(f.profitPerAcre || 0).toFixed(2)},${f.isProfitable ? 'Yes' : 'No'}\n`;
      });
    } else if (reportData.type === 'variance') {
      csv = 'Category,Planned,Actual,Variance,% Change\n';
      reportData.categories.forEach(cat => {
        csv += `"${cat.name}",${cat.planned.toFixed(2)},${cat.actual.toFixed(2)},${cat.variance.toFixed(2)},${cat.pctChange.toFixed(1)}%\n`;
      });
    }

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `breakeven-report-${cropYear}-${reportType}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  if (loading) return <div className="flex items-center justify-center h-64"><Icon name="loader" className="animate-spin text-blue-600" size={32} /></div>;

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Reports</h1>
          <p className="text-sm text-gray-500">Generate filtered breakeven and profitability reports</p>
        </div>
        <select value={cropYear} onChange={(e) => onYearChange(parseInt(e.target.value))} className="px-4 py-2 border rounded-lg">
          {cropYears.map(y => <option key={y} value={y}>{y} Crop Year</option>)}
        </select>
      </div>

      {/* Filters */}
      <div className="bg-white rounded-xl shadow-sm border p-6">
        <h2 className="font-semibold text-lg mb-4">Filters</h2>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
          <div>
            <label className="block text-sm font-medium mb-1">Farm</label>
            <select
              value={filters.farm}
              onChange={(e) => handleFarmChange(e.target.value)}
              className="w-full px-3 py-2 border rounded-lg"
            >
              <option value="">All Farms</option>
              {data.farms.map(f => <option key={f.id} value={f.id}>{f.name}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Crop</label>
            <select
              value={filters.commodity}
              onChange={(e) => setFilters(f => ({ ...f, commodity: e.target.value, fields: [] }))}
              className="w-full px-3 py-2 border rounded-lg"
            >
              <option value="">All Crops</option>
              {data.commodities.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Practice</label>
            <select
              value={filters.practiceType}
              onChange={(e) => setFilters(f => ({ ...f, practiceType: e.target.value }))}
              className="w-full px-3 py-2 border rounded-lg"
            >
              <option value="">All Practices</option>
              <option value="IR">Irrigated</option>
              <option value="DL">Dryland</option>
              <option value="FS">Full Season</option>
              <option value="DC">Double Crop</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Landlord {filters.farm && `(${filteredLandlords.length})`}</label>
            <select
              value={filters.landlord}
              onChange={(e) => handleLandlordChange(e.target.value)}
              className="w-full px-3 py-2 border rounded-lg"
            >
              <option value="">All Landlords</option>
              {filteredLandlords.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}
            </select>
          </div>
        </div>

        {/* Field multi-select */}
        {filteredFields.length > 0 && (
          <div className="mb-4">
            <label className="block text-sm font-medium mb-1">Fields ({filters.fields.length} of {filteredFields.length} selected)</label>
            <div className="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-2 border rounded-lg bg-gray-50">
              {filteredFields.map(f => (
                <label key={f.id} className="flex items-center gap-1.5 px-2 py-1 bg-white border rounded text-sm cursor-pointer hover:bg-blue-50">
                  <input
                    type="checkbox"
                    checked={filters.fields.includes(f.id)}
                    onChange={(e) => {
                      if (e.target.checked) {
                        setFilters(prev => ({ ...prev, fields: [...prev.fields, f.id] }));
                      } else {
                        setFilters(prev => ({ ...prev, fields: prev.fields.filter(id => id !== f.id) }));
                      }
                    }}
                    className="w-3.5 h-3.5 rounded border-gray-300 text-blue-600"
                  />
                  <span>{f.name}</span>
                </label>
              ))}
            </div>
            {filters.fields.length > 0 && (
              <button
                onClick={() => setFilters(f => ({ ...f, fields: [] }))}
                className="text-xs text-blue-600 hover:underline mt-1"
              >
                Clear selection
              </button>
            )}
          </div>
        )}

        <div className="flex flex-wrap items-center gap-6 pt-4 border-t">
          <label className="flex items-center gap-2 cursor-pointer">
            <input
              type="checkbox"
              checked={filters.includeFamilyLiving}
              onChange={(e) => setFilters(f => ({ ...f, includeFamilyLiving: e.target.checked }))}
              className="w-4 h-4 rounded border-gray-300 text-blue-600"
            />
            <span className="text-sm text-gray-600">Include Family Living</span>
          </label>

          <div className="flex items-center gap-2">
            <span className="text-sm text-gray-600">View:</span>
            <div className="flex rounded-lg border overflow-hidden">
              <button
                onClick={() => setFilters(f => ({ ...f, viewMode: 'per_acre' }))}
                className={`px-3 py-1.5 text-sm ${filters.viewMode === 'per_acre' ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'}`}
              >
                Per Acre
              </button>
              <button
                onClick={() => setFilters(f => ({ ...f, viewMode: 'total' }))}
                className={`px-3 py-1.5 text-sm ${filters.viewMode === 'total' ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'}`}
              >
                Total
              </button>
            </div>
          </div>

          <div className="flex items-center gap-2">
            <span className="text-sm text-gray-600">Costs:</span>
            <div className="flex rounded-lg border overflow-hidden">
              <button
                onClick={() => setFilters(f => ({ ...f, costView: 'actual' }))}
                className={`px-3 py-1.5 text-sm ${filters.costView === 'actual' ? 'bg-green-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'}`}
              >
                Actual
              </button>
              <button
                onClick={() => setFilters(f => ({ ...f, costView: 'planned' }))}
                className={`px-3 py-1.5 text-sm ${filters.costView === 'planned' ? 'bg-amber-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'}`}
              >
                Planned
              </button>
              <button
                onClick={() => setFilters(f => ({ ...f, costView: 'variance' }))}
                className={`px-3 py-1.5 text-sm ${filters.costView === 'variance' ? 'bg-purple-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'}`}
              >
                Variance
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* Spray-Suite Sync & Profitability Pricing */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="bg-white rounded-xl shadow-sm border p-4">
          <div className="flex items-center justify-between">
            <div>
              <h3 className="font-medium text-gray-900">Chemical Costs (Spray-Suite)</h3>
              <p className="text-xs text-gray-500">
                {actualChemicalCosts.lastSynced
                  ? `Last synced: ${formatDate(actualChemicalCosts.lastSynced)}`
                  : 'Not synced yet'}
              </p>
            </div>
            <button
              onClick={syncChemicalCosts}
              className="flex items-center gap-2 px-3 py-1.5 text-sm bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200"
            >
              <Icon name="refresh-cw" size={16} /> Sync
            </button>
          </div>
        </div>

        <div className="bg-white rounded-xl shadow-sm border p-4">
          <div className="flex items-center justify-between">
            <div>
              <h3 className="font-medium text-gray-900">Profitability Pricing</h3>
              <p className="text-xs text-gray-500">Configure prices for profit calculations</p>
            </div>
            <button
              onClick={() => setShowPriceConfig(!showPriceConfig)}
              className="flex items-center gap-2 px-3 py-1.5 text-sm bg-green-100 text-green-700 rounded-lg hover:bg-green-200"
            >
              <Icon name="dollar-sign" size={16} /> {showPriceConfig ? 'Hide' : 'Configure'}
            </button>
          </div>
        </div>
      </div>

      {/* Profitability Price Configuration */}
      {showPriceConfig && (
        <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
          <div className="p-4 bg-green-50 border-b">
            <h3 className="font-semibold text-green-800">Profitability Pricing - {cropYear}</h3>
            <p className="text-sm text-green-600">Select price source for each commodity</p>
          </div>
          <table className="w-full text-sm">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left">Commodity</th>
                <th className="px-4 py-3 text-right">Market Price</th>
                <th className="px-4 py-3 text-right">Insurance Price</th>
                <th className="px-4 py-3 text-center">Use Price</th>
                <th className="px-4 py-3 text-right">Effective Price</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {data.commodities.map(c => {
                const priceInfo = profitabilityPrices[c.id] || {};
                return (
                  <tr key={c.id} className="hover:bg-gray-50">
                    <td className="px-4 py-3 font-medium">{c.name}</td>
                    <td className="px-4 py-3 text-right text-gray-600">
                      {priceInfo.market_price ? `$${priceInfo.market_price.toFixed(2)}` : '-'}
                    </td>
                    <td className="px-4 py-3 text-right text-gray-600">
                      {priceInfo.insurance_price ? `$${priceInfo.insurance_price.toFixed(2)}` : '-'}
                    </td>
                    <td className="px-4 py-3 text-center">
                      <select
                        value={priceInfo.price_source || 'insurance'}
                        onChange={(e) => handlePriceSourceChange(c.id, e.target.value)}
                        className="px-2 py-1 border rounded text-sm"
                      >
                        <option value="market">Market</option>
                        <option value="insurance">Insurance</option>
                        <option value="manual">Manual</option>
                      </select>
                      {priceInfo.price_source === 'manual' && (
                        <input
                          type="number"
                          step="0.01"
                          value={priceInfo.manual_price || ''}
                          onChange={(e) => handlePriceSourceChange(c.id, 'manual', parseFloat(e.target.value))}
                          className="ml-2 w-20 px-2 py-1 border rounded text-sm"
                          placeholder="$0.00"
                        />
                      )}
                    </td>
                    <td className="px-4 py-3 text-right font-bold text-green-600">
                      {priceInfo.effective_price ? `$${priceInfo.effective_price.toFixed(2)}` : '-'}
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}

      {/* Report Type & Generate */}
      <div className="bg-white rounded-xl shadow-sm border p-6">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <label className="text-sm font-medium">Report Type:</label>
            <select
              value={reportType}
              onChange={(e) => setReportType(e.target.value)}
              className="px-3 py-2 border rounded-lg"
            >
              <option value="breakeven_summary">Breakeven Summary</option>
              <option value="field_profitability">Field Profitability</option>
              <option value="variance">Variance Report</option>
            </select>
          </div>
          <div className="flex items-center gap-2">
            {reportData && (
              <button
                onClick={exportCSV}
                className="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
              >
                <Icon name="download" size={18} /> Export CSV
              </button>
            )}
            <button
              onClick={generateReport}
              disabled={generating}
              className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
            >
              {generating ? <Icon name="loader" className="animate-spin" size={18} /> : <Icon name="file-text" size={18} />}
              Generate Report
            </button>
          </div>
        </div>
      </div>

      {/* Report Output */}
      {reportData && (
        <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
          {reportData.type === 'breakeven_summary' && (
            <>
              <div className="p-4 bg-gray-50 border-b flex items-center justify-between">
                <div>
                  <h3 className="font-semibold">Breakeven Summary - {cropYear}</h3>
                  <p className="text-xs text-gray-500">
                    {filters.costView === 'actual' && 'Showing actual costs from Spray-Suite & Fertilizer App'}
                    {filters.costView === 'planned' && 'Showing planned costs from crop plans'}
                    {filters.costView === 'variance' && 'Showing planned vs actual comparison'}
                  </p>
                </div>
                {filters.costView === 'variance' && reportData.totals.variance && (
                  <div className={`px-3 py-1 rounded-full text-sm font-medium ${reportData.totals.variance.total.variance < 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                    {reportData.totals.variance.total.variance < 0 ? 'Under Budget' : 'Over Budget'}: {formatCurrency(Math.abs(reportData.totals.variance.total.variance))}
                  </div>
                )}
              </div>
              <table className="w-full text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left">Commodity</th>
                    <th className="px-4 py-3 text-right">Acres</th>
                    <th className="px-4 py-3 text-right">{filters.viewMode === 'per_acre' ? 'Cost/Acre' : 'Total Cost'}</th>
                    {filters.costView === 'variance' && (
                      <th className="px-4 py-3 text-right">Variance</th>
                    )}
                    <th className="px-4 py-3 text-right">{filters.viewMode === 'per_acre' ? 'Income/Acre' : 'Income Offset'}</th>
                    <th className="px-4 py-3 text-right">{filters.viewMode === 'per_acre' ? 'Net Cost/Acre' : 'Net Cost'}</th>
                    <th className="px-4 py-3 text-right">Bushels</th>
                    <th className="px-4 py-3 text-right">Net Breakeven</th>
                    <th className="px-4 py-3 text-right">{filters.viewMode === 'per_acre' ? 'Profit/Acre' : 'Profit'}</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {reportData.commodities.map(c => (
                    <tr key={c.name} className={`hover:bg-gray-50 ${c.isProfitable === false ? 'bg-red-50' : ''}`}>
                      <td className="px-4 py-3 font-medium">{c.name}</td>
                      <td className="px-4 py-3 text-right">{formatNumber(c.acres)}</td>
                      <td className="px-4 py-3 text-right">{formatCurrency(filters.viewMode === 'per_acre' ? c.costPerAcre : c.totalCost)}</td>
                      {filters.costView === 'variance' && c.variance && (
                        <td className={`px-4 py-3 text-right font-medium ${c.variance.total.variance < 0 ? 'text-green-600' : c.variance.total.variance > 0 ? 'text-red-600' : ''}`}>
                          {c.variance.total.variance !== 0 && (c.variance.total.variance > 0 ? '+' : '')}
                          {formatCurrency(filters.viewMode === 'per_acre' ? (c.acres > 0 ? c.variance.total.variance / c.acres : 0) : c.variance.total.variance)}
                        </td>
                      )}
                      <td className="px-4 py-3 text-right text-green-600">{formatCurrency(filters.viewMode === 'per_acre' ? (c.acres > 0 ? c.incomeOffset / c.acres : 0) : c.incomeOffset)}</td>
                      <td className="px-4 py-3 text-right font-medium">{formatCurrency(filters.viewMode === 'per_acre' ? c.netCostPerAcre : c.netCost)}</td>
                      <td className="px-4 py-3 text-right">{formatNumber(c.bushels, 0)}</td>
                      <td className="px-4 py-3 text-right font-bold text-blue-600">{c.netBreakeven ? `$${c.netBreakeven.toFixed(4)}` : '-'}</td>
                      <td className={`px-4 py-3 text-right font-bold ${c.isProfitable ? 'text-green-600' : 'text-red-600'}`}>
                        {formatCurrency(filters.viewMode === 'per_acre' ? c.profitPerAcre : c.profit)}
                      </td>
                    </tr>
                  ))}
                </tbody>
                <tfoot className="bg-gray-100">
                  <tr>
                    <td className="px-4 py-3 font-bold">Total</td>
                    <td className="px-4 py-3 text-right font-bold">{formatNumber(reportData.totals.acres)}</td>
                    <td className="px-4 py-3 text-right font-bold">{formatCurrency(filters.viewMode === 'per_acre' ? (reportData.totals.acres > 0 ? reportData.totals.totalCost / reportData.totals.acres : 0) : reportData.totals.totalCost)}</td>
                    {filters.costView === 'variance' && reportData.totals.variance && (
                      <td className={`px-4 py-3 text-right font-bold ${reportData.totals.variance.total.variance < 0 ? 'text-green-600' : 'text-red-600'}`}>
                        {reportData.totals.variance.total.variance !== 0 && (reportData.totals.variance.total.variance > 0 ? '+' : '')}
                        {formatCurrency(filters.viewMode === 'per_acre' ? (reportData.totals.acres > 0 ? reportData.totals.variance.total.variance / reportData.totals.acres : 0) : reportData.totals.variance.total.variance)}
                      </td>
                    )}
                    <td className="px-4 py-3 text-right font-bold text-green-600">{formatCurrency(filters.viewMode === 'per_acre' ? (reportData.totals.acres > 0 ? reportData.totals.incomeOffset / reportData.totals.acres : 0) : reportData.totals.incomeOffset)}</td>
                    <td className="px-4 py-3 text-right font-bold">{formatCurrency(filters.viewMode === 'per_acre' ? (reportData.totals.acres > 0 ? reportData.totals.netCost / reportData.totals.acres : 0) : reportData.totals.netCost)}</td>
                    <td className="px-4 py-3 text-right font-bold">{formatNumber(reportData.totals.bushels, 0)}</td>
                    <td className="px-4 py-3 text-right font-bold text-blue-600">{reportData.totals.bushels > 0 ? `$${(reportData.totals.netCost / reportData.totals.bushels).toFixed(4)}` : '-'}</td>
                    <td className={`px-4 py-3 text-right font-bold ${reportData.totals.profit > 0 ? 'text-green-600' : 'text-red-600'}`}>
                      {formatCurrency(filters.viewMode === 'per_acre' ? (reportData.totals.acres > 0 ? reportData.totals.profit / reportData.totals.acres : 0) : reportData.totals.profit)}
                    </td>
                  </tr>
                </tfoot>
              </table>
            </>
          )}

          {reportData.type === 'field_profitability' && (
            <>
              <div className="p-4 bg-gray-50 border-b">
                <h3 className="font-semibold">Field Profitability - {cropYear}</h3>
                <p className="text-sm text-gray-500">Sorted by profit per acre (highest first)</p>
              </div>
              <table className="w-full text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left">Field</th>
                    <th className="px-4 py-3 text-left">Crop</th>
                    <th className="px-4 py-3 text-center">Practice</th>
                    <th className="px-4 py-3 text-right">Acres</th>
                    <th className="px-4 py-3 text-right">{filters.viewMode === 'per_acre' ? 'Cost/Acre' : 'Total Cost'}</th>
                    <th className="px-4 py-3 text-right">Price</th>
                    <th className="px-4 py-3 text-right">{filters.viewMode === 'per_acre' ? 'Revenue/Acre' : 'Revenue'}</th>
                    <th className="px-4 py-3 text-right">{filters.viewMode === 'per_acre' ? 'Profit/Acre' : 'Profit'}</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {reportData.fields.map(f => (
                    <tr key={f.id} className={`hover:bg-gray-50 ${f.isProfitable ? '' : 'bg-red-50'}`}>
                      <td className="px-4 py-3 font-medium">{f.field_name}</td>
                      <td className="px-4 py-3">{f.commodity_name}</td>
                      <td className="px-4 py-3 text-center">
                        <span className={`px-2 py-0.5 rounded text-xs ${f.practice_type === 'IR' ? 'bg-blue-100 text-blue-700' : 'bg-amber-100 text-amber-700'}`}>
                          {f.practice_type || 'N/A'}
                        </span>
                      </td>
                      <td className="px-4 py-3 text-right">{formatNumber(f.planted_acres || 0)}</td>
                      <td className="px-4 py-3 text-right">{formatCurrency(filters.viewMode === 'per_acre' ? f.costPerAcre : f.totalCost)}</td>
                      <td className="px-4 py-3 text-right text-gray-600">{f.price ? `$${f.price.toFixed(2)}` : '-'}</td>
                      <td className="px-4 py-3 text-right text-blue-600">{formatCurrency(filters.viewMode === 'per_acre' ? (f.planted_acres > 0 ? f.revenue / f.planted_acres : 0) : f.revenue)}</td>
                      <td className={`px-4 py-3 text-right font-bold ${f.isProfitable ? 'text-green-600' : 'text-red-600'}`}>
                        {formatCurrency(filters.viewMode === 'per_acre' ? f.profitPerAcre : f.profit)}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              {reportData.fields.length === 0 && (
                <div className="p-8 text-center text-gray-500">No fields match the selected filters</div>
              )}
            </>
          )}

          {reportData.type === 'variance' && (
            <>
              <div className="p-4 bg-purple-50 border-b">
                <h3 className="font-semibold text-purple-800">Planned vs Actual Variance - {cropYear}</h3>
                <p className="text-sm text-purple-600">Chemical costs from Spray-Suite vs planned</p>
              </div>
              <table className="w-full text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left">Category</th>
                    <th className="px-4 py-3 text-right">Planned</th>
                    <th className="px-4 py-3 text-right">Actual</th>
                    <th className="px-4 py-3 text-right">Variance</th>
                    <th className="px-4 py-3 text-right">% Change</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {reportData.categories.map(cat => (
                    <tr key={cat.name} className={`hover:bg-gray-50 ${cat.name === 'Total' ? 'bg-gray-100 font-semibold' : ''}`}>
                      <td className="px-4 py-3 font-medium">{cat.name}</td>
                      <td className="px-4 py-3 text-right">{formatCurrency(cat.planned)}</td>
                      <td className="px-4 py-3 text-right">{formatCurrency(cat.actual)}</td>
                      <td className={`px-4 py-3 text-right font-medium ${cat.variance < 0 ? 'text-green-600' : cat.variance > 0 ? 'text-red-600' : ''}`}>
                        {cat.variance !== 0 && (cat.variance > 0 ? '+' : '')}{formatCurrency(cat.variance)}
                      </td>
                      <td className={`px-4 py-3 text-right ${cat.pctChange < 0 ? 'text-green-600' : cat.pctChange > 0 ? 'text-red-600' : ''}`}>
                        {cat.pctChange !== 0 && (cat.pctChange > 0 ? '+' : '')}{cat.pctChange.toFixed(1)}%
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <div className="p-4 bg-gray-50 border-t">
                <div className="flex items-center gap-4 text-sm">
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded-full bg-green-500"></div>
                    <span className="text-gray-600">Under Budget</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded-full bg-red-500"></div>
                    <span className="text-gray-600">Over Budget</span>
                  </div>
                </div>
              </div>
            </>
          )}
        </div>
      )}

      {!reportData && (
        <div className="bg-white rounded-xl shadow-sm border p-8 text-center">
          <Icon name="file-text" size={48} className="mx-auto text-gray-300 mb-4" />
          <h3 className="text-lg font-semibold text-gray-900 mb-2">Generate a Report</h3>
          <p className="text-gray-500">Select your filters and click "Generate Report" to view breakeven data.</p>
        </div>
      )}
    </div>
  );
}

// ============================================================================
// CROP PLANS PAGE
// ============================================================================
function CropPlansPage({ cropYear, onYearChange }) {
  const [cropPlans, setCropPlans] = useState([]);
  const [commodities, setCommodities] = useState([]);
  const [tankMixes, setTankMixes] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showEditor, setShowEditor] = useState(false);
  const [editingPlan, setEditingPlan] = useState(null);
  const [deleteConfirm, setDeleteConfirm] = useState(null);
  const [filterCommodity, setFilterCommodity] = useState('');
  const { addToast } = useToast();
  const currentYear = new Date().getFullYear();
  const cropYears = [currentYear - 1, currentYear, currentYear + 1];

  const loadData = async () => {
    setLoading(true);
    const [plans, coms, tm] = await Promise.all([
      getCropPlans(cropYear),
      getCommodities(),
      getTankMixes()
    ]);
    setCropPlans(plans);
    setCommodities(coms);
    setTankMixes(tm);
    setLoading(false);
  };

  useEffect(() => { loadData(); }, [cropYear]);

  const handleDelete = async () => {
    try {
      await deleteCropPlan(deleteConfirm.id);
      addToast('Crop plan deleted', { type: 'success' });
      setDeleteConfirm(null);
      loadData();
    } catch (e) {
      addToast('Failed to delete: ' + e.message, { type: 'error' });
    }
  };

  const handleClone = async (plan) => {
    try {
      const newPlan = await saveCropPlan({
        name: plan.name + ' (Copy)',
        commodity_id: plan.commodity_id,
        practice_type: plan.practice_type,
        crop_year: cropYear,
        description: plan.description
      });
      if (plan.seed) await saveCropPlanSeed(newPlan.id, plan.seed);
      if (plan.custom_costs?.length) await saveCropPlanCustomCosts(newPlan.id, plan.custom_costs);
      if (plan.fertilizer_passes?.length) await saveCropPlanFertilizer(newPlan.id, plan.fertilizer_passes);
      if (plan.chemical_passes?.length) await saveCropPlanChemicals(newPlan.id, plan.chemical_passes);
      addToast('Plan cloned successfully', { type: 'success' });
      loadData();
    } catch (e) {
      addToast('Failed to clone: ' + e.message, { type: 'error' });
    }
  };

  const filteredPlans = filterCommodity
    ? cropPlans.filter(p => p.commodity_id === filterCommodity)
    : cropPlans;

  if (showEditor) {
    return (
      <CropPlanEditor
        plan={editingPlan}
        cropYear={cropYear}
        commodities={commodities}
        tankMixes={tankMixes}
        onClose={() => { setShowEditor(false); setEditingPlan(null); }}
        onSave={() => { setShowEditor(false); setEditingPlan(null); loadData(); }}
      />
    );
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Crop Plans</h1>
          <p className="text-sm text-gray-500">Comprehensive cost templates with seed, custom costs, fertilizer, and chemicals</p>
        </div>
        <div className="flex gap-3">
          <button onClick={() => { setEditingPlan(null); setShowEditor(true); }} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            <Icon name="plus" size={18} /> New Crop Plan
          </button>
          <select value={cropYear} onChange={(e) => onYearChange(parseInt(e.target.value))} className="px-4 py-2 border rounded-lg">
            {cropYears.map(y => <option key={y} value={y}>{y} Crop Year</option>)}
          </select>
        </div>
      </div>

      <div className="flex gap-4 items-center">
        <div className="flex-1">
          <select value={filterCommodity} onChange={(e) => setFilterCommodity(e.target.value)} className="px-3 py-2 border rounded-lg">
            <option value="">All Commodities</option>
            {commodities.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
          </select>
        </div>
        <div className="text-sm text-gray-500">{filteredPlans.length} plan(s)</div>
      </div>

      {loading ? (
        <div className="p-8 text-center"><Icon name="loader" className="animate-spin text-blue-600 mx-auto" size={32} /></div>
      ) : filteredPlans.length === 0 ? (
        <div className="bg-white rounded-xl shadow-sm border p-12 text-center">
          <Icon name="clipboard-list" size={48} className="mx-auto text-gray-300 mb-4" />
          <h3 className="text-lg font-medium text-gray-900 mb-2">No Crop Plans</h3>
          <p className="text-gray-500 mb-4">Create a comprehensive crop plan to track all your input costs.</p>
          <button onClick={() => setShowEditor(true)} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Create Your First Plan
          </button>
        </div>
      ) : (
        <div className="grid gap-4">
          {filteredPlans.map(plan => {
            const costPerAcre = calculateCropPlanCost(plan);
            return (
              <div key={plan.id} className="bg-white rounded-xl shadow-sm border overflow-hidden">
                <div className="p-4 flex items-start justify-between">
                  <div className="flex-1">
                    <div className="flex items-center gap-3 mb-1">
                      <h3 className="font-semibold text-lg">{plan.name}</h3>
                      {plan.commodity_name && (
                        <span className="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs font-medium">{plan.commodity_name}</span>
                      )}
                      {plan.practice_type && (
                        <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-medium">{plan.practice_type === 'IR' ? 'Irrigated' : 'Dryland'}</span>
                      )}
                    </div>
                    {plan.description && <p className="text-sm text-gray-500">{plan.description}</p>}
                  </div>
                  <div className="text-right">
                    <div className="text-2xl font-bold text-gray-900">{formatCurrency(costPerAcre)}</div>
                    <div className="text-xs text-gray-500">per acre</div>
                  </div>
                </div>

                <div className="px-4 pb-4 grid grid-cols-4 gap-3 text-sm">
                  <div className="bg-gray-50 rounded-lg p-3">
                    <div className="flex items-center gap-2 text-gray-500 mb-1">
                      <Icon name="package" size={14} /> Seed
                    </div>
                    {plan.seed ? (
                      <div>
                        <div className="font-medium">{plan.seed.brand} {plan.seed.hybrid}</div>
                        <div className="text-xs text-gray-500">{plan.seed.default_seeding_rate?.toLocaleString()} seeds/ac @ {formatCurrency(plan.seed.price_per_bag)}/bag</div>
                      </div>
                    ) : (
                      <div className="text-gray-400">Not set</div>
                    )}
                  </div>

                  <div className="bg-gray-50 rounded-lg p-3">
                    <div className="flex items-center gap-2 text-gray-500 mb-1">
                      <Icon name="wrench" size={14} /> Custom Costs
                    </div>
                    {plan.custom_costs?.length > 0 ? (
                      <div>
                        <div className="font-medium">{plan.custom_costs.length} item(s)</div>
                        <div className="text-xs text-gray-500">{formatCurrency(plan.custom_costs.reduce((s, c) => s + (c.cost_type === 'PER_ACRE' ? c.amount : 0), 0))}/ac</div>
                      </div>
                    ) : (
                      <div className="text-gray-400">None</div>
                    )}
                  </div>

                  <div className="bg-gray-50 rounded-lg p-3">
                    <div className="flex items-center gap-2 text-gray-500 mb-1">
                      <Icon name="flask-conical" size={14} /> Fertilizer
                    </div>
                    {plan.fertilizer_passes?.length > 0 ? (
                      <div>
                        <div className="font-medium">{plan.fertilizer_passes.length} pass(es)</div>
                        <div className="text-xs text-gray-500">{plan.fertilizer_passes.reduce((s, p) => s + (p.products?.length || 0), 0)} products</div>
                      </div>
                    ) : (
                      <div className="text-gray-400">None</div>
                    )}
                  </div>

                  <div className="bg-gray-50 rounded-lg p-3">
                    <div className="flex items-center gap-2 text-gray-500 mb-1">
                      <Icon name="spray-can" size={14} /> Chemicals
                    </div>
                    {plan.chemical_passes?.length > 0 ? (
                      <div>
                        <div className="font-medium">{plan.chemical_passes.length} pass(es)</div>
                        <div className="text-xs text-gray-500">{plan.chemical_passes.reduce((s, p) => s + (p.products?.length || 0), 0)} products</div>
                      </div>
                    ) : (
                      <div className="text-gray-400">None</div>
                    )}
                  </div>
                </div>

                <div className="px-4 py-3 bg-gray-50 border-t flex items-center justify-between">
                  <div className="flex gap-2">
                    <button onClick={() => { setEditingPlan(plan); setShowEditor(true); }} className="flex items-center gap-1 px-3 py-1.5 bg-white border rounded-lg text-sm hover:bg-gray-50">
                      <Icon name="pencil" size={14} /> Edit
                    </button>
                    <button onClick={() => handleClone(plan)} className="flex items-center gap-1 px-3 py-1.5 bg-white border rounded-lg text-sm hover:bg-gray-50">
                      <Icon name="copy" size={14} /> Clone
                    </button>
                  </div>
                  <button onClick={() => setDeleteConfirm(plan)} className="flex items-center gap-1 px-3 py-1.5 text-red-600 hover:bg-red-50 rounded-lg text-sm">
                    <Icon name="trash-2" size={14} /> Delete
                  </button>
                </div>
              </div>
            );
          })}
        </div>
      )}

      <ConfirmModal
        isOpen={!!deleteConfirm}
        title="Delete Crop Plan"
        message={`Are you sure you want to delete "${deleteConfirm?.name}"? This cannot be undone.`}
        onConfirm={handleDelete}
        onCancel={() => setDeleteConfirm(null)}
      />
    </div>
  );
}

// ============================================================================
// CROP PLAN EDITOR (Full-featured editor with tabs)
// ============================================================================
function CropPlanEditor({ plan, cropYear, commodities, tankMixes, onClose, onSave }) {
  const [activeTab, setActiveTab] = useState('info');
  const [saving, setSaving] = useState(false);
  const [seedProducts, setSeedProducts] = useState([]);
  const { addToast } = useToast();

  // Load seed products
  useEffect(() => {
    getSeedProducts(cropYear).then(setSeedProducts);
  }, [cropYear]);

  // Form state
  const [info, setInfo] = useState({
    name: plan?.name || '',
    commodity_id: plan?.commodity_id || '',
    practice_type: plan?.practice_type || '',
    description: plan?.description || ''
  });

  const [seed, setSeed] = useState(plan?.seed || {
    seed_product_id: '', brand: '', hybrid: '', seeds_per_bag: 80000, price_per_bag: '', default_seeding_rate: '', treatment: '', notes: ''
  });

  const [customCosts, setCustomCosts] = useState(plan?.custom_costs || []);
  const [fertPasses, setFertPasses] = useState(plan?.fertilizer_passes || []);
  const [chemPasses, setChemPasses] = useState(plan?.chemical_passes || []);

  // Update seeds_per_bag default based on commodity
  useEffect(() => {
    if (info.commodity_id && !plan?.seed) {
      const com = commodities.find(c => c.id === info.commodity_id);
      if (com?.name?.toLowerCase().includes('corn')) {
        setSeed(s => ({ ...s, seeds_per_bag: 80000, default_seeding_rate: s.default_seeding_rate || 34000 }));
      } else if (com?.name?.toLowerCase().includes('soy') || com?.name?.toLowerCase().includes('bean')) {
        setSeed(s => ({ ...s, seeds_per_bag: 140000, default_seeding_rate: s.default_seeding_rate || 140000 }));
      }
    }
  }, [info.commodity_id]);

  const handleSave = async () => {
    if (!info.name.trim()) {
      addToast('Plan name is required', { type: 'error' });
      return;
    }

    setSaving(true);
    try {
      // Save main plan
      const savedPlan = await saveCropPlan({
        id: plan?.id,
        name: info.name,
        commodity_id: info.commodity_id || null,
        practice_type: info.practice_type || null,
        crop_year: cropYear,
        description: info.description
      });

      const planId = savedPlan.id || plan?.id;

      // Save related data
      await saveCropPlanSeed(planId, seed);
      await saveCropPlanCustomCosts(planId, customCosts);
      await saveCropPlanFertilizer(planId, fertPasses);
      await saveCropPlanChemicals(planId, chemPasses);

      addToast('Crop plan saved', { type: 'success' });
      onSave();
    } catch (e) {
      addToast('Failed to save: ' + e.message, { type: 'error' });
    }
    setSaving(false);
  };

  // Calculate total cost
  const totalCost = calculateCropPlanCost({
    seed: seed.price_per_bag ? seed : null,
    custom_costs: customCosts,
    fertilizer_passes: fertPasses,
    chemical_passes: chemPasses
  });

  const tabs = [
    { id: 'info', label: 'Info', icon: 'file-text' },
    { id: 'seed', label: 'Seed', icon: 'package' },
    { id: 'custom', label: 'Field Operations', icon: 'tractor' },
    { id: 'fertilizer', label: 'Fertilizer', icon: 'flask-conical' },
    { id: 'chemicals', label: 'Chemicals', icon: 'spray-can' }
  ];

  // Tab navigation helpers
  const currentTabIndex = tabs.findIndex(t => t.id === activeTab);
  const canGoBack = currentTabIndex > 0;
  const canGoNext = currentTabIndex < tabs.length - 1;
  const goBack = () => canGoBack && setActiveTab(tabs[currentTabIndex - 1].id);
  const goNext = () => canGoNext && setActiveTab(tabs[currentTabIndex + 1].id);

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg">
            <Icon name="arrow-left" size={20} />
          </button>
          <div>
            <h1 className="text-2xl font-bold text-gray-900">{plan ? 'Edit Crop Plan' : 'New Crop Plan'}</h1>
            <p className="text-sm text-gray-500">{cropYear} â€¢ Est. {formatCurrency(totalCost)}/acre</p>
          </div>
        </div>
        <button onClick={handleSave} disabled={saving} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
          {saving ? <Icon name="loader" className="animate-spin" size={18} /> : <Icon name="save" size={18} />}
          {saving ? 'Saving...' : 'Save Plan'}
        </button>
      </div>

      <div className="flex gap-2 border-b overflow-x-auto">
        {tabs.map(tab => (
          <button key={tab.id} onClick={() => setActiveTab(tab.id)}
            className={`flex items-center gap-2 px-4 py-2 font-medium whitespace-nowrap ${activeTab === tab.id ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'}`}>
            <Icon name={tab.icon} size={16} /> {tab.label}
          </button>
        ))}
      </div>

      <div className="bg-white rounded-xl shadow-sm border p-6">
        {activeTab === 'info' && (
          <div className="space-y-4 max-w-xl">
            <div>
              <label className="block text-sm font-medium mb-1">Plan Name *</label>
              <input type="text" value={info.name} onChange={(e) => setInfo(i => ({ ...i, name: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" placeholder="2026 Irrigated Corn" />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium mb-1">Commodity</label>
                <select value={info.commodity_id} onChange={(e) => setInfo(i => ({ ...i, commodity_id: e.target.value }))} className="w-full px-3 py-2 border rounded-lg">
                  <option value="">Any Commodity</option>
                  {commodities.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Practice Type</label>
                <select value={info.practice_type} onChange={(e) => setInfo(i => ({ ...i, practice_type: e.target.value }))} className="w-full px-3 py-2 border rounded-lg">
                  <option value="">Any Practice</option>
                  <option value="IR">Irrigated</option>
                  <option value="DL">Dryland</option>
                </select>
              </div>
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Description</label>
              <textarea value={info.description} onChange={(e) => setInfo(i => ({ ...i, description: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" rows={2} placeholder="Notes about this plan..." />
            </div>
          </div>
        )}

        {activeTab === 'seed' && (
          <SeedEditor seed={seed} onChange={setSeed} commodityId={info.commodity_id} practiceType={info.practice_type} commodities={commodities} seedProducts={seedProducts} />
        )}

        {activeTab === 'custom' && (
          <CustomCostsEditor costs={customCosts} onChange={setCustomCosts} />
        )}

        {activeTab === 'fertilizer' && (
          <FertilizerPassesEditor passes={fertPasses} onChange={setFertPasses} />
        )}

        {activeTab === 'chemicals' && (
          <ChemicalPassesEditor passes={chemPasses} onChange={setChemPasses} tankMixes={tankMixes} />
        )}

        {/* Tab Navigation - Back/Next */}
        <div className="flex justify-between items-center pt-6 mt-6 border-t">
          <button onClick={goBack} disabled={!canGoBack}
            className={`flex items-center gap-2 px-4 py-2 rounded-lg ${canGoBack ? 'text-gray-700 hover:bg-gray-100' : 'text-gray-300 cursor-not-allowed'}`}>
            <Icon name="arrow-left" size={18} />
            {canGoBack ? tabs[currentTabIndex - 1].label : 'Back'}
          </button>
          <div className="flex items-center gap-2">
            {tabs.map((tab, idx) => (
              <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                className={`w-2.5 h-2.5 rounded-full transition-colors ${idx === currentTabIndex ? 'bg-blue-600' : 'bg-gray-300 hover:bg-gray-400'}`}
                title={tab.label} />
            ))}
          </div>
          {canGoNext ? (
            <button onClick={goNext}
              className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
              {tabs[currentTabIndex + 1].label}
              <Icon name="arrow-right" size={18} />
            </button>
          ) : (
            <button onClick={handleSave} disabled={saving}
              className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50">
              {saving ? <Icon name="loader" className="animate-spin" size={18} /> : <Icon name="check" size={18} />}
              {saving ? 'Saving...' : 'Save & Finish'}
            </button>
          )}
        </div>
      </div>
    </div>
  );
}

// Seed Editor Component
function SeedEditor({ seed, onChange, commodityId, practiceType, commodities, seedProducts = [] }) {
  const commodity = commodities.find(c => c.id === commodityId);
  const isCorn = commodity?.name?.toLowerCase().includes('corn');
  const isBeans = commodity?.name?.toLowerCase().includes('soy') || commodity?.name?.toLowerCase().includes('bean');

  // Filter products by commodity and practice type
  const availableProducts = seedProducts.filter(p => {
    if (commodityId && p.commodity_id !== commodityId) return false;
    if (practiceType && p.practice_type && p.practice_type !== practiceType) return false;
    return true;
  });

  // Handle product selection
  const handleProductSelect = (productId) => {
    if (!productId) {
      // Clear to manual entry
      onChange({ ...seed, seed_product_id: '', brand: '', hybrid: '', seeds_per_bag: isCorn ? 80000 : isBeans ? 140000 : 80000, price_per_bag: '', default_seeding_rate: '' });
      return;
    }
    const product = seedProducts.find(p => p.id === productId);
    if (product) {
      onChange({
        ...seed,
        seed_product_id: productId,
        brand: product.brand,
        hybrid: product.hybrid,
        seeds_per_bag: product.seeds_per_bag,
        price_per_bag: product.price_per_bag,
        default_seeding_rate: product.default_seeding_rate
      });
    }
  };

  const bagsNeeded = seed.default_seeding_rate && seed.seeds_per_bag ? seed.default_seeding_rate / seed.seeds_per_bag : 0;
  const costPerAcre = bagsNeeded * (seed.price_per_bag || 0);

  return (
    <div className="space-y-4 max-w-2xl">
      {/* Product Selection */}
      {availableProducts.length > 0 && (
        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
          <label className="block text-sm font-medium text-green-800 mb-2">Select from Seed Products</label>
          <select
            value={seed.seed_product_id || ''}
            onChange={(e) => handleProductSelect(e.target.value)}
            className="w-full px-3 py-2 border rounded-lg bg-white"
          >
            <option value="">-- Manual Entry --</option>
            {availableProducts.map(p => (
              <option key={p.id} value={p.id}>
                {p.brand} {p.hybrid} - {formatCurrency(p.price_per_bag)}/bag ({formatNumber(p.default_seeding_rate)} seeds/ac)
              </option>
            ))}
          </select>
          <p className="text-xs text-green-600 mt-1">
            {availableProducts.length} product{availableProducts.length !== 1 ? 's' : ''} available for {commodity?.name || 'this crop'}
            {practiceType && ` (${practiceType === 'IR' ? 'Irrigated' : 'Dryland'})`}
          </p>
        </div>
      )}

      {availableProducts.length === 0 && (
        <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-800">
          <Icon name="info" size={16} className="inline mr-2" />
          No seed products found for this crop. Add products in the Seed Products page or enter details manually below.
        </div>
      )}

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium mb-1">Brand</label>
          <input type="text" value={seed.brand || ''} onChange={(e) => onChange({ ...seed, brand: e.target.value, seed_product_id: '' })} className="w-full px-3 py-2 border rounded-lg" placeholder="Pioneer, Dekalb, Asgrow..." />
        </div>
        <div>
          <label className="block text-sm font-medium mb-1">Hybrid/Variety</label>
          <input type="text" value={seed.hybrid || ''} onChange={(e) => onChange({ ...seed, hybrid: e.target.value, seed_product_id: '' })} className="w-full px-3 py-2 border rounded-lg" placeholder="P1185AM, DKC64-35..." />
        </div>
      </div>

      <div className="grid grid-cols-3 gap-4">
        <div>
          <label className="block text-sm font-medium mb-1">Seeds per Bag</label>
          <input type="number" value={seed.seeds_per_bag || ''} onChange={(e) => onChange({ ...seed, seeds_per_bag: parseInt(e.target.value) || 0 })} className="w-full px-3 py-2 border rounded-lg" placeholder={isCorn ? '80000' : isBeans ? '140000' : '80000'} />
          <div className="text-xs text-gray-500 mt-1">{isCorn ? 'Corn: 80K typical' : isBeans ? 'Beans: 140K typical' : ''}</div>
        </div>
        <div>
          <label className="block text-sm font-medium mb-1">Price per Bag</label>
          <div className="relative">
            <span className="absolute left-3 top-2 text-gray-500">$</span>
            <input type="number" step="0.01" value={seed.price_per_bag || ''} onChange={(e) => onChange({ ...seed, price_per_bag: parseFloat(e.target.value) || 0 })} className="w-full pl-7 pr-3 py-2 border rounded-lg" placeholder={isCorn ? '350' : isBeans ? '65' : ''} />
          </div>
        </div>
        <div>
          <label className="block text-sm font-medium mb-1">Seeding Rate (seeds/ac)</label>
          <input type="number" value={seed.default_seeding_rate || ''} onChange={(e) => onChange({ ...seed, default_seeding_rate: parseInt(e.target.value) || 0 })} className="w-full px-3 py-2 border rounded-lg" placeholder={isCorn ? '34000' : isBeans ? '140000' : ''} />
        </div>
      </div>

      {costPerAcre > 0 && (
        <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
          <div className="flex justify-between items-center">
            <div>
              <div className="text-sm text-blue-600">Calculated Seed Cost</div>
              <div className="text-xs text-blue-500">{bagsNeeded.toFixed(2)} bags/acre @ {formatCurrency(seed.price_per_bag)}/bag</div>
            </div>
            <div className="text-xl font-bold text-blue-700">{formatCurrency(costPerAcre)}/acre</div>
          </div>
        </div>
      )}

      <div>
        <label className="block text-sm font-medium mb-1">Seed Treatment</label>
        <input type="text" value={seed.treatment || ''} onChange={(e) => onChange({ ...seed, treatment: e.target.value })} className="w-full px-3 py-2 border rounded-lg" placeholder="Poncho/Votivo, Acceleron..." />
      </div>

      <div>
        <label className="block text-sm font-medium mb-1">Notes</label>
        <textarea value={seed.notes || ''} onChange={(e) => onChange({ ...seed, notes: e.target.value })} className="w-full px-3 py-2 border rounded-lg" rows={2} placeholder="Additional notes..." />
      </div>
    </div>
  );
}

// Custom Costs Editor Component
function CustomCostsEditor({ costs, onChange }) {
  // Common field operations for quick-add
  const quickAddOptions = [
    { name: 'Harvest', cost_type: 'PER_ACRE', timing: 'Harvest', placeholder: 'Custom combining' },
    { name: 'Planting', cost_type: 'PER_ACRE', timing: 'At-plant', placeholder: 'Custom planting' },
    { name: 'Tillage', cost_type: 'PER_ACRE', timing: 'Pre-plant', placeholder: 'Disk, field cultivator' },
    { name: 'Drying', cost_type: 'PER_BUSHEL', timing: 'Post-harvest', placeholder: '$/point/bu' },
    { name: 'Hauling', cost_type: 'PER_BUSHEL', timing: 'Harvest', placeholder: 'Trucking' },
    { name: 'Aerial Application', cost_type: 'PER_ACRE', timing: 'In-season', placeholder: 'Fungicide/insecticide' }
  ];

  const addCost = (template = null) => {
    const newCost = template
      ? { ...template, amount: '', unit: template.cost_type === 'PER_ACRE' ? '/acre' : '/bu', notes: '' }
      : { name: '', cost_type: 'PER_ACRE', amount: '', unit: '/acre', timing: '', notes: '' };
    onChange([...costs, newCost]);
  };

  const updateCost = (index, field, value) => {
    const updated = [...costs];
    updated[index] = { ...updated[index], [field]: value };
    onChange(updated);
  };

  const removeCost = (index) => {
    onChange(costs.filter((_, i) => i !== index));
  };

  const totalPerAcre = costs.reduce((sum, c) => sum + (c.cost_type === 'PER_ACRE' ? (parseFloat(c.amount) || 0) : 0), 0);

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <div>
          <div className="text-sm text-gray-500">Field operations: harvest, planting, tillage, drying, custom hire, etc.</div>
        </div>
        <div className="text-right">
          <div className="text-sm text-gray-500">Per-acre total</div>
          <div className="font-bold">{formatCurrency(totalPerAcre)}/acre</div>
        </div>
      </div>

      {/* Quick-add buttons */}
      <div className="flex flex-wrap gap-2">
        {quickAddOptions.map(opt => (
          <button key={opt.name} onClick={() => addCost(opt)}
            className="px-3 py-1.5 text-sm border rounded-full hover:bg-gray-100 text-gray-600">
            + {opt.name}
          </button>
        ))}
      </div>

      {costs.length === 0 ? (
        <div className="text-center py-8 text-gray-500">
          <Icon name="tractor" size={32} className="mx-auto mb-2 text-gray-300" />
          <p>No field operations added</p>
          <p className="text-xs mt-1">Click a button above to add common operations</p>
        </div>
      ) : (
        <div className="space-y-3">
          {costs.map((cost, i) => (
            <div key={i} className="flex gap-3 items-start p-3 bg-gray-50 rounded-lg">
              <div className="flex-1 grid grid-cols-4 gap-3">
                <div>
                  <label className="block text-xs font-medium mb-1">Name</label>
                  <input type="text" value={cost.name} onChange={(e) => updateCost(i, 'name', e.target.value)} className="w-full px-2 py-1.5 border rounded text-sm" placeholder="Custom Disk" />
                </div>
                <div>
                  <label className="block text-xs font-medium mb-1">Type</label>
                  <select value={cost.cost_type} onChange={(e) => updateCost(i, 'cost_type', e.target.value)} className="w-full px-2 py-1.5 border rounded text-sm">
                    <option value="PER_ACRE">Per Acre</option>
                    <option value="PER_BUSHEL">Per Bushel</option>
                    <option value="FIXED">Fixed</option>
                  </select>
                </div>
                <div>
                  <label className="block text-xs font-medium mb-1">Amount</label>
                  <div className="relative">
                    <span className="absolute left-2 top-1.5 text-gray-500 text-sm">$</span>
                    <input type="number" step="0.01" value={cost.amount} onChange={(e) => updateCost(i, 'amount', parseFloat(e.target.value) || 0)} className="w-full pl-6 pr-2 py-1.5 border rounded text-sm" />
                  </div>
                </div>
                <div>
                  <label className="block text-xs font-medium mb-1">Timing</label>
                  <select value={cost.timing || ''} onChange={(e) => updateCost(i, 'timing', e.target.value)} className="w-full px-2 py-1.5 border rounded text-sm">
                    <option value="">Select...</option>
                    <option value="Pre-plant">Pre-plant</option>
                    <option value="At-plant">At-plant</option>
                    <option value="In-season">In-season</option>
                    <option value="Harvest">Harvest</option>
                    <option value="Post-harvest">Post-harvest</option>
                  </select>
                </div>
              </div>
              <button onClick={() => removeCost(i)} className="p-1.5 text-red-500 hover:bg-red-100 rounded mt-5">
                <Icon name="x" size={16} />
              </button>
            </div>
          ))}
        </div>
      )}

      <button onClick={() => addCost()} className="flex items-center gap-2 px-3 py-2 border-2 border-dashed rounded-lg text-gray-500 hover:text-gray-700 hover:border-gray-400 w-full justify-center">
        <Icon name="plus" size={16} /> Add Field Operation
      </button>
    </div>
  );
}

// Fertilizer Passes Editor Component
function FertilizerPassesEditor({ passes, onChange }) {
  const addPass = () => {
    onChange([...passes, { pass_name: '', timing: '', application_method: '', notes: '', products: [] }]);
  };

  const updatePass = (index, field, value) => {
    const updated = [...passes];
    updated[index] = { ...updated[index], [field]: value };
    onChange(updated);
  };

  const removePass = (index) => {
    onChange(passes.filter((_, i) => i !== index));
  };

  const addProduct = (passIndex) => {
    const updated = [...passes];
    updated[passIndex].products = [...(updated[passIndex].products || []), { product_name: '', rate: '', rate_unit: 'lb/acre', price_per_unit: '' }];
    onChange(updated);
  };

  const updateProduct = (passIndex, prodIndex, field, value) => {
    const updated = [...passes];
    updated[passIndex].products[prodIndex] = { ...updated[passIndex].products[prodIndex], [field]: value };
    onChange(updated);
  };

  const removeProduct = (passIndex, prodIndex) => {
    const updated = [...passes];
    updated[passIndex].products = updated[passIndex].products.filter((_, i) => i !== prodIndex);
    onChange(updated);
  };

  const totalCost = passes.reduce((sum, pass) => {
    return sum + (pass.products || []).reduce((pSum, prod) => {
      return pSum + ((parseFloat(prod.rate) || 0) * (parseFloat(prod.price_per_unit) || 0));
    }, 0);
  }, 0);

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <div className="text-sm text-gray-500">Fertilizer applications with products and rates</div>
        <div className="text-right">
          <div className="text-sm text-gray-500">Total fertilizer cost</div>
          <div className="font-bold">{formatCurrency(totalCost)}/acre</div>
        </div>
      </div>

      {passes.length === 0 ? (
        <div className="text-center py-8 text-gray-500">
          <Icon name="flask-conical" size={32} className="mx-auto mb-2 text-gray-300" />
          <p>No fertilizer passes added</p>
        </div>
      ) : (
        <div className="space-y-4">
          {passes.map((pass, pi) => (
            <div key={pi} className="border rounded-lg overflow-hidden">
              <div className="bg-green-50 px-4 py-3 flex items-center justify-between">
                <div className="flex gap-3 items-center flex-1">
                  <input type="text" value={pass.pass_name} onChange={(e) => updatePass(pi, 'pass_name', e.target.value)} className="px-2 py-1 border rounded font-medium bg-white" placeholder="Pass name (e.g., Fall NH3)" />
                  <select value={pass.timing || ''} onChange={(e) => updatePass(pi, 'timing', e.target.value)} className="px-2 py-1 border rounded text-sm bg-white">
                    <option value="">Timing...</option>
                    <option value="Fall">Fall</option>
                    <option value="Pre-plant">Pre-plant</option>
                    <option value="At-plant">At-plant</option>
                    <option value="Side-dress">Side-dress</option>
                    <option value="Foliar">Foliar</option>
                  </select>
                </div>
                <button onClick={() => removePass(pi)} className="p-1 text-red-500 hover:bg-red-100 rounded">
                  <Icon name="trash-2" size={16} />
                </button>
              </div>
              <div className="p-4 space-y-2">
                {(pass.products || []).map((prod, pri) => (
                  <div key={pri} className="flex gap-2 items-center">
                    <input type="text" value={prod.product_name} onChange={(e) => updateProduct(pi, pri, 'product_name', e.target.value)} className="flex-1 px-2 py-1.5 border rounded text-sm" placeholder="Product (NH3, MAP, UAN...)" />
                    <input type="number" step="0.01" value={prod.rate} onChange={(e) => updateProduct(pi, pri, 'rate', e.target.value)} className="w-20 px-2 py-1.5 border rounded text-sm" placeholder="Rate" />
                    <select value={prod.rate_unit} onChange={(e) => updateProduct(pi, pri, 'rate_unit', e.target.value)} className="px-2 py-1.5 border rounded text-sm">
                      <option value="lb/acre">lb/ac</option>
                      <option value="gal/acre">gal/ac</option>
                      <option value="ton/acre">ton/ac</option>
                    </select>
                    <div className="flex items-center">
                      <span className="text-gray-500 text-sm">$</span>
                      <input type="number" step="0.01" value={prod.price_per_unit} onChange={(e) => updateProduct(pi, pri, 'price_per_unit', e.target.value)} className="w-16 px-1 py-1.5 border rounded text-sm" placeholder="0.00" />
                      <span className="text-gray-500 text-sm">/unit</span>
                    </div>
                    <span className="text-sm text-gray-600 w-20 text-right">{formatCurrency((parseFloat(prod.rate) || 0) * (parseFloat(prod.price_per_unit) || 0))}</span>
                    <button onClick={() => removeProduct(pi, pri)} className="p-1 text-red-400 hover:text-red-600">
                      <Icon name="x" size={14} />
                    </button>
                  </div>
                ))}
                <button onClick={() => addProduct(pi)} className="flex items-center gap-1 text-sm text-green-600 hover:text-green-700 mt-2">
                  <Icon name="plus" size={14} /> Add Product
                </button>
              </div>
            </div>
          ))}
        </div>
      )}

      <button onClick={addPass} className="flex items-center gap-2 px-3 py-2 border-2 border-dashed rounded-lg text-gray-500 hover:text-gray-700 hover:border-gray-400 w-full justify-center">
        <Icon name="plus" size={16} /> Add Fertilizer Pass
      </button>
    </div>
  );
}

// Chemical Passes Editor Component
function ChemicalPassesEditor({ passes, onChange, tankMixes }) {
  const addPass = () => {
    onChange([...passes, { pass_name: '', timing: '', tank_mix_id: '', application_method: '', notes: '', products: [] }]);
  };

  const updatePass = (index, field, value) => {
    const updated = [...passes];
    updated[index] = { ...updated[index], [field]: value };
    onChange(updated);
  };

  // When tank mix is selected, populate products from that mix
  const selectTankMix = (passIndex, tankMixId) => {
    console.log('selectTankMix called:', { passIndex, tankMixId, tankMixesCount: tankMixes.length });

    const updated = [...passes];
    updated[passIndex].tank_mix_id = tankMixId;

    if (tankMixId) {
      // Find the tank mix - compare as strings since select values are strings
      const mix = tankMixes.find(tm => String(tm.id) === String(tankMixId));
      console.log('Found tank mix:', mix);

      if (mix && mix.products && mix.products.length > 0) {
        // Auto-populate products from the selected tank mix
        updated[passIndex].products = mix.products.map(p => ({
          product_name: p.product_name,
          rate: p.rate,
          rate_unit: p.rate_unit || 'oz/acre',
          price_per_unit: p.price_per_unit || 0
        }));
        // Also set pass name from tank mix name if empty
        if (!updated[passIndex].pass_name) {
          updated[passIndex].pass_name = mix.name;
        }
        console.log('Updated pass with products:', updated[passIndex]);
      } else {
        console.log('Mix not found or no products:', { mix, hasProducts: mix?.products?.length });
      }
    }

    onChange(updated);
  };

  const removePass = (index) => {
    onChange(passes.filter((_, i) => i !== index));
  };

  const addProduct = (passIndex) => {
    const updated = [...passes];
    updated[passIndex].products = [...(updated[passIndex].products || []), { product_name: '', rate: '', rate_unit: 'oz/acre', price_per_unit: '' }];
    onChange(updated);
  };

  const updateProduct = (passIndex, prodIndex, field, value) => {
    const updated = [...passes];
    updated[passIndex].products[prodIndex] = { ...updated[passIndex].products[prodIndex], [field]: value };
    onChange(updated);
  };

  const removeProduct = (passIndex, prodIndex) => {
    const updated = [...passes];
    updated[passIndex].products = updated[passIndex].products.filter((_, i) => i !== prodIndex);
    onChange(updated);
  };

  const totalCost = passes.reduce((sum, pass) => {
    return sum + (pass.products || []).reduce((pSum, prod) => {
      return pSum + ((parseFloat(prod.rate) || 0) * (parseFloat(prod.price_per_unit) || 0));
    }, 0);
  }, 0);

  // Add a pass directly from a tank mix
  const addPassFromMix = (tankMix) => {
    const newPass = {
      pass_name: tankMix.name,
      timing: '',
      tank_mix_id: tankMix.id,
      application_method: 'Ground',
      notes: '',
      products: tankMix.products.map(p => ({
        product_name: p.product_name,
        rate: p.rate,
        rate_unit: p.rate_unit || 'oz/acre',
        price_per_unit: p.price_per_unit || 0
      }))
    };
    onChange([...passes, newPass]);
  };

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <div className="text-sm text-gray-500">Chemical applications (herbicide, fungicide, insecticide)</div>
        <div className="text-right">
          <div className="text-sm text-gray-500">Total chemical cost</div>
          <div className="font-bold">{formatCurrency(totalCost)}/acre</div>
        </div>
      </div>

      {/* Quick-add from Spray-Suite tank mixes */}
      {tankMixes.length > 0 && (
        <div className="bg-amber-50 rounded-lg p-3">
          <div className="text-xs font-medium text-amber-800 mb-2">Quick add from Spray-Suite:</div>
          <div className="flex flex-wrap gap-2">
            {tankMixes.slice(0, 8).map(tm => (
              <button key={tm.id} onClick={() => addPassFromMix(tm)}
                className="px-3 py-1.5 text-sm bg-white border border-amber-300 rounded-full hover:bg-amber-100 text-amber-800">
                + {tm.name}
              </button>
            ))}
            {tankMixes.length > 8 && (
              <span className="text-xs text-amber-600 self-center">+{tankMixes.length - 8} more in dropdown</span>
            )}
          </div>
        </div>
      )}

      {passes.length === 0 ? (
        <div className="text-center py-8 text-gray-500">
          <Icon name="spray-can" size={32} className="mx-auto mb-2 text-gray-300" />
          <p>No chemical passes added</p>
          <p className="text-xs mt-1">Click a button above to import from Spray-Suite</p>
        </div>
      ) : (
        <div className="space-y-4">
          {passes.map((pass, pi) => (
            <div key={pi} className="border rounded-lg overflow-hidden">
              <div className="bg-amber-50 px-4 py-3 flex items-center justify-between">
                <div className="flex gap-3 items-center flex-1 flex-wrap">
                  <input type="text" value={pass.pass_name} onChange={(e) => updatePass(pi, 'pass_name', e.target.value)} className="px-2 py-1 border rounded font-medium bg-white" placeholder="Pass name (e.g., Burndown)" />
                  <select value={pass.timing || ''} onChange={(e) => updatePass(pi, 'timing', e.target.value)} className="px-2 py-1 border rounded text-sm bg-white">
                    <option value="">Timing...</option>
                    <option value="Burndown">Burndown</option>
                    <option value="Pre-emerge">Pre-emerge</option>
                    <option value="Post-emerge">Post-emerge</option>
                    <option value="Layby">Layby</option>
                    <option value="Fungicide">Fungicide</option>
                  </select>
                  <select value={pass.tank_mix_id || ''} onChange={(e) => selectTankMix(pi, e.target.value)} className="px-2 py-1 border rounded text-sm bg-white min-w-48">
                    <option value="">Import from Spray-Suite...</option>
                    {tankMixes.map(tm => (
                      <option key={tm.id} value={tm.id}>
                        {tm.name} {tm.total_cost ? `(${formatCurrency(tm.total_cost)}/ac)` : ''}
                      </option>
                    ))}
                  </select>
                  {pass.tank_mix_id && (
                    <span className="px-2 py-0.5 bg-green-100 text-green-800 rounded text-xs flex items-center gap-1">
                      <Icon name="link" size={12} /> Linked to Spray-Suite
                    </span>
                  )}
                </div>
                <button onClick={() => removePass(pi)} className="p-1 text-red-500 hover:bg-red-100 rounded ml-2">
                  <Icon name="trash-2" size={16} />
                </button>
              </div>
              <div className="p-4 space-y-2">
                {(pass.products || []).map((prod, pri) => (
                  <div key={pri} className="flex gap-2 items-center">
                    <input type="text" value={prod.product_name} onChange={(e) => updateProduct(pi, pri, 'product_name', e.target.value)} className="flex-1 px-2 py-1.5 border rounded text-sm" placeholder="Product (Roundup, Atrazine...)" />
                    <input type="number" step="0.01" value={prod.rate} onChange={(e) => updateProduct(pi, pri, 'rate', e.target.value)} className="w-20 px-2 py-1.5 border rounded text-sm" placeholder="Rate" />
                    <select value={prod.rate_unit} onChange={(e) => updateProduct(pi, pri, 'rate_unit', e.target.value)} className="px-2 py-1.5 border rounded text-sm">
                      <option value="oz/acre">oz/ac</option>
                      <option value="pt/acre">pt/ac</option>
                      <option value="qt/acre">qt/ac</option>
                      <option value="gal/acre">gal/ac</option>
                    </select>
                    <div className="flex items-center">
                      <span className="text-gray-500 text-sm">$</span>
                      <input type="number" step="0.01" value={prod.price_per_unit} onChange={(e) => updateProduct(pi, pri, 'price_per_unit', e.target.value)} className="w-16 px-1 py-1.5 border rounded text-sm" placeholder="0.00" />
                      <span className="text-gray-500 text-sm">/unit</span>
                    </div>
                    <span className="text-sm text-gray-600 w-20 text-right">{formatCurrency((parseFloat(prod.rate) || 0) * (parseFloat(prod.price_per_unit) || 0))}</span>
                    <button onClick={() => removeProduct(pi, pri)} className="p-1 text-red-400 hover:text-red-600">
                      <Icon name="x" size={14} />
                    </button>
                  </div>
                ))}
                <button onClick={() => addProduct(pi)} className="flex items-center gap-1 text-sm text-amber-600 hover:text-amber-700 mt-2">
                  <Icon name="plus" size={14} /> Add Product
                </button>
              </div>
            </div>
          ))}
        </div>
      )}

      <button onClick={addPass} className="flex items-center gap-2 px-3 py-2 border-2 border-dashed rounded-lg text-gray-500 hover:text-gray-700 hover:border-gray-400 w-full justify-center">
        <Icon name="plus" size={16} /> Add Chemical Pass
      </button>
    </div>
  );
}

// ============================================================================
// FIELD APPLICATIONS PAGE (Assign Crop Plans to Fields)
// ============================================================================
function FieldApplicationsPage({ cropYear, onYearChange }) {
  const [fieldCropYears, setFieldCropYears] = useState([]);
  const [assignments, setAssignments] = useState([]);
  const [cropPlans, setCropPlans] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [showBulkModal, setShowBulkModal] = useState(false);
  const [selectedField, setSelectedField] = useState(null);
  const [filterCommodity, setFilterCommodity] = useState('');
  const [commodities, setCommodities] = useState([]);
  const { addToast } = useToast();
  const currentYear = new Date().getFullYear();
  const cropYears = [currentYear - 1, currentYear, currentYear + 1];

  const loadData = async () => {
    setLoading(true);
    const [fcy, assign, plans, c] = await Promise.all([
      getFieldCropYears(cropYear),
      getFieldPlanAssignments(cropYear),
      getCropPlans(cropYear),
      getCommodities()
    ]);
    setFieldCropYears(fcy);
    setAssignments(assign);
    setCropPlans(plans);
    setCommodities(c);
    setLoading(false);
  };

  useEffect(() => { loadData(); }, [cropYear]);

  // Filter out fields where adams_grain_share = 0 (e.g., Dwight Farms - separate entity)
  const myFields = fieldCropYears.filter(f => {
    const share = f.effective_share ?? 1;
    // Exclude fields where the user has no stake
    return share > 0;
  });

  // Match fields with their crop plan assignments
  const fieldsWithPlans = myFields.map(fcy => {
    const assign = assignments.find(a => a.field_crop_year_id === fcy.id);
    const plan = assign ? cropPlans.find(p => p.id === assign.crop_plan_id) : null;
    return {
      ...fcy,
      assignment: assign || null,
      plan: plan || null,
      hasPlan: !!assign
    };
  });

  const filteredFields = filterCommodity
    ? fieldsWithPlans.filter(f => f.commodity_id === filterCommodity)
    : fieldsWithPlans;

  const uniqueCommodities = [...new Set(myFields.map(f => f.commodity_id))];
  const unassignedFields = fieldsWithPlans.filter(f => !f.hasPlan);

  // Calculate plan cost per acre considering overrides
  const getPlanCost = (f) => {
    if (!f.plan) return 0;
    let cost = calculateCropPlanCost(f.plan);
    // Apply seed override if present
    if (f.assignment?.seed_override_price && f.assignment?.seed_override_rate && f.plan.seed?.seeds_per_bag) {
      const planSeedCost = f.plan.seed?.price_per_bag && f.plan.seed?.default_seeding_rate
        ? (f.plan.seed.default_seeding_rate / f.plan.seed.seeds_per_bag) * f.plan.seed.price_per_bag
        : 0;
      const overrideSeedCost = (f.assignment.seed_override_rate / f.plan.seed.seeds_per_bag) * f.assignment.seed_override_price;
      cost = cost - planSeedCost + overrideSeedCost;
    }
    return cost;
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Field Applications</h1>
          <p className="text-sm text-gray-500">Apply crop plans and seed products to fields for {cropYear}</p>
        </div>
        <div className="flex gap-3">
          {unassignedFields.length > 0 && (
            <button onClick={() => setShowBulkModal(true)} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
              <Icon name="layers" size={18} /> Bulk Assign ({unassignedFields.length})
            </button>
          )}
          <select value={filterCommodity} onChange={(e) => setFilterCommodity(e.target.value)} className="px-4 py-2 border rounded-lg">
            <option value="">All Commodities</option>
            {commodities.filter(c => uniqueCommodities.includes(c.id)).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
          </select>
          <select value={cropYear} onChange={(e) => onYearChange(parseInt(e.target.value))} className="px-4 py-2 border rounded-lg">
            {cropYears.map(y => <option key={y} value={y}>{y} Crop Year</option>)}
          </select>
        </div>
      </div>

      {/* Summary cards */}
      <div className="grid grid-cols-3 gap-4">
        <div className="bg-white rounded-xl p-4 shadow-sm border">
          <div className="text-sm text-gray-500">Total Fields</div>
          <div className="text-2xl font-bold">{myFields.length}</div>
          <div className="text-xs text-gray-400 mt-1">{formatNumber(myFields.reduce((sum, f) => sum + (f.planted_acres || 0), 0))} acres</div>
        </div>
        <div className="bg-white rounded-xl p-4 shadow-sm border">
          <div className="text-sm text-gray-500">Plans Assigned</div>
          <div className="text-2xl font-bold text-green-600">{fieldsWithPlans.filter(f => f.hasPlan).length}</div>
          <div className="text-xs text-gray-400 mt-1">{formatNumber(fieldsWithPlans.filter(f => f.hasPlan).reduce((sum, f) => sum + (f.planted_acres || 0), 0))} acres</div>
        </div>
        <div className="bg-white rounded-xl p-4 shadow-sm border">
          <div className="text-sm text-gray-500">Needs Assignment</div>
          <div className="text-2xl font-bold text-amber-600">{unassignedFields.length}</div>
          <div className="text-xs text-gray-400 mt-1">{formatNumber(unassignedFields.reduce((sum, f) => sum + (f.planted_acres || 0), 0))} acres</div>
        </div>
      </div>

      <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
        <div className="p-4 border-b">
          <h2 className="font-semibold">Field Crop Plan Assignments</h2>
        </div>
        {loading ? (
          <div className="p-8 text-center"><Icon name="loader" className="animate-spin text-blue-600 mx-auto" size={32} /></div>
        ) : (
          <table className="w-full text-sm">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left">Field</th>
                <th className="px-4 py-3 text-left">Crop</th>
                <th className="px-4 py-3 text-right">Acres</th>
                <th className="px-4 py-3 text-left">Your Share</th>
                <th className="px-4 py-3 text-left">Crop Plan</th>
                <th className="px-4 py-3 text-left">Seed Override</th>
                <th className="px-4 py-3 text-right">Est. Cost</th>
                <th className="px-4 py-3 text-center">Actions</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {filteredFields.length === 0 ? (
                <tr><td colSpan={8} className="px-4 py-8 text-center text-gray-500">No fields for {cropYear}. Add production in GrainTrack first.</td></tr>
              ) : filteredFields.map(f => {
                const effectiveShare = f.effective_share ?? (f.tenant_share ?? 1);
                const planCost = getPlanCost(f);
                return (
                  <tr key={f.id} className={`hover:bg-gray-50 ${!f.hasPlan ? 'bg-amber-50' : ''}`}>
                    <td className="px-4 py-3">
                      <div className="font-medium">{f.field_name}</div>
                      <div className="text-xs text-gray-500">{f.farm_name}</div>
                    </td>
                    <td className="px-4 py-3">
                      <span className="px-2 py-0.5 bg-gray-100 rounded text-xs">{f.commodity_name}</span>
                    </td>
                    <td className="px-4 py-3 text-right">{formatNumber(f.planted_acres)}</td>
                    <td className="px-4 py-3">
                      {effectiveShare < 1 ? (
                        <span className={`px-2 py-0.5 rounded text-xs ${effectiveShare < 0.5 ? 'bg-orange-100 text-orange-800' : 'bg-purple-100 text-purple-800'}`}>
                          {(effectiveShare * 100).toFixed(0)}%
                        </span>
                      ) : (
                        <span className="text-gray-400 text-xs">100%</span>
                      )}
                    </td>
                    <td className="px-4 py-3">
                      {f.plan ? (
                        <span className="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs">{f.plan.name}</span>
                      ) : (
                        <span className="text-amber-600 text-xs font-medium">No plan assigned</span>
                      )}
                    </td>
                    <td className="px-4 py-3">
                      {f.assignment?.seed_override_hybrid ? (
                        <span className="text-xs text-gray-600">{f.assignment.seed_override_hybrid}</span>
                      ) : (
                        <span className="text-gray-400 text-xs">-</span>
                      )}
                    </td>
                    <td className="px-4 py-3 text-right font-medium">
                      {planCost > 0 ? formatCurrency(planCost) + '/ac' : '-'}
                    </td>
                    <td className="px-4 py-3 text-center">
                      <button onClick={() => { setSelectedField(f); setShowModal(true); }}
                        className={`px-3 py-1 rounded text-sm ${f.hasPlan ? 'bg-gray-100 hover:bg-gray-200' : 'bg-blue-600 text-white hover:bg-blue-700'}`}>
                        {f.hasPlan ? 'Edit' : 'Assign'}
                      </button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        )}
      </div>

      {showModal && selectedField && (
        <FieldAssignmentModal
          fieldCropYear={selectedField}
          existingAssignment={selectedField.assignment}
          cropPlans={cropPlans}
          onClose={() => setShowModal(false)}
          onSave={() => { setShowModal(false); loadData(); }}
        />
      )}

      {showBulkModal && (
        <BulkAssignModal
          fields={unassignedFields}
          cropPlans={cropPlans}
          commodities={commodities}
          onClose={() => setShowBulkModal(false)}
          onSave={() => { setShowBulkModal(false); loadData(); }}
        />
      )}
    </div>
  );
}

// Field Assignment Modal - assign crop plan with seed overrides
function FieldAssignmentModal({ fieldCropYear, existingAssignment, cropPlans, onClose, onSave }) {
  const [form, setForm] = useState({
    crop_plan_id: existingAssignment?.crop_plan_id || '',
    seed_override_brand: existingAssignment?.seed_override_brand || '',
    seed_override_hybrid: existingAssignment?.seed_override_hybrid || '',
    seed_override_rate: existingAssignment?.seed_override_rate || '',
    seed_override_price: existingAssignment?.seed_override_price || '',
    status: existingAssignment?.status || 'PLANNED',
    notes: existingAssignment?.notes || ''
  });
  const [saving, setSaving] = useState(false);
  const { addToast } = useToast();

  // Filter plans by commodity and practice
  const compatiblePlans = cropPlans.filter(p =>
    (!p.commodity_id || p.commodity_id === fieldCropYear.commodity_id)
  );

  const selectedPlan = cropPlans.find(p => p.id === form.crop_plan_id);
  const planSeed = selectedPlan?.seed;

  const handleSave = async () => {
    if (!form.crop_plan_id) {
      addToast('Please select a crop plan', { type: 'error' });
      return;
    }
    setSaving(true);
    try {
      await saveFieldPlanAssignment({
        id: existingAssignment?.id,
        field_crop_year_id: fieldCropYear.id,
        ...form
      });
      addToast('Assignment saved', { type: 'success' });
      onSave();
    } catch (e) {
      addToast('Failed to save: ' + e.message, { type: 'error' });
    }
    setSaving(false);
  };

  const handleDelete = async () => {
    if (!existingAssignment?.id) return;
    setSaving(true);
    try {
      await deleteFieldPlanAssignment(existingAssignment.id);
      addToast('Assignment removed', { type: 'success' });
      onSave();
    } catch (e) {
      addToast('Failed to delete: ' + e.message, { type: 'error' });
    }
    setSaving(false);
  };

  return (
    <Modal isOpen={true} onClose={onClose} title={`Assign Plan: ${fieldCropYear.field_name}`} size="lg">
      <div className="space-y-6">
        <div className="bg-gray-50 rounded-lg p-4">
          <div className="grid grid-cols-4 gap-4 text-sm">
            <div><span className="text-gray-500">Field:</span> <span className="font-medium">{fieldCropYear.field_name}</span></div>
            <div><span className="text-gray-500">Farm:</span> <span className="font-medium">{fieldCropYear.farm_name}</span></div>
            <div><span className="text-gray-500">Crop:</span> <span className="font-medium">{fieldCropYear.commodity_name}</span></div>
            <div><span className="text-gray-500">Acres:</span> <span className="font-medium">{formatNumber(fieldCropYear.planted_acres)}</span></div>
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">Crop Plan *</label>
          <select value={form.crop_plan_id} onChange={(e) => setForm(f => ({ ...f, crop_plan_id: e.target.value }))} className="w-full px-3 py-2 border rounded-lg">
            <option value="">Select a crop plan...</option>
            {compatiblePlans.map(p => (
              <option key={p.id} value={p.id}>
                {p.name} - {formatCurrency(calculateCropPlanCost(p))}/ac
              </option>
            ))}
          </select>
          {compatiblePlans.length === 0 && (
            <p className="text-sm text-amber-600 mt-1">No plans available for {fieldCropYear.commodity_name}. Create one in Crop Plans first.</p>
          )}
        </div>

        {selectedPlan && (
          <>
            <div className="border rounded-lg p-4">
              <h4 className="font-medium mb-3 flex items-center gap-2">
                <Icon name="package" size={18} className="text-green-600" />
                Seed Override
                <span className="text-xs text-gray-500 font-normal ml-2">(Leave blank to use plan defaults)</span>
              </h4>
              {planSeed && (
                <p className="text-sm text-gray-500 mb-3">
                  Plan default: {planSeed.brand} {planSeed.hybrid} @ {formatNumber(planSeed.default_seeding_rate)} seeds/ac, {formatCurrency(planSeed.price_per_bag)}/bag
                </p>
              )}
              <div className="grid grid-cols-4 gap-4">
                <div>
                  <label className="block text-xs font-medium mb-1">Brand</label>
                  <input type="text" value={form.seed_override_brand} onChange={(e) => setForm(f => ({ ...f, seed_override_brand: e.target.value }))}
                    className="w-full px-3 py-2 border rounded-lg" placeholder={planSeed?.brand || 'Brand'} />
                </div>
                <div>
                  <label className="block text-xs font-medium mb-1">Hybrid/Variety</label>
                  <input type="text" value={form.seed_override_hybrid} onChange={(e) => setForm(f => ({ ...f, seed_override_hybrid: e.target.value }))}
                    className="w-full px-3 py-2 border rounded-lg" placeholder={planSeed?.hybrid || 'Hybrid'} />
                </div>
                <div>
                  <label className="block text-xs font-medium mb-1">Rate (seeds/ac)</label>
                  <input type="number" value={form.seed_override_rate} onChange={(e) => setForm(f => ({ ...f, seed_override_rate: e.target.value ? parseInt(e.target.value) : '' }))}
                    className="w-full px-3 py-2 border rounded-lg" placeholder={planSeed?.default_seeding_rate || '34000'} />
                </div>
                <div>
                  <label className="block text-xs font-medium mb-1">Price/Bag ($)</label>
                  <input type="number" step="0.01" value={form.seed_override_price} onChange={(e) => setForm(f => ({ ...f, seed_override_price: e.target.value ? parseFloat(e.target.value) : '' }))}
                    className="w-full px-3 py-2 border rounded-lg" placeholder={planSeed?.price_per_bag || '350'} />
                </div>
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium mb-1">Status</label>
                <select value={form.status} onChange={(e) => setForm(f => ({ ...f, status: e.target.value }))} className="w-full px-3 py-2 border rounded-lg">
                  <option value="PLANNED">Planned</option>
                  <option value="IN_PROGRESS">In Progress</option>
                  <option value="COMPLETED">Completed</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Notes</label>
                <input type="text" value={form.notes} onChange={(e) => setForm(f => ({ ...f, notes: e.target.value }))}
                  className="w-full px-3 py-2 border rounded-lg" placeholder="Optional notes..." />
              </div>
            </div>
          </>
        )}

        <div className="flex justify-between pt-4 border-t">
          <div>
            {existingAssignment && (
              <button onClick={handleDelete} disabled={saving} className="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg">
                Remove Assignment
              </button>
            )}
          </div>
          <div className="flex gap-3">
            <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
            <button onClick={handleSave} disabled={saving || !form.crop_plan_id} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
              {saving ? 'Saving...' : 'Save Assignment'}
            </button>
          </div>
        </div>
      </div>
    </Modal>
  );
}

// Bulk Assignment Modal
function BulkAssignModal({ fields, cropPlans, commodities, onClose, onSave }) {
  const [filterCommodity, setFilterCommodity] = useState('');
  const [selectedPlanId, setSelectedPlanId] = useState('');
  const [selectedFields, setSelectedFields] = useState([]);
  const [saving, setSaving] = useState(false);
  const { addToast } = useToast();

  const filteredFields = filterCommodity
    ? fields.filter(f => f.commodity_id === filterCommodity)
    : fields;

  const compatiblePlans = filterCommodity
    ? cropPlans.filter(p => !p.commodity_id || p.commodity_id === filterCommodity)
    : cropPlans;

  const toggleField = (id) => {
    setSelectedFields(prev =>
      prev.includes(id) ? prev.filter(f => f !== id) : [...prev, id]
    );
  };

  const selectAll = () => {
    setSelectedFields(filteredFields.map(f => f.id));
  };

  const handleAssign = async () => {
    if (!selectedPlanId || selectedFields.length === 0) {
      addToast('Select a plan and at least one field', { type: 'error' });
      return;
    }
    setSaving(true);
    try {
      await bulkAssignCropPlan(selectedFields, selectedPlanId);
      addToast(`Assigned plan to ${selectedFields.length} fields`, { type: 'success' });
      onSave();
    } catch (e) {
      addToast('Failed: ' + e.message, { type: 'error' });
    }
    setSaving(false);
  };

  return (
    <Modal isOpen={true} onClose={onClose} title="Bulk Assign Crop Plan" size="xl">
      <div className="space-y-4">
        <div className="flex gap-4">
          <div className="flex-1">
            <label className="block text-sm font-medium mb-1">Filter by Commodity</label>
            <select value={filterCommodity} onChange={(e) => { setFilterCommodity(e.target.value); setSelectedFields([]); setSelectedPlanId(''); }}
              className="w-full px-3 py-2 border rounded-lg">
              <option value="">All Commodities</option>
              {commodities.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
            </select>
          </div>
          <div className="flex-1">
            <label className="block text-sm font-medium mb-1">Crop Plan to Assign</label>
            <select value={selectedPlanId} onChange={(e) => setSelectedPlanId(e.target.value)}
              className="w-full px-3 py-2 border rounded-lg">
              <option value="">Select a plan...</option>
              {compatiblePlans.map(p => (
                <option key={p.id} value={p.id}>{p.name} - {formatCurrency(calculateCropPlanCost(p))}/ac</option>
              ))}
            </select>
          </div>
        </div>

        <div className="border rounded-lg max-h-64 overflow-y-auto">
          <div className="sticky top-0 bg-gray-50 px-4 py-2 border-b flex items-center justify-between">
            <span className="text-sm font-medium">{filteredFields.length} fields available</span>
            <button onClick={selectAll} className="text-sm text-blue-600 hover:underline">Select All</button>
          </div>
          <div className="divide-y">
            {filteredFields.map(f => (
              <label key={f.id} className="flex items-center gap-3 px-4 py-2 hover:bg-gray-50 cursor-pointer">
                <input type="checkbox" checked={selectedFields.includes(f.id)} onChange={() => toggleField(f.id)}
                  className="w-4 h-4 text-blue-600 rounded" />
                <div className="flex-1">
                  <span className="font-medium">{f.field_name}</span>
                  <span className="text-gray-500 ml-2">{f.farm_name}</span>
                </div>
                <span className="text-sm text-gray-500">{f.commodity_name}</span>
                <span className="text-sm text-gray-500">{formatNumber(f.planted_acres)} ac</span>
              </label>
            ))}
          </div>
        </div>

        <div className="flex justify-between pt-4 border-t">
          <div className="text-sm text-gray-500">
            {selectedFields.length} fields selected
          </div>
          <div className="flex gap-3">
            <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
            <button onClick={handleAssign} disabled={saving || !selectedPlanId || selectedFields.length === 0}
              className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50">
              {saving ? 'Assigning...' : `Assign to ${selectedFields.length} Fields`}
            </button>
          </div>
        </div>
      </div>
    </Modal>
  );
}

// Legacy FieldPlanModal for backwards compatibility (remove after migration)
function FieldPlanModal({ fieldCropYear, existingPlan, fertPlans, herbPlans, onClose, onSave }) {
  const [form, setForm] = useState({
    fertilizer_plan_id: existingPlan?.fertilizer_plan_id || '',
    fertilizer_plan_override: existingPlan?.fertilizer_plan_override || '',
    herbicide_cost_override: existingPlan?.herbicide_cost_override || '',
    notes: existingPlan?.notes || ''
  });
  const [herbPasses, setHerbPasses] = useState(
    existingPlan?.herbicide_passes?.map(p => ({
      herbicide_plan_id: p.herbicide_plan_id,
      pass_name: p.pass_name || ''
    })) || []
  );
  const [saving, setSaving] = useState(false);
  const { addToast } = useToast();

  const commodityHerbPlans = herbPlans.filter(p => !p.commodity_id || p.commodity_id === fieldCropYear.commodity_id);
  const commodityFertPlans = fertPlans.filter(p => !p.commodity_id || p.commodity_id === fieldCropYear.commodity_id);

  const addHerbPass = () => {
    setHerbPasses([...herbPasses, { herbicide_plan_id: '', pass_name: '' }]);
  };

  const removeHerbPass = (index) => {
    setHerbPasses(herbPasses.filter((_, i) => i !== index));
  };

  const updateHerbPass = (index, field, value) => {
    const updated = [...herbPasses];
    updated[index] = { ...updated[index], [field]: value };
    setHerbPasses(updated);
  };

  const handleSave = async () => {
    setSaving(true);
    try {
      const planData = {
        id: existingPlan?.id,
        field_crop_year_id: fieldCropYear.id,
        fertilizer_plan_id: form.fertilizer_plan_id || null,
        fertilizer_plan_override: form.fertilizer_plan_override || null,
        herbicide_cost_override: form.herbicide_cost_override || null,
        notes: form.notes
      };
      const savedPlan = await saveFieldCropPlan(planData);

      // Save herbicide passes
      const validPasses = herbPasses.filter(p => p.herbicide_plan_id);
      if (validPasses.length > 0 || existingPlan?.herbicide_passes?.length > 0) {
        await saveHerbicidePasses(savedPlan.id || existingPlan.id, validPasses);
      }

      addToast('Field plan saved', { type: 'success' });
      onSave();
    } catch (e) {
      addToast('Failed to save: ' + e.message, { type: 'error' });
    }
    setSaving(false);
  };

  return (
    <Modal isOpen={true} onClose={onClose} title={`${fieldCropYear.field_name} - ${fieldCropYear.commodity_name}`} size="lg">
      <div className="space-y-6">
        <div className="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
          <div><span className="text-gray-500">Farm:</span> {fieldCropYear.farm_name}</div>
          <div><span className="text-gray-500">Acres:</span> {formatNumber(fieldCropYear.planted_acres)}</div>
        </div>

        <div>
          <h3 className="font-medium mb-3 flex items-center gap-2"><Icon name="flask-conical" size={18} className="text-green-600" /> Fertilizer</h3>
          <div className="space-y-3">
            <div>
              <label className="block text-sm font-medium mb-1">Fertilizer Plan</label>
              <select value={form.fertilizer_plan_id} onChange={(e) => setForm(f => ({ ...f, fertilizer_plan_id: e.target.value }))} className="w-full px-3 py-2 border rounded-lg">
                <option value="">Select plan or use override</option>
                {commodityFertPlans.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Or Cost Override ($/ac)</label>
              <input type="number" step="0.01" value={form.fertilizer_plan_override} onChange={(e) => setForm(f => ({ ...f, fertilizer_plan_override: e.target.value }))}
                className="w-full px-3 py-2 border rounded-lg" placeholder="Override planned cost" disabled={!!form.fertilizer_plan_id} />
              <p className="text-xs text-gray-500 mt-1">All fertilizer costs are split with landlord at their grain share %</p>
            </div>
          </div>
        </div>

        <div>
          <h3 className="font-medium mb-3 flex items-center gap-2"><Icon name="spray-can" size={18} className="text-purple-600" /> Herbicide Passes</h3>
          <div className="space-y-3">
            {herbPasses.map((pass, i) => (
              <div key={i} className="flex gap-3 items-center">
                <input type="text" value={pass.pass_name} onChange={(e) => updateHerbPass(i, 'pass_name', e.target.value)}
                  className="w-32 px-3 py-2 border rounded-lg" placeholder="Pass name" />
                <select value={pass.herbicide_plan_id} onChange={(e) => updateHerbPass(i, 'herbicide_plan_id', e.target.value)} className="flex-1 px-3 py-2 border rounded-lg">
                  <option value="">Select herbicide plan</option>
                  {commodityHerbPlans.map(p => <option key={p.id} value={p.id}>{p.name} - {formatCurrency(p.estimated_cost_per_acre)}/ac</option>)}
                </select>
                <button onClick={() => removeHerbPass(i)} className="p-2 text-red-600 hover:bg-red-50 rounded"><Icon name="trash-2" size={16} /></button>
              </div>
            ))}
            <button onClick={addHerbPass} className="flex items-center gap-2 px-3 py-2 text-blue-600 hover:bg-blue-50 rounded-lg text-sm">
              <Icon name="plus" size={16} /> Add Herbicide Pass
            </button>
            <div>
              <label className="block text-sm font-medium mb-1">Or Cost Override ($/ac)</label>
              <input type="number" step="0.01" value={form.herbicide_cost_override} onChange={(e) => setForm(f => ({ ...f, herbicide_cost_override: e.target.value }))}
                className="w-full px-3 py-2 border rounded-lg" placeholder="Override planned cost" disabled={herbPasses.length > 0} />
              <p className="text-xs text-gray-500 mt-1">Chemical costs split with landlord IF split toggle is on in Spray-Suite</p>
            </div>
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">Notes</label>
          <textarea value={form.notes} onChange={(e) => setForm(f => ({ ...f, notes: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" rows={2} />
        </div>

        <div className="flex justify-end gap-3 pt-4 border-t">
          <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
          <button onClick={handleSave} disabled={saving} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
            {saving ? 'Saving...' : 'Save Plan'}
          </button>
        </div>
      </div>
    </Modal>
  );
}

// ============================================================================
// BREAKEVEN PAGE
// ============================================================================
function BreakevenPage({ cropYear, onYearChange }) {
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [viewMode, setViewMode] = useState('tenant'); // 'tenant' or 'total'
  const [filters, setFilters] = useState({
    farm: '',
    commodity: '',
    practiceType: '',
    landlord: '',
    fields: [],
    costView: 'actual' // 'actual' or 'planned' for herbicide costs
  });
  const currentYear = new Date().getFullYear();
  const cropYears = [currentYear - 1, currentYear, currentYear + 1];

  useEffect(() => {
    async function load() {
      setLoading(true);
      const [fcys, expenses, seeds, rents, fertCosts, herbActual, herbPlanned] = await Promise.all([
        getFieldCropYears(cropYear),
        getOverheadExpenses(cropYear),
        getSeedCosts(cropYear),
        getLandRent(cropYear),
        getFertilizerCostsDetailed(cropYear),
        getHerbicideCosts(cropYear),
        getPlannedHerbicideCosts(cropYear)
      ]);

      const overheadAlloc = allocateOverhead(expenses, fcys);
      const seedMap = {};
      seeds.forEach(s => { seedMap[s.field_crop_year_id] = s.total_cost || calculateSeedCost({ ...s, planted_acres: s.planted_acres }); });

      // Build rent map with rent type (CASH, SHARE, OWNED)
      const rentMap = {};
      rents.forEach(r => {
        rentMap[r.field_id] = {
          rentPerAcre: r.rent_per_acre || 0,
          rentType: r.rent_type || 'OWNED'
        };
      });

      const results = fcys.map(fcy => {
        // Tenant share comes from fields table (e.g., 0.5 = 50% tenant, 50% landlord)
        // For BFP fields, effective_share includes adams_grain_share (partnership split)
        const tenantShareBase = fcy.tenant_share || 1;
        const effectiveShare = fcy.effective_share || tenantShareBase;
        const tenantShare = tenantShareBase;
        const landlordShare = 1 - tenantShare;

        // Calculate adams_grain_share (BFP partnership split)
        const adamsGrainShare = tenantShareBase > 0 ? effectiveShare / tenantShareBase : 1;

        // Overhead already allocated by effective acres, no additional multiplication needed
        const overhead = overheadAlloc[fcy.id] || 0;
        const seed = (seedMap[fcy.id] || 0) * adamsGrainShare;
        const rentInfo = rentMap[fcy.field_id] || { rentPerAcre: 0, rentType: 'OWNED' };
        const rent = (rentInfo.rentPerAcre * (fcy.planted_acres || 0)) * adamsGrainShare;
        const rentType = rentInfo.rentType;

        // Has landlord = tenant_share < 1 (regardless of rent_type record)
        const hasLandlordSplit = landlordShare > 0;

        // Rent type determines if it's share crop vs cash rent
        // But if tenant_share < 1, there IS a landlord split
        const isShareCrop = hasLandlordSplit && (rentType === 'SHARE' || rentType === 'OWNED');
        // Note: If tenant_share < 1 but no be_land_rent record, treat as share crop

        // Get fertilizer costs (always split when there's a landlord)
        const fertData = fertCosts[fcy.field_id] || { total: 0, splitCost: 0 };
        const fertTotal = fertData.total;

        // Get herbicide costs based on cost view filter
        const herbCosts_source = filters.costView === 'planned' ? herbPlanned : herbActual;
        const herbData = herbCosts_source[fcy.field_id] || { total: 0, splitCost: 0, nonSplitCost: 0 };
        const herbTotal = herbData.total;
        const herbSplitCost = herbData.splitCost;      // Products marked 'shared' on products table
        const herbNonSplitCost = herbData.nonSplitCost; // Burndowns, etc. (100% tenant)

        // Calculate tenant's portion:
        // - If landlord split exists: split costs at tenant_share %
        // - CASH RENT with 100% tenant_share: no split
        let fertTenant, fertLandlord, herbTenant, herbLandlord;

        if (hasLandlordSplit) {
          // SHARE CROP or any field with tenant_share < 1
          // Fertilizer: ALWAYS split at tenant_share
          fertTenant = fertTotal * tenantShare;
          fertLandlord = fertTotal * landlordShare;

          // Herbicide: Only split products marked 'shared' on products table
          // Non-shared products (burndowns) = 100% tenant
          herbTenant = (herbSplitCost * tenantShare) + herbNonSplitCost;
          herbLandlord = herbSplitCost * landlordShare;
        } else {
          // No landlord split (100% tenant_share) - tenant pays all
          fertTenant = fertTotal;
          fertLandlord = 0;
          herbTenant = herbTotal;
          herbLandlord = 0;
        }

        // Apply BFP partnership split (adams_grain_share) to tenant costs
        // Overhead already allocated correctly by effective acres, don't multiply again
        // Seed and rent already multiplied above
        // Apply to fertilizer and herbicide
        fertTenant = fertTenant * adamsGrainShare;
        herbTenant = herbTenant * adamsGrainShare;

        const totalAll = overhead + (seed / adamsGrainShare) + (rent / adamsGrainShare) + fertTotal + herbTotal;
        const totalTenant = overhead + seed + rent + fertTenant + herbTenant;
        const totalLandlord = fertLandlord + herbLandlord;

        // Bushels: Apply effective share (includes BFP partnership split)
        const bushelsAll = fcy.actual_production || ((fcy.planted_acres || 0) * (fcy.estimated_yield || 0));
        const bushelsTenant = bushelsAll * effectiveShare;

        // Breakeven: Total tenant costs / Tenant bushels
        const breakevenAll = bushelsAll > 0 ? totalAll / bushelsAll : null;
        const breakevenTenant = bushelsTenant > 0 ? totalTenant / bushelsTenant : null;
        const costPerAcreAll = fcy.planted_acres > 0 ? totalAll / fcy.planted_acres : 0;
        const costPerAcreTenant = fcy.planted_acres > 0 ? totalTenant / fcy.planted_acres : 0;

        return {
          ...fcy,
          overhead,
          seed,
          rent,
          rentType,
          isShareCrop: hasLandlordSplit,
          fertTotal,
          fertTenant,
          fertLandlord,
          herbTotal,
          herbSplitCost,
          herbNonSplitCost,
          herbTenant,
          herbLandlord,
          totalAll,
          totalTenant,
          totalLandlord,
          bushelsAll,
          bushelsTenant,
          breakevenAll,
          breakevenTenant,
          costPerAcreAll,
          costPerAcreTenant,
          hasLandlord: hasLandlordSplit
        };
      });

      setData(results);
      setLoading(false);
    }
    load();
  }, [cropYear]);

  const exportCSV = () => {
    const headers = ['Field', 'Farm', 'Commodity', 'Acres', 'Rent Type', 'Landlord', 'Split %', 'Overhead', 'Seed', 'Rent', 'Fertilizer', 'Herbicide', 'Total Cost', 'Bushels', 'Breakeven'];
    const rows = data.map(d => {
      const fert = viewMode === 'tenant' ? d.fertTenant : d.fertTotal;
      const herb = viewMode === 'tenant' ? d.herbTenant : d.herbTotal;
      const total = viewMode === 'tenant' ? d.totalTenant : d.totalAll;
      const bushels = viewMode === 'tenant' ? d.bushelsTenant : d.bushelsAll;
      const breakeven = viewMode === 'tenant' ? d.breakevenTenant : d.breakevenAll;
      return [d.field_name, d.farm_name, d.commodity_name, d.planted_acres, d.rentType, d.landlord || '', d.hasLandlord ? ((1 - d.tenant_share) * 100).toFixed(0) + '%' : '', d.overhead.toFixed(2), d.seed.toFixed(2), d.rent.toFixed(2), fert.toFixed(2), herb.toFixed(2), total.toFixed(2), bushels.toFixed(0), breakeven?.toFixed(4) || ''];
    });
    const csv = [headers, ...rows].map(r => r.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `breakeven-${viewMode}-${cropYear}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  if (loading) return <div className="flex items-center justify-center h-64"><Icon name="loader" className="animate-spin text-blue-600" size={32} /></div>;

  // Build filter options - memoize to prevent re-renders
  const uniqueFarms = useMemo(() =>
    [...new Map(data.map(d => [d.farm_id, { id: d.farm_id, name: d.farm_name }])).values()],
    [data]
  );

  const uniqueCommodities = useMemo(() =>
    [...new Map(data.map(d => [d.commodity_id, { id: d.commodity_id, name: d.commodity_name }])).values()],
    [data]
  );

  const filteredLandlords = useMemo(() =>
    filters.farm
      ? [...new Map(data.filter(d => d.farm_id === filters.farm && d.landlord).map(d => [d.landlord, { id: d.landlord, name: d.landlord_name || d.landlord }])).values()]
      : [],
    [data, filters.farm]
  );

  // Apply filters to data
  const filteredData = useMemo(() => {
    let result = data;

    if (filters.farm) {
      result = result.filter(d => d.farm_id === filters.farm);
    }

    if (filters.commodity) {
      result = result.filter(d => d.commodity_id === filters.commodity);
    }

    if (filters.practiceType) {
      if (filters.practiceType === 'IR') {
        result = result.filter(d => d.is_irrigated);
      } else if (filters.practiceType === 'DL') {
        result = result.filter(d => !d.is_irrigated);
      }
    }

    if (filters.landlord) {
      result = result.filter(d => d.landlord === filters.landlord);
    }

    if (filters.fields && filters.fields.length > 0) {
      result = result.filter(d => filters.fields.includes(d.field_id));
    }

    return result;
  }, [data, filters.farm, filters.commodity, filters.practiceType, filters.landlord, JSON.stringify(filters.fields)]);

  const hasAnyLandlord = data.some(d => d.hasLandlord);

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Breakeven Analysis</h1>
          <p className="text-sm text-gray-500">Per-field cost breakdown and breakeven prices</p>
        </div>
        <div className="flex gap-3">
          {hasAnyLandlord && (
            <div className="flex items-center bg-gray-100 rounded-lg p-1">
              <button onClick={() => setViewMode('tenant')} className={`px-3 py-1.5 rounded text-sm font-medium ${viewMode === 'tenant' ? 'bg-white shadow text-blue-600' : 'text-gray-600'}`}>
                Tenant Share
              </button>
              <button onClick={() => setViewMode('total')} className={`px-3 py-1.5 rounded text-sm font-medium ${viewMode === 'total' ? 'bg-white shadow text-blue-600' : 'text-gray-600'}`}>
                Total Costs
              </button>
            </div>
          )}
          <select value={cropYear} onChange={(e) => onYearChange(parseInt(e.target.value))} className="px-4 py-2 border rounded-lg">
            {cropYears.map(y => <option key={y} value={y}>{y} Crop Year</option>)}
          </select>
          <button onClick={exportCSV} className="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
            <Icon name="download" size={18} /> Export CSV
          </button>
        </div>
      </div>

      {/* Filters Section */}
      <div className="bg-white rounded-xl shadow-sm border p-4">
        <div className="grid grid-cols-2 md:grid-cols-6 gap-4">
          {/* Farm Filter */}
          <div>
            <label className="block text-sm font-medium mb-1">Farm</label>
            <select
              value={filters.farm}
              onChange={(e) => {
                const newFarmId = e.target.value;
                setFilters(f => ({ ...f, farm: newFarmId, landlord: '', fields: [] }));
              }}
              className="w-full px-3 py-2 border rounded-lg text-sm"
            >
              <option value="">All Farms</option>
              {uniqueFarms.map(farm => (
                <option key={farm.id} value={farm.id}>{farm.name}</option>
              ))}
            </select>
          </div>

          {/* Commodity Filter */}
          <div>
            <label className="block text-sm font-medium mb-1">Commodity</label>
            <select
              value={filters.commodity}
              onChange={(e) => setFilters(f => ({ ...f, commodity: e.target.value }))}
              className="w-full px-3 py-2 border rounded-lg text-sm"
            >
              <option value="">All Crops</option>
              {uniqueCommodities.map(c => (
                <option key={c.id} value={c.id}>{c.name}</option>
              ))}
            </select>
          </div>

          {/* Practice Type Filter */}
          <div>
            <label className="block text-sm font-medium mb-1">Practice</label>
            <select
              value={filters.practiceType}
              onChange={(e) => setFilters(f => ({ ...f, practiceType: e.target.value }))}
              className="w-full px-3 py-2 border rounded-lg text-sm"
            >
              <option value="">All</option>
              <option value="IR">Irrigated</option>
              <option value="DL">Dryland</option>
            </select>
          </div>

          {/* Landlord Filter */}
          <div>
            <label className="block text-sm font-medium mb-1">Landlord</label>
            <select
              value={filters.landlord}
              onChange={(e) => setFilters(f => ({ ...f, landlord: e.target.value, fields: [] }))}
              className="w-full px-3 py-2 border rounded-lg text-sm"
              disabled={!filters.farm}
            >
              <option value="">All Landlords</option>
              {filteredLandlords.map(l => (
                <option key={l.id} value={l.id}>{l.name}</option>
              ))}
            </select>
          </div>

          {/* Cost View Toggle - Herbicide Actual vs Planned */}
          <div>
            <label className="block text-sm font-medium mb-1">Herbicide Costs</label>
            <div className="flex rounded-lg border overflow-hidden">
              <button
                onClick={() => setFilters(f => ({ ...f, costView: 'actual' }))}
                className={`flex-1 px-3 py-2 text-sm ${
                  filters.costView === 'actual'
                    ? 'bg-green-600 text-white'
                    : 'bg-white text-gray-600 hover:bg-gray-50'
                }`}
              >
                Actual
              </button>
              <button
                onClick={() => setFilters(f => ({ ...f, costView: 'planned' }))}
                className={`flex-1 px-3 py-2 text-sm ${
                  filters.costView === 'planned'
                    ? 'bg-amber-600 text-white'
                    : 'bg-white text-gray-600 hover:bg-gray-50'
                }`}
              >
                Planned
              </button>
            </div>
          </div>

          {/* Clear Filters Button */}
          {(filters.farm || filters.commodity || filters.practiceType || filters.landlord) && (
            <div className="flex items-end">
              <button
                onClick={() => setFilters({
                  farm: '', commodity: '', practiceType: '', landlord: '', fields: [], costView: filters.costView
                })}
                className="w-full px-3 py-2 text-sm text-gray-600 hover:bg-gray-50 border rounded-lg"
              >
                Clear Filters
              </button>
            </div>
          )}
        </div>
      </div>

      {viewMode === 'tenant' && hasAnyLandlord && (
        <div className="bg-purple-50 border border-purple-200 rounded-lg p-4 text-sm text-purple-800">
          <strong>Tenant Share View:</strong> Shows YOUR costs and YOUR bushels.
          <ul className="mt-2 ml-4 list-disc space-y-1">
            <li><strong>Share Crop:</strong> Fertilizer always split. Herbicide split only for products marked "split with landlord" (in-crop, at-planting residuals). Burndowns = 100% tenant.</li>
            <li><strong>Cash Rent / Owned:</strong> 100% tenant pays all costs, receives all bushels.</li>
            <li><strong>Overhead, Seed, Rent:</strong> Always 100% tenant responsibility.</li>
          </ul>
        </div>
      )}

      <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left">Field</th>
                <th className="px-4 py-3 text-left">Commodity</th>
                <th className="px-4 py-3 text-right">Acres</th>
                <th className="px-4 py-3 text-right">Overhead</th>
                <th className="px-4 py-3 text-right">Seed</th>
                <th className="px-4 py-3 text-right">Rent</th>
                <th className="px-4 py-3 text-right">Fertilizer</th>
                <th className="px-4 py-3 text-right">Herbicide</th>
                <th className="px-4 py-3 text-right font-semibold">Total</th>
                <th className="px-4 py-3 text-right">$/Acre</th>
                <th className="px-4 py-3 text-right font-semibold">Breakeven</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {filteredData.length === 0 ? (
                <tr><td colSpan={11} className="px-4 py-8 text-center text-gray-500">No field data for {cropYear}</td></tr>
              ) : filteredData.map(d => {
                const fert = viewMode === 'tenant' ? d.fertTenant : d.fertTotal;
                const herb = viewMode === 'tenant' ? d.herbTenant : d.herbTotal;
                const total = viewMode === 'tenant' ? d.totalTenant : d.totalAll;
                const costPerAcre = viewMode === 'tenant' ? d.costPerAcreTenant : d.costPerAcreAll;
                const breakeven = viewMode === 'tenant' ? d.breakevenTenant : d.breakevenAll;
                return (
                  <tr key={d.id} className={`hover:bg-gray-50 ${d.isShareCrop ? 'bg-purple-50/30' : ''}`}>
                    <td className="px-4 py-3">
                      <div className="font-medium">{d.field_name}</div>
                      <div className="text-xs text-gray-500">{d.farm_name}</div>
                      {d.isShareCrop && d.hasLandlord ? (
                        <div className="text-xs text-purple-600">
                          <span className="font-medium">SHARE</span> - {d.landlord} ({((1 - d.tenant_share) * 100).toFixed(0)}%)
                        </div>
                      ) : d.rentType === 'CASH' ? (
                        <div className="text-xs text-green-600 font-medium">CASH RENT</div>
                      ) : (
                        <div className="text-xs text-gray-400">OWNED</div>
                      )}
                    </td>
                    <td className="px-4 py-3">{d.commodity_name}</td>
                    <td className="px-4 py-3 text-right">{formatNumber(d.planted_acres)}</td>
                    <td className="px-4 py-3 text-right">{formatCurrency(d.overhead)}</td>
                    <td className="px-4 py-3 text-right">{formatCurrency(d.seed)}</td>
                    <td className="px-4 py-3 text-right">{formatCurrency(d.rent)}</td>
                    <td className="px-4 py-3 text-right">{formatCurrency(fert)}</td>
                    <td className="px-4 py-3 text-right">{formatCurrency(herb)}</td>
                    <td className="px-4 py-3 text-right font-semibold">{formatCurrency(total)}</td>
                    <td className="px-4 py-3 text-right">{formatCurrency(costPerAcre)}</td>
                    <td className="px-4 py-3 text-right font-bold text-blue-600">{breakeven ? formatPrice(breakeven) : '-'}</td>
                  </tr>
                );
              })}
            </tbody>
            <tfoot className="bg-gray-100">
              <tr className="font-semibold">
                <td className="px-4 py-3">TOTAL</td>
                <td></td>
                <td className="px-4 py-3 text-right">{formatNumber(filteredData.reduce((s, d) => s + (d.planted_acres || 0), 0))}</td>
                <td className="px-4 py-3 text-right">{formatCurrency(filteredData.reduce((s, d) => s + d.overhead, 0))}</td>
                <td className="px-4 py-3 text-right">{formatCurrency(filteredData.reduce((s, d) => s + d.seed, 0))}</td>
                <td className="px-4 py-3 text-right">{formatCurrency(filteredData.reduce((s, d) => s + d.rent, 0))}</td>
                <td className="px-4 py-3 text-right">{formatCurrency(filteredData.reduce((s, d) => s + (viewMode === 'tenant' ? d.fertTenant : d.fertTotal), 0))}</td>
                <td className="px-4 py-3 text-right">{formatCurrency(filteredData.reduce((s, d) => s + (viewMode === 'tenant' ? d.herbTenant : d.herbTotal), 0))}</td>
                <td className="px-4 py-3 text-right font-bold">{formatCurrency(filteredData.reduce((s, d) => s + (viewMode === 'tenant' ? d.totalTenant : d.totalAll), 0))}</td>
                <td></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  );
}

// ============================================================================
// LANDLORD REPORT PAGE
// ============================================================================
function LandlordReportPage({ cropYear, onYearChange }) {
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [expandedLandlord, setExpandedLandlord] = useState(null);
  const currentYear = new Date().getFullYear();
  const cropYears = [currentYear - 1, currentYear, currentYear + 1];

  useEffect(() => {
    async function load() {
      setLoading(true);
      const [fcys, fertCosts, herbCosts] = await Promise.all([
        getFieldCropYears(cropYear),
        getFertilizerCostsDetailed(cropYear),
        getHerbicideCosts(cropYear)
      ]);

      // Only include fields with landlord splits (tenant_share < 1)
      const landlordFields = fcys.filter(fcy => fcy.tenant_share != null && fcy.tenant_share < 1);

      // Calculate landlord costs for each field
      const fieldsWithCosts = landlordFields.map(fcy => {
        const tenantShare = fcy.tenant_share;
        const landlordShare = 1 - tenantShare;

        // Fertilizer: ALWAYS split
        const fertData = fertCosts[fcy.field_id] || { total: 0 };
        const fertTotal = fertData.total;
        const fertLandlord = fertTotal * landlordShare;

        // Herbicide: Only split products marked 'split' = 'Y'
        const herbData = herbCosts[fcy.field_id] || { total: 0, splitCost: 0, nonSplitCost: 0 };
        const herbSplitCost = herbData.splitCost;  // Only these are split
        const herbLandlord = herbSplitCost * landlordShare;

        const totalLandlord = fertLandlord + herbLandlord;
        const costPerAcreLandlord = fcy.planted_acres > 0 ? totalLandlord / fcy.planted_acres : 0;

        return {
          ...fcy,
          landlordShare,
          fertTotal,
          fertLandlord,
          herbSplitCost,
          herbLandlord,
          totalLandlord,
          costPerAcreLandlord
        };
      });

      // Group by landlord name
      const byLandlord = {};
      fieldsWithCosts.forEach(f => {
        const landlordName = f.landlord || 'Unknown Landlord';
        if (!byLandlord[landlordName]) {
          byLandlord[landlordName] = { name: landlordName, fields: [], totals: { acres: 0, fertLandlord: 0, herbLandlord: 0, totalLandlord: 0 } };
        }
        byLandlord[landlordName].fields.push(f);
        byLandlord[landlordName].totals.acres += f.planted_acres || 0;
        byLandlord[landlordName].totals.fertLandlord += f.fertLandlord;
        byLandlord[landlordName].totals.herbLandlord += f.herbLandlord;
        byLandlord[landlordName].totals.totalLandlord += f.totalLandlord;
      });

      setData(Object.values(byLandlord).sort((a, b) => a.name.localeCompare(b.name)));
      setLoading(false);
    }
    load();
  }, [cropYear]);

  const exportCSV = () => {
    const headers = ['Landlord', 'Field', 'Farm', 'Commodity', 'Acres', 'Landlord %', 'Fertilizer Share', 'Herbicide Share', 'Total Landlord Cost'];
    const rows = [];
    data.forEach(landlord => {
      landlord.fields.forEach(f => {
        rows.push([
          landlord.name,
          f.field_name,
          f.farm_name,
          f.commodity_name,
          f.planted_acres,
          (f.landlordShare * 100).toFixed(0) + '%',
          f.fertLandlord.toFixed(2),
          f.herbLandlord.toFixed(2),
          f.totalLandlord.toFixed(2)
        ]);
      });
      rows.push([landlord.name + ' TOTAL', '', '', '', landlord.totals.acres, '', landlord.totals.fertLandlord.toFixed(2), landlord.totals.herbLandlord.toFixed(2), landlord.totals.totalLandlord.toFixed(2)]);
    });
    const csv = [headers, ...rows].map(r => r.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `landlord-report-${cropYear}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const grandTotals = data.reduce((acc, l) => ({
    acres: acc.acres + l.totals.acres,
    fertLandlord: acc.fertLandlord + l.totals.fertLandlord,
    herbLandlord: acc.herbLandlord + l.totals.herbLandlord,
    totalLandlord: acc.totalLandlord + l.totals.totalLandlord
  }), { acres: 0, fertLandlord: 0, herbLandlord: 0, totalLandlord: 0 });

  const exportPDF = (landlordName = null) => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const margin = 14;
    let yPos = 20;

    const landlords = landlordName ? data.filter(l => l.name === landlordName) : data;
    const title = landlordName ? `Landlord Statement - ${landlordName}` : 'Landlord Report Summary';

    // Title
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.text(title, margin, yPos);
    yPos += 8;

    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(100);
    doc.text(`${cropYear} Crop Year â€¢ Generated ${new Date().toLocaleDateString()}`, margin, yPos);
    yPos += 12;

    doc.setTextColor(0);

    landlords.forEach((landlord, idx) => {
      if (idx > 0) {
        yPos += 10;
        if (yPos > 250) {
          doc.addPage();
          yPos = 20;
        }
      }

      // Landlord header
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text(landlord.name, margin, yPos);
      yPos += 6;

      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text(`${landlord.fields.length} field(s) â€¢ ${formatNumber(landlord.totals.acres)} acres`, margin, yPos);
      yPos += 8;

      // Table
      const tableData = landlord.fields.map(f => [
        f.field_name,
        f.commodity_name,
        formatNumber(f.planted_acres),
        (f.landlordShare * 100).toFixed(0) + '%',
        formatCurrency(f.fertLandlord),
        formatCurrency(f.herbLandlord),
        formatCurrency(f.totalLandlord)
      ]);

      // Add totals row
      tableData.push([
        { content: 'TOTAL', styles: { fontStyle: 'bold' } },
        '',
        { content: formatNumber(landlord.totals.acres), styles: { fontStyle: 'bold' } },
        '',
        { content: formatCurrency(landlord.totals.fertLandlord), styles: { fontStyle: 'bold' } },
        { content: formatCurrency(landlord.totals.herbLandlord), styles: { fontStyle: 'bold' } },
        { content: formatCurrency(landlord.totals.totalLandlord), styles: { fontStyle: 'bold' } }
      ]);

      doc.autoTable({
        startY: yPos,
        head: [['Field', 'Crop', 'Acres', 'Share %', 'Fertilizer', 'Herbicide', 'Total']],
        body: tableData,
        margin: { left: margin, right: margin },
        styles: { fontSize: 9 },
        headStyles: { fillColor: [88, 80, 141] },
        columnStyles: {
          2: { halign: 'right' },
          3: { halign: 'right' },
          4: { halign: 'right' },
          5: { halign: 'right' },
          6: { halign: 'right' }
        }
      });

      yPos = doc.lastAutoTable.finalY + 5;
    });

    // Grand total if showing all landlords
    if (!landlordName && landlords.length > 1) {
      yPos += 5;
      if (yPos > 260) {
        doc.addPage();
        yPos = 20;
      }

      doc.setFillColor(88, 80, 141);
      doc.rect(margin, yPos, doc.internal.pageSize.width - margin * 2, 12, 'F');
      doc.setTextColor(255);
      doc.setFont('helvetica', 'bold');
      doc.text('GRAND TOTAL ALL LANDLORDS:', margin + 4, yPos + 8);
      doc.text(formatCurrency(grandTotals.totalLandlord), doc.internal.pageSize.width - margin - 4, yPos + 8, { align: 'right' });
      doc.setTextColor(0);
    }

    // Footer note
    yPos = doc.internal.pageSize.height - 20;
    doc.setFontSize(8);
    doc.setFont('helvetica', 'italic');
    doc.setTextColor(100);
    doc.text('Note: Includes fertilizer and split herbicide costs only. Burndowns, overhead, seed, rent, insurance, and taxes are tenant responsibility.', margin, yPos);

    const fileName = landlordName
      ? `landlord-statement-${landlordName.replace(/\s+/g, '-').toLowerCase()}-${cropYear}.pdf`
      : `landlord-report-${cropYear}.pdf`;
    doc.save(fileName);
  };

  if (loading) return <div className="flex items-center justify-center h-64"><Icon name="loader" className="animate-spin text-blue-600" size={32} /></div>;

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Landlord Report</h1>
          <p className="text-sm text-gray-500">Expected expenses by landlord for {cropYear}</p>
        </div>
        <div className="flex gap-3">
          <select value={cropYear} onChange={(e) => onYearChange(parseInt(e.target.value))} className="px-4 py-2 border rounded-lg">
            {cropYears.map(y => <option key={y} value={y}>{y} Crop Year</option>)}
          </select>
          <button onClick={exportCSV} className="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
            <Icon name="download" size={18} /> CSV
          </button>
          <button onClick={() => exportPDF()} className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
            <Icon name="file-text" size={18} /> PDF Report
          </button>
        </div>
      </div>

      <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 text-sm text-amber-800">
        <Icon name="info" size={16} className="inline mr-2" />
        <strong>Note:</strong> This report shows landlord's share of <strong>fertilizer</strong> and <strong>herbicide</strong> costs only.
        Insurance, overhead, seed, rent, and misc income (ARC/PLC/CRP payments) are tenant responsibilities and not included here.
        Taxes are landlord's responsibility on share crop land. Burndowns and non-residual herbicides are 100% tenant and excluded.
      </div>

      {data.length === 0 ? (
        <div className="bg-white rounded-xl shadow-sm border p-8 text-center text-gray-500">
          <Icon name="users" size={48} className="mx-auto mb-4 text-gray-300" />
          <p>No landlord fields found for {cropYear}.</p>
          <p className="text-sm mt-2">Fields with tenant_share less than 100% will appear here.</p>
        </div>
      ) : (
        <div className="space-y-4">
          {data.map(landlord => (
            <div key={landlord.name} className="bg-white rounded-xl shadow-sm border overflow-hidden">
              <button
                onClick={() => setExpandedLandlord(expandedLandlord === landlord.name ? null : landlord.name)}
                className="w-full flex items-center justify-between p-4 hover:bg-gray-50"
              >
                <div className="flex items-center gap-4">
                  <div className="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                    <Icon name="user" size={20} className="text-purple-600" />
                  </div>
                  <div className="text-left">
                    <div className="font-semibold text-lg">{landlord.name}</div>
                    <div className="text-sm text-gray-500">{landlord.fields.length} field{landlord.fields.length !== 1 ? 's' : ''} â€¢ {formatNumber(landlord.totals.acres)} acres</div>
                  </div>
                </div>
                <div className="flex items-center gap-6">
                  <div className="text-right">
                    <div className="text-sm text-gray-500">Expected Expenses</div>
                    <div className="text-xl font-bold text-purple-600">{formatCurrency(landlord.totals.totalLandlord)}</div>
                  </div>
                  <Icon name={expandedLandlord === landlord.name ? 'chevron-up' : 'chevron-down'} size={20} className="text-gray-400" />
                </div>
              </button>

              {expandedLandlord === landlord.name && (
                <div className="border-t">
                  <table className="w-full text-sm">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-4 py-2 text-left">Field</th>
                        <th className="px-4 py-2 text-left">Commodity</th>
                        <th className="px-4 py-2 text-right">Acres</th>
                        <th className="px-4 py-2 text-right">Share %</th>
                        <th className="px-4 py-2 text-right">Fertilizer</th>
                        <th className="px-4 py-2 text-right">Herbicide</th>
                        <th className="px-4 py-2 text-right font-semibold">Total</th>
                        <th className="px-4 py-2 text-right">$/Acre</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y">
                      {landlord.fields.map(f => (
                        <tr key={f.id} className="hover:bg-gray-50">
                          <td className="px-4 py-2">
                            <div className="font-medium">{f.field_name}</div>
                            <div className="text-xs text-gray-500">{f.farm_name}</div>
                          </td>
                          <td className="px-4 py-2">{f.commodity_name}</td>
                          <td className="px-4 py-2 text-right">{formatNumber(f.planted_acres)}</td>
                          <td className="px-4 py-2 text-right">
                            <span className="px-2 py-0.5 bg-purple-100 text-purple-800 rounded text-xs">
                              {(f.landlordShare * 100).toFixed(0)}%
                            </span>
                          </td>
                          <td className="px-4 py-2 text-right">{formatCurrency(f.fertLandlord)}</td>
                          <td className="px-4 py-2 text-right">{formatCurrency(f.herbLandlord)}</td>
                          <td className="px-4 py-2 text-right font-semibold">{formatCurrency(f.totalLandlord)}</td>
                          <td className="px-4 py-2 text-right text-gray-600">{formatCurrency(f.costPerAcreLandlord)}</td>
                        </tr>
                      ))}
                    </tbody>
                    <tfoot className="bg-purple-50">
                      <tr className="font-semibold text-purple-800">
                        <td className="px-4 py-2">{landlord.name} Total</td>
                        <td></td>
                        <td className="px-4 py-2 text-right">{formatNumber(landlord.totals.acres)}</td>
                        <td></td>
                        <td className="px-4 py-2 text-right">{formatCurrency(landlord.totals.fertLandlord)}</td>
                        <td className="px-4 py-2 text-right">{formatCurrency(landlord.totals.herbLandlord)}</td>
                        <td className="px-4 py-2 text-right">{formatCurrency(landlord.totals.totalLandlord)}</td>
                        <td></td>
                      </tr>
                    </tfoot>
                  </table>
                  <div className="p-3 bg-gray-50 border-t flex justify-end">
                    <button
                      onClick={(e) => { e.stopPropagation(); exportPDF(landlord.name); }}
                      className="flex items-center gap-2 px-3 py-1.5 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700"
                    >
                      <Icon name="file-text" size={16} /> Export {landlord.name} Statement
                    </button>
                  </div>
                </div>
              )}
            </div>
          ))}

          <div className="bg-purple-600 text-white rounded-xl shadow-sm p-6">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-purple-200 text-sm">Grand Total - All Landlords</div>
                <div className="text-2xl font-bold">{formatCurrency(grandTotals.totalLandlord)}</div>
              </div>
              <div className="grid grid-cols-3 gap-8 text-right">
                <div>
                  <div className="text-purple-200 text-sm">Total Acres</div>
                  <div className="text-xl font-semibold">{formatNumber(grandTotals.acres)}</div>
                </div>
                <div>
                  <div className="text-purple-200 text-sm">Fertilizer</div>
                  <div className="text-xl font-semibold">{formatCurrency(grandTotals.fertLandlord)}</div>
                </div>
                <div>
                  <div className="text-purple-200 text-sm">Herbicide</div>
                  <div className="text-xl font-semibold">{formatCurrency(grandTotals.herbLandlord)}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============================================================================
// SETTINGS PAGE
// ============================================================================
function SettingsPage({ isConnected }) {
  const [activeTab, setActiveTab] = useState('hotlinks');
  const [fields, setFields] = useState([]);
  const [fieldSettings, setFieldSettings] = useState({});
  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState({});
  const { addToast } = useToast();

  // Load fields and settings when visibility tab is active
  useEffect(() => {
    if (activeTab === 'visibility') {
      loadFieldVisibilityData();
    }
  }, [activeTab]);

  const loadFieldVisibilityData = async () => {
    setLoading(true);
    const [fieldsData, settingsData] = await Promise.all([
      db.from('fields')
        .select('id, name, acres, farm_id, active, farms(id, name, adams_grain_share)')
        .eq('active', true)
        .order('name')
        .then(r => r.data || []),
      getFieldSettings()
    ]);

    // Build settings map
    const settingsMap = {};
    settingsData.forEach(s => {
      settingsMap[s.field_id] = s;
    });

    setFields(fieldsData);
    setFieldSettings(settingsMap);
    setLoading(false);
  };

  const handleToggleField = async (fieldId, currentValue) => {
    setSaving(prev => ({ ...prev, [fieldId]: true }));
    try {
      await saveFieldSetting(fieldId, !currentValue);
      setFieldSettings(prev => ({
        ...prev,
        [fieldId]: { ...prev[fieldId], is_active_for_breakeven: !currentValue }
      }));
      addToast('Field visibility updated', { type: 'success' });
    } catch (err) {
      console.error('Error saving field setting:', err);
      addToast('Failed to update setting', { type: 'error' });
    }
    setSaving(prev => ({ ...prev, [fieldId]: false }));
  };

  // Group fields by farm
  const fieldsByFarm = useMemo(() => {
    const grouped = {};
    fields.forEach(f => {
      const farmName = f.farms?.name || 'Unknown Farm';
      const farmId = f.farm_id;
      const adamsShare = f.farms?.adams_grain_share ?? 1;
      if (!grouped[farmId]) {
        grouped[farmId] = {
          name: farmName,
          adamsShare,
          fields: [],
          isExcludedFarm: adamsShare === 0
        };
      }
      grouped[farmId].fields.push(f);
    });
    // Sort farms by name
    return Object.entries(grouped).sort((a, b) => a[1].name.localeCompare(b[1].name));
  }, [fields]);

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-bold text-gray-900">Settings</h1>
        <p className="text-sm text-gray-500">App configuration and links</p>
      </div>

      <div className="flex gap-2 border-b">
        <button onClick={() => setActiveTab('hotlinks')} className={`px-4 py-2 font-medium ${activeTab === 'hotlinks' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>App Links</button>
        <button onClick={() => setActiveTab('visibility')} className={`px-4 py-2 font-medium ${activeTab === 'visibility' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>Field Visibility</button>
        <button onClick={() => setActiveTab('status')} className={`px-4 py-2 font-medium ${activeTab === 'status' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>Status</button>
      </div>

      {activeTab === 'hotlinks' && (
        <div className="bg-white rounded-xl shadow-sm border p-6">
          <h2 className="font-semibold mb-4">Farm Management Suite</h2>
          <div className="grid gap-4">
            {appLinks.map(app => (
              <a key={app.name} href={app.url} className="flex items-center gap-4 p-4 border rounded-lg hover:bg-gray-50">
                <div className="p-2 bg-blue-100 rounded-lg"><Icon name={app.icon} size={24} className="text-blue-600" /></div>
                <div>
                  <div className="font-medium">{app.name}</div>
                  <div className="text-sm text-gray-500">{app.desc}</div>
                </div>
              </a>
            ))}
          </div>
        </div>
      )}

      {activeTab === 'visibility' && (
        <div className="bg-white rounded-xl shadow-sm border p-6">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h2 className="font-semibold">Field Visibility</h2>
              <p className="text-sm text-gray-500">Control which fields appear in Breakeven reports</p>
            </div>
            <button
              onClick={loadFieldVisibilityData}
              className="flex items-center gap-2 px-3 py-1.5 text-sm bg-gray-100 rounded-lg hover:bg-gray-200"
            >
              <Icon name="refresh-cw" size={16} /> Refresh
            </button>
          </div>

          {loading ? (
            <div className="flex items-center justify-center py-12">
              <Icon name="loader" className="animate-spin text-blue-600" size={32} />
            </div>
          ) : (
            <div className="space-y-6">
              <div className="p-4 bg-blue-50 rounded-lg">
                <h3 className="font-medium text-blue-800 mb-2">Visibility Rules</h3>
                <ul className="text-sm text-blue-700 space-y-1">
                  <li>Fields with unchecked boxes are excluded from all Breakeven reports</li>
                  <li>Farms with adams_grain_share = 0 (Dwight farms) are automatically excluded</li>
                  <li>Use this to exclude cleanup fields, test fields, etc.</li>
                </ul>
              </div>

              {fieldsByFarm.map(([farmId, farm]) => (
                <div key={farmId} className={`border rounded-lg ${farm.isExcludedFarm ? 'border-gray-200 bg-gray-50' : 'border-gray-200'}`}>
                  <div className={`px-4 py-3 border-b flex items-center justify-between ${farm.isExcludedFarm ? 'bg-gray-100' : 'bg-gray-50'}`}>
                    <div className="flex items-center gap-2">
                      <Icon name="building" size={18} className={farm.isExcludedFarm ? 'text-gray-400' : 'text-gray-600'} />
                      <span className={`font-medium ${farm.isExcludedFarm ? 'text-gray-400' : ''}`}>{farm.name}</span>
                      {farm.isExcludedFarm && (
                        <span className="px-2 py-0.5 bg-gray-300 text-gray-600 text-xs rounded">Excluded (Share = 0%)</span>
                      )}
                    </div>
                    <span className="text-sm text-gray-500">{farm.fields.length} fields</span>
                  </div>
                  <div className="divide-y">
                    {farm.fields.map(field => {
                      const setting = fieldSettings[field.id];
                      const isActive = setting?.is_active_for_breakeven !== false;
                      const isSaving = saving[field.id];
                      const isDisabled = farm.isExcludedFarm;

                      return (
                        <div key={field.id} className={`px-4 py-3 flex items-center justify-between ${isDisabled ? 'opacity-50' : ''}`}>
                          <div className="flex items-center gap-3">
                            <input
                              type="checkbox"
                              checked={isActive && !isDisabled}
                              onChange={() => !isDisabled && handleToggleField(field.id, isActive)}
                              disabled={isSaving || isDisabled}
                              className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 disabled:opacity-50"
                            />
                            <div>
                              <div className={`font-medium ${!isActive && !isDisabled ? 'text-gray-400 line-through' : ''}`}>{field.name}</div>
                              <div className="text-xs text-gray-500">{formatNumber(field.acres)} acres</div>
                            </div>
                          </div>
                          {isSaving && <Icon name="loader" className="animate-spin text-blue-600" size={16} />}
                          {!isActive && !isDisabled && (
                            <span className="px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded">Excluded</span>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {activeTab === 'status' && (
        <div className="bg-white rounded-xl shadow-sm border p-6">
          <div className="flex items-center gap-3">
            <div className={`w-3 h-3 rounded-full ${isConnected ? 'bg-green-500' : 'bg-red-500'}`} />
            <span className="font-medium">{isConnected ? 'Connected to Database' : 'Disconnected'}</span>
          </div>
          <p className="text-sm text-gray-500 mt-2">Breakeven Calculator v2.5.0</p>
          <div className="mt-4 p-4 bg-blue-50 rounded-lg">
            <h3 className="font-medium text-blue-800 mb-2">Data Sources</h3>
            <ul className="text-sm text-blue-700 space-y-1">
              <li>Fertilizer costs pulled from Fertilizer App</li>
              <li>Herbicide costs pulled from Spray-Suite applications</li>
              <li>Overhead, seed, and rent managed here</li>
            </ul>
          </div>
        </div>
      )}
    </div>
  );
}

// ============================================================================
// MAIN APP
// ============================================================================
function App() {
  const [currentPage, setCurrentPage] = useState('dashboard');
  const [isConnected, setIsConnected] = useState(null);
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [user, setUser] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);
  const currentYear = new Date().getFullYear();
  const [selectedCropYear, setSelectedCropYear] = useState(currentYear);

  useEffect(() => {
    async function checkAuth() {
      const { data: { session } } = await db.auth.getSession();
      if (!session) {
        window.location.href = 'login.html';
        return;
      }
      setUser(session.user);
      setAuthLoading(false);
    }
    checkAuth();
    const { data: { subscription } } = db.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_OUT' || !session) window.location.href = 'login.html';
      else setUser(session.user);
    });
    return () => subscription.unsubscribe();
  }, []);

  useEffect(() => { testConnection().then(setIsConnected); }, []);

  const handleLogout = async () => {
    await db.auth.signOut();
    window.location.href = 'login.html';
  };

  if (authLoading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <Icon name="loader" className="animate-spin text-blue-600" size={32} />
      </div>
    );
  }

  const renderPage = () => {
    switch (currentPage) {
      case 'dashboard': return <DashboardPage cropYear={selectedCropYear} onYearChange={setSelectedCropYear} />;
      case 'overhead': return <OverheadPage cropYear={selectedCropYear} onYearChange={setSelectedCropYear} />;
      case 'income': return <MiscIncomePage cropYear={selectedCropYear} onYearChange={setSelectedCropYear} />;
      case 'seed-products': return <SeedProductsPage />;
      case 'land-rent': return <LandRentPage cropYear={selectedCropYear} onYearChange={setSelectedCropYear} />;
      case 'crop-plans': return <CropPlansPage cropYear={selectedCropYear} onYearChange={setSelectedCropYear} />;
      case 'field-applications': return <FieldApplicationsPage cropYear={selectedCropYear} onYearChange={setSelectedCropYear} />;
      case 'breakeven': return <BreakevenPage cropYear={selectedCropYear} onYearChange={setSelectedCropYear} />;
      case 'analysis': return <AnalysisPage cropYear={selectedCropYear} onYearChange={setSelectedCropYear} />;
      case 'reports': return <ReportsPage cropYear={selectedCropYear} onYearChange={setSelectedCropYear} />;
      case 'landlord-report': return <LandlordReportPage cropYear={selectedCropYear} onYearChange={setSelectedCropYear} />;
      case 'settings': return <SettingsPage isConnected={isConnected} />;
      default: return <DashboardPage cropYear={selectedCropYear} onYearChange={setSelectedCropYear} />;
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Mobile header */}
      <div className="lg:hidden bg-white border-b px-4 py-3 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <button onClick={() => setIsSidebarOpen(true)} className="p-2 hover:bg-gray-100 rounded-lg"><Icon name="menu" size={20} /></button>
          <div className="flex items-center gap-2">
            <Icon name="target" size={24} className="text-blue-600" />
            <span className="font-bold text-gray-900">Breakeven</span>
          </div>
        </div>
        <div className="flex items-center gap-1">
          <a href="https://baldwinag.com/portal/graintrack" className="p-2 hover:bg-gray-100 rounded-lg" title="GrainTrack"><Icon name="wheat" size={18} className="text-amber-600" /></a>
          <a href="https://baldwinag.com/portal/fertilizer" className="p-2 hover:bg-gray-100 rounded-lg" title="Fertilizer"><Icon name="flask-conical" size={18} className="text-green-600" /></a>
          <a href="https://baldwinag.com/spray/manager" className="p-2 hover:bg-gray-100 rounded-lg" title="Spray-Suite"><Icon name="spray-can" size={18} className="text-purple-600" /></a>
        </div>
      </div>

      {/* Mobile sidebar overlay */}
      {isSidebarOpen && (
        <div className="lg:hidden fixed inset-0 z-50">
          <div className="fixed inset-0 bg-black bg-opacity-50" onClick={() => setIsSidebarOpen(false)} />
          <div className="fixed left-0 top-0 bottom-0 w-64 bg-white shadow-xl">
            <div className="p-4 border-b flex items-center justify-between">
              <div className="flex items-center gap-2">
                <Icon name="target" size={24} className="text-blue-600" />
                <span className="font-bold text-gray-900">Breakeven</span>
              </div>
              <button onClick={() => setIsSidebarOpen(false)} className="p-2 hover:bg-gray-100 rounded-lg"><Icon name="x" size={20} /></button>
            </div>
            <nav className="p-2">
              {navItems.map(item => (
                <button key={item.id} onClick={() => { setCurrentPage(item.id); setIsSidebarOpen(false); }}
                  className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left mb-1 ${currentPage === item.id ? 'bg-blue-100 text-blue-900' : 'text-gray-600 hover:bg-gray-100'}`}>
                  <Icon name={item.icon} size={20} />
                  <span className="font-medium">{item.label}</span>
                </button>
              ))}
            </nav>
          </div>
        </div>
      )}

      <div className="lg:flex">
        {/* Desktop sidebar */}
        <div className="hidden lg:flex lg:flex-col w-64 min-h-screen bg-white border-r">
          <div className="p-4 border-b">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <Icon name="target" size={28} className="text-blue-600" />
                <div>
                  <div className="font-bold text-gray-900">Breakeven Calculator</div>
                  <div className="text-xs text-gray-500">v2.5.0</div>
                </div>
              </div>
              <div className="flex items-center gap-1">
                <a href="https://baldwinag.com/portal/graintrack" className="p-2 hover:bg-gray-100 rounded-lg" title="GrainTrack"><Icon name="wheat" size={18} className="text-amber-600" /></a>
                <a href="https://baldwinag.com/portal/fertilizer" className="p-2 hover:bg-gray-100 rounded-lg" title="Fertilizer"><Icon name="flask-conical" size={18} className="text-green-600" /></a>
                <a href="https://baldwinag.com/spray/manager" className="p-2 hover:bg-gray-100 rounded-lg" title="Spray-Suite"><Icon name="spray-can" size={18} className="text-purple-600" /></a>
              </div>
            </div>
          </div>
          <nav className="flex-1 p-2 overflow-y-auto">
            {navItems.map(item => (
              <button key={item.id} onClick={() => setCurrentPage(item.id)}
                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left mb-1 ${currentPage === item.id ? 'bg-blue-100 text-blue-900' : 'text-gray-600 hover:bg-gray-100'}`}>
                <Icon name={item.icon} size={20} />
                <span className="font-medium">{item.label}</span>
              </button>
            ))}
          </nav>
          <div className="p-4 border-t bg-white space-y-3 flex-shrink-0">
            {user && (
              <div className="flex items-center justify-between">
                <span className="text-sm text-gray-700 truncate">{user.email}</span>
                <button onClick={handleLogout} className="p-2 text-gray-400 hover:text-red-500 rounded-lg" title="Sign out">
                  <Icon name="log-out" size={18} />
                </button>
              </div>
            )}
            <div className="flex items-center gap-2">
              <div className={`w-2 h-2 rounded-full ${isConnected ? 'bg-green-500' : isConnected === false ? 'bg-red-500' : 'bg-gray-300'}`} />
              <span className="text-sm text-gray-500">{isConnected ? 'Connected' : isConnected === false ? 'Disconnected' : 'Checking...'}</span>
            </div>
          </div>
        </div>

        {/* Main content */}
        <div className="flex-1 p-4 lg:p-8">{renderPage()}</div>
      </div>
    </div>
  );
}

// Render the app
ReactDOM.createRoot(document.getElementById('root')).render(
  <ToastProvider>
    <App />
  </ToastProvider>
);
</script>
</body>
</html>
